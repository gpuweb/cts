{"version":3,"sources":["../../../src/webgpu/util/check_contents.ts"],"names":["assert","ErrorWithExtra","iterRange","range","float16BitsToFloat32","checkElementsEqual","actual","expected","constructor","length","checkElementsEqualGenerated","i","checkElementsBetween","error","checkElementsPassPredicate","index","value","Math","min","max","predicatePrinter","leftHeader","getValueForCell","undefined","checkElementsFloat16Between","BYTES_PER_ELEMENT","actualF32","Float32Array","forEach","v","expectedF32","checkElementsEqualEither","generator","predicate","size","ctor","printAsFloat","Float64Array","failedElementsFirstMaybe","failedElements","failedElementsFirst","failedElementsLast","printElementsStart","printElementsEnd","printElementsCount","numberToString","n","toPrecision","intToPaddedHex","byteLength","numberPrefix","printActual","subarray","printExpected","cell","push","printFailedValueMarkers","opts","fillToWidth","msg","generatePrettyTable","slice","number","Number","isInteger","s","abs","toString","padStart","rows","rowStrings","totalTableWidth","iters","map","row","Symbol","iterator","cellsForColumn","iter","r","next","done","every","colWidth","c","join"],"mappings":"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","sourcesContent":["import {\n  assert,\n  ErrorWithExtra,\n  iterRange,\n  range,\n  TypedArrayBufferView,\n  TypedArrayBufferViewConstructor,\n} from '../../common/util/util.js';\n\nimport { float16BitsToFloat32 } from './conversion.js';\n\n/** Generate an expected value at `index`, to test for equality with the actual value. */\nexport type CheckElementsGenerator = (index: number) => number;\n/** Check whether the actual `value` at `index` is as expected. */\nexport type CheckElementsPredicate = (index: number, value: number) => boolean;\n/**\n * Provides a pretty-printing implementation for a particular CheckElementsPredicate.\n * This is an array; each element provides info to print an additional row in the error message.\n */\nexport type CheckElementsSupplementalTableRows = Array<{\n  /** Row header. */\n  leftHeader: string;\n  /**\n   * Get the value for a cell in the table with element index `index`.\n   * May be a string or a number; a number will be formatted according to the TypedArray type used.\n   */\n  getValueForCell: (index: number) => number | string;\n}>;\n\n/**\n * Check whether two `TypedArray`s have equal contents.\n * Returns `undefined` if the check passes, or an `Error` if not.\n */\nexport function checkElementsEqual(\n  actual: TypedArrayBufferView,\n  expected: TypedArrayBufferView\n): ErrorWithExtra | undefined {\n  assert(actual.constructor === expected.constructor, 'TypedArray type mismatch');\n  assert(actual.length === expected.length, 'size mismatch');\n  return checkElementsEqualGenerated(actual, i => expected[i]);\n}\n\n/**\n * Check whether each value in a `TypedArray` is between the two corresponding \"expected\" values\n * (either `a(i) <= actual[i] <= b(i)` or `a(i) >= actual[i] => b(i)`).\n */\nexport function checkElementsBetween(\n  actual: TypedArrayBufferView,\n  expected: readonly [CheckElementsGenerator, CheckElementsGenerator]\n): ErrorWithExtra | undefined {\n  const error = checkElementsPassPredicate(\n    actual,\n    (index, value) =>\n      value >= Math.min(expected[0](index), expected[1](index)) &&\n      value <= Math.max(expected[0](index), expected[1](index)),\n    {\n      predicatePrinter: [\n        { leftHeader: 'between', getValueForCell: index => expected[0](index) },\n        { leftHeader: 'and', getValueForCell: index => expected[1](index) },\n      ],\n    }\n  );\n  // If there was an error, extend it with additional extras.\n  return error ? new ErrorWithExtra(error, () => ({ expected })) : undefined;\n}\n\n/**\n * Equivalent to {@link checkElementsBetween} but interpret values as float16 and convert to JS number before comparison.\n */\nexport function checkElementsFloat16Between(\n  actual: TypedArrayBufferView,\n  expected: readonly [TypedArrayBufferView, TypedArrayBufferView]\n): ErrorWithExtra | undefined {\n  assert(actual.BYTES_PER_ELEMENT === 2, 'bytes per element need to be 2 (16bit)');\n  const actualF32 = new Float32Array(actual.length);\n  actual.forEach((v: number, i: number) => {\n    actualF32[i] = float16BitsToFloat32(v);\n  });\n  const expectedF32 = [new Float32Array(expected[0].length), new Float32Array(expected[1].length)];\n  expected[0].forEach((v: number, i: number) => {\n    expectedF32[0][i] = float16BitsToFloat32(v);\n  });\n  expected[1].forEach((v: number, i: number) => {\n    expectedF32[1][i] = float16BitsToFloat32(v);\n  });\n\n  const error = checkElementsPassPredicate(\n    actualF32,\n    (index, value) =>\n      value >= Math.min(expectedF32[0][index], expectedF32[1][index]) &&\n      value <= Math.max(expectedF32[0][index], expectedF32[1][index]),\n    {\n      predicatePrinter: [\n        { leftHeader: 'between', getValueForCell: index => expectedF32[0][index] },\n        { leftHeader: 'and', getValueForCell: index => expectedF32[1][index] },\n      ],\n    }\n  );\n  // If there was an error, extend it with additional extras.\n  return error ? new ErrorWithExtra(error, () => ({ expectedF32 })) : undefined;\n}\n\n/**\n * Check whether each value in a `TypedArray` is equal to one of the two corresponding \"expected\"\n * values (either `actual[i] === a[i]` or `actual[i] === b[i]`)\n */\nexport function checkElementsEqualEither(\n  actual: TypedArrayBufferView,\n  expected: readonly [TypedArrayBufferView, TypedArrayBufferView]\n): ErrorWithExtra | undefined {\n  const error = checkElementsPassPredicate(\n    actual,\n    (index, value) => value === expected[0][index] || value === expected[1][index],\n    {\n      predicatePrinter: [\n        { leftHeader: 'either', getValueForCell: index => expected[0][index] },\n        { leftHeader: 'or', getValueForCell: index => expected[1][index] },\n      ],\n    }\n  );\n  // If there was an error, extend it with additional extras.\n  return error ? new ErrorWithExtra(error, () => ({ expected })) : undefined;\n}\n\n/**\n * Check whether a `TypedArray`'s contents equal the values produced by a generator function.\n * Returns `undefined` if the check passes, or an `Error` if not.\n *\n * ```text\n * Array had unexpected contents at indices 2 through 19.\n *  Starting at index 1:\n *    actual == 0x: 00 fe ff 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00\n *    failed ->        xx xx    xx xx xx xx xx xx xx xx xx xx xx xx xx xx xx\n *  expected ==     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\n * ```\n *\n * ```text\n * Array had unexpected contents at indices 2 through 29.\n *  Starting at index 1:\n *    actual ==  0.000 -2.000e+100 -1.000e+100 0.000 1.000e+100 2.000e+100 3.000e+100 4.000e+100 5.000e+100 6.000e+100 7.000e+100 ...\n *    failed ->                 xx          xx               xx         xx         xx         xx         xx         xx         xx ...\n *  expected ==  0.000       0.000       0.000 0.000      0.000      0.000      0.000      0.000      0.000      0.000      0.000 ...\n * ```\n */\nexport function checkElementsEqualGenerated(\n  actual: TypedArrayBufferView,\n  generator: CheckElementsGenerator\n): ErrorWithExtra | undefined {\n  const error = checkElementsPassPredicate(actual, (index, value) => value === generator(index), {\n    predicatePrinter: [{ leftHeader: 'expected ==', getValueForCell: index => generator(index) }],\n  });\n  // If there was an error, extend it with additional extras.\n  return error ? new ErrorWithExtra(error, () => ({ generator })) : undefined;\n}\n\n/**\n * Check whether a `TypedArray`'s values pass the provided predicate function.\n * Returns `undefined` if the check passes, or an `Error` if not.\n */\nexport function checkElementsPassPredicate(\n  actual: TypedArrayBufferView,\n  predicate: CheckElementsPredicate,\n  { predicatePrinter }: { predicatePrinter?: CheckElementsSupplementalTableRows }\n): ErrorWithExtra | undefined {\n  const size = actual.length;\n  const ctor = actual.constructor as TypedArrayBufferViewConstructor;\n  const printAsFloat = ctor === Float32Array || ctor === Float64Array;\n\n  let failedElementsFirstMaybe: number | undefined = undefined;\n  /** Sparse array with `true` for elements that failed. */\n  const failedElements: (true | undefined)[] = [];\n  for (let i = 0; i < size; ++i) {\n    if (!predicate(i, actual[i])) {\n      failedElementsFirstMaybe ??= i;\n      failedElements[i] = true;\n    }\n  }\n\n  if (failedElementsFirstMaybe === undefined) {\n    return undefined;\n  }\n  const failedElementsFirst = failedElementsFirstMaybe;\n  const failedElementsLast = failedElements.length - 1;\n\n  // Include one extra non-failed element at the beginning and end (if they exist), for context.\n  const printElementsStart = Math.max(0, failedElementsFirst - 1);\n  const printElementsEnd = Math.min(size, failedElementsLast + 2);\n  const printElementsCount = printElementsEnd - printElementsStart;\n\n  const numberToString = printAsFloat\n    ? (n: number) => n.toPrecision(4)\n    : (n: number) => intToPaddedHex(n, { byteLength: ctor.BYTES_PER_ELEMENT });\n  const numberPrefix = printAsFloat ? '' : '0x:';\n\n  const printActual = actual.subarray(printElementsStart, printElementsEnd);\n  const printExpected: Array<Iterable<string | number>> = [];\n  if (predicatePrinter) {\n    for (const { leftHeader, getValueForCell: cell } of predicatePrinter) {\n      printExpected.push(\n        (function* () {\n          yield* [leftHeader, ''];\n          yield* iterRange(printElementsCount, i => cell(printElementsStart + i));\n        })()\n      );\n    }\n  }\n\n  const printFailedValueMarkers = (function* () {\n    yield* ['failed ->', ''];\n    yield* range(printElementsCount, i => (failedElements[printElementsStart + i] ? 'xx' : ''));\n  })();\n\n  const opts = {\n    fillToWidth: 120,\n    numberToString,\n  };\n  const msg = `Array had unexpected contents at indices ${failedElementsFirst} through ${failedElementsLast}.\n Starting at index ${printElementsStart}:\n${generatePrettyTable(opts, [\n  ['actual ==', numberPrefix, ...printActual],\n  printFailedValueMarkers,\n  ...printExpected,\n])}`;\n  return new ErrorWithExtra(msg, () => ({\n    actual: actual.slice(),\n  }));\n}\n\n// Helper helpers\n\n/** Convert an integral `number` into a hex string, padded to the specified `byteLength`. */\nfunction intToPaddedHex(number: number, { byteLength }: { byteLength: number }) {\n  assert(Number.isInteger(number), 'number must be integer');\n  let s = Math.abs(number).toString(16);\n  if (byteLength) s = s.padStart(byteLength * 2, '0');\n  if (number < 0) s = '-' + s;\n  return s;\n}\n\n/**\n * Pretty-prints a \"table\" of cell values (each being `number | string`), right-aligned.\n * Each row may be any iterator, including lazily-generated (potentially infinite) rows.\n *\n * The first argument is the printing options:\n *  - fillToWidth: Keep printing columns (as long as there is data) until this width is passed.\n *    If there is more data, \"...\" is appended.\n *  - numberToString: if a cell value is a number, this is used to stringify it.\n *\n * Each remaining argument provides one row for the table.\n */\nfunction generatePrettyTable(\n  { fillToWidth, numberToString }: { fillToWidth: number; numberToString: (n: number) => string },\n  rows: ReadonlyArray<Iterable<string | number>>\n): string {\n  const rowStrings = range(rows.length, () => '');\n  let totalTableWidth = 0;\n  const iters = rows.map(row => row[Symbol.iterator]());\n\n  // Loop over columns\n  for (;;) {\n    const cellsForColumn = iters.map(iter => {\n      const r = iter.next(); // Advance the iterator for each row, in lock-step.\n      return r.done ? undefined : typeof r.value === 'number' ? numberToString(r.value) : r.value;\n    });\n    if (cellsForColumn.every(cell => cell === undefined)) break;\n\n    // Maximum width of any cell in this column, plus one for space between columns\n    // (also inserts a space at the left of the first column).\n    const colWidth = Math.max(...cellsForColumn.map(c => (c === undefined ? 0 : c.length))) + 1;\n    for (let row = 0; row < rowStrings.length; ++row) {\n      const cell = cellsForColumn[row];\n      if (cell !== undefined) {\n        rowStrings[row] += cell.padStart(colWidth);\n      }\n    }\n\n    totalTableWidth += colWidth;\n    if (totalTableWidth >= fillToWidth) {\n      for (let row = 0; row < rowStrings.length; ++row) {\n        if (cellsForColumn[row] !== undefined) {\n          rowStrings[row] += ' ...';\n        }\n      }\n      break;\n    }\n  }\n  return rowStrings.join('\\n');\n}\n"],"file":"check_contents.js"}