{"version":3,"file":"video.spec.js","names":["description","makeTestGroup","GPUTest","TextureTestMixin","startPlayingAndWaitForVideo","getVideoElement","getVideoFrameFromVideoElement","convertToUnorm8","kPredefinedColorSpace","kVideoNames","kVideoInfo","kVideoExpectedColors","kFormat","g","test","desc","params","u","combine","fn","t","videoName","sourceType","srcDoFlipYDuringCopy","dstColorSpace","VideoFrame","skip","videoElement","source","width","height","displayWidth","displayHeight","videoWidth","videoHeight","dstTexture","createTextureTracked","format","size","depthOrArrayLayers","usage","GPUTextureUsage","COPY_SRC","COPY_DST","RENDER_ATTACHMENT","queue","copyExternalImageToTexture","origin","x","y","flipY","texture","colorSpace","premultipliedAlpha","srcColorSpace","presentColors","expect","display","expectSinglePixelComparisonsAreOkInTexture","coord","exp","bottomLeftColor","bottomRightColor","topLeftColor","topRightColor","close"],"sources":["../../../../src/webgpu/web_platform/copyToTexture/video.spec.ts"],"sourcesContent":["export const description = `\ncopyToTexture with HTMLVideoElement and VideoFrame.\n\n- videos with various encodings/formats (webm vp8, webm vp9, ogg theora, mp4), video color spaces\n  (bt.601, bt.709, bt.2020) and dst color spaces(display-p3, srgb).\n\n  TODO: Test video in BT.2020 color space\n`;\n\nimport { makeTestGroup } from '../../../common/framework/test_group.js';\nimport { GPUTest, TextureTestMixin } from '../../gpu_test.js';\nimport {\n  startPlayingAndWaitForVideo,\n  getVideoElement,\n  getVideoFrameFromVideoElement,\n  convertToUnorm8,\n  kPredefinedColorSpace,\n  kVideoNames,\n  kVideoInfo,\n  kVideoExpectedColors,\n} from '../../web_platform/util.js';\n\nconst kFormat = 'rgba8unorm';\n\nexport const g = makeTestGroup(TextureTestMixin(GPUTest));\n\ng.test('copy_from_video')\n  .desc(\n    `\nTest HTMLVideoElement and VideoFrame can be copied to WebGPU texture correctly.\n\nIt creates HTMLVideoElement with videos under Resource folder.\n\n  Then call copyExternalImageToTexture() to do a full copy to the 0 mipLevel\n  of dst texture, and read the contents out to compare with the ImageBitmap contents.\n\n  If 'flipY' in 'GPUImageCopyExternalImage' is set to 'true', copy will ensure the result\n  is flipped.\n\n  The tests covers:\n  - Video comes from different color spaces.\n  - Valid 'flipY' config in 'GPUImageCopyExternalImage' (named 'srcDoFlipYDuringCopy' in cases)\n  - TODO: partial copy tests should be added\n  - TODO: all valid dstColorFormat tests should be added.\n`\n  )\n  .params(u =>\n    u //\n      .combine('videoName', kVideoNames)\n      .combine('sourceType', ['VideoElement', 'VideoFrame'] as const)\n      .combine('srcDoFlipYDuringCopy', [true, false])\n      .combine('dstColorSpace', kPredefinedColorSpace)\n  )\n  .fn(async t => {\n    const { videoName, sourceType, srcDoFlipYDuringCopy, dstColorSpace } = t.params;\n\n    if (sourceType === 'VideoFrame' && typeof VideoFrame === 'undefined') {\n      t.skip('WebCodec is not supported');\n    }\n\n    const videoElement = getVideoElement(t, videoName);\n\n    await startPlayingAndWaitForVideo(videoElement, async () => {\n      let source, width, height;\n      if (sourceType === 'VideoFrame') {\n        source = await getVideoFrameFromVideoElement(t, videoElement);\n        width = source.displayWidth;\n        height = source.displayHeight;\n      } else {\n        source = videoElement;\n        width = source.videoWidth;\n        height = source.videoHeight;\n      }\n\n      const dstTexture = t.createTextureTracked({\n        format: kFormat,\n        size: { width, height, depthOrArrayLayers: 1 },\n        usage:\n          GPUTextureUsage.COPY_SRC | GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n      });\n\n      t.queue.copyExternalImageToTexture(\n        {\n          source,\n          origin: { x: 0, y: 0 },\n          flipY: srcDoFlipYDuringCopy,\n        },\n        {\n          texture: dstTexture,\n          origin: { x: 0, y: 0 },\n          colorSpace: dstColorSpace,\n          premultipliedAlpha: true,\n        },\n        { width, height, depthOrArrayLayers: 1 }\n      );\n\n      const srcColorSpace = kVideoInfo[videoName].colorSpace;\n      const presentColors = kVideoExpectedColors[srcColorSpace][dstColorSpace];\n\n      // visible rect is whole frame, no clipping.\n      const expect = kVideoInfo[videoName].display;\n\n      if (srcDoFlipYDuringCopy) {\n        t.expectSinglePixelComparisonsAreOkInTexture({ texture: dstTexture }, [\n          // Flipped top-left.\n          {\n            coord: { x: width * 0.25, y: height * 0.25 },\n            exp: convertToUnorm8(presentColors[expect.bottomLeftColor]),\n          },\n          // Flipped top-right.\n          {\n            coord: { x: width * 0.75, y: height * 0.25 },\n            exp: convertToUnorm8(presentColors[expect.bottomRightColor]),\n          },\n          // Flipped bottom-left.\n          {\n            coord: { x: width * 0.25, y: height * 0.75 },\n            exp: convertToUnorm8(presentColors[expect.topLeftColor]),\n          },\n          // Flipped bottom-right.\n          {\n            coord: { x: width * 0.75, y: height * 0.75 },\n            exp: convertToUnorm8(presentColors[expect.topRightColor]),\n          },\n        ]);\n      } else {\n        t.expectSinglePixelComparisonsAreOkInTexture({ texture: dstTexture }, [\n          // Top-left.\n          {\n            coord: { x: width * 0.25, y: height * 0.25 },\n            exp: convertToUnorm8(presentColors[expect.topLeftColor]),\n          },\n          // Top-right.\n          {\n            coord: { x: width * 0.75, y: height * 0.25 },\n            exp: convertToUnorm8(presentColors[expect.topRightColor]),\n          },\n          // Bottom-left.\n          {\n            coord: { x: width * 0.25, y: height * 0.75 },\n            exp: convertToUnorm8(presentColors[expect.bottomLeftColor]),\n          },\n          // Bottom-right.\n          {\n            coord: { x: width * 0.75, y: height * 0.75 },\n            exp: convertToUnorm8(presentColors[expect.bottomRightColor]),\n          },\n        ]);\n      }\n\n      if (source instanceof VideoFrame) {\n        source.close();\n      }\n    });\n  });\n"],"mappings":"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"}