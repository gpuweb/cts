{"version":3,"file":"video.spec.js","names":["description","makeTestGroup","GPUTest","TextureTestMixin","startPlayingAndWaitForVideo","getVideoFrameFromVideoElement","getVideoElement","convertToUnorm8","kPredefinedColorSpace","kVideoNames","kVideoInfo","kVideoExpectedColors","kHeight","kWidth","kFormat","g","createExternalTextureSamplingTestPipeline","t","pipeline","device","createRenderPipeline","layout","vertex","module","createShaderModule","code","entryPoint","fragment","targets","format","primitive","topology","createExternalTextureSamplingTestBindGroup","checkNonStandardIsZeroCopy","source","dstColorSpace","linearSampler","createSampler","externalTexture","importExternalTexture","colorSpace","expectZeroCopyNonStandard","bindGroup","createBindGroup","getBindGroupLayout","entries","binding","resource","expect","isZeroCopy","checkNonStandardIsZeroCopyIfAvailable","GPUExternalTexture","prototype","hasOwnProperty","test","desc","params","u","combineWithParams","combine","fn","videoName","sourceType","VideoFrame","skip","videoElement","colorAttachment","createTexture","size","width","height","depthOrArrayLayers","usage","GPUTextureUsage","COPY_SRC","RENDER_ATTACHMENT","commandEncoder","createCommandEncoder","passEncoder","beginRenderPass","colorAttachments","view","createView","clearValue","r","b","a","loadOp","storeOp","setPipeline","setBindGroup","draw","end","queue","submit","finish","srcColorSpace","presentColors","display","expectSinglePixelComparisonsAreOkInTexture","texture","coord","x","y","exp","topLeftColor","topRightColor","bottomLeftColor","bottomRightColor","srcVideoHeight","codedHeight","srcVideoWidth","codedWidth","coded","cropParams","subRect","color","cropParam","visibleRect","close","outputTexture","STORAGE_BINDING","createComputePipeline","compute","constants","frameWidth","displayWidth","videoWidth","frameHeight","displayHeight","videoHeight","bg","encoder","pass","beginComputePass","dispatchWorkgroups"],"sources":["../../../../src/webgpu/web_platform/external_texture/video.spec.ts"],"sourcesContent":["export const description = `\nTests for external textures from HTMLVideoElement (and other video-type sources?).\n\n- videos with various encodings/formats (webm vp8, webm vp9, ogg theora, mp4), video color spaces\n  (bt.601, bt.709, bt.2020) and dst color spaces(display-p3, srgb)\n\nTODO: consider whether external_texture and copyToTexture video tests should be in the same file\nTODO(#3193): Test video in BT.2020 color space\n`;\n\nimport { makeTestGroup } from '../../../common/framework/test_group.js';\nimport { GPUTest, TextureTestMixin } from '../../gpu_test.js';\nimport {\n  startPlayingAndWaitForVideo,\n  getVideoFrameFromVideoElement,\n  getVideoElement,\n  convertToUnorm8,\n  kPredefinedColorSpace,\n  kVideoNames,\n  kVideoInfo,\n  kVideoExpectedColors,\n} from '../../web_platform/util.js';\n\nconst kHeight = 16;\nconst kWidth = 16;\nconst kFormat = 'rgba8unorm';\n\nexport const g = makeTestGroup(TextureTestMixin(GPUTest));\n\nfunction createExternalTextureSamplingTestPipeline(t: GPUTest): GPURenderPipeline {\n  const pipeline = t.device.createRenderPipeline({\n    layout: 'auto',\n    vertex: {\n      module: t.device.createShaderModule({\n        code: `\n        @vertex fn main(@builtin(vertex_index) VertexIndex : u32) -> @builtin(position) vec4<f32> {\n            var pos = array<vec4<f32>, 6>(\n              vec4<f32>( 1.0,  1.0, 0.0, 1.0),\n              vec4<f32>( 1.0, -1.0, 0.0, 1.0),\n              vec4<f32>(-1.0, -1.0, 0.0, 1.0),\n              vec4<f32>( 1.0,  1.0, 0.0, 1.0),\n              vec4<f32>(-1.0, -1.0, 0.0, 1.0),\n              vec4<f32>(-1.0,  1.0, 0.0, 1.0)\n            );\n            return pos[VertexIndex];\n        }\n        `,\n      }),\n      entryPoint: 'main',\n    },\n    fragment: {\n      module: t.device.createShaderModule({\n        code: `\n        @group(0) @binding(0) var s : sampler;\n        @group(0) @binding(1) var t : texture_external;\n\n        @fragment fn main(@builtin(position) FragCoord : vec4<f32>)\n                                 -> @location(0) vec4<f32> {\n            return textureSampleBaseClampToEdge(t, s, FragCoord.xy / vec2<f32>(16.0, 16.0));\n        }\n        `,\n      }),\n      entryPoint: 'main',\n      targets: [\n        {\n          format: kFormat,\n        },\n      ],\n    },\n    primitive: { topology: 'triangle-list' },\n  });\n\n  return pipeline;\n}\n\nfunction createExternalTextureSamplingTestBindGroup(\n  t: GPUTest,\n  checkNonStandardIsZeroCopy: true | undefined,\n  source: HTMLVideoElement | VideoFrame,\n  pipeline: GPURenderPipeline,\n  dstColorSpace: PredefinedColorSpace\n): GPUBindGroup {\n  const linearSampler = t.device.createSampler();\n\n  const externalTexture = t.device.importExternalTexture({\n    source,\n    colorSpace: dstColorSpace,\n  });\n\n  if (checkNonStandardIsZeroCopy) {\n    expectZeroCopyNonStandard(t, externalTexture);\n  }\n  const bindGroup = t.device.createBindGroup({\n    layout: pipeline.getBindGroupLayout(0),\n    entries: [\n      {\n        binding: 0,\n        resource: linearSampler,\n      },\n      {\n        binding: 1,\n        resource: externalTexture,\n      },\n    ],\n  });\n\n  return bindGroup;\n}\n\n/**\n * Expect the non-standard `externalTexture.isZeroCopy` is true.\n */\nfunction expectZeroCopyNonStandard(t: GPUTest, externalTexture: GPUExternalTexture): void {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  t.expect((externalTexture as any).isZeroCopy, '0-copy import failed.');\n}\n\n/**\n * `externalTexture.isZeroCopy` is a non-standard Chrome API for testing only.\n * It is exposed by enabling chrome://flags/#enable-webgpu-developer-features\n *\n * If the API is available, this function adds a parameter `checkNonStandardIsZeroCopy`.\n * Cases with that parameter set to `true` will fail if `externalTexture.isZeroCopy` is not true.\n */\nfunction checkNonStandardIsZeroCopyIfAvailable(): { checkNonStandardIsZeroCopy?: true }[] {\n  if (\n    typeof GPUExternalTexture !== 'undefined' &&\n    // eslint-disable-next-line no-prototype-builtins\n    GPUExternalTexture.prototype.hasOwnProperty('isZeroCopy')\n  ) {\n    return [{}, { checkNonStandardIsZeroCopy: true }];\n  } else {\n    return [{}];\n  }\n}\n\ng.test('importExternalTexture,sample')\n  .desc(\n    `\nTests that we can import an HTMLVideoElement/VideoFrame into a GPUExternalTexture, sample from it\nfor several combinations of video format, video color spaces and dst color spaces.\n`\n  )\n  .params(u =>\n    u //\n      .combineWithParams(checkNonStandardIsZeroCopyIfAvailable())\n      .combine('videoName', kVideoNames)\n      .combine('sourceType', ['VideoElement', 'VideoFrame'] as const)\n      .combine('dstColorSpace', kPredefinedColorSpace)\n  )\n  .fn(async t => {\n    const { videoName, sourceType, dstColorSpace } = t.params;\n\n    if (sourceType === 'VideoFrame' && typeof VideoFrame === 'undefined') {\n      t.skip('WebCodec is not supported');\n    }\n\n    const videoElement = getVideoElement(t, videoName);\n\n    await startPlayingAndWaitForVideo(videoElement, async () => {\n      const source =\n        sourceType === 'VideoFrame'\n          ? await getVideoFrameFromVideoElement(t, videoElement)\n          : videoElement;\n\n      const colorAttachment = t.device.createTexture({\n        format: kFormat,\n        size: { width: kWidth, height: kHeight, depthOrArrayLayers: 1 },\n        usage: GPUTextureUsage.COPY_SRC | GPUTextureUsage.RENDER_ATTACHMENT,\n      });\n\n      const pipeline = createExternalTextureSamplingTestPipeline(t);\n      const bindGroup = createExternalTextureSamplingTestBindGroup(\n        t,\n        t.params.checkNonStandardIsZeroCopy,\n        source,\n        pipeline,\n        dstColorSpace\n      );\n\n      const commandEncoder = t.device.createCommandEncoder();\n      const passEncoder = commandEncoder.beginRenderPass({\n        colorAttachments: [\n          {\n            view: colorAttachment.createView(),\n            clearValue: { r: 0.0, g: 0.0, b: 0.0, a: 1.0 },\n            loadOp: 'clear',\n            storeOp: 'store',\n          },\n        ],\n      });\n      passEncoder.setPipeline(pipeline);\n      passEncoder.setBindGroup(0, bindGroup);\n      passEncoder.draw(6);\n      passEncoder.end();\n      t.device.queue.submit([commandEncoder.finish()]);\n\n      const srcColorSpace = kVideoInfo[videoName].colorSpace;\n      const presentColors = kVideoExpectedColors[srcColorSpace][dstColorSpace];\n\n      // visible rect is whole frame, no clipping.\n      const expect = kVideoInfo[videoName].display;\n\n      // For validation, we sample a few pixels away from the edges to avoid compression\n      // artifacts.\n      t.expectSinglePixelComparisonsAreOkInTexture({ texture: colorAttachment }, [\n        // Top-left.\n        {\n          coord: { x: kWidth * 0.25, y: kHeight * 0.25 },\n          exp: convertToUnorm8(presentColors[expect.topLeftColor]),\n        },\n        // Top-right.\n        {\n          coord: { x: kWidth * 0.75, y: kHeight * 0.25 },\n          exp: convertToUnorm8(presentColors[expect.topRightColor]),\n        },\n        // Bottom-left.\n        {\n          coord: { x: kWidth * 0.25, y: kHeight * 0.75 },\n          exp: convertToUnorm8(presentColors[expect.bottomLeftColor]),\n        },\n        // Bottom-right.\n        {\n          coord: { x: kWidth * 0.75, y: kHeight * 0.75 },\n          exp: convertToUnorm8(presentColors[expect.bottomRightColor]),\n        },\n      ]);\n    });\n  });\n\ng.test('importExternalTexture,sampleWithVideoFrameWithVisibleRectParam')\n  .desc(\n    `\nTests that we can import VideoFrames and sample the correct sub-rectangle when visibleRect\nparameters are present.\n`\n  )\n  .params(u =>\n    u //\n      .combineWithParams(checkNonStandardIsZeroCopyIfAvailable())\n      .combine('videoName', kVideoNames)\n      .combine('dstColorSpace', kPredefinedColorSpace)\n  )\n  .fn(async t => {\n    const { videoName, dstColorSpace } = t.params;\n\n    const videoElement = getVideoElement(t, videoName);\n\n    await startPlayingAndWaitForVideo(videoElement, async () => {\n      const source = await getVideoFrameFromVideoElement(t, videoElement);\n\n      // All tested videos are derived from an image showing yellow, red, blue or green in each\n      // quadrant. In this test we crop the video to each quadrant and check that desired color\n      // is sampled from each corner of the cropped image.\n      // visible rect clip applies on raw decoded frame, which defines based on video frame coded size.\n      const srcVideoHeight = source.codedHeight;\n      const srcVideoWidth = source.codedWidth;\n\n      const srcColorSpace = kVideoInfo[videoName].colorSpace;\n      const presentColors = kVideoExpectedColors[srcColorSpace][dstColorSpace];\n\n      // The test crops raw decoded videos first and then apply transform. Expectation should\n      // use coded colors as reference.\n      const expect = kVideoInfo[videoName].coded;\n\n      const cropParams = [\n        // Top left\n        {\n          subRect: { x: 0, y: 0, width: srcVideoWidth / 2, height: srcVideoHeight / 2 },\n          color: convertToUnorm8(presentColors[expect.topLeftColor]),\n        },\n        // Top right\n        {\n          subRect: {\n            x: srcVideoWidth / 2,\n            y: 0,\n            width: srcVideoWidth / 2,\n            height: srcVideoHeight / 2,\n          },\n          color: convertToUnorm8(presentColors[expect.topRightColor]),\n        },\n        // Bottom left\n        {\n          subRect: {\n            x: 0,\n            y: srcVideoHeight / 2,\n            width: srcVideoWidth / 2,\n            height: srcVideoHeight / 2,\n          },\n          color: convertToUnorm8(presentColors[expect.bottomLeftColor]),\n        },\n        // Bottom right\n        {\n          subRect: {\n            x: srcVideoWidth / 2,\n            y: srcVideoHeight / 2,\n            width: srcVideoWidth / 2,\n            height: srcVideoHeight / 2,\n          },\n          color: convertToUnorm8(presentColors[expect.bottomRightColor]),\n        },\n      ];\n\n      for (const cropParam of cropParams) {\n        const subRect = new VideoFrame(source, { visibleRect: cropParam.subRect });\n\n        const colorAttachment = t.device.createTexture({\n          format: kFormat,\n          size: { width: kWidth, height: kHeight, depthOrArrayLayers: 1 },\n          usage: GPUTextureUsage.COPY_SRC | GPUTextureUsage.RENDER_ATTACHMENT,\n        });\n\n        const pipeline = createExternalTextureSamplingTestPipeline(t);\n        const bindGroup = createExternalTextureSamplingTestBindGroup(\n          t,\n          t.params.checkNonStandardIsZeroCopy,\n          subRect,\n          pipeline,\n          dstColorSpace\n        );\n\n        const commandEncoder = t.device.createCommandEncoder();\n        const passEncoder = commandEncoder.beginRenderPass({\n          colorAttachments: [\n            {\n              view: colorAttachment.createView(),\n              clearValue: { r: 0.0, g: 0.0, b: 0.0, a: 1.0 },\n              loadOp: 'clear',\n              storeOp: 'store',\n            },\n          ],\n        });\n        passEncoder.setPipeline(pipeline);\n        passEncoder.setBindGroup(0, bindGroup);\n        passEncoder.draw(6);\n        passEncoder.end();\n        t.device.queue.submit([commandEncoder.finish()]);\n\n        // For validation, we sample a few pixels away from the edges to avoid compression\n        // artifacts.\n        t.expectSinglePixelComparisonsAreOkInTexture({ texture: colorAttachment }, [\n          { coord: { x: kWidth * 0.1, y: kHeight * 0.1 }, exp: cropParam.color },\n          { coord: { x: kWidth * 0.9, y: kHeight * 0.1 }, exp: cropParam.color },\n          { coord: { x: kWidth * 0.1, y: kHeight * 0.9 }, exp: cropParam.color },\n          { coord: { x: kWidth * 0.9, y: kHeight * 0.9 }, exp: cropParam.color },\n        ]);\n\n        subRect.close();\n      }\n\n      source.close();\n    });\n  });\ng.test('importExternalTexture,compute')\n  .desc(\n    `\nTests that we can import an HTMLVideoElement/VideoFrame into a GPUExternalTexture and use it in a\ncompute shader, for several combinations of video format, video color spaces and dst color spaces.\n`\n  )\n  .params(u =>\n    u //\n      .combineWithParams(checkNonStandardIsZeroCopyIfAvailable())\n      .combine('videoName', kVideoNames)\n      .combine('sourceType', ['VideoElement', 'VideoFrame'] as const)\n      .combine('dstColorSpace', kPredefinedColorSpace)\n  )\n  .fn(async t => {\n    const { videoName, sourceType, dstColorSpace } = t.params;\n\n    if (sourceType === 'VideoFrame' && typeof VideoFrame === 'undefined') {\n      t.skip('WebCodec is not supported');\n    }\n\n    const videoElement = getVideoElement(t, videoName);\n\n    await startPlayingAndWaitForVideo(videoElement, async () => {\n      const source =\n        sourceType === 'VideoFrame'\n          ? await getVideoFrameFromVideoElement(t, videoElement)\n          : videoElement;\n      const externalTexture = t.device.importExternalTexture({\n        source,\n        colorSpace: dstColorSpace,\n      });\n      if (t.params.checkNonStandardIsZeroCopy) {\n        expectZeroCopyNonStandard(t, externalTexture);\n      }\n      const outputTexture = t.device.createTexture({\n        format: 'rgba8unorm',\n        size: [2, 2, 1],\n        usage: GPUTextureUsage.COPY_SRC | GPUTextureUsage.STORAGE_BINDING,\n      });\n\n      // Use display size of VideoFrame and video size of HTMLVideoElement as frame size. These sizes are presenting size which\n      // apply transformation in video metadata if any.\n\n      const pipeline = t.device.createComputePipeline({\n        layout: 'auto',\n        compute: {\n          // Shader loads 4 pixels, and then store them in a storage texture.\n          module: t.device.createShaderModule({\n            code: `\n              override frameWidth : i32 = 0;\n              override frameHeight : i32 = 0;\n              @group(0) @binding(0) var t : texture_external;\n              @group(0) @binding(1) var outImage : texture_storage_2d<rgba8unorm, write>;\n\n              @compute @workgroup_size(1) fn main() {\n                let coordTopLeft = vec2<i32>(frameWidth / 4, frameHeight / 4);\n                let coordTopRight = vec2<i32>(frameWidth / 4 * 3, frameHeight / 4);\n                let coordBottomLeft = vec2<i32>(frameWidth / 4, frameHeight / 4 * 3);\n                let coordBottomRight = vec2<i32>(frameWidth / 4 * 3, frameHeight / 4 * 3);\n                var yellow : vec4<f32> = textureLoad(t, coordTopLeft);\n                textureStore(outImage, vec2<i32>(0, 0), yellow);\n                var red : vec4<f32> = textureLoad(t, coordTopRight);\n                textureStore(outImage, vec2<i32>(0, 1), red);\n                var blue : vec4<f32> = textureLoad(t, coordBottomLeft);\n                textureStore(outImage, vec2<i32>(1, 0), blue);\n                var green : vec4<f32> = textureLoad(t, coordBottomRight);\n                textureStore(outImage, vec2<i32>(1, 1), green);\n                return;\n              }\n            `,\n          }),\n          entryPoint: 'main',\n\n          // Use display size of VideoFrame and video size of HTMLVideoElement as frame size. These sizes are presenting size which\n          // apply transformation in video metadata if any.\n          constants: {\n            frameWidth:\n              sourceType === 'VideoFrame'\n                ? (source as VideoFrame).displayWidth\n                : (source as HTMLVideoElement).videoWidth,\n            frameHeight:\n              sourceType === 'VideoFrame'\n                ? (source as VideoFrame).displayHeight\n                : (source as HTMLVideoElement).videoHeight,\n          },\n        },\n      });\n\n      const bg = t.device.createBindGroup({\n        entries: [\n          { binding: 0, resource: externalTexture },\n          { binding: 1, resource: outputTexture.createView() },\n        ],\n        layout: pipeline.getBindGroupLayout(0),\n      });\n\n      const encoder = t.device.createCommandEncoder();\n      const pass = encoder.beginComputePass();\n      pass.setPipeline(pipeline);\n      pass.setBindGroup(0, bg);\n      pass.dispatchWorkgroups(1);\n      pass.end();\n      t.device.queue.submit([encoder.finish()]);\n\n      const srcColorSpace = kVideoInfo[videoName].colorSpace;\n      const presentColors = kVideoExpectedColors[srcColorSpace][dstColorSpace];\n\n      // visible rect is whole frame, no clipping.\n      const expect = kVideoInfo[videoName].display;\n\n      t.expectSinglePixelComparisonsAreOkInTexture({ texture: outputTexture }, [\n        // Top-left.\n        { coord: { x: 0, y: 0 }, exp: convertToUnorm8(presentColors[expect.topLeftColor]) },\n        // Top-right.\n        { coord: { x: 0, y: 1 }, exp: convertToUnorm8(presentColors[expect.topRightColor]) },\n        // Bottom-left.\n        { coord: { x: 1, y: 0 }, exp: convertToUnorm8(presentColors[expect.bottomLeftColor]) },\n        // Bottom-right.\n        { coord: { x: 1, y: 1 }, exp: convertToUnorm8(presentColors[expect.bottomRightColor]) },\n      ]);\n    });\n  });\n"],"mappings":"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"}