{"version":3,"file":"canvas_composite_alpha.html.js","names":["assert","unreachable","runRefTest","run","format","alphaMode","writeCanvasMethod","t","module","device","createShaderModule","code","document","querySelectorAll","forEach","canvas","ctx","getContext","GPUCanvasContext","usage","GPUTextureUsage","RENDER_ATTACHMENT","COPY_DST","configure","kBlendStateSourceOver","color","srcFactor","dstFactor","operation","alpha","pipeline","createRenderPipeline","layout","vertex","entryPoint","fragment","targets","blend","premultiplied","opaque","undefined","primitive","topology","renderTarget","getCurrentTexture","createTexture","size","width","height","COPY_SRC","renderPassDescriptor","colorAttachments","view","createView","clearValue","r","g","b","a","loadOp","storeOp","commandEncoder","createCommandEncoder","passEncoder","beginRenderPass","setPipeline","draw","end","copyTextureToTexture","texture","queue","submit","finish"],"sources":["../../../../src/webgpu/web_platform/reftests/canvas_composite_alpha.html.ts"],"sourcesContent":["import { assert, unreachable } from '../../../common/util/util.js';\n\nimport { runRefTest } from './gpu_ref_test.js';\n\ntype WriteCanvasMethod = 'draw' | 'copy';\n\nexport function run(\n  format: GPUTextureFormat,\n  alphaMode: GPUCanvasAlphaMode,\n  writeCanvasMethod: WriteCanvasMethod\n) {\n  runRefTest(t => {\n    const module = t.device.createShaderModule({\n      code: `\nstruct VertexOutput {\n@builtin(position) Position : vec4<f32>,\n@location(0) fragColor : vec4<f32>,\n}\n\n@vertex\nfn mainVS(@builtin(vertex_index) VertexIndex : u32) -> VertexOutput {\nvar pos = array<vec2<f32>, 6>(\n    vec2<f32>( 0.75,  0.75),\n    vec2<f32>( 0.75, -0.75),\n    vec2<f32>(-0.75, -0.75),\n    vec2<f32>( 0.75,  0.75),\n    vec2<f32>(-0.75, -0.75),\n    vec2<f32>(-0.75,  0.75));\n\nvar offset = array<vec2<f32>, 4>(\nvec2<f32>( -0.25,  0.25),\nvec2<f32>( 0.25, 0.25),\nvec2<f32>(-0.25, -0.25),\nvec2<f32>( 0.25,  -0.25));\n\n// Alpha channel value is set to 0.5 regardless of the canvas alpha mode.\n// For 'opaque' mode, it shouldn't affect the end result, as the alpha channel should always get cleared to 1.0.\nvar color = array<vec4<f32>, 4>(\n    vec4<f32>(0.4, 0.0, 0.0, 0.5),\n    vec4<f32>(0.0, 0.4, 0.0, 0.5),\n    vec4<f32>(0.0, 0.0, 0.4, 0.5),\n    vec4<f32>(0.4, 0.4, 0.0, 0.5)); // 0.4 -> 0x66\n\nvar output : VertexOutput;\noutput.Position = vec4<f32>(pos[VertexIndex % 6u] + offset[VertexIndex / 6u], 0.0, 1.0);\noutput.fragColor = color[VertexIndex / 6u];\nreturn output;\n}\n\n@fragment\nfn mainFS(@location(0) fragColor: vec4<f32>) -> @location(0) vec4<f32> {\nreturn fragColor;\n}\n      `,\n    });\n\n    document.querySelectorAll('canvas').forEach(canvas => {\n      const ctx = canvas.getContext('webgpu');\n      assert(ctx instanceof GPUCanvasContext, 'Failed to get WebGPU context from canvas');\n\n      switch (format) {\n        case 'bgra8unorm':\n        case 'bgra8unorm-srgb':\n        case 'rgba8unorm':\n        case 'rgba8unorm-srgb':\n        case 'rgba16float':\n          break;\n        default:\n          unreachable();\n      }\n\n      let usage = 0;\n      switch (writeCanvasMethod) {\n        case 'draw':\n          usage = GPUTextureUsage.RENDER_ATTACHMENT;\n          break;\n        case 'copy':\n          usage = GPUTextureUsage.COPY_DST;\n          break;\n      }\n      ctx.configure({\n        device: t.device,\n        format,\n        usage,\n        alphaMode,\n      });\n\n      // The blending behavior here is to mimic 2d context blending behavior\n      // of drawing rects in order\n      // https://drafts.fxtf.org/compositing/#porterduffcompositingoperators_srcover\n      const kBlendStateSourceOver = {\n        color: {\n          srcFactor: 'src-alpha',\n          dstFactor: 'one-minus-src-alpha',\n          operation: 'add',\n        },\n        alpha: {\n          srcFactor: 'one',\n          dstFactor: 'one-minus-src-alpha',\n          operation: 'add',\n        },\n      } as const;\n\n      const pipeline = t.device.createRenderPipeline({\n        layout: 'auto',\n        vertex: {\n          module,\n          entryPoint: 'mainVS',\n        },\n        fragment: {\n          module,\n          entryPoint: 'mainFS',\n          targets: [\n            {\n              format,\n              blend: { premultiplied: kBlendStateSourceOver, opaque: undefined }[alphaMode],\n            },\n          ],\n        },\n        primitive: {\n          topology: 'triangle-list',\n        },\n      });\n\n      let renderTarget: GPUTexture;\n      switch (writeCanvasMethod) {\n        case 'draw':\n          renderTarget = ctx.getCurrentTexture();\n          break;\n        case 'copy':\n          // eslint-disable-next-line no-restricted-syntax\n          renderTarget = t.device.createTexture({\n            size: [ctx.canvas.width, ctx.canvas.height],\n            format,\n            usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n          });\n          break;\n      }\n      const renderPassDescriptor: GPURenderPassDescriptor = {\n        colorAttachments: [\n          {\n            view: renderTarget.createView(),\n            clearValue: { r: 0.0, g: 0.0, b: 0.0, a: 0.0 },\n            loadOp: 'clear',\n            storeOp: 'store',\n          },\n        ],\n      };\n\n      const commandEncoder = t.device.createCommandEncoder();\n      const passEncoder = commandEncoder.beginRenderPass(renderPassDescriptor);\n      passEncoder.setPipeline(pipeline);\n      passEncoder.draw(6, 1, 0, 0);\n      passEncoder.draw(6, 1, 6, 0);\n      passEncoder.draw(6, 1, 12, 0);\n      passEncoder.draw(6, 1, 18, 0);\n      passEncoder.end();\n\n      switch (writeCanvasMethod) {\n        case 'draw':\n          break;\n        case 'copy':\n          commandEncoder.copyTextureToTexture(\n            {\n              texture: renderTarget,\n            },\n            {\n              texture: ctx.getCurrentTexture(),\n            },\n            [ctx.canvas.width, ctx.canvas.height]\n          );\n          break;\n      }\n\n      t.device.queue.submit([commandEncoder.finish()]);\n    });\n  });\n}\n"],"mappings":"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"}