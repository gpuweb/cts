{"version":3,"file":"canvas_colorspace.html.js","names":["kUnitCaseParamsBuilder","Float16Array","kCanvasAlphaModes","kCanvasColorSpaces","runRefTest","bgra8UnormFromRgba8Unorm","rgba8Unorm","bgra8Unorm","slice","i","length","rgba16floatFromRgba8unorm","rgba16Float","render","device","canvas","format","alphaMode","colorSpace","textureData","context","getContext","configure","usage","GPUTextureUsage","COPY_DST","RENDER_ATTACHMENT","texture","getCurrentTexture","queue","writeTexture","width","height","runColorSpaceTest","t","kRGBA8UnormData","Uint8Array","kBGRA8UnormData","kRGBA16FloatData","testData","rgba8unorm","bgra8unorm","rgba16float","buffer","createCanvas","creation","document","createElement","body","appendChild","offscreenCanvas","transferControlToOffscreen","source","toString","blob","Blob","type","url","URL","createObjectURL","worker","Worker","resolve","promise","Promise","_resolve","onmessage","event","data","postMessage","u","combine"],"sources":["../../../../src/webgpu/web_platform/reftests/canvas_colorspace.html.ts"],"sourcesContent":["import { kUnitCaseParamsBuilder } from '../../../common/framework/params_builder.js';\nimport { Float16Array } from '../../../external/petamoriken/float16/float16.js';\nimport { kCanvasAlphaModes, kCanvasColorSpaces } from '../../capability_info.js';\n\nimport { runRefTest } from './gpu_ref_test.js';\n\nfunction bgra8UnormFromRgba8Unorm(rgba8Unorm: Uint8Array) {\n  // This is used only once. May need to optimize if reused.\n  const bgra8Unorm = rgba8Unorm.slice();\n  for (let i = 0; i < bgra8Unorm.length; i += 4) {\n    [bgra8Unorm[i], bgra8Unorm[i + 2]] = [bgra8Unorm[i + 2], bgra8Unorm[i]];\n  }\n  return bgra8Unorm;\n}\n\nfunction rgba16floatFromRgba8unorm(rgba8Unorm: Uint8Array) {\n  // This is used only once. May need to optimize if reused.\n  const rgba16Float = new Float16Array(rgba8Unorm.length);\n  for (let i = 0; i < rgba8Unorm.length; ++i) {\n    rgba16Float[i] = rgba8Unorm[i] / 255;\n  }\n  return rgba16Float;\n}\n\ntype Transferable = {\n  canvas: HTMLCanvasElement | OffscreenCanvas;\n  textureData: ArrayBuffer;\n  format: GPUTextureFormat;\n  colorSpace: PredefinedColorSpace;\n  alphaMode: GPUCanvasAlphaMode;\n};\n\nfunction render(\n  device: GPUDevice,\n  { canvas, format, alphaMode, colorSpace, textureData }: Transferable\n) {\n  const context = canvas.getContext('webgpu') as GPUCanvasContext;\n  context.configure({\n    device,\n    format,\n    usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n    alphaMode,\n    colorSpace,\n  });\n\n  const texture = context.getCurrentTexture();\n  device.queue.writeTexture({ texture }, textureData, {}, { width: 4, height: 1 });\n}\n\nexport function runColorSpaceTest(format: GPUTextureFormat) {\n  runRefTest(async t => {\n    // prettier-ignore\n    const kRGBA8UnormData = new Uint8Array([\n      0, 255, 0, 255,\n      117, 251, 7, 255,\n      170, 35, 209, 255,\n      80, 150, 200, 255,\n    ]);\n    const kBGRA8UnormData = bgra8UnormFromRgba8Unorm(kRGBA8UnormData);\n    const kRGBA16FloatData = rgba16floatFromRgba8unorm(kRGBA8UnormData);\n    const width = kRGBA8UnormData.length / 4;\n\n    const testData: { [id: string]: Uint8Array | Float16Array } = {\n      rgba8unorm: kRGBA8UnormData,\n      bgra8unorm: kBGRA8UnormData,\n      rgba16float: kRGBA16FloatData,\n    };\n    const textureData = testData[format].buffer;\n\n    async function createCanvas(\n      creation: string,\n      alphaMode: GPUCanvasAlphaMode,\n      format: GPUTextureFormat,\n      colorSpace: PredefinedColorSpace\n    ) {\n      const canvas = document.createElement('canvas');\n      canvas.width = width;\n      canvas.height = 1;\n      document.body.appendChild(canvas);\n\n      switch (creation) {\n        case 'canvas':\n          render(t.device, { canvas, format, alphaMode, colorSpace, textureData });\n          break;\n\n        case 'transferControlToOffscreen': {\n          const offscreenCanvas = canvas.transferControlToOffscreen();\n          render(t.device, { canvas: offscreenCanvas, format, alphaMode, colorSpace, textureData });\n          break;\n        }\n\n        case 'transferControlToOffscreenWorker': {\n          const offscreenCanvas = canvas.transferControlToOffscreen();\n          const source = `\n          ${render.toString()}\n\n          onmessage = async (event) => {\n            try {\n              const adapter = await navigator.gpu.requestAdapter();\n              const device = await adapter.requestDevice();\n              render(device, event.data);\n              postMessage(true);\n            } catch (e) {\n              postMessage(false);\n            }\n          };\n          `;\n          const blob = new Blob([source], { type: 'application/javascript' });\n          const url = URL.createObjectURL(blob);\n          const worker = new Worker(url);\n          let resolve: (success: boolean) => void;\n          const promise = new Promise(_resolve => (resolve = _resolve));\n          worker.onmessage = event => {\n            resolve(event.data);\n          };\n          worker.postMessage(\n            { canvas: offscreenCanvas, format, alphaMode, colorSpace, textureData },\n            [offscreenCanvas]\n          );\n          await promise;\n          break;\n        }\n      }\n    }\n\n    const u = kUnitCaseParamsBuilder\n      .combine('alphaMode', kCanvasAlphaModes)\n      .combine('colorSpace', kCanvasColorSpaces)\n      .combine('creation', [\n        'canvas',\n        'transferControlToOffscreen',\n        'transferControlToOffscreenWorker',\n      ]);\n\n    for (const { alphaMode, colorSpace, creation } of u) {\n      await createCanvas(creation, alphaMode, format, colorSpace);\n    }\n  });\n}\n"],"mappings":"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"}