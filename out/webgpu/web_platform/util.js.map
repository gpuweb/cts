{"version":3,"file":"util.js","names":["SkipTestCase","getResourcePath","keysOf","timeout","ErrorWithExtra","assert","raceWithRejectOnTimeout","srgbToDisplayP3","convertToUnorm8","expectation","rgba8Unorm","Uint8ClampedArray","Math","round","R","G","B","A","Uint8Array","buffer","kBt601PixelValue","srgb","red","green","blue","yellow","kBt709PixelValue","makeTable","table","Object","fromEntries","entries","map","k","row","kVideoExpectedColors","bt601","bt709","kImageExpectedColors","kVideoInfo","mimeType","colorSpace","coded","topLeftColor","topRightColor","bottomLeftColor","bottomRightColor","display","kVideoNames","kPredefinedColorSpace","startPlayingAndWaitForVideo","video","callback","Promise","resolve","reject","callbackAndResolve","ex","error","message","addEventListener","event","requestVideoFrameCallback","timeWatcher","currentTime","requestAnimationFrame","loop","muted","preload","play","catch","waitForNextTask","promise","callbackHelper","waitForNextFrame","getVideoFrameFromVideoElement","test","skipIf","captureStream","undefined","videoTrack","getVideoTracks","trackProcessor","MediaStreamTrackProcessor","track","transformer","TransformStream","transform","videoFrame","_controller","stop","trackForCleanup","flush","controller","terminate","trackGenerator","MediaStreamTrackGenerator","kind","readable","pipeThrough","pipeTo","writable","getVideoElement","t","videoName","HTMLVideoElement","skip","videoElement","document","createElement","videoInfo","canPlayType","videoUrl","src","timeoutMessage","promiseWithoutTimeout","getStreamFromCamera","videoTrackConstraints","navigator","mediaDevices","getUserMedia","stream","audio","close","getTracks","waitForNonBlankFrame","getSource","cvs","width","height","ctx","getContext","willReadFrequently","foundNonBlankFrame","i","drawImage","pixels","Uint32Array","getImageData","data","some","p","getVideoFrameFromCamera","tracks","length","reader","getReader","result","read","done","value","frame","getVideoElementFromCamera","paused","setAttribute","srcObject","onloadedmetadata","onpause","pause","kFourColorsInfo","kEXIFImageInfo","kImageInfo","kImageNames","kEXIFImageNames","kObjectTypeFromFiles","getSourceFromEXIFImageFile","exifImageName","objectTypeFromFile","imageUrl","globalThis","constructor","name","createImageBitmap","response","fetch","blob","HTMLImageElement","image","Image","decode","loadImageFileAndRun","imageName","onload"],"sources":["../../../src/webgpu/web_platform/util.ts"],"sourcesContent":["import { Fixture, SkipTestCase } from '../../common/framework/fixture.js';\nimport { getResourcePath } from '../../common/framework/resources.js';\nimport { keysOf } from '../../common/util/data_tables.js';\nimport { timeout } from '../../common/util/timeout.js';\nimport { ErrorWithExtra, assert, raceWithRejectOnTimeout } from '../../common/util/util.js';\nimport { GPUTest } from '../gpu_test.js';\nimport { RGBA, srgbToDisplayP3 } from '../util/color_space_conversion.js';\n\ndeclare global {\n  interface HTMLMediaElement {\n    // Add captureStream() support for HTMLMediaElement from\n    // https://w3c.github.io/mediacapture-fromelement/#dom-htmlmediaelement-capturestream\n    captureStream(): MediaStream;\n  }\n}\n\n// MAINTENANCE_TODO: Uses raw floats as expectation in external_texture related cases has some diffs.\n// Remove this conversion utils and uses raw float data as expectation in external_textrue\n// related cases when resolve this.\nexport function convertToUnorm8(expectation: Readonly<RGBA>): Uint8Array {\n  const rgba8Unorm = new Uint8ClampedArray(4);\n  rgba8Unorm[0] = Math.round(expectation.R * 255.0);\n  rgba8Unorm[1] = Math.round(expectation.G * 255.0);\n  rgba8Unorm[2] = Math.round(expectation.B * 255.0);\n  rgba8Unorm[3] = Math.round(expectation.A * 255.0);\n\n  return new Uint8Array(rgba8Unorm.buffer);\n}\n\n// MAINTENANCE_TODO: Add helper function for BT.601 and BT.709 to remove all magic numbers.\n// Expectation values about converting video contents to sRGB color space.\n// Source video color space affects expected values.\n// The process to calculate these expected pixel values can be found:\n// https://github.com/gpuweb/cts/pull/2242#issuecomment-1430382811\n// and https://github.com/gpuweb/cts/pull/2242#issuecomment-1463273434\nconst kBt601PixelValue = {\n  srgb: {\n    red: { R: 0.972945567233341, G: 0.141794376683341, B: -0.0209589916711088, A: 1.0 },\n    green: { R: 0.248234279433399, G: 0.984810378661784, B: -0.0564701319494314, A: 1.0 },\n    blue: { R: 0.10159735826538, G: 0.135451122863674, B: 1.00262982899724, A: 1.0 },\n    yellow: { R: 0.995470750775951, G: 0.992742114518355, B: -0.0701036235167653, A: 1.0 },\n  },\n} as const;\n\nconst kBt709PixelValue = {\n  srgb: {\n    red: { R: 1.0, G: 0.0, B: 0.0, A: 1.0 },\n    green: { R: 0.0, G: 1.0, B: 0.0, A: 1.0 },\n    blue: { R: 0.0, G: 0.0, B: 1.0, A: 1.0 },\n    yellow: { R: 1.0, G: 1.0, B: 0.0, A: 1.0 },\n  },\n} as const;\n\nfunction makeTable<Table extends { readonly [K: string]: {} }>({\n  table,\n}: {\n  table: Table;\n}): {\n  readonly [F in keyof Table]: {\n    readonly [K in keyof Table[F]]: Table[F][K];\n  };\n} {\n  return Object.fromEntries(\n    Object.entries(table).map(([k, row]) => [k, { ...row }])\n    /* eslint-disable-next-line @typescript-eslint/no-explicit-any */\n  ) as any;\n}\n\n// Video expected pixel value table. Finding expected pixel value\n// with video color space and dst color space.\nexport const kVideoExpectedColors = makeTable({\n  table: {\n    bt601: {\n      'display-p3': {\n        yellow: srgbToDisplayP3(kBt601PixelValue.srgb.yellow),\n        red: srgbToDisplayP3(kBt601PixelValue.srgb.red),\n        blue: srgbToDisplayP3(kBt601PixelValue.srgb.blue),\n        green: srgbToDisplayP3(kBt601PixelValue.srgb.green),\n      },\n      srgb: {\n        yellow: kBt601PixelValue.srgb.yellow,\n        red: kBt601PixelValue.srgb.red,\n        blue: kBt601PixelValue.srgb.blue,\n        green: kBt601PixelValue.srgb.green,\n      },\n    },\n    bt709: {\n      'display-p3': {\n        yellow: srgbToDisplayP3(kBt709PixelValue.srgb.yellow),\n        red: srgbToDisplayP3(kBt709PixelValue.srgb.red),\n        blue: srgbToDisplayP3(kBt709PixelValue.srgb.blue),\n        green: srgbToDisplayP3(kBt709PixelValue.srgb.green),\n      },\n      srgb: {\n        yellow: kBt709PixelValue.srgb.yellow,\n        red: kBt709PixelValue.srgb.red,\n        blue: kBt709PixelValue.srgb.blue,\n        green: kBt709PixelValue.srgb.green,\n      },\n    },\n  },\n} as const);\n\nexport const kImageExpectedColors = {\n  srgb: {\n    red: { R: 1.0, G: 0.0, B: 0.0, A: 1.0 },\n    green: { R: 0.0, G: 1.0, B: 0.0, A: 1.0 },\n    blue: { R: 0.0, G: 0.0, B: 1.0, A: 1.0 },\n    yellow: { R: 1.0, G: 1.0, B: 0.0, A: 1.0 },\n  },\n} as const;\n\n// MAINTENANCE_TODO: Add BT.2020 video in table.\n// Video container and codec defines several transform ops to apply to raw decoded frame to display.\n// Our test cases covers 'visible rect' and 'rotation'.\n// 'visible rect' is associated with the\n// video bitstream and should apply to the raw decoded frames before any transformation.\n// 'rotation' is associated with the track or presentation and should transform\n// the whole visible rect (e.g. 90-degree rotate makes visible rect of vertical video to horizontal)\n// The order to apply these transformations is below:\n\n// [raw decoded frame] ----visible rect clipping ---->[visible frame] ---rotation  ---> present\n//      ^                                                                   ^\n//      |                                                                   |\n// coded size                                                           display size\n// The table holds test videos meta infos, including mimeType to check browser compatibility\n// video color space, raw frame content layout and the frame displayed layout.\nexport const kVideoInfo = makeTable({\n  table: {\n    'four-colors-vp8-bt601.webm': {\n      mimeType: 'video/webm; codecs=vp8',\n      colorSpace: 'bt601',\n      coded: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n      display: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n    },\n    'four-colors-h264-bt601.mp4': {\n      mimeType: 'video/mp4; codecs=avc1.4d400c',\n      colorSpace: 'bt601',\n      coded: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n      display: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n    },\n    'four-colors-vp9-bt601.webm': {\n      mimeType: 'video/webm; codecs=vp9',\n      colorSpace: 'bt601',\n      coded: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n      display: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n    },\n    'four-colors-vp9-bt709.webm': {\n      mimeType: 'video/webm; codecs=vp9',\n      colorSpace: 'bt709',\n      coded: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n      display: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n    },\n    // video coded content has been rotate\n    'four-colors-h264-bt601-rotate-90.mp4': {\n      mimeType: 'video/mp4; codecs=avc1.4d400c',\n      colorSpace: 'bt601',\n      coded: {\n        topLeftColor: 'red',\n        topRightColor: 'green',\n        bottomLeftColor: 'yellow',\n        bottomRightColor: 'blue',\n      },\n      display: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n    },\n    'four-colors-h264-bt601-rotate-180.mp4': {\n      mimeType: 'video/mp4; codecs=avc1.4d400c',\n      colorSpace: 'bt601',\n      coded: {\n        topLeftColor: 'green',\n        topRightColor: 'blue',\n        bottomLeftColor: 'red',\n        bottomRightColor: 'yellow',\n      },\n      display: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n    },\n    'four-colors-h264-bt601-rotate-270.mp4': {\n      mimeType: 'video/mp4; codecs=avc1.4d400c',\n      colorSpace: 'bt601',\n      coded: {\n        topLeftColor: 'blue',\n        topRightColor: 'yellow',\n        bottomLeftColor: 'green',\n        bottomRightColor: 'red',\n      },\n      display: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n    },\n    'four-colors-vp9-bt601-rotate-90.mp4': {\n      mimeType: 'video/mp4; codecs=vp09.00.10.08',\n      colorSpace: 'bt601',\n      coded: {\n        topLeftColor: 'red',\n        topRightColor: 'green',\n        bottomLeftColor: 'yellow',\n        bottomRightColor: 'blue',\n      },\n      display: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n    },\n    'four-colors-vp9-bt601-rotate-180.mp4': {\n      mimeType: 'video/mp4; codecs=vp09.00.10.08',\n      colorSpace: 'bt601',\n      coded: {\n        topLeftColor: 'green',\n        topRightColor: 'blue',\n        bottomLeftColor: 'red',\n        bottomRightColor: 'yellow',\n      },\n      display: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n    },\n    'four-colors-vp9-bt601-rotate-270.mp4': {\n      mimeType: 'video/mp4; codecs=vp09.00.10.08',\n      colorSpace: 'bt601',\n      coded: {\n        topLeftColor: 'blue',\n        topRightColor: 'yellow',\n        bottomLeftColor: 'green',\n        bottomRightColor: 'red',\n      },\n      display: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n    },\n    'four-colors-h264-bt601-hflip.mp4': {\n      mimeType: 'video/mp4; codecs=avc1.4d400c',\n      colorSpace: 'bt601',\n      coded: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n      display: {\n        topLeftColor: 'red',\n        topRightColor: 'yellow',\n        bottomLeftColor: 'green',\n        bottomRightColor: 'blue',\n      },\n    },\n    'four-colors-h264-bt601-vflip.mp4': {\n      mimeType: 'video/mp4; codecs=avc1.4d400c',\n      colorSpace: 'bt601',\n      coded: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n      display: {\n        topLeftColor: 'blue',\n        topRightColor: 'green',\n        bottomLeftColor: 'yellow',\n        bottomRightColor: 'red',\n      },\n    },\n    'four-colors-vp9-bt601-hflip.mp4': {\n      mimeType: 'video/mp4; codecs=vp09.00.10.08',\n      colorSpace: 'bt601',\n      coded: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n      display: {\n        topLeftColor: 'red',\n        topRightColor: 'yellow',\n        bottomLeftColor: 'green',\n        bottomRightColor: 'blue',\n      },\n    },\n    'four-colors-vp9-bt601-vflip.mp4': {\n      mimeType: 'video/mp4; codecs=vp09.00.10.08',\n      colorSpace: 'bt601',\n      coded: {\n        topLeftColor: 'yellow',\n        topRightColor: 'red',\n        bottomLeftColor: 'blue',\n        bottomRightColor: 'green',\n      },\n      display: {\n        topLeftColor: 'blue',\n        topRightColor: 'green',\n        bottomLeftColor: 'yellow',\n        bottomRightColor: 'red',\n      },\n    },\n  },\n} as const);\n\ntype VideoName = keyof typeof kVideoInfo;\nexport const kVideoNames: readonly VideoName[] = keysOf(kVideoInfo);\n\nexport const kPredefinedColorSpace = ['display-p3', 'srgb'] as const;\n\n/**\n * Starts playing a video and waits for it to be consumable.\n * Returns a promise which resolves after `callback` (which may be async) completes.\n *\n * @param video An HTML5 Video element.\n * @param callback Function to call when video is ready.\n *\n * Adapted from https://github.com/KhronosGroup/WebGL/blob/main/sdk/tests/js/webgl-test-utils.js\n */\nexport function startPlayingAndWaitForVideo(\n  video: HTMLVideoElement,\n  callback: () => unknown | Promise<unknown>\n): Promise<void> {\n  return raceWithRejectOnTimeout(\n    new Promise((resolve, reject) => {\n      const callbackAndResolve = () =>\n        void (async () => {\n          try {\n            await callback();\n            resolve();\n          } catch (ex) {\n            reject(ex);\n          }\n        })();\n      if (video.error) {\n        reject(\n          new ErrorWithExtra('Video.error: ' + video.error.message, () => ({ error: video.error }))\n        );\n        return;\n      }\n\n      video.addEventListener(\n        'error',\n        event =>\n          reject(\n            new ErrorWithExtra('Video received \"error\" event, message: ' + event.message, () => ({\n              event,\n            }))\n          ),\n        true\n      );\n\n      if (video.requestVideoFrameCallback) {\n        video.requestVideoFrameCallback(() => {\n          callbackAndResolve();\n        });\n      } else {\n        // If requestVideoFrameCallback isn't available, check each frame if the video has advanced.\n        const timeWatcher = () => {\n          if (video.currentTime > 0) {\n            callbackAndResolve();\n          } else {\n            requestAnimationFrame(timeWatcher);\n          }\n        };\n        timeWatcher();\n      }\n\n      video.loop = true;\n      video.muted = true;\n      video.preload = 'auto';\n      video.play().catch(reject);\n    }),\n    2000,\n    'Video never became ready'\n  );\n}\n\n/**\n * Fire a `callback` when the script animation reaches a new frame.\n * Returns a promise which resolves after `callback` (which may be async) completes.\n */\nexport function waitForNextTask(callback: () => unknown | Promise<unknown>): Promise<void> {\n  const { promise, callbackAndResolve } = callbackHelper(callback, 'wait for next task timed out');\n  timeout(() => {\n    callbackAndResolve();\n  }, 0);\n\n  return promise;\n}\n\n/**\n * Fire a `callback` when the video reaches a new frame.\n * Returns a promise which resolves after `callback` (which may be async) completes.\n *\n * MAINTENANCE_TODO: Find a way to implement this for browsers without requestVideoFrameCallback as\n * well, similar to the timeWatcher path in startPlayingAndWaitForVideo. If that path is proven to\n * work well, we can consider getting rid of the requestVideoFrameCallback path.\n */\nexport function waitForNextFrame(\n  video: HTMLVideoElement,\n  callback: () => unknown | Promise<unknown>\n): Promise<void> {\n  const { promise, callbackAndResolve } = callbackHelper(callback, 'waitForNextFrame timed out');\n\n  if ('requestVideoFrameCallback' in video) {\n    video.requestVideoFrameCallback(() => {\n      callbackAndResolve();\n    });\n  } else {\n    throw new SkipTestCase('waitForNextFrame currently requires requestVideoFrameCallback');\n  }\n\n  return promise;\n}\n\nexport async function getVideoFrameFromVideoElement(\n  test: Fixture,\n  video: HTMLVideoElement\n): Promise<VideoFrame> {\n  test.skipIf(video.captureStream === undefined, 'HTMLVideoElement.captureStream is not supported');\n\n  return raceWithRejectOnTimeout(\n    new Promise<VideoFrame>(resolve => {\n      const videoTrack: MediaStreamVideoTrack = video\n        .captureStream()\n        .getVideoTracks()[0] as MediaStreamVideoTrack;\n      const trackProcessor: MediaStreamTrackProcessor<VideoFrame> = new MediaStreamTrackProcessor({\n        track: videoTrack,\n      });\n      const transformer: TransformStream = new TransformStream({\n        transform(videoFrame, _controller) {\n          videoTrack.stop();\n          test.trackForCleanup(videoFrame);\n          resolve(videoFrame);\n        },\n        flush(controller) {\n          controller.terminate();\n        },\n      });\n      const trackGenerator: MediaStreamTrackGenerator<VideoFrame> = new MediaStreamTrackGenerator({\n        kind: 'video',\n      });\n      trackProcessor.readable\n        .pipeThrough(transformer)\n        .pipeTo(trackGenerator.writable)\n        .catch(() => {});\n    }),\n    2000,\n    'Video never became ready'\n  );\n}\n\n/**\n * Create HTMLVideoElement based on VideoName. Check whether video is playable in current\n * browser environment.\n * Returns a HTMLVideoElement.\n *\n * @param t: GPUTest that requires getting HTMLVideoElement\n * @param videoName: Required video name\n *\n */\nexport function getVideoElement(t: GPUTest, videoName: VideoName): HTMLVideoElement {\n  if (typeof HTMLVideoElement === 'undefined') {\n    t.skip('HTMLVideoElement not available');\n  }\n\n  const videoElement = document.createElement('video');\n  const videoInfo = kVideoInfo[videoName];\n\n  if (videoElement.canPlayType(videoInfo.mimeType) === '') {\n    t.skip('Video codec is not supported');\n  }\n\n  const videoUrl = getResourcePath(videoName);\n  videoElement.src = videoUrl;\n\n  t.trackForCleanup(videoElement);\n\n  return videoElement;\n}\n\n/**\n * Helper for doing something inside of a (possibly async) callback (directly, not in a following\n * microtask), and returning a promise when the callback is done.\n * MAINTENANCE_TODO: Use this in startPlayingAndWaitForVideo (and make sure it works).\n */\nfunction callbackHelper(\n  callback: () => unknown | Promise<unknown>,\n  timeoutMessage: string\n): { promise: Promise<void>; callbackAndResolve: () => void } {\n  let callbackAndResolve: () => void;\n\n  const promiseWithoutTimeout = new Promise<void>((resolve, reject) => {\n    callbackAndResolve = () =>\n      void (async () => {\n        try {\n          await callback(); // catches both exceptions and rejections\n          resolve();\n        } catch (ex) {\n          reject(ex);\n        }\n      })();\n  });\n  const promise = raceWithRejectOnTimeout(promiseWithoutTimeout, 2000, timeoutMessage);\n  return { promise, callbackAndResolve: callbackAndResolve! };\n}\n\n/**\n * Get a MediaStream from the default webcam via `getUserMedia()`.\n */\nasync function getStreamFromCamera(\n  test: Fixture,\n  videoTrackConstraints: MediaTrackConstraints | true\n): Promise<MediaStream> {\n  test.skipIf(typeof navigator === 'undefined', 'navigator does not exist in this environment');\n  test.skipIf(\n    typeof navigator.mediaDevices === 'undefined' ||\n      typeof navigator.mediaDevices.getUserMedia === 'undefined',\n    \"Browser doesn't support capture frame from camera.\"\n  );\n\n  const stream = await navigator.mediaDevices.getUserMedia({\n    audio: false,\n    video: videoTrackConstraints,\n  });\n  test.trackForCleanup({\n    close() {\n      for (const track of stream.getTracks()) {\n        track.stop();\n      }\n    },\n  });\n  return stream;\n}\n\n/**\n * Chrome on macOS (at least) takes a while before it switches from blank frames\n * to real frames. Wait up to 50 frames for something to show up on the camera.\n */\nasync function waitForNonBlankFrame({\n  getSource,\n  waitForNextFrame,\n}: {\n  getSource: () => HTMLVideoElement | VideoFrame;\n  waitForNextFrame: () => Promise<void>;\n}) {\n  const cvs = document.createElement('canvas');\n  [cvs.width, cvs.height] = [4, 4];\n  const ctx = cvs.getContext('2d', { willReadFrequently: true })!;\n  let foundNonBlankFrame = false;\n  for (let i = 0; i < 50; ++i) {\n    ctx.drawImage(getSource(), 0, 0, cvs.width, cvs.height);\n    const pixels = new Uint32Array(ctx.getImageData(0, 0, cvs.width, cvs.height).data.buffer);\n    // Look only at RGB, ignore alpha.\n    if (pixels.some(p => (p & 0x00ffffff) !== 0)) {\n      foundNonBlankFrame = true;\n      break;\n    }\n    await waitForNextFrame();\n  }\n  assert(foundNonBlankFrame, 'Failed to get a non-blank video frame');\n}\n\n/**\n * Uses MediaStreamTrackProcessor to capture a VideoFrame from the camera.\n * Skips the test if not supported.\n * @param videoTrackConstraints - MediaTrackConstraints (e.g. width/height) to pass to\n *     `getUserMedia()`, or `true` if none.\n */\nexport async function getVideoFrameFromCamera(\n  test: Fixture,\n  videoTrackConstraints: MediaTrackConstraints | true\n): Promise<VideoFrame> {\n  test.skipIf(\n    typeof MediaStreamTrackProcessor === 'undefined',\n    'MediaStreamTrackProcessor not supported'\n  );\n\n  const stream = await getStreamFromCamera(test, videoTrackConstraints);\n  const tracks = stream.getVideoTracks();\n  assert(tracks.length > 0, 'no tracks found');\n  const track = tracks[0] as MediaStreamVideoTrack;\n\n  const trackProcessor = new MediaStreamTrackProcessor({ track });\n  const reader = trackProcessor.readable.getReader();\n\n  const waitForNextFrame = async () => {\n    const result = await reader.read();\n    assert(!result.done, \"MediaStreamTrackProcessor: Couldn't get valid frame from stream.\");\n    return result.value;\n  };\n  let frame: VideoFrame = await waitForNextFrame();\n  await waitForNonBlankFrame({\n    getSource: () => frame,\n    async waitForNextFrame() {\n      frame.close();\n      frame = await waitForNextFrame();\n    },\n  });\n\n  test.trackForCleanup(frame);\n  return frame;\n}\n\n/**\n * Create an HTMLVideoElement from the camera stream. Skips the test if not supported.\n * @param videoTrackConstraints - MediaTrackConstraints (e.g. width/height) to pass to\n *     `getUserMedia()`, or `true` if none.\n * @param paused - whether the video should be paused before returning.\n */\nexport async function getVideoElementFromCamera(\n  test: Fixture,\n  videoTrackConstraints: MediaTrackConstraints | true,\n  paused: boolean\n): Promise<HTMLVideoElement> {\n  const stream = await getStreamFromCamera(test, videoTrackConstraints);\n\n  // Main thread\n  const video = document.createElement('video');\n  video.loop = false;\n  video.muted = true;\n  video.setAttribute('playsinline', '');\n  video.srcObject = stream;\n  await new Promise(resolve => {\n    video.onloadedmetadata = resolve;\n  });\n  await startPlayingAndWaitForVideo(video, () => {});\n\n  await waitForNonBlankFrame({\n    getSource: () => video,\n    waitForNextFrame: () =>\n      new Promise(resolve =>\n        video.requestVideoFrameCallback(() => {\n          resolve();\n        })\n      ),\n  });\n\n  if (paused) {\n    // Pause the video so we get consistent readbacks.\n    await new Promise(resolve => {\n      video.onpause = resolve;\n      video.pause();\n    });\n  }\n\n  return video;\n}\n\nconst kFourColorsInfo = {\n  display: {\n    topLeftColor: 'yellow',\n    topRightColor: 'red',\n    bottomLeftColor: 'blue',\n    bottomRightColor: 'green',\n  },\n} as const;\n\nexport const kEXIFImageInfo = makeTable({\n  table: {\n    'four-colors.jpg': kFourColorsInfo,\n    'four-colors-rotate-90-cw.jpg': kFourColorsInfo,\n    'four-colors-rotate-180-cw.jpg': kFourColorsInfo,\n    'four-colors-rotate-270-cw.jpg': kFourColorsInfo,\n  },\n} as const);\n\nexport const kImageInfo = makeTable({\n  table: {\n    'four-colors.jpg': kFourColorsInfo,\n    'four-colors.png': kFourColorsInfo,\n    'four-colors.bmp': kFourColorsInfo,\n    'four-colors.webp': kFourColorsInfo,\n    'four-colors.gif': kFourColorsInfo,\n    'four-colors.avif': kFourColorsInfo,\n    'four-colors.ico': kFourColorsInfo,\n    'four-colors.svg': kFourColorsInfo,\n  },\n} as const);\n\ntype ImageName = keyof typeof kImageInfo;\nexport const kImageNames: readonly ImageName[] = keysOf(kImageInfo);\n\ntype EXIFImageName = keyof typeof kEXIFImageInfo;\nexport const kEXIFImageNames: readonly EXIFImageName[] = keysOf(kEXIFImageInfo);\n\ntype ObjectTypeFromFile = (typeof kObjectTypeFromFiles)[number];\nexport const kObjectTypeFromFiles = [\n  'ImageBitmap-from-Blob',\n  'ImageBitmap-from-Image',\n  'Image',\n] as const;\n\n/**\n * Load image file(e.g. *.jpg) from ImageBitmap, blob or HTMLImageElement. And\n * convert the result to valid source that GPUCopyExternalImageSource supported.\n */\nexport async function getSourceFromEXIFImageFile(\n  test: GPUTest,\n  exifImageName: EXIFImageName,\n  objectTypeFromFile: ObjectTypeFromFile\n): Promise<ImageBitmap | HTMLImageElement> {\n  const imageUrl = getResourcePath(exifImageName);\n\n  switch (objectTypeFromFile) {\n    case 'ImageBitmap-from-Blob': {\n      // MAINTENANCE_TODO: resource folder path when using service worker is not correct. Return\n      // the correct path to load resource in correct place.\n      // The wrong path: /out/webgpu/webworker/web_platform/copyToTexture/resources\n      test.skipIf(\n        globalThis.constructor.name === 'ServiceWorkerGlobalScope',\n        'Try to load image resource from serivce worker but the path is not correct.'\n      );\n      test.skipIf(\n        typeof createImageBitmap === 'undefined',\n        'createImageBitmap does not exist in this environment'\n      );\n      // Load image file through fetch.\n      const response = await fetch(imageUrl);\n      return createImageBitmap(await response.blob());\n    }\n    case 'ImageBitmap-from-Image':\n    case 'Image': {\n      // Skip test if HTMLImageElement is not available, e.g. in worker.\n      test.skipIf(\n        typeof HTMLImageElement === 'undefined',\n        'Try to use HTMLImage do image file decoding but HTMLImageElement not available.'\n      );\n\n      // Load image file through HTMLImageElement.\n      const image = new Image();\n      image.src = imageUrl;\n      await raceWithRejectOnTimeout(image.decode(), 5000, 'decode image timeout');\n      if (objectTypeFromFile === 'Image') {\n        return image;\n      }\n\n      return createImageBitmap(image);\n    }\n  }\n}\n\n/**\n * Create HTMLImageElement and load image file and waits for it to be loaded.\n * Returns a promise which resolves after `callback` (which may be async) completes.\n *\n * @param imageName An valid imageName in kkImageInfo table .\n * @param callback Function to call when HTMLImageElement is loaded.\n *\n */\nexport function loadImageFileAndRun(\n  test: GPUTest,\n  imageName: ImageName,\n  callback: (image: HTMLImageElement) => unknown | Promise<unknown>\n): Promise<void> {\n  return raceWithRejectOnTimeout(\n    new Promise((resolve, reject) => {\n      const callbackAndResolve = (image: HTMLImageElement) =>\n        void (async () => {\n          try {\n            await callback(image);\n            resolve();\n          } catch (ex) {\n            reject(ex);\n          }\n        })();\n      // Skip test if HTMLImageElement is not available, e.g. in worker.\n      test.skipIf(\n        typeof HTMLImageElement === 'undefined',\n        'Try to use HTMLImage do image file decoding but HTMLImageElement not available.'\n      );\n      const image = new Image();\n      image.src = getResourcePath(imageName);\n      image.onload = () => {\n        callbackAndResolve(image);\n      };\n    }),\n    2000,\n    'Video never became ready'\n  );\n}\n"],"mappings":"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"}