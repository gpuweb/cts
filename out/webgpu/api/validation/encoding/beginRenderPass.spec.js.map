{"version":3,"file":"beginRenderPass.spec.js","names":["description","makeTestGroup","AllFeaturesMaxLimitsValidationTest","g","test","desc","paramsSubcasesOnly","view0Mismatched","target0Mismatched","view1Mismatched","target1Mismatched","beforeAllSubcases","t","usesMismatchedDevice","fn","params","mismatched","view0Texture","getDeviceMismatchedRenderTexture","getRenderTexture","target0Texture","view1Texture","target1Texture","encoder","createEncoder","pass","beginRenderPass","colorAttachments","view","createView","clearValue","r","b","a","loadOp","storeOp","resolveTarget","end","validateFinish","u","combine","descriptor","size","width","height","depthOrArrayLayers","format","usage","GPUTextureUsage","RENDER_ATTACHMENT","depthStencilTexture","getDeviceMismatchedTexture","createTextureTracked","depthStencilAttachment","depthClearValue","depthLoadOp","depthStoreOp","stencilClearValue","stencilLoadOp","stencilStoreOp","sourceDevice","mismatchedDevice","device","occlusionQuerySet","trackForCleanup","createQuerySet","type","count","skipIfDeviceDoesNotSupportQueryType","timestampQuerySet","timestampWrites","querySet","beginningOfPassWriteIndex","colorTexture"],"sources":["../../../../../src/webgpu/api/validation/encoding/beginRenderPass.spec.ts"],"sourcesContent":["export const description = `\nNote: render pass 'occlusionQuerySet' validation is tested in queries/general.spec.ts\n\nTODO: Check that depth-stencil attachment views must encompass all aspects.\n\nTODO: check for duplication (render_pass/, etc.), plan, and implement.\nNote possibly a lot of this should be operation tests instead.\nNotes:\n> - color attachments {zero, one, multiple}\n>     - many different formats (some are non-renderable)\n>     - is a view on a texture with multiple mip levels or array layers\n>     - two attachments use the same view, or views of {intersecting, disjoint} ranges\n>     - {without, with} resolve target\n>         - resolve format compatibility with multisampled format\n>     - {all possible load ops, load color {in range, negative, too large}}\n>     - all possible store ops\n> - depth/stencil attachment\n>     - {unset, all possible formats}\n>     - {all possible {depth, stencil} load ops, load values {in range, negative, too large}}\n>     - all possible {depth, stencil} store ops\n>     - depthReadOnly {t,f}, stencilReadOnly {t,f}\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { AllFeaturesMaxLimitsValidationTest } from '../validation_test.js';\n\nexport const g = makeTestGroup(AllFeaturesMaxLimitsValidationTest);\n\ng.test('color_attachments,device_mismatch')\n  .desc(\n    `\n    Tests beginRenderPass cannot be called with color attachments whose texture view or resolve target is created from another device\n    The 'view' and 'resolveTarget' are:\n    - created from same device in ColorAttachment0 and ColorAttachment1\n    - created from different device in ColorAttachment0 and ColorAttachment1\n    - created from same device in ColorAttachment0, but from different device in ColorAttachment1\n    `\n  )\n  .paramsSubcasesOnly([\n    {\n      view0Mismatched: false,\n      target0Mismatched: false,\n      view1Mismatched: false,\n      target1Mismatched: false,\n    }, // control case\n    {\n      view0Mismatched: false,\n      target0Mismatched: true,\n      view1Mismatched: false,\n      target1Mismatched: true,\n    },\n    {\n      view0Mismatched: true,\n      target0Mismatched: false,\n      view1Mismatched: true,\n      target1Mismatched: false,\n    },\n    {\n      view0Mismatched: false,\n      target0Mismatched: false,\n      view1Mismatched: false,\n      target1Mismatched: true,\n    },\n  ])\n  .beforeAllSubcases(t => t.usesMismatchedDevice())\n  .fn(t => {\n    const { view0Mismatched, target0Mismatched, view1Mismatched, target1Mismatched } = t.params;\n    const mismatched = view0Mismatched || target0Mismatched || view1Mismatched || target1Mismatched;\n\n    const view0Texture = view0Mismatched\n      ? t.getDeviceMismatchedRenderTexture(4)\n      : t.getRenderTexture(4);\n    const target0Texture = target0Mismatched\n      ? t.getDeviceMismatchedRenderTexture()\n      : t.getRenderTexture();\n    const view1Texture = view1Mismatched\n      ? t.getDeviceMismatchedRenderTexture(4)\n      : t.getRenderTexture(4);\n    const target1Texture = target1Mismatched\n      ? t.getDeviceMismatchedRenderTexture()\n      : t.getRenderTexture();\n\n    const encoder = t.createEncoder('non-pass');\n    const pass = encoder.encoder.beginRenderPass({\n      colorAttachments: [\n        {\n          view: view0Texture.createView(),\n          clearValue: { r: 1.0, g: 0.0, b: 0.0, a: 1.0 },\n          loadOp: 'clear',\n          storeOp: 'store',\n          resolveTarget: target0Texture.createView(),\n        },\n        {\n          view: view1Texture.createView(),\n          clearValue: { r: 1.0, g: 0.0, b: 0.0, a: 1.0 },\n          loadOp: 'clear',\n          storeOp: 'store',\n          resolveTarget: target1Texture.createView(),\n        },\n      ],\n    });\n    pass.end();\n\n    encoder.validateFinish(!mismatched);\n  });\n\ng.test('depth_stencil_attachment,device_mismatch')\n  .desc(\n    'Tests beginRenderPass cannot be called with a depth stencil attachment whose texture view is created from another device'\n  )\n  .paramsSubcasesOnly(u => u.combine('mismatched', [true, false]))\n  .beforeAllSubcases(t => t.usesMismatchedDevice())\n  .fn(t => {\n    const { mismatched } = t.params;\n\n    const descriptor: GPUTextureDescriptor = {\n      size: { width: 4, height: 4, depthOrArrayLayers: 1 },\n      format: 'depth24plus-stencil8',\n      usage: GPUTextureUsage.RENDER_ATTACHMENT,\n    };\n\n    const depthStencilTexture = mismatched\n      ? t.getDeviceMismatchedTexture(descriptor)\n      : t.createTextureTracked(descriptor);\n\n    const encoder = t.createEncoder('non-pass');\n    const pass = encoder.encoder.beginRenderPass({\n      colorAttachments: [],\n      depthStencilAttachment: {\n        view: depthStencilTexture.createView(),\n        depthClearValue: 0,\n        depthLoadOp: 'clear',\n        depthStoreOp: 'store',\n        stencilClearValue: 0,\n        stencilLoadOp: 'clear',\n        stencilStoreOp: 'store',\n      },\n    });\n    pass.end();\n\n    encoder.validateFinish(!mismatched);\n  });\n\ng.test('occlusion_query_set,device_mismatch')\n  .desc(\n    'Tests beginRenderPass cannot be called with an occlusion query set created from another device'\n  )\n  .paramsSubcasesOnly(u => u.combine('mismatched', [true, false]))\n  .beforeAllSubcases(t => t.usesMismatchedDevice())\n  .fn(t => {\n    const { mismatched } = t.params;\n    const sourceDevice = mismatched ? t.mismatchedDevice : t.device;\n\n    const occlusionQuerySet = t.trackForCleanup(\n      sourceDevice.createQuerySet({\n        type: 'occlusion',\n        count: 1,\n      })\n    );\n\n    const encoder = t.createEncoder('render pass', { occlusionQuerySet });\n    encoder.validateFinish(!mismatched);\n  });\n\ng.test('timestamp_query_set,device_mismatch')\n  .desc(\n    `\n  Tests beginRenderPass cannot be called with a timestamp query set created from another device.\n  `\n  )\n  .paramsSubcasesOnly(u => u.combine('mismatched', [true, false]))\n  .beforeAllSubcases(t => t.usesMismatchedDevice())\n  .fn(t => {\n    t.skipIfDeviceDoesNotSupportQueryType('timestamp');\n    const { mismatched } = t.params;\n    const sourceDevice = mismatched ? t.mismatchedDevice : t.device;\n\n    const timestampQuerySet = t.trackForCleanup(\n      sourceDevice.createQuerySet({\n        type: 'timestamp',\n        count: 1,\n      })\n    );\n\n    const timestampWrites = {\n      querySet: timestampQuerySet,\n      beginningOfPassWriteIndex: 0,\n    };\n\n    const colorTexture = t.createTextureTracked({\n      format: 'rgba8unorm',\n      size: { width: 4, height: 4, depthOrArrayLayers: 1 },\n      usage: GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    const encoder = t.createEncoder('non-pass');\n    const pass = encoder.encoder.beginRenderPass({\n      colorAttachments: [\n        {\n          view: colorTexture.createView(),\n          loadOp: 'load',\n          storeOp: 'store',\n        },\n      ],\n      timestampWrites,\n    });\n    pass.end();\n\n    encoder.validateFinish(!mismatched);\n  });\n"],"mappings":"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"}