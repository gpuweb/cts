{"version":3,"file":"clearBuffer.spec.js","names":["description","makeTestGroup","kBufferUsages","kResourceStates","kMaxSafeMultipleOf8","ValidationTest","F","TestClearBuffer","options","buffer","offset","size","isSuccess","commandEncoder","device","createCommandEncoder","clearBuffer","expectValidationError","finish","g","test","desc","params","u","combine","fn","t","bufferState","createBufferWithState","usage","GPUBufferUsage","COPY_DST","cmd","queue","submit","paramsSubcasesOnly","beforeAllSubcases","selectMismatchedDeviceOrSkipTestCase","undefined","mismatched","sourceDevice","mismatchedDevice","trackForCleanup","createBuffer","createBufferTracked","_isSuccess"],"sources":["../../../../../../src/webgpu/api/validation/encoding/cmds/clearBuffer.spec.ts"],"sourcesContent":["export const description = `\nAPI validation tests for clearBuffer.\n`;\n\nimport { makeTestGroup } from '../../../../../common/framework/test_group.js';\nimport { kBufferUsages } from '../../../../capability_info.js';\nimport { kResourceStates } from '../../../../gpu_test.js';\nimport { kMaxSafeMultipleOf8 } from '../../../../util/math.js';\nimport { ValidationTest } from '../../validation_test.js';\n\nclass F extends ValidationTest {\n  TestClearBuffer(options: {\n    buffer: GPUBuffer;\n    offset: number | undefined;\n    size: number | undefined;\n    isSuccess: boolean;\n  }): void {\n    const { buffer, offset, size, isSuccess } = options;\n\n    const commandEncoder = this.device.createCommandEncoder();\n    commandEncoder.clearBuffer(buffer, offset, size);\n\n    this.expectValidationError(() => {\n      commandEncoder.finish();\n    }, !isSuccess);\n  }\n}\n\nexport const g = makeTestGroup(F);\n\ng.test('buffer_state')\n  .desc(`Test that clearing an invalid or destroyed buffer fails.`)\n  .params(u => u.combine('bufferState', kResourceStates))\n  .fn(t => {\n    const { bufferState } = t.params;\n\n    const buffer = t.createBufferWithState(bufferState, {\n      size: 8,\n      usage: GPUBufferUsage.COPY_DST,\n    });\n\n    const commandEncoder = t.device.createCommandEncoder();\n    commandEncoder.clearBuffer(buffer, 0, 8);\n\n    if (bufferState === 'invalid') {\n      t.expectValidationError(() => {\n        commandEncoder.finish();\n      });\n    } else {\n      const cmd = commandEncoder.finish();\n      t.expectValidationError(() => {\n        t.device.queue.submit([cmd]);\n      }, bufferState === 'destroyed');\n    }\n  });\n\ng.test('buffer,device_mismatch')\n  .desc(`Tests clearBuffer cannot be called with buffer created from another device.`)\n  .paramsSubcasesOnly(u => u.combine('mismatched', [true, false]))\n  .beforeAllSubcases(t => {\n    t.selectMismatchedDeviceOrSkipTestCase(undefined);\n  })\n  .fn(t => {\n    const { mismatched } = t.params;\n    const sourceDevice = mismatched ? t.mismatchedDevice : t.device;\n    const size = 8;\n\n    const buffer = t.trackForCleanup(\n      sourceDevice.createBuffer({\n        size,\n        usage: GPUBufferUsage.COPY_DST,\n      })\n    );\n\n    t.TestClearBuffer({\n      buffer,\n      offset: 0,\n      size,\n      isSuccess: !mismatched,\n    });\n  });\n\ng.test('default_args')\n  .desc(`Test that calling clearBuffer with a default offset and size is valid.`)\n  .paramsSubcasesOnly([\n    { offset: undefined, size: undefined },\n    { offset: 4, size: undefined },\n    { offset: undefined, size: 8 },\n  ] as const)\n  .fn(t => {\n    const { offset, size } = t.params;\n\n    const buffer = t.createBufferTracked({\n      size: 16,\n      usage: GPUBufferUsage.COPY_DST,\n    });\n\n    t.TestClearBuffer({\n      buffer,\n      offset,\n      size,\n      isSuccess: true,\n    });\n  });\n\ng.test('buffer_usage')\n  .desc(`Test that only buffers with COPY_DST usage are valid to use with copyBuffers.`)\n  .paramsSubcasesOnly(u =>\n    u //\n      .combine('usage', kBufferUsages)\n  )\n  .fn(t => {\n    const { usage } = t.params;\n\n    const buffer = t.createBufferTracked({\n      size: 16,\n      usage,\n    });\n\n    t.TestClearBuffer({\n      buffer,\n      offset: 0,\n      size: 16,\n      isSuccess: usage === GPUBufferUsage.COPY_DST,\n    });\n  });\n\ng.test('size_alignment')\n  .desc(\n    `\n    Test that the clear size must be 4 byte aligned.\n    - Test size is not a multiple of 4.\n    - Test size is 0.\n    - Test size overflows the buffer size.\n    - Test size is omitted.\n  `\n  )\n  .paramsSubcasesOnly([\n    { size: 0, _isSuccess: true },\n    { size: 2, _isSuccess: false },\n    { size: 4, _isSuccess: true },\n    { size: 5, _isSuccess: false },\n    { size: 8, _isSuccess: true },\n    { size: 20, _isSuccess: false },\n    { size: undefined, _isSuccess: true },\n  ] as const)\n  .fn(t => {\n    const { size, _isSuccess: isSuccess } = t.params;\n\n    const buffer = t.createBufferTracked({\n      size: 16,\n      usage: GPUBufferUsage.COPY_DST,\n    });\n\n    t.TestClearBuffer({\n      buffer,\n      offset: 0,\n      size,\n      isSuccess,\n    });\n  });\n\ng.test('offset_alignment')\n  .desc(\n    `\n    Test that the clear offsets must be 4 byte aligned.\n    - Test offset is not a multiple of 4.\n    - Test offset is larger than the buffer size.\n    - Test offset is omitted.\n  `\n  )\n  .paramsSubcasesOnly([\n    { offset: 0, _isSuccess: true },\n    { offset: 2, _isSuccess: false },\n    { offset: 4, _isSuccess: true },\n    { offset: 5, _isSuccess: false },\n    { offset: 8, _isSuccess: true },\n    { offset: 20, _isSuccess: false },\n    { offset: undefined, _isSuccess: true },\n  ] as const)\n  .fn(t => {\n    const { offset, _isSuccess: isSuccess } = t.params;\n\n    const buffer = t.createBufferTracked({\n      size: 16,\n      usage: GPUBufferUsage.COPY_DST,\n    });\n\n    t.TestClearBuffer({\n      buffer,\n      offset,\n      size: 8,\n      isSuccess,\n    });\n  });\n\ng.test('overflow')\n  .desc(`Test that clears which may cause arithmetic overflows are invalid.`)\n  .paramsSubcasesOnly([\n    { offset: 0, size: kMaxSafeMultipleOf8 },\n    { offset: 16, size: kMaxSafeMultipleOf8 },\n    { offset: kMaxSafeMultipleOf8, size: 16 },\n    { offset: kMaxSafeMultipleOf8, size: kMaxSafeMultipleOf8 },\n  ] as const)\n  .fn(t => {\n    const { offset, size } = t.params;\n\n    const buffer = t.createBufferTracked({\n      size: 16,\n      usage: GPUBufferUsage.COPY_DST,\n    });\n\n    t.TestClearBuffer({\n      buffer,\n      offset,\n      size,\n      isSuccess: false,\n    });\n  });\n\ng.test('out_of_bounds')\n  .desc(`Test that clears which exceed the buffer bounds are invalid.`)\n  .paramsSubcasesOnly([\n    { offset: 0, size: 32, _isSuccess: true },\n    { offset: 0, size: 36 },\n    { offset: 32, size: 0, _isSuccess: true },\n    { offset: 32, size: 4 },\n    { offset: 36, size: 4 },\n    { offset: 36, size: 0 },\n    { offset: 20, size: 16 },\n    { offset: 20, size: 12, _isSuccess: true },\n  ] as const)\n  .fn(t => {\n    const { offset, size, _isSuccess = false } = t.params;\n\n    const buffer = t.createBufferTracked({\n      size: 32,\n      usage: GPUBufferUsage.COPY_DST,\n    });\n\n    t.TestClearBuffer({\n      buffer,\n      offset,\n      size,\n      isSuccess: _isSuccess,\n    });\n  });\n"],"mappings":"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"}