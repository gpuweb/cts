{"version":3,"sources":["../../../../../../../src/webgpu/api/validation/encoding/cmds/render/indirect_draw.spec.ts"],"names":["description","makeTestGroup","GPUConst","kResourceStates","ValidationTest","kRenderEncodeTypeParams","kIndirectDrawTestParams","combine","F","makeIndexBuffer","device","createBuffer","size","usage","GPUBufferUsage","INDEX","g","test","desc","paramsSubcasesOnly","fn","t","encoderType","indexed","state","params","pipeline","createNoOpRenderPipeline","indirectBuffer","createBufferWithState","INDIRECT","encoder","validateFinishAndSubmitGivenState","createEncoder","setPipeline","indexBuffer","setIndexBuffer","drawIndexedIndirect","drawIndirect","mismatched","selectMismatchedDeviceOrSkipTestCase","undefined","mismatchedDevice","trackForCleanup","validateFinish","BufferUsage","COPY_DST","indirectOffset","expandWithParams","p","indirectParamsSize","bufferSize","_valid"],"mappings":"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","sourcesContent":["export const description = `\nValidation tests for drawIndirect/drawIndexedIndirect on render pass and render bundle.\n`;\n\nimport { makeTestGroup } from '../../../../../../common/framework/test_group.js';\nimport { GPUConst } from '../../../../../constants.js';\nimport { kResourceStates } from '../../../../../gpu_test.js';\nimport { ValidationTest } from '../../../validation_test.js';\n\nimport { kRenderEncodeTypeParams } from './render.js';\n\nconst kIndirectDrawTestParams = kRenderEncodeTypeParams.combine('indexed', [true, false] as const);\n\nclass F extends ValidationTest {\n  makeIndexBuffer(): GPUBuffer {\n    return this.device.createBuffer({\n      size: 16,\n      usage: GPUBufferUsage.INDEX,\n    });\n  }\n}\n\nexport const g = makeTestGroup(F);\n\ng.test('indirect_buffer_state')\n  .desc(\n    `\nTests indirect buffer must be valid.\n  `\n  )\n  .paramsSubcasesOnly(kIndirectDrawTestParams.combine('state', kResourceStates))\n  .fn(t => {\n    const { encoderType, indexed, state } = t.params;\n    const pipeline = t.createNoOpRenderPipeline();\n    const indirectBuffer = t.createBufferWithState(state, {\n      size: 256,\n      usage: GPUBufferUsage.INDIRECT,\n    });\n\n    const { encoder, validateFinishAndSubmitGivenState } = t.createEncoder(encoderType);\n    encoder.setPipeline(pipeline);\n    if (indexed) {\n      const indexBuffer = t.makeIndexBuffer();\n      encoder.setIndexBuffer(indexBuffer, 'uint32');\n      encoder.drawIndexedIndirect(indirectBuffer, 0);\n    } else {\n      encoder.drawIndirect(indirectBuffer, 0);\n    }\n\n    validateFinishAndSubmitGivenState(state);\n  });\n\ng.test('indirect_buffer,device_mismatch')\n  .desc(\n    'Tests draw(Indexed)Indirect cannot be called with an indirect buffer created from another device'\n  )\n  .paramsSubcasesOnly(kIndirectDrawTestParams.combine('mismatched', [true, false]))\n  .fn(async t => {\n    const { encoderType, indexed, mismatched } = t.params;\n\n    if (mismatched) {\n      await t.selectMismatchedDeviceOrSkipTestCase(undefined);\n    }\n\n    const device = mismatched ? t.mismatchedDevice : t.device;\n\n    const indirectBuffer = device.createBuffer({\n      size: 256,\n      usage: GPUBufferUsage.INDIRECT,\n    });\n    t.trackForCleanup(indirectBuffer);\n\n    const { encoder, validateFinish } = t.createEncoder(encoderType);\n    encoder.setPipeline(t.createNoOpRenderPipeline());\n\n    if (indexed) {\n      encoder.setIndexBuffer(t.makeIndexBuffer(), 'uint32');\n      encoder.drawIndexedIndirect(indirectBuffer, 0);\n    } else {\n      encoder.drawIndirect(indirectBuffer, 0);\n    }\n    validateFinish(!mismatched);\n  });\n\ng.test('indirect_buffer_usage')\n  .desc(\n    `\nTests indirect buffer must have 'Indirect' usage.\n  `\n  )\n  .paramsSubcasesOnly(\n    kIndirectDrawTestParams.combine('usage', [\n      GPUConst.BufferUsage.INDIRECT, // control case\n      GPUConst.BufferUsage.COPY_DST,\n      GPUConst.BufferUsage.COPY_DST | GPUConst.BufferUsage.INDIRECT,\n    ] as const)\n  )\n  .fn(t => {\n    const { encoderType, indexed, usage } = t.params;\n    const indirectBuffer = t.device.createBuffer({\n      size: 256,\n      usage,\n    });\n\n    const { encoder, validateFinish } = t.createEncoder(encoderType);\n    encoder.setPipeline(t.createNoOpRenderPipeline());\n    if (indexed) {\n      const indexBuffer = t.makeIndexBuffer();\n      encoder.setIndexBuffer(indexBuffer, 'uint32');\n      encoder.drawIndexedIndirect(indirectBuffer, 0);\n    } else {\n      encoder.drawIndirect(indirectBuffer, 0);\n    }\n    validateFinish((usage & GPUBufferUsage.INDIRECT) !== 0);\n  });\n\ng.test('indirect_offset_alignment')\n  .desc(\n    `\nTests indirect offset must be a multiple of 4.\n  `\n  )\n  .paramsSubcasesOnly(kIndirectDrawTestParams.combine('indirectOffset', [0, 2, 4] as const))\n  .fn(t => {\n    const { encoderType, indexed, indirectOffset } = t.params;\n    const pipeline = t.createNoOpRenderPipeline();\n    const indirectBuffer = t.device.createBuffer({\n      size: 256,\n      usage: GPUBufferUsage.INDIRECT,\n    });\n\n    const { encoder, validateFinish } = t.createEncoder(encoderType);\n    encoder.setPipeline(pipeline);\n    if (indexed) {\n      const indexBuffer = t.makeIndexBuffer();\n      encoder.setIndexBuffer(indexBuffer, 'uint32');\n      encoder.drawIndexedIndirect(indirectBuffer, indirectOffset);\n    } else {\n      encoder.drawIndirect(indirectBuffer, indirectOffset);\n    }\n\n    validateFinish(indirectOffset % 4 === 0);\n  });\n\ng.test('indirect_offset_oob')\n  .desc(\n    `\nTests indirect draw calls with various indirect offsets and buffer sizes.\n- (offset, b.size) is\n  - (0, 0)\n  - (0, min size) (control case)\n  - (0, min size + 1) (control case)\n  - (0, min size - 1)\n  - (0, min size - min alignment)\n  - (min alignment, min size + min alignment)\n  - (min alignment, min size + min alignment - 1)\n  - (min alignment / 2, min size + min alignment)\n  - (min alignment +/- 1, min size + min alignment)\n  - (min size, min size)\n  - (min size + min alignment, min size)\n  - min size = indirect draw parameters size\n  - x =(drawIndirect, drawIndexedIndirect)\n  `\n  )\n  .paramsSubcasesOnly(\n    kIndirectDrawTestParams.expandWithParams(p => {\n      const indirectParamsSize = p.indexed ? 20 : 16;\n      return [\n        { indirectOffset: 0, bufferSize: 0, _valid: false },\n        { indirectOffset: 0, bufferSize: indirectParamsSize, _valid: true },\n        { indirectOffset: 0, bufferSize: indirectParamsSize + 1, _valid: true },\n        { indirectOffset: 0, bufferSize: indirectParamsSize - 1, _valid: false },\n        { indirectOffset: 0, bufferSize: indirectParamsSize - 4, _valid: false },\n        { indirectOffset: 4, bufferSize: indirectParamsSize + 4, _valid: true },\n        { indirectOffset: 4, bufferSize: indirectParamsSize + 3, _valid: false },\n        { indirectOffset: 2, bufferSize: indirectParamsSize + 4, _valid: false },\n        { indirectOffset: 3, bufferSize: indirectParamsSize + 4, _valid: false },\n        { indirectOffset: 5, bufferSize: indirectParamsSize + 4, _valid: false },\n        { indirectOffset: indirectParamsSize, bufferSize: indirectParamsSize, _valid: false },\n        { indirectOffset: indirectParamsSize + 4, bufferSize: indirectParamsSize, _valid: false },\n      ] as const;\n    })\n  )\n  .fn(t => {\n    const { encoderType, indexed, indirectOffset, bufferSize, _valid } = t.params;\n    const pipeline = t.createNoOpRenderPipeline();\n    const indirectBuffer = t.device.createBuffer({\n      size: bufferSize,\n      usage: GPUBufferUsage.INDIRECT,\n    });\n\n    const { encoder, validateFinish } = t.createEncoder(encoderType);\n    encoder.setPipeline(pipeline);\n    if (indexed) {\n      const indexBuffer = t.makeIndexBuffer();\n      encoder.setIndexBuffer(indexBuffer, 'uint32');\n      encoder.drawIndexedIndirect(indirectBuffer, indirectOffset);\n    } else {\n      encoder.drawIndirect(indirectBuffer, indirectOffset);\n    }\n\n    validateFinish(_valid);\n  });\n"],"file":"indirect_draw.spec.js"}