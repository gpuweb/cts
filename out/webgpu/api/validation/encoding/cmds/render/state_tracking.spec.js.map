{"version":3,"file":"state_tracking.spec.js","names":["description","makeTestGroup","range","ValidationTest","F","getVertexBuffer","createBufferTracked","size","usage","GPUBufferUsage","VERTEX","createRenderPipeline","bufferCount","device","layout","vertex","module","createShaderModule","code","i","join","entryPoint","buffers","arrayStride","attributes","format","offset","shaderLocation","fragment","targets","primitive","topology","beginRenderPass","commandEncoder","attachmentTexture","createTextureTracked","width","height","depthOrArrayLayers","GPUTextureUsage","RENDER_ATTACHMENT","colorAttachments","view","createView","clearValue","r","g","b","a","loadOp","storeOp","test","desc","unimplemented","fn","t","pipeline1","pipeline2","vertexBuffer1","vertexBuffer2","createCommandEncoder","renderPass","setPipeline","draw","end","expectValidationError","finish","setVertexBuffer"],"sources":["../../../../../../../src/webgpu/api/validation/encoding/cmds/render/state_tracking.spec.ts"],"sourcesContent":["export const description = `\nValidation tests for setVertexBuffer/setIndexBuffer state (not validation). See also operation tests.\n`;\n\nimport { makeTestGroup } from '../../../../../../common/framework/test_group.js';\nimport { range } from '../../../../../../common/util/util.js';\nimport { ValidationTest } from '../../../validation_test.js';\n\nclass F extends ValidationTest {\n  getVertexBuffer(): GPUBuffer {\n    return this.createBufferTracked({\n      size: 256,\n      usage: GPUBufferUsage.VERTEX,\n    });\n  }\n\n  createRenderPipeline(bufferCount: number): GPURenderPipeline {\n    return this.device.createRenderPipeline({\n      layout: 'auto',\n      vertex: {\n        module: this.device.createShaderModule({\n          code: `\n            struct Inputs {\n            ${range(bufferCount, i => `\\n@location(${i}) a_position${i} : vec3<f32>,`).join('')}\n            };\n            @vertex fn main(input : Inputs\n              ) -> @builtin(position) vec4<f32> {\n              return vec4<f32>(0.0, 0.0, 0.0, 1.0);\n            }`,\n        }),\n        entryPoint: 'main',\n        buffers: [\n          {\n            arrayStride: 3 * 4,\n            attributes: range(bufferCount, i => ({\n              format: 'float32x3',\n              offset: 0,\n              shaderLocation: i,\n            })),\n          },\n        ],\n      },\n      fragment: {\n        module: this.device.createShaderModule({\n          code: `\n            @fragment fn main() -> @location(0) vec4<f32> {\n              return vec4<f32>(0.0, 1.0, 0.0, 1.0);\n            }`,\n        }),\n        entryPoint: 'main',\n        targets: [{ format: 'rgba8unorm' }],\n      },\n      primitive: { topology: 'triangle-list' },\n    });\n  }\n\n  beginRenderPass(commandEncoder: GPUCommandEncoder): GPURenderPassEncoder {\n    const attachmentTexture = this.createTextureTracked({\n      format: 'rgba8unorm',\n      size: { width: 16, height: 16, depthOrArrayLayers: 1 },\n      usage: GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    return commandEncoder.beginRenderPass({\n      colorAttachments: [\n        {\n          view: attachmentTexture.createView(),\n          clearValue: { r: 1.0, g: 0.0, b: 0.0, a: 1.0 },\n          loadOp: 'clear',\n          storeOp: 'store',\n        },\n      ],\n    });\n  }\n}\n\nexport const g = makeTestGroup(F);\n\ng.test(`all_needed_vertex_buffer_should_be_bound`)\n  .desc(\n    `\nIn this test we test that any missing vertex buffer for a used slot will cause validation errors when drawing.\n- All (non/indexed, in/direct) draw commands\n    - A needed vertex buffer is not bound\n        - Was bound in another render pass but not the current one\n`\n  )\n  .unimplemented();\n\ng.test(`all_needed_index_buffer_should_be_bound`)\n  .desc(\n    `\nIn this test we test that missing index buffer for a used slot will cause validation errors when drawing.\n- All indexed in/direct draw commands\n    - No index buffer is bound\n`\n  )\n  .unimplemented();\n\ng.test('vertex_buffers_inherit_from_previous_pipeline').fn(t => {\n  const pipeline1 = t.createRenderPipeline(1);\n  const pipeline2 = t.createRenderPipeline(2);\n\n  const vertexBuffer1 = t.getVertexBuffer();\n  const vertexBuffer2 = t.getVertexBuffer();\n\n  {\n    // Check failure when vertex buffer is not set\n    const commandEncoder = t.device.createCommandEncoder();\n    const renderPass = t.beginRenderPass(commandEncoder);\n    renderPass.setPipeline(pipeline1);\n    renderPass.draw(3);\n    renderPass.end();\n\n    t.expectValidationError(() => {\n      commandEncoder.finish();\n    });\n  }\n  {\n    // Check success when vertex buffer is inherited from previous pipeline\n    const commandEncoder = t.device.createCommandEncoder();\n    const renderPass = t.beginRenderPass(commandEncoder);\n    renderPass.setPipeline(pipeline2);\n    renderPass.setVertexBuffer(0, vertexBuffer1);\n    renderPass.setVertexBuffer(1, vertexBuffer2);\n    renderPass.draw(3);\n    renderPass.setPipeline(pipeline1);\n    renderPass.draw(3);\n    renderPass.end();\n\n    commandEncoder.finish();\n  }\n});\n\ng.test('vertex_buffers_do_not_inherit_between_render_passes').fn(t => {\n  const pipeline1 = t.createRenderPipeline(1);\n  const pipeline2 = t.createRenderPipeline(2);\n\n  const vertexBuffer1 = t.getVertexBuffer();\n  const vertexBuffer2 = t.getVertexBuffer();\n\n  {\n    // Check success when vertex buffer is set for each render pass\n    const commandEncoder = t.device.createCommandEncoder();\n    {\n      const renderPass = t.beginRenderPass(commandEncoder);\n      renderPass.setPipeline(pipeline2);\n      renderPass.setVertexBuffer(0, vertexBuffer1);\n      renderPass.setVertexBuffer(1, vertexBuffer2);\n      renderPass.draw(3);\n      renderPass.end();\n    }\n    {\n      const renderPass = t.beginRenderPass(commandEncoder);\n      renderPass.setPipeline(pipeline1);\n      renderPass.setVertexBuffer(0, vertexBuffer1);\n      renderPass.draw(3);\n      renderPass.end();\n    }\n    commandEncoder.finish();\n  }\n  {\n    // Check failure because vertex buffer is not inherited in second subpass\n    const commandEncoder = t.device.createCommandEncoder();\n    {\n      const renderPass = t.beginRenderPass(commandEncoder);\n      renderPass.setPipeline(pipeline2);\n      renderPass.setVertexBuffer(0, vertexBuffer1);\n      renderPass.setVertexBuffer(1, vertexBuffer2);\n      renderPass.draw(3);\n      renderPass.end();\n    }\n    {\n      const renderPass = t.beginRenderPass(commandEncoder);\n      renderPass.setPipeline(pipeline1);\n      renderPass.draw(3);\n      renderPass.end();\n    }\n\n    t.expectValidationError(() => {\n      commandEncoder.finish();\n    });\n  }\n});\n"],"mappings":"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"}