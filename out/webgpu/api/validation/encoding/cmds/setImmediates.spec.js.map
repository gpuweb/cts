{"version":3,"file":"setImmediates.spec.js","names":["description","makeTestGroup","getGPU","kTypedArrayBufferViews","kTypedArrayBufferViewKeys","AllFeaturesMaxLimitsGPUTest","kProgrammableEncoderTypes","SetImmediatesTest","init","GPURenderPassEncoder","prototype","GPUComputePassEncoder","GPURenderBundleEncoder","GPUSupportedLimits","rec","wgslLanguageFeatures","has","skip","g","test","desc","params","u","combine","filter","p","arrayType","combineWithParams","rangeOffset","contentByteSize","arrayConstructor","BYTES_PER_ELEMENT","fn","t","encoderType","arrayBufferType","elementSize","elementCount","isRangeOffsetAligned","isContentSizeAligned","encoder","validateFinish","createEncoder","data","shouldThrow","setImmediates","dataOffset","_expectedError","doSetImmediates","rangeOffsetDelta","dataLengthDelta","maxImmediateSize","device","limits","undefined","dataLength","rangeOverLimit","dataOverLimit"],"sources":["../../../../../../src/webgpu/api/validation/encoding/cmds/setImmediates.spec.ts"],"sourcesContent":["export const description = `\nsetImmediates validation tests.\nTODO(#4297): enable Float16Array\n`;\n\nimport { makeTestGroup } from '../../../../../common/framework/test_group.js';\nimport { getGPU } from '../../../../../common/util/navigator_gpu.js';\nimport {\n  kTypedArrayBufferViews,\n  kTypedArrayBufferViewKeys,\n} from '../../../../../common/util/util.js';\nimport { AllFeaturesMaxLimitsGPUTest } from '../../../../gpu_test.js';\nimport { kProgrammableEncoderTypes } from '../../../../util/command_buffer_maker.js';\n\nclass SetImmediatesTest extends AllFeaturesMaxLimitsGPUTest {\n  override async init() {\n    await super.init();\n    if (\n      !('setImmediates' in GPURenderPassEncoder.prototype) &&\n      !('setImmediates' in GPUComputePassEncoder.prototype) &&\n      !('setImmediates' in GPURenderBundleEncoder.prototype) &&\n      !('maxImmediateSize' in GPUSupportedLimits.prototype) &&\n      !getGPU(this.rec).wgslLanguageFeatures.has('immediate_address_space')\n    ) {\n      this.skip('setImmediates not supported');\n    }\n  }\n}\n\nexport const g = makeTestGroup(SetImmediatesTest);\n\ng.test('alignment')\n  .desc('Tests that rangeOffset and contentSize must align to 4 bytes.')\n  .params(u =>\n    u //\n      .combine('encoderType', kProgrammableEncoderTypes)\n      .combine('arrayType', kTypedArrayBufferViewKeys)\n      .filter(p => p.arrayType !== 'Float16Array')\n      .combineWithParams([\n        // control case: rangeOffset 4 is aligned. contentByteSize 8 is aligned.\n        { rangeOffset: 4, contentByteSize: 8 },\n        // rangeOffset 6 is unaligned (6 % 4 !== 0).\n        { rangeOffset: 6, contentByteSize: 8 },\n        // contentByteSize 10 is unaligned (10 % 4 !== 0).\n        // Note: This case will be skipped for types with element size > 2 (e.g. Uint32, Uint64)\n        // because they cannot form a 10-byte array.\n        { rangeOffset: 4, contentByteSize: 10 },\n      ])\n      .filter(({ arrayType, contentByteSize }) => {\n        // Skip if the contentByteSize is not a multiple of the element size.\n        // For example, we can't have 10 bytes if the element size is 4 or 8 bytes.\n        const arrayConstructor = kTypedArrayBufferViews[arrayType];\n        return contentByteSize % arrayConstructor.BYTES_PER_ELEMENT === 0;\n      })\n  )\n  .fn(t => {\n    const { encoderType, arrayType, rangeOffset, contentByteSize } = t.params;\n    const arrayBufferType = kTypedArrayBufferViews[arrayType];\n    const elementSize = arrayBufferType.BYTES_PER_ELEMENT;\n    const elementCount = contentByteSize / elementSize;\n\n    const isRangeOffsetAligned = rangeOffset % 4 === 0;\n    const isContentSizeAligned = contentByteSize % 4 === 0;\n\n    const { encoder, validateFinish } = t.createEncoder(encoderType);\n    const data = new arrayBufferType(elementCount);\n\n    t.shouldThrow(isContentSizeAligned ? false : 'RangeError', () => {\n      // Cast to any to avoid Float16Array issues\n      // MAINTENANCE_TODO: remove this cast when the types are updated.\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      (encoder as any).setImmediates(rangeOffset, data as any, 0, elementCount);\n    });\n\n    validateFinish(isRangeOffsetAligned);\n  });\n\ng.test('overflow')\n  .desc(\n    `\n    Tests that rangeOffset + contentSize or dataOffset + size is handled correctly if it exceeds limits.\n    `\n  )\n  .params(u =>\n    u //\n      .combine('encoderType', kProgrammableEncoderTypes)\n      .combine('arrayType', kTypedArrayBufferViewKeys)\n      .filter(p => p.arrayType !== 'Float16Array')\n      .combineWithParams([\n        // control case\n        { rangeOffset: 0, dataOffset: 0, elementCount: 4, _expectedError: null },\n        // elementCount 0\n        { rangeOffset: 0, dataOffset: 0, elementCount: 0, _expectedError: null },\n        // rangeOffset + contentSize overflows\n        {\n          rangeOffset: 2 ** 31 - 8,\n          dataOffset: 0,\n          elementCount: 4,\n          _expectedError: 'validation',\n        },\n        {\n          rangeOffset: 2 ** 32 - 8,\n          dataOffset: 0,\n          elementCount: 4,\n          _expectedError: 'validation',\n        },\n        // dataOffset + size overflows\n        {\n          rangeOffset: 0,\n          dataOffset: 2 ** 31 - 1,\n          elementCount: 4,\n          _expectedError: 'RangeError',\n        },\n        {\n          rangeOffset: 0,\n          dataOffset: 2 ** 32 - 1,\n          elementCount: 4,\n          _expectedError: 'RangeError',\n        },\n      ])\n  )\n  .fn(t => {\n    const { encoderType, arrayType, rangeOffset, dataOffset, elementCount, _expectedError } =\n      t.params;\n    const arrayBufferType = kTypedArrayBufferViews[arrayType];\n\n    const { encoder, validateFinish } = t.createEncoder(encoderType);\n    const data = new arrayBufferType(elementCount);\n\n    const doSetImmediates = () => {\n      // Cast to any to avoid Float16Array issues\n      // MAINTENANCE_TODO: remove this cast when the types are updated.\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      (encoder as any).setImmediates(rangeOffset, data as any, dataOffset, elementCount);\n    };\n\n    if (_expectedError === 'RangeError') {\n      t.shouldThrow('RangeError', doSetImmediates);\n    } else {\n      doSetImmediates();\n      validateFinish(_expectedError === null);\n    }\n  });\n\ng.test('out_of_bounds')\n  .desc(\n    `\n    Tests that rangeOffset + contentSize is greater than maxImmediateSize (Validation Error)\n    and contentSize is larger than data size (RangeError).\n    `\n  )\n  .params(u =>\n    u //\n      .combine('encoderType', kProgrammableEncoderTypes)\n      .combine('arrayType', kTypedArrayBufferViewKeys)\n      .filter(p => p.arrayType !== 'Float16Array')\n      .combineWithParams([\n        // control case\n        { rangeOffsetDelta: 0, dataLengthDelta: 0 },\n        // rangeOffset + contentSize > maxImmediateSize\n        { rangeOffsetDelta: 4, dataLengthDelta: 0 },\n        // dataOffset + size > data.length\n        { rangeOffsetDelta: 0, dataLengthDelta: -1 },\n      ])\n  )\n  .fn(t => {\n    const { encoderType, arrayType, rangeOffsetDelta, dataLengthDelta } = t.params;\n    const arrayBufferType = kTypedArrayBufferViews[arrayType];\n    const elementSize = arrayBufferType.BYTES_PER_ELEMENT;\n\n    // MAINTENANCE_TODO: remove this cast when the types are updated.\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const maxImmediateSize = (t.device.limits as any).maxImmediateSize;\n    if (maxImmediateSize === undefined) {\n      t.skip('maxImmediateSize not found');\n    }\n\n    // We want contentByteSize to be aligned to 4 bytes to avoid alignment errors.\n    // We use 8 bytes to cover all types including BigUint64 (8 bytes).\n    const elementCount = elementSize >= 8 ? 1 : 8 / elementSize;\n    const contentByteSize = elementCount * elementSize;\n\n    const rangeOffset = maxImmediateSize - contentByteSize + rangeOffsetDelta;\n    const dataLength = elementCount + dataLengthDelta;\n\n    const data = new arrayBufferType(dataLength);\n\n    const { encoder, validateFinish } = t.createEncoder(encoderType);\n\n    const rangeOverLimit = rangeOffset + contentByteSize > maxImmediateSize;\n    const dataOverLimit = elementCount > dataLength;\n\n    t.shouldThrow(dataOverLimit ? 'RangeError' : false, () => {\n      // MAINTENANCE_TODO: remove this cast when the types are updated.\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      (encoder as any).setImmediates(rangeOffset, data as any, 0, elementCount);\n    });\n\n    if (!dataOverLimit) {\n      validateFinish(!rangeOverLimit);\n    }\n  });\n"],"mappings":";;GAAA,OAAO,MAAMA,WAAW,GAAI;AAC5B;AACA;AACA,CAAC,CAED,SAASC,aAAa,QAAQ,+CAA+C;AAC7E,SAASC,MAAM,QAAQ,6CAA6C;AACpE;EACEC,sBAAsB;EACtBC,yBAAyB;AACpB,oCAAoC;AAC3C,SAASC,2BAA2B,QAAQ,yBAAyB;AACrE,SAASC,yBAAyB,QAAQ,0CAA0C;;AAEpF,MAAMC,iBAAiB,SAASF,2BAA2B,CAAC;EAC1D,MAAeG,IAAIA,CAAA,EAAG;IACpB,MAAM,KAAK,CAACA,IAAI,CAAC,CAAC;IAClB;IACE,EAAE,eAAe,IAAIC,oBAAoB,CAACC,SAAS,CAAC;IACpD,EAAE,eAAe,IAAIC,qBAAqB,CAACD,SAAS,CAAC;IACrD,EAAE,eAAe,IAAIE,sBAAsB,CAACF,SAAS,CAAC;IACtD,EAAE,kBAAkB,IAAIG,kBAAkB,CAACH,SAAS,CAAC;IACrD,CAACR,MAAM,CAAC,IAAI,CAACY,GAAG,CAAC,CAACC,oBAAoB,CAACC,GAAG,CAAC,yBAAyB,CAAC;IACrE;MACA,IAAI,CAACC,IAAI,CAAC,6BAA6B,CAAC;IAC1C;EACF;AACF;;AAEA,OAAO,MAAMC,CAAC,GAAGjB,aAAa,CAACM,iBAAiB,CAAC;;AAEjDW,CAAC,CAACC,IAAI,CAAC,WAAW,CAAC;AAChBC,IAAI,CAAC,+DAA+D,CAAC;AACrEC,MAAM,CAAC,CAAAC,CAAC;AACPA,CAAC,CAAC;AAAA,CACCC,OAAO,CAAC,aAAa,EAAEjB,yBAAyB,CAAC;AACjDiB,OAAO,CAAC,WAAW,EAAEnB,yBAAyB,CAAC;AAC/CoB,MAAM,CAAC,CAAAC,CAAC,KAAIA,CAAC,CAACC,SAAS,KAAK,cAAc,CAAC;AAC3CC,iBAAiB,CAAC;AACjB;AACA,EAAEC,WAAW,EAAE,CAAC,EAAEC,eAAe,EAAE,CAAC,CAAC,CAAC;AACtC;AACA,EAAED,WAAW,EAAE,CAAC,EAAEC,eAAe,EAAE,CAAC,CAAC,CAAC;AACtC;AACA;AACA;AACA,EAAED,WAAW,EAAE,CAAC,EAAEC,eAAe,EAAE,EAAE,CAAC,CAAC;AACxC,CAAC;AACDL,MAAM,CAAC,CAAC,EAAEE,SAAS,EAAEG,eAAe,CAAC,CAAC,KAAK;EAC1C;EACA;EACA,MAAMC,gBAAgB,GAAG3B,sBAAsB,CAACuB,SAAS,CAAC;EAC1D,OAAOG,eAAe,GAAGC,gBAAgB,CAACC,iBAAiB,KAAK,CAAC;AACnE,CAAC;AACL,CAAC;AACAC,EAAE,CAAC,CAAAC,CAAC,KAAI;EACP,MAAM,EAAEC,WAAW,EAAER,SAAS,EAAEE,WAAW,EAAEC,eAAe,CAAC,CAAC,GAAGI,CAAC,CAACZ,MAAM;EACzE,MAAMc,eAAe,GAAGhC,sBAAsB,CAACuB,SAAS,CAAC;EACzD,MAAMU,WAAW,GAAGD,eAAe,CAACJ,iBAAiB;EACrD,MAAMM,YAAY,GAAGR,eAAe,GAAGO,WAAW;;EAElD,MAAME,oBAAoB,GAAGV,WAAW,GAAG,CAAC,KAAK,CAAC;EAClD,MAAMW,oBAAoB,GAAGV,eAAe,GAAG,CAAC,KAAK,CAAC;;EAEtD,MAAM,EAAEW,OAAO,EAAEC,cAAc,CAAC,CAAC,GAAGR,CAAC,CAACS,aAAa,CAACR,WAAW,CAAC;EAChE,MAAMS,IAAI,GAAG,IAAIR,eAAe,CAACE,YAAY,CAAC;;EAE9CJ,CAAC,CAACW,WAAW,CAACL,oBAAoB,GAAG,KAAK,GAAG,YAAY,EAAE,MAAM;IAC/D;IACA;;IAECC,OAAO,CAASK,aAAa,CAACjB,WAAW,EAAEe,IAAI,EAAS,CAAC,EAAEN,YAAY,CAAC;EAC3E,CAAC,CAAC;;EAEFI,cAAc,CAACH,oBAAoB,CAAC;AACtC,CAAC,CAAC;;AAEJpB,CAAC,CAACC,IAAI,CAAC,UAAU,CAAC;AACfC,IAAI;EACF;AACL;AACA;AACE,CAAC;AACAC,MAAM,CAAC,CAAAC,CAAC;AACPA,CAAC,CAAC;AAAA,CACCC,OAAO,CAAC,aAAa,EAAEjB,yBAAyB,CAAC;AACjDiB,OAAO,CAAC,WAAW,EAAEnB,yBAAyB,CAAC;AAC/CoB,MAAM,CAAC,CAAAC,CAAC,KAAIA,CAAC,CAACC,SAAS,KAAK,cAAc,CAAC;AAC3CC,iBAAiB,CAAC;AACjB;AACA,EAAEC,WAAW,EAAE,CAAC,EAAEkB,UAAU,EAAE,CAAC,EAAET,YAAY,EAAE,CAAC,EAAEU,cAAc,EAAE,IAAI,CAAC,CAAC;AACxE;AACA,EAAEnB,WAAW,EAAE,CAAC,EAAEkB,UAAU,EAAE,CAAC,EAAET,YAAY,EAAE,CAAC,EAAEU,cAAc,EAAE,IAAI,CAAC,CAAC;AACxE;AACA;EACEnB,WAAW,EAAE,CAAC,IAAI,EAAE,GAAG,CAAC;EACxBkB,UAAU,EAAE,CAAC;EACbT,YAAY,EAAE,CAAC;EACfU,cAAc,EAAE;AAClB,CAAC;AACD;EACEnB,WAAW,EAAE,CAAC,IAAI,EAAE,GAAG,CAAC;EACxBkB,UAAU,EAAE,CAAC;EACbT,YAAY,EAAE,CAAC;EACfU,cAAc,EAAE;AAClB,CAAC;AACD;AACA;EACEnB,WAAW,EAAE,CAAC;EACdkB,UAAU,EAAE,CAAC,IAAI,EAAE,GAAG,CAAC;EACvBT,YAAY,EAAE,CAAC;EACfU,cAAc,EAAE;AAClB,CAAC;AACD;EACEnB,WAAW,EAAE,CAAC;EACdkB,UAAU,EAAE,CAAC,IAAI,EAAE,GAAG,CAAC;EACvBT,YAAY,EAAE,CAAC;EACfU,cAAc,EAAE;AAClB,CAAC;AACF;AACL,CAAC;AACAf,EAAE,CAAC,CAAAC,CAAC,KAAI;EACP,MAAM,EAAEC,WAAW,EAAER,SAAS,EAAEE,WAAW,EAAEkB,UAAU,EAAET,YAAY,EAAEU,cAAc,CAAC,CAAC;EACrFd,CAAC,CAACZ,MAAM;EACV,MAAMc,eAAe,GAAGhC,sBAAsB,CAACuB,SAAS,CAAC;;EAEzD,MAAM,EAAEc,OAAO,EAAEC,cAAc,CAAC,CAAC,GAAGR,CAAC,CAACS,aAAa,CAACR,WAAW,CAAC;EAChE,MAAMS,IAAI,GAAG,IAAIR,eAAe,CAACE,YAAY,CAAC;;EAE9C,MAAMW,eAAe,GAAGA,CAAA,KAAM;IAC5B;IACA;;IAECR,OAAO,CAASK,aAAa,CAACjB,WAAW,EAAEe,IAAI,EAASG,UAAU,EAAET,YAAY,CAAC;EACpF,CAAC;;EAED,IAAIU,cAAc,KAAK,YAAY,EAAE;IACnCd,CAAC,CAACW,WAAW,CAAC,YAAY,EAAEI,eAAe,CAAC;EAC9C,CAAC,MAAM;IACLA,eAAe,CAAC,CAAC;IACjBP,cAAc,CAACM,cAAc,KAAK,IAAI,CAAC;EACzC;AACF,CAAC,CAAC;;AAEJ7B,CAAC,CAACC,IAAI,CAAC,eAAe,CAAC;AACpBC,IAAI;EACF;AACL;AACA;AACA;AACE,CAAC;AACAC,MAAM,CAAC,CAAAC,CAAC;AACPA,CAAC,CAAC;AAAA,CACCC,OAAO,CAAC,aAAa,EAAEjB,yBAAyB,CAAC;AACjDiB,OAAO,CAAC,WAAW,EAAEnB,yBAAyB,CAAC;AAC/CoB,MAAM,CAAC,CAAAC,CAAC,KAAIA,CAAC,CAACC,SAAS,KAAK,cAAc,CAAC;AAC3CC,iBAAiB,CAAC;AACjB;AACA,EAAEsB,gBAAgB,EAAE,CAAC,EAAEC,eAAe,EAAE,CAAC,CAAC,CAAC;AAC3C;AACA,EAAED,gBAAgB,EAAE,CAAC,EAAEC,eAAe,EAAE,CAAC,CAAC,CAAC;AAC3C;AACA,EAAED,gBAAgB,EAAE,CAAC,EAAEC,eAAe,EAAE,CAAC,CAAC,CAAC,CAAC;AAC7C;AACL,CAAC;AACAlB,EAAE,CAAC,CAAAC,CAAC,KAAI;EACP,MAAM,EAAEC,WAAW,EAAER,SAAS,EAAEuB,gBAAgB,EAAEC,eAAe,CAAC,CAAC,GAAGjB,CAAC,CAACZ,MAAM;EAC9E,MAAMc,eAAe,GAAGhC,sBAAsB,CAACuB,SAAS,CAAC;EACzD,MAAMU,WAAW,GAAGD,eAAe,CAACJ,iBAAiB;;EAErD;;EAEA,MAAMoB,gBAAgB,GAAIlB,CAAC,CAACmB,MAAM,CAACC,MAAM,CAASF,gBAAgB;EAClE,IAAIA,gBAAgB,KAAKG,SAAS,EAAE;IAClCrB,CAAC,CAAChB,IAAI,CAAC,4BAA4B,CAAC;EACtC;;EAEA;EACA;EACA,MAAMoB,YAAY,GAAGD,WAAW,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,GAAGA,WAAW;EAC3D,MAAMP,eAAe,GAAGQ,YAAY,GAAGD,WAAW;;EAElD,MAAMR,WAAW,GAAGuB,gBAAgB,GAAGtB,eAAe,GAAGoB,gBAAgB;EACzE,MAAMM,UAAU,GAAGlB,YAAY,GAAGa,eAAe;;EAEjD,MAAMP,IAAI,GAAG,IAAIR,eAAe,CAACoB,UAAU,CAAC;;EAE5C,MAAM,EAAEf,OAAO,EAAEC,cAAc,CAAC,CAAC,GAAGR,CAAC,CAACS,aAAa,CAACR,WAAW,CAAC;;EAEhE,MAAMsB,cAAc,GAAG5B,WAAW,GAAGC,eAAe,GAAGsB,gBAAgB;EACvE,MAAMM,aAAa,GAAGpB,YAAY,GAAGkB,UAAU;;EAE/CtB,CAAC,CAACW,WAAW,CAACa,aAAa,GAAG,YAAY,GAAG,KAAK,EAAE,MAAM;IACxD;;IAECjB,OAAO,CAASK,aAAa,CAACjB,WAAW,EAAEe,IAAI,EAAS,CAAC,EAAEN,YAAY,CAAC;EAC3E,CAAC,CAAC;;EAEF,IAAI,CAACoB,aAAa,EAAE;IAClBhB,cAAc,CAAC,CAACe,cAAc,CAAC;EACjC;AACF,CAAC,CAAC"}