{"version":3,"sources":["../../../../../../src/webgpu/api/validation/encoding/queries/general.spec.ts"],"names":["description","makeTestGroup","kQueryTypes","ValidationTest","createQuerySetWithType","g","test","desc","params","u","combine","undefined","beforeAllSubcases","t","type","selectDeviceForQueryTypeOrSkipTestCase","fn","querySet","encoder","createEncoder","occlusionQuerySet","beginOcclusionQuery","endOcclusionQuery","validateFinish","paramsSubcasesOnly","createQuerySetWithState","querySetState","validateFinishAndSubmitGivenState","queryIndex","beginSubcases","expand","p","queryTypes","push","count","writeTimestamp","selectMismatchedDeviceOrSkipTestCase","mismatched","device","mismatchedDevice","createQuerySet","trackForCleanup"],"mappings":"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","sourcesContent":["export const description = `\nTODO: pipeline statistics queries are removed from core; consider moving tests to another suite.\nTODO:\n- Start a pipeline statistics query in all possible encoders:\n    - queryIndex {in, out of} range for GPUQuerySet\n    - GPUQuerySet {valid, invalid, device mismatched}\n    - x ={render pass, compute pass} encoder\n`;\n\nimport { makeTestGroup } from '../../../../../common/framework/test_group.js';\nimport { kQueryTypes } from '../../../../capability_info.js';\nimport { ValidationTest } from '../../validation_test.js';\n\nimport { createQuerySetWithType } from './common.js';\n\nexport const g = makeTestGroup(ValidationTest);\n\ng.test('occlusion_query,query_type')\n  .desc(\n    `\nTests that set occlusion query set with all types in render pass descriptor:\n- type {occlusion (control case), pipeline statistics, timestamp}\n- {undefined} for occlusion query set in render pass descriptor\n  `\n  )\n  .params(u => u.combine('type', [undefined, ...kQueryTypes]))\n  .beforeAllSubcases(t => {\n    const { type } = t.params;\n    if (type) {\n      t.selectDeviceForQueryTypeOrSkipTestCase(type);\n    }\n  })\n  .fn(async t => {\n    const type = t.params.type;\n    const querySet = type === undefined ? undefined : createQuerySetWithType(t, type, 1);\n\n    const encoder = t.createEncoder('render pass', { occlusionQuerySet: querySet });\n    encoder.encoder.beginOcclusionQuery(0);\n    encoder.encoder.endOcclusionQuery();\n    encoder.validateFinish(type === 'occlusion');\n  });\n\ng.test('occlusion_query,invalid_query_set')\n  .desc(\n    `\nTests that begin occlusion query with a invalid query set that failed during creation.\n  `\n  )\n  .paramsSubcasesOnly(u => u.combine('querySetState', ['valid', 'invalid'] as const))\n  .fn(t => {\n    const occlusionQuerySet = t.createQuerySetWithState(t.params.querySetState);\n\n    const encoder = t.createEncoder('render pass', { occlusionQuerySet });\n    encoder.encoder.beginOcclusionQuery(0);\n    encoder.encoder.endOcclusionQuery();\n    encoder.validateFinishAndSubmitGivenState(t.params.querySetState);\n  });\n\ng.test('occlusion_query,query_index')\n  .desc(\n    `\nTests that begin occlusion query with query index:\n- queryIndex {in, out of} range for GPUQuerySet\n  `\n  )\n  .paramsSubcasesOnly(u => u.combine('queryIndex', [0, 2]))\n  .fn(t => {\n    const occlusionQuerySet = createQuerySetWithType(t, 'occlusion', 2);\n\n    const encoder = t.createEncoder('render pass', { occlusionQuerySet });\n    encoder.encoder.beginOcclusionQuery(t.params.queryIndex);\n    encoder.encoder.endOcclusionQuery();\n    encoder.validateFinish(t.params.queryIndex < 2);\n  });\n\ng.test('timestamp_query,query_type_and_index')\n  .desc(\n    `\nTests that write timestamp to all types of query set on all possible encoders:\n- type {occlusion, pipeline statistics, timestamp}\n- queryIndex {in, out of} range for GPUQuerySet\n- x= {non-pass} encoder\n  `\n  )\n  .params(u =>\n    u\n      .combine('type', kQueryTypes)\n      .beginSubcases()\n      .expand('queryIndex', p => (p.type === 'timestamp' ? [0, 2] : [0]))\n  )\n  .beforeAllSubcases(t => {\n    const { type } = t.params;\n\n    // writeTimestamp is only available for devices that enable the 'timestamp-query' feature.\n    const queryTypes: GPUQueryType[] = ['timestamp'];\n    if (type !== 'timestamp') {\n      queryTypes.push(type);\n    }\n\n    t.selectDeviceForQueryTypeOrSkipTestCase(queryTypes);\n  })\n  .fn(async t => {\n    const { type, queryIndex } = t.params;\n\n    const count = 2;\n    const querySet = createQuerySetWithType(t, type, count);\n\n    const encoder = t.createEncoder('non-pass');\n    encoder.encoder.writeTimestamp(querySet, queryIndex);\n    encoder.validateFinish(type === 'timestamp' && queryIndex < count);\n  });\n\ng.test('timestamp_query,invalid_query_set')\n  .desc(\n    `\nTests that write timestamp to a invalid query set that failed during creation:\n- x= {non-pass} encoder\n  `\n  )\n  .paramsSubcasesOnly(u => u.combine('querySetState', ['valid', 'invalid'] as const))\n  .beforeAllSubcases(t => {\n    t.selectDeviceForQueryTypeOrSkipTestCase('timestamp');\n  })\n  .fn(async t => {\n    const { querySetState } = t.params;\n\n    const querySet = t.createQuerySetWithState(querySetState, {\n      type: 'timestamp',\n      count: 2,\n    });\n\n    const encoder = t.createEncoder('non-pass');\n    encoder.encoder.writeTimestamp(querySet, 0);\n    encoder.validateFinish(querySetState !== 'invalid');\n  });\n\ng.test('timestamp_query,device_mismatch')\n  .desc('Tests writeTimestamp cannot be called with a query set created from another device')\n  .paramsSubcasesOnly(u => u.combine('mismatched', [true, false]))\n  .beforeAllSubcases(t => {\n    t.selectDeviceForQueryTypeOrSkipTestCase('timestamp');\n    t.selectMismatchedDeviceOrSkipTestCase('timestamp-query');\n  })\n  .fn(async t => {\n    const { mismatched } = t.params;\n    const device = mismatched ? t.mismatchedDevice : t.device;\n\n    const querySet = device.createQuerySet({\n      type: 'timestamp',\n      count: 2,\n    });\n    t.trackForCleanup(querySet);\n\n    const encoder = t.createEncoder('non-pass');\n    encoder.encoder.writeTimestamp(querySet, 0);\n    encoder.validateFinish(!mismatched);\n  });\n"],"file":"general.spec.js"}