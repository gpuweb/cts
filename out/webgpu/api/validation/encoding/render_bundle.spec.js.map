{"version":3,"file":"render_bundle.spec.js","names":["description","makeTestGroup","kDepthStencilFormats","ValidationTest","g","test","desc","fn","t","encoder","createEncoder","executeBundles","validateFinish","paramsSubcasesOnly","bundle0Mismatched","bundle1Mismatched","beforeAllSubcases","selectMismatchedDeviceOrSkipTestCase","undefined","params","descriptor","colorFormats","bundle0Device","mismatchedDevice","device","bundle0","createRenderBundleEncoder","finish","bundle1Device","bundle1","u","combineWithParams","bundleFormats","passFormats","_compatible","bundleEncoder","bundle","attachmentInfo","bundleFormat","passFormat","selectDeviceForTextureFormatOrSkipTestCase","compatible","depthStencilFormat","combine","beginSubcases","bundleDepthReadOnly","bundleStencilReadOnly","passDepthReadOnly","passStencilReadOnly","depthReadOnly","stencilReadOnly","bundleSamples","passSamples","sampleCount"],"sources":["../../../../../src/webgpu/api/validation/encoding/render_bundle.spec.ts"],"sourcesContent":["export const description = `\nTests execution of render bundles.\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { kDepthStencilFormats } from '../../../format_info.js';\nimport { ValidationTest } from '../validation_test.js';\n\nexport const g = makeTestGroup(ValidationTest);\n\ng.test('empty_bundle_list')\n  .desc(\n    `\n    Test that it is valid to execute an empty list of render bundles\n    `\n  )\n  .fn(t => {\n    const encoder = t.createEncoder('render pass');\n    encoder.encoder.executeBundles([]);\n    encoder.validateFinish(true);\n  });\n\ng.test('device_mismatch')\n  .desc(\n    `\n    Tests executeBundles cannot be called with render bundles created from another device\n    Test with two bundles to make sure all bundles can be validated:\n    - bundle0 and bundle1 from same device\n    - bundle0 and bundle1 from different device\n    `\n  )\n  .paramsSubcasesOnly([\n    { bundle0Mismatched: false, bundle1Mismatched: false }, // control case\n    { bundle0Mismatched: true, bundle1Mismatched: false },\n    { bundle0Mismatched: false, bundle1Mismatched: true },\n  ])\n  .beforeAllSubcases(t => {\n    t.selectMismatchedDeviceOrSkipTestCase(undefined);\n  })\n  .fn(t => {\n    const { bundle0Mismatched, bundle1Mismatched } = t.params;\n\n    const descriptor: GPURenderBundleEncoderDescriptor = {\n      colorFormats: ['rgba8unorm'],\n    };\n\n    const bundle0Device = bundle0Mismatched ? t.mismatchedDevice : t.device;\n    const bundle0 = bundle0Device.createRenderBundleEncoder(descriptor).finish();\n\n    const bundle1Device = bundle1Mismatched ? t.mismatchedDevice : t.device;\n    const bundle1 = bundle1Device.createRenderBundleEncoder(descriptor).finish();\n\n    const encoder = t.createEncoder('render pass');\n    encoder.encoder.executeBundles([bundle0, bundle1]);\n\n    encoder.validateFinish(!(bundle0Mismatched || bundle1Mismatched));\n  });\n\ng.test('color_formats_mismatch')\n  .desc(\n    `\n    Tests executeBundles cannot be called with render bundles that do match the colorFormats of the\n    render pass. This includes:\n    - formats don't match\n    - formats match but are in a different order\n    - formats match but there is a different count\n    `\n  )\n  .params(u =>\n    u.combineWithParams([\n      {\n        bundleFormats: ['bgra8unorm', 'rg8unorm'] as const,\n        passFormats: ['bgra8unorm', 'rg8unorm'] as const,\n        _compatible: true,\n      }, // control case\n      {\n        bundleFormats: ['bgra8unorm', 'rg8unorm'] as const,\n        passFormats: ['bgra8unorm', 'bgra8unorm'] as const,\n        _compatible: false,\n      },\n      {\n        bundleFormats: ['bgra8unorm', 'rg8unorm'] as const,\n        passFormats: ['rg8unorm', 'bgra8unorm'] as const,\n        _compatible: false,\n      },\n      {\n        bundleFormats: ['bgra8unorm', 'rg8unorm', 'rgba8unorm'] as const,\n        passFormats: ['rg8unorm', 'bgra8unorm'] as const,\n        _compatible: false,\n      },\n      {\n        bundleFormats: ['bgra8unorm', 'rg8unorm'] as const,\n        passFormats: ['rg8unorm', 'bgra8unorm', 'rgba8unorm'] as const,\n        _compatible: false,\n      },\n    ])\n  )\n  .fn(t => {\n    const { bundleFormats, passFormats, _compatible } = t.params;\n\n    const bundleEncoder = t.device.createRenderBundleEncoder({\n      colorFormats: bundleFormats,\n    });\n    const bundle = bundleEncoder.finish();\n\n    const encoder = t.createEncoder('render pass', {\n      attachmentInfo: {\n        colorFormats: passFormats,\n      },\n    });\n    encoder.encoder.executeBundles([bundle]);\n\n    encoder.validateFinish(_compatible);\n  });\n\ng.test('depth_stencil_formats_mismatch')\n  .desc(\n    `\n    Tests executeBundles cannot be called with render bundles that do match the depthStencil of the\n    render pass. This includes:\n    - formats don't match\n    - formats have matching depth or stencil aspects, but other aspects are missing\n    `\n  )\n  .params(u =>\n    u.combineWithParams([\n      { bundleFormat: 'depth24plus', passFormat: 'depth24plus' }, // control case\n      { bundleFormat: 'depth24plus', passFormat: 'depth16unorm' },\n      { bundleFormat: 'depth24plus', passFormat: 'depth24plus-stencil8' },\n      { bundleFormat: 'stencil8', passFormat: 'depth24plus-stencil8' },\n    ] as const)\n  )\n  .beforeAllSubcases(t => {\n    const { bundleFormat, passFormat } = t.params;\n    t.selectDeviceForTextureFormatOrSkipTestCase([bundleFormat, passFormat]);\n  })\n  .fn(t => {\n    const { bundleFormat, passFormat } = t.params;\n    const compatible = bundleFormat === passFormat;\n\n    const bundleEncoder = t.device.createRenderBundleEncoder({\n      colorFormats: [],\n      depthStencilFormat: bundleFormat,\n    });\n    const bundle = bundleEncoder.finish();\n\n    const encoder = t.createEncoder('render pass', {\n      attachmentInfo: {\n        colorFormats: [],\n        depthStencilFormat: passFormat,\n      },\n    });\n    encoder.encoder.executeBundles([bundle]);\n\n    encoder.validateFinish(compatible);\n  });\n\ng.test('depth_stencil_readonly_mismatch')\n  .desc(\n    `\n    Tests executeBundles cannot be called with render bundles that do match the depthStencil\n    readonly state of the render pass.\n    `\n  )\n  .params(u =>\n    u\n      .combine('depthStencilFormat', kDepthStencilFormats)\n      .beginSubcases()\n      .combine('bundleDepthReadOnly', [false, true])\n      .combine('bundleStencilReadOnly', [false, true])\n      .combine('passDepthReadOnly', [false, true])\n      .combine('passStencilReadOnly', [false, true])\n  )\n  .beforeAllSubcases(t => {\n    t.selectDeviceForTextureFormatOrSkipTestCase(t.params.depthStencilFormat);\n  })\n  .fn(t => {\n    const {\n      depthStencilFormat,\n      bundleDepthReadOnly,\n      bundleStencilReadOnly,\n      passDepthReadOnly,\n      passStencilReadOnly,\n    } = t.params;\n\n    const compatible =\n      (!passDepthReadOnly || bundleDepthReadOnly === passDepthReadOnly) &&\n      (!passStencilReadOnly || bundleStencilReadOnly === passStencilReadOnly);\n\n    const bundleEncoder = t.device.createRenderBundleEncoder({\n      colorFormats: [],\n      depthStencilFormat,\n      depthReadOnly: bundleDepthReadOnly,\n      stencilReadOnly: bundleStencilReadOnly,\n    });\n    const bundle = bundleEncoder.finish();\n\n    const encoder = t.createEncoder('render pass', {\n      attachmentInfo: {\n        colorFormats: [],\n        depthStencilFormat,\n        depthReadOnly: passDepthReadOnly,\n        stencilReadOnly: passStencilReadOnly,\n      },\n    });\n    encoder.encoder.executeBundles([bundle]);\n\n    encoder.validateFinish(compatible);\n  });\n\ng.test('sample_count_mismatch')\n  .desc(\n    `\n    Tests executeBundles cannot be called with render bundles that do match the sampleCount of the\n    render pass.\n    `\n  )\n  .params(u =>\n    u.combineWithParams([\n      { bundleSamples: 1, passSamples: 1 }, // control case\n      { bundleSamples: 4, passSamples: 4 }, // control case\n      { bundleFormat: 4, passFormat: 1 },\n      { bundleFormat: 1, passFormat: 4 },\n    ])\n  )\n  .fn(t => {\n    const { bundleSamples, passSamples } = t.params;\n\n    const compatible = bundleSamples === passSamples;\n\n    const bundleEncoder = t.device.createRenderBundleEncoder({\n      colorFormats: ['bgra8unorm'],\n      sampleCount: bundleSamples,\n    });\n    const bundle = bundleEncoder.finish();\n\n    const encoder = t.createEncoder('render pass', {\n      attachmentInfo: {\n        colorFormats: ['bgra8unorm'],\n        sampleCount: passSamples,\n      },\n    });\n    encoder.encoder.executeBundles([bundle]);\n\n    encoder.validateFinish(compatible);\n  });\n"],"mappings":"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"}