{"version":3,"file":"non_filterable_texture.spec.js","names":["description","makeTestGroup","keysOf","AllFeaturesMaxLimitsValidationTest","kNonFilterableCaseInfo","sint","type","component","uint","float","depth","kNonFilterableCases","g","test","desc","params","u","combine","fn","t","device","pipeline","async","sampleType","viewDimension","sameGroup","skipIfTextureViewDimensionNotSupported","coord","startsWith","dimensionSuffix","replace","textureType","layer","endsWith","groupNdx","module","createShaderModule","code","bindGroup0LayoutEntries","binding","visibility","GPUShaderStage","COMPUTE","FRAGMENT","texture","multisampled","samplerBGLEntry","sampler","push","bindGroupLayout0","createBindGroupLayout","entries","pipelineLayoutDesc","bindGroupLayouts","bindGroupLayout1","layout","createPipelineLayout","success","doCreateComputePipelineTest","compute","doCreateRenderPipelineTest","vertex","fragment","targets","format"],"sources":["../../../../src/webgpu/api/validation/non_filterable_texture.spec.ts"],"sourcesContent":["export const description = `\nTests that non-filterable textures used with filtering samplers generate a validation error.\n`;\n\nimport { makeTestGroup } from '../../../common/framework/test_group.js';\nimport { keysOf } from '../../../common/util/data_tables.js';\n\nimport { AllFeaturesMaxLimitsValidationTest } from './validation_test.js';\n\nconst kNonFilterableCaseInfo: Record<GPUTextureSampleType, { type: string; component: string }> = {\n  sint: { type: 'i32', component: '0,' },\n  uint: { type: 'u32', component: '0,' },\n  float: { type: 'f32', component: '0,' }, // no error for f32\n  'unfilterable-float': { type: 'f32', component: '0,' }, // no error for f32\n  depth: { type: 'depth', component: '' },\n};\nconst kNonFilterableCases = keysOf(kNonFilterableCaseInfo);\n\nexport const g = makeTestGroup(AllFeaturesMaxLimitsValidationTest);\n\ng.test('non_filterable_texture_with_filtering_sampler')\n  .desc(\n    'test that createXXXPipeline generates a validation error if a depth/u32/i32 texture binding is used with a filtering sampler binding'\n  )\n  .params(u =>\n    u\n      .combine('pipeline', ['compute', 'render'])\n      .combine('async', [true, false] as const)\n      .combine('sampleType', kNonFilterableCases)\n      .combine('viewDimension', ['2d', '2d-array', 'cube', 'cube-array'] as const)\n      .combine('sameGroup', [true, false] as const)\n  )\n  .fn(t => {\n    const { device } = t;\n    const { pipeline, async, sampleType, viewDimension, sameGroup } = t.params;\n    const { type, component } = kNonFilterableCaseInfo[sampleType];\n    t.skipIfTextureViewDimensionNotSupported(viewDimension);\n\n    const coord = viewDimension.startsWith('2d') ? 'vec2f(0)' : 'vec3f(0)';\n    const dimensionSuffix = viewDimension.replace('-', '_');\n    const textureType =\n      type === 'depth' ? `texture_depth_${dimensionSuffix}` : `texture_${dimensionSuffix}<${type}>`;\n    const layer = viewDimension.endsWith('-array') ? ', 0' : '';\n\n    const groupNdx = sameGroup ? 0 : 1;\n\n    const module = device.createShaderModule({\n      code: `\n      @group(0) @binding(0) var t: ${textureType};\n      @group(${groupNdx}) @binding(1) var s: sampler;\n\n      fn test() {\n        _ = textureGather(${component} t, s, ${coord}${layer});\n      }\n\n      @compute @workgroup_size(1) fn cs() {\n        test();\n      }\n\n      @vertex fn vs() -> @builtin(position) vec4f {\n        return vec4f(0);\n      }\n\n      @fragment fn fs() -> @location(0) vec4f {\n        test();\n        return vec4f(0);\n      }\n      `,\n    });\n\n    const bindGroup0LayoutEntries: GPUBindGroupLayoutEntry[] = [\n      {\n        binding: 0,\n        visibility: GPUShaderStage.COMPUTE | GPUShaderStage.FRAGMENT,\n        texture: {\n          sampleType,\n          viewDimension,\n          multisampled: false,\n        },\n      },\n    ];\n\n    const samplerBGLEntry: GPUBindGroupLayoutEntry = {\n      binding: 1,\n      visibility: GPUShaderStage.COMPUTE | GPUShaderStage.FRAGMENT,\n      sampler: {\n        type: 'filtering',\n      },\n    };\n\n    if (sameGroup) {\n      bindGroup0LayoutEntries.push(samplerBGLEntry);\n    }\n\n    const bindGroupLayout0 = device.createBindGroupLayout({\n      entries: bindGroup0LayoutEntries,\n    });\n\n    const pipelineLayoutDesc = {\n      bindGroupLayouts: [bindGroupLayout0],\n    };\n\n    if (!sameGroup) {\n      const bindGroupLayout1 = device.createBindGroupLayout({\n        entries: [samplerBGLEntry],\n      });\n      pipelineLayoutDesc.bindGroupLayouts.push(bindGroupLayout1);\n    }\n\n    const layout = device.createPipelineLayout(pipelineLayoutDesc);\n\n    const success = sampleType === 'float';\n\n    if (pipeline === 'compute') {\n      t.doCreateComputePipelineTest(async, success, {\n        layout,\n        compute: { module },\n      });\n    } else {\n      t.doCreateRenderPipelineTest(async, success, {\n        layout,\n        vertex: { module },\n        fragment: { module, targets: [{ format: 'rgba8unorm' }] },\n      });\n    }\n  });\n"],"mappings":"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"}