{"version":3,"file":"maxInterStageShaderVariables.spec.js","names":["range","kMaximumLimitBaseParams","makeLimitTestGroup","getPipelineDescriptor","device","testValue","pointList","frontFacing","sampleIndex","sampleMaskIn","sampleMaskOut","vertexOutputDeductions","fragmentInputDeductions","map","p","reduce","acc","vertexOutputVariables","fragmentInputVariables","numInterStageVariables","Math","min","maxVertexOutputVariables","limits","maxInterStageShaderVariables","maxFragmentInputVariables","maxInterStageVariables","varyings","i","join","code","module","createShaderModule","pipelineDescriptor","layout","primitive","topology","vertex","entryPoint","fragment","targets","format","limit","g","description","test","desc","params","combine","beforeAllSubcases","t","isCompatibility","skipIf","fn","limitTest","testValueName","async","testDeviceWithRequestedMaximumLimits","shouldError","testCreateRenderPipeline"],"sources":["../../../../../../src/webgpu/api/validation/capability_checks/limits/maxInterStageShaderVariables.spec.ts"],"sourcesContent":["import { range } from '../../../../../common/util/util.js';\n\nimport { kMaximumLimitBaseParams, makeLimitTestGroup } from './limit_utils.js';\n\nfunction getPipelineDescriptor(\n  device: GPUDevice,\n  testValue: number,\n  pointList: boolean,\n  frontFacing: boolean,\n  sampleIndex: boolean,\n  sampleMaskIn: boolean,\n  sampleMaskOut: boolean\n): GPURenderPipelineDescriptor {\n  const vertexOutputDeductions = pointList ? 1 : 0;\n  const fragmentInputDeductions = [frontFacing, sampleIndex, sampleMaskIn]\n    .map(p => (p ? 1 : 0) as number)\n    .reduce((acc, p) => acc + p);\n\n  const vertexOutputVariables = testValue - vertexOutputDeductions;\n  const fragmentInputVariables = testValue - fragmentInputDeductions;\n  const numInterStageVariables = Math.min(vertexOutputVariables, fragmentInputVariables);\n\n  const maxVertexOutputVariables =\n    device.limits.maxInterStageShaderVariables - vertexOutputDeductions;\n  const maxFragmentInputVariables =\n    device.limits.maxInterStageShaderVariables - fragmentInputDeductions;\n  const maxInterStageVariables = Math.min(maxVertexOutputVariables, maxFragmentInputVariables);\n\n  const varyings = `\n      ${range(numInterStageVariables, i => `@location(${i}) v4_${i}: vec4f,`).join('\\n')}\n  `;\n\n  const code = `\n    // test value                        : ${testValue}\n    // maxInterStageShaderVariables     : ${device.limits.maxInterStageShaderVariables}\n    // num variables in vertex shader : ${vertexOutputVariables}${pointList ? ' + point-list' : ''}\n    // num variables in fragment shader : ${fragmentInputVariables}${\n      frontFacing ? ' + front-facing' : ''\n    }${sampleIndex ? ' + sample_index' : ''}${sampleMaskIn ? ' + sample_mask' : ''}\n    // maxInterStageVariables:           : ${maxInterStageVariables}\n    // num used inter stage variables    : ${numInterStageVariables}\n\n    struct VSOut {\n      @builtin(position) p: vec4f,\n      ${varyings}\n    }\n    struct FSIn {\n      ${frontFacing ? '@builtin(front_facing) frontFacing: bool,' : ''}\n      ${sampleIndex ? '@builtin(sample_index) sampleIndex: u32,' : ''}\n      ${sampleMaskIn ? '@builtin(sample_mask) sampleMask: u32,' : ''}\n      ${varyings}\n    }\n    struct FSOut {\n      @location(0) color: vec4f,\n      ${sampleMaskOut ? '@builtin(sample_mask) sampleMask: u32,' : ''}\n    }\n    @vertex fn vs() -> VSOut {\n      var o: VSOut;\n      o.p = vec4f(0);\n      return o;\n    }\n    @fragment fn fs(i: FSIn) -> FSOut {\n      var o: FSOut;\n      o.color = vec4f(0);\n      return o;\n    }\n  `;\n  const module = device.createShaderModule({ code });\n  const pipelineDescriptor: GPURenderPipelineDescriptor = {\n    layout: 'auto',\n    primitive: {\n      topology: pointList ? 'point-list' : 'triangle-list',\n    },\n    vertex: {\n      module,\n      entryPoint: 'vs',\n    },\n    fragment: {\n      module,\n      entryPoint: 'fs',\n      targets: [\n        {\n          format: 'rgba8unorm',\n        },\n      ],\n    },\n  };\n  return pipelineDescriptor;\n}\n\nconst limit = 'maxInterStageShaderVariables';\nexport const { g, description } = makeLimitTestGroup(limit);\n\ng.test('createRenderPipeline,at_over')\n  .desc(`Test using at and over ${limit} limit in createRenderPipeline(Async)`)\n  .params(\n    kMaximumLimitBaseParams\n      .combine('async', [false, true])\n      .combine('pointList', [false, true])\n      .combine('frontFacing', [false, true])\n      .combine('sampleIndex', [false, true])\n      .combine('sampleMaskIn', [false, true])\n      .combine('sampleMaskOut', [false, true])\n  )\n  .beforeAllSubcases(t => {\n    if (t.isCompatibility) {\n      t.skipIf(\n        t.params.sampleMaskIn || t.params.sampleMaskOut,\n        'sample_mask not supported in compatibility mode'\n      );\n      t.skipIf(t.params.sampleIndex, 'sample_index not supported in compatibility mode');\n    }\n  })\n  .fn(async t => {\n    const {\n      limitTest,\n      testValueName,\n      async,\n      pointList,\n      frontFacing,\n      sampleIndex,\n      sampleMaskIn,\n      sampleMaskOut,\n    } = t.params;\n    await t.testDeviceWithRequestedMaximumLimits(\n      limitTest,\n      testValueName,\n      async ({ device, testValue, shouldError }) => {\n        const pipelineDescriptor = getPipelineDescriptor(\n          device,\n          testValue,\n          pointList,\n          frontFacing,\n          sampleIndex,\n          sampleMaskIn,\n          sampleMaskOut\n        );\n\n        await t.testCreateRenderPipeline(pipelineDescriptor, async, shouldError);\n      }\n    );\n  });\n"],"mappings":"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"}