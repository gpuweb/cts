{"version":3,"file":"query_types.spec.js","names":["description","makeTestGroup","UniqueFeaturesAndLimitsValidationTest","g","test","desc","params","u","combine","beforeAllSubcases","t","featureContainsTimestampQuery","requiredFeatures","push","selectDeviceOrSkipTestCase","fn","type","count","shouldException","shouldThrow","createQuerySetTracked","querySet","expected","encoder","createEncoder","writeTimestamp","message","finish","beginComputePass","timestampWrites","beginningOfPassWriteIndex","endOfPassWriteIndex","end","expectValidationError","view","createTextureTracked","size","format","usage","GPUTextureUsage","RENDER_ATTACHMENT","createView","beginRenderPass","colorAttachments","loadOp","storeOp"],"sources":["../../../../../../src/webgpu/api/validation/capability_checks/features/query_types.spec.ts"],"sourcesContent":["export const description = `\nTests for capability checking for features enabling optional query types.\n`;\n\nimport { makeTestGroup } from '../../../../../common/framework/test_group.js';\nimport { UniqueFeaturesAndLimitsValidationTest } from '../../validation_test.js';\n\nexport const g = makeTestGroup(UniqueFeaturesAndLimitsValidationTest);\n\ng.test('createQuerySet')\n  .desc(\n    `\n  Tests that creating a query set throws a type error exception if the features don't contain\n  'timestamp-query'.\n    - createQuerySet\n      - type {occlusion, timestamp}\n      - x= timestamp query {enable, disable}\n  `\n  )\n  .params(u =>\n    u\n      .combine('type', ['occlusion', 'timestamp'] as const)\n      .combine('featureContainsTimestampQuery', [false, true])\n  )\n  .beforeAllSubcases(t => {\n    const { featureContainsTimestampQuery } = t.params;\n\n    const requiredFeatures: GPUFeatureName[] = [];\n    if (featureContainsTimestampQuery) {\n      requiredFeatures.push('timestamp-query');\n    }\n\n    t.selectDeviceOrSkipTestCase({ requiredFeatures });\n  })\n  .fn(t => {\n    const { type, featureContainsTimestampQuery } = t.params;\n\n    const count = 1;\n    const shouldException = type === 'timestamp' && !featureContainsTimestampQuery;\n\n    t.shouldThrow(shouldException ? 'TypeError' : false, () => {\n      t.createQuerySetTracked({ type, count });\n    });\n  });\n\ng.test('timestamp')\n  .desc(\n    `\n  Tests that writing a timestamp throws a type error exception if the features don't contain\n  'timestamp-query'.\n\n  TODO: writeTimestamp test is disabled since it's removed from the spec for now.\n  `\n  )\n  .params(u => u.combine('featureContainsTimestampQuery', [false, true]))\n  .beforeAllSubcases(t => {\n    const { featureContainsTimestampQuery } = t.params;\n\n    const requiredFeatures: GPUFeatureName[] = [];\n    if (featureContainsTimestampQuery) {\n      requiredFeatures.push('timestamp-query');\n    }\n\n    t.selectDeviceOrSkipTestCase({ requiredFeatures });\n  })\n  .fn(t => {\n    const { featureContainsTimestampQuery } = t.params;\n\n    const querySet = t.createQuerySetTracked({\n      type: featureContainsTimestampQuery ? 'timestamp' : 'occlusion',\n      count: 2,\n    });\n\n    {\n      let expected = featureContainsTimestampQuery ? false : 'TypeError';\n      // writeTimestamp no longer exists and this should always TypeError.\n      expected = 'TypeError';\n\n      const encoder = t.createEncoder('non-pass');\n      t.shouldThrow(\n        expected,\n        () => {\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any\n          (encoder.encoder as any).writeTimestamp(querySet, 0);\n        },\n        { message: 'writeTimestamp should throw' }\n      );\n      encoder.finish();\n    }\n\n    {\n      const encoder = t.createEncoder('non-pass');\n      encoder.encoder\n        .beginComputePass({\n          timestampWrites: { querySet, beginningOfPassWriteIndex: 0, endOfPassWriteIndex: 1 },\n        })\n        .end();\n      t.expectValidationError(() => {\n        encoder.finish();\n      }, !featureContainsTimestampQuery);\n    }\n\n    {\n      const encoder = t.createEncoder('non-pass');\n      const view = t\n        .createTextureTracked({\n          size: [16, 16, 1],\n          format: 'rgba8unorm',\n          usage: GPUTextureUsage.RENDER_ATTACHMENT,\n        })\n        .createView();\n      encoder.encoder\n        .beginRenderPass({\n          colorAttachments: [{ view, loadOp: 'clear', storeOp: 'discard' }],\n          timestampWrites: { querySet, beginningOfPassWriteIndex: 0, endOfPassWriteIndex: 1 },\n        })\n        .end();\n      t.expectValidationError(() => {\n        encoder.finish();\n      }, !featureContainsTimestampQuery);\n    }\n  });\n"],"mappings":"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"}