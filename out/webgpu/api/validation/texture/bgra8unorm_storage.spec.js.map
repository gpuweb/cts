{"version":3,"file":"bgra8unorm_storage.spec.js","names":["description","makeTestGroup","assert","kTextureUsages","kValidCombinationsOfOneOrTwoTextureUsages","usageIsTypeErrorForConfigure","GPUConst","UniqueFeaturesOrLimitsGPUTest","kAllCanvasTypes","createCanvas","BGRA8UnormStorageValidationTests","testCreateShaderModuleWithBGRA8UnormStorage","shaderType","success","shaderDeclaration","expectValidationError","device","createShaderModule","code","g","test","desc","beforeAllSubcases","t","selectDeviceOrSkipTestCase","fn","descriptor","size","format","usage","TextureUsage","STORAGE_BINDING","createTextureTracked","createBindGroupLayout","entries","binding","visibility","GPUShaderStage","COMPUTE","storageTexture","params","u","combine","beginSubcases","filter","canvasType","TRANSIENT_ATTACHMENT","skipIfTransientAttachmentNotSupported","canvas","ctx","getContext","GPUCanvasContext","requiredStorageBinding","GPUTextureUsage","configure","requiredFeatures","requiredLimits","maxStorageTexturesInFragmentStage","map","currentTexture","getCurrentTexture","bindGroupLayout","FRAGMENT","access","createBindGroup","layout","resource","createView"],"sources":["../../../../../src/webgpu/api/validation/texture/bgra8unorm_storage.spec.ts"],"sourcesContent":["export const description = `\nTests for capabilities added by bgra8unorm-storage flag.\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { assert } from '../../../../common/util/util.js';\nimport {\n  kTextureUsages,\n  kValidCombinationsOfOneOrTwoTextureUsages,\n  usageIsTypeErrorForConfigure,\n} from '../../../capability_info.js';\nimport { GPUConst } from '../../../constants.js';\nimport { UniqueFeaturesOrLimitsGPUTest } from '../../../gpu_test.js';\nimport { kAllCanvasTypes, createCanvas } from '../../../util/create_elements.js';\n\nclass BGRA8UnormStorageValidationTests extends UniqueFeaturesOrLimitsGPUTest {\n  testCreateShaderModuleWithBGRA8UnormStorage(\n    shaderType: 'fragment' | 'compute',\n    success: boolean\n  ): void {\n    let shaderDeclaration = '';\n    switch (shaderType) {\n      case 'fragment':\n        shaderDeclaration = '@fragment';\n        break;\n      case 'compute':\n        shaderDeclaration = '@compute @workgroup_size(1)';\n        break;\n    }\n    this.expectValidationError(() => {\n      this.device.createShaderModule({\n        code: `\n      @group(0) @binding(1) var outputTex: texture_storage_2d<bgra8unorm, write>;\n      ${shaderDeclaration} fn main() {\n        textureStore(outputTex, vec2<i32>(), vec4<f32>());\n      }\n      `,\n      });\n    }, !success);\n  }\n}\n\nexport const g = makeTestGroup(BGRA8UnormStorageValidationTests);\n\ng.test('create_texture')\n  .desc(\n    `\nTest that it is valid to create bgra8unorm texture with STORAGE usage iff the feature\nbgra8unorm-storage is enabled. Note, the createTexture test suite covers the validation cases where\nthis feature is not enabled, which are skipped here.\n`\n  )\n  .beforeAllSubcases(t => {\n    t.selectDeviceOrSkipTestCase('bgra8unorm-storage');\n  })\n  .fn(t => {\n    const descriptor = {\n      size: [1, 1, 1],\n      format: 'bgra8unorm' as const,\n      usage: GPUConst.TextureUsage.STORAGE_BINDING,\n    };\n    t.createTextureTracked(descriptor);\n  });\n\ng.test('create_bind_group_layout')\n  .desc(\n    `\nTest that it is valid to create GPUBindGroupLayout that uses bgra8unorm as storage texture format\niff the feature bgra8unorm-storage is enabled. Note, the createBindGroupLayout test suite covers the\nvalidation cases where this feature is not enabled, which are skipped here.\n`\n  )\n  .beforeAllSubcases(t => {\n    t.selectDeviceOrSkipTestCase('bgra8unorm-storage');\n  })\n  .fn(t => {\n    t.device.createBindGroupLayout({\n      entries: [\n        {\n          binding: 0,\n          visibility: GPUShaderStage.COMPUTE,\n          storageTexture: { format: 'bgra8unorm' },\n        },\n      ],\n    });\n  });\n\ng.test('configure_storage_usage_on_canvas_context_without_bgra8unorm_storage')\n  .desc(\n    `\nTest that it is invalid to configure a GPUCanvasContext to 'GPUStorageBinding' usage with\n'bgra8unorm' format on a GPUDevice with 'bgra8unorm-storage' disabled.\n`\n  )\n  .params(u =>\n    u\n      .combine('canvasType', kAllCanvasTypes)\n      .beginSubcases()\n      .combine(\n        'usage',\n        kValidCombinationsOfOneOrTwoTextureUsages\n          // Don't test disallowed usages here, that's covered by configure() tests.\n          .filter(usage => !usageIsTypeErrorForConfigure(usage))\n      )\n  )\n  .fn(t => {\n    const { canvasType, usage } = t.params;\n\n    // MAINTENANCE_TODO(#4509): Remove this when TRANSIENT_ATTACHMENT is added to the WebGPU spec.\n    if ((usage & GPUConst.TextureUsage.TRANSIENT_ATTACHMENT) !== 0) {\n      t.skipIfTransientAttachmentNotSupported();\n    }\n\n    const canvas = createCanvas(t, canvasType, 1, 1);\n    const ctx = canvas.getContext('webgpu');\n    assert(ctx instanceof GPUCanvasContext, 'Failed to get WebGPU context from canvas');\n\n    const requiredStorageBinding = !!(usage & GPUTextureUsage.STORAGE_BINDING);\n    t.expectValidationError(() => {\n      ctx.configure({\n        device: t.device,\n        format: 'bgra8unorm',\n        usage,\n      });\n    }, requiredStorageBinding);\n  });\n\ng.test('configure_storage_usage_on_canvas_context_with_bgra8unorm_storage')\n  .desc(\n    `\nTest that it is valid to configure a GPUCanvasContext with GPUStorageBinding usage and a GPUDevice\nwith 'bgra8unorm-storage' enabled.\n`\n  )\n  .beforeAllSubcases(t => {\n    t.selectDeviceOrSkipTestCase({\n      requiredFeatures: ['bgra8unorm-storage'],\n      requiredLimits: {\n        maxStorageTexturesInFragmentStage: 1,\n      },\n    });\n  })\n  .params(u =>\n    u\n      .combine('canvasType', kAllCanvasTypes)\n      .beginSubcases()\n      .combine(\n        'usage',\n        kTextureUsages\n          // Don't test disallowed usages here, that's covered by configure() tests.\n          .filter(usage => !usageIsTypeErrorForConfigure(usage))\n          .map(usage => usage | GPUConst.TextureUsage.STORAGE_BINDING)\n      )\n  )\n  .fn(t => {\n    const { canvasType, usage } = t.params;\n\n    // MAINTENANCE_TODO(#4509): Remove this when TRANSIENT_ATTACHMENT is added to the WebGPU spec.\n    if ((usage & GPUConst.TextureUsage.TRANSIENT_ATTACHMENT) !== 0) {\n      t.skipIfTransientAttachmentNotSupported();\n    }\n\n    const canvas = createCanvas(t, canvasType, 1, 1);\n    const ctx = canvas.getContext('webgpu');\n    assert(ctx instanceof GPUCanvasContext, 'Failed to get WebGPU context from canvas');\n\n    ctx.configure({\n      device: t.device,\n      format: 'bgra8unorm',\n      usage,\n    });\n\n    const currentTexture = ctx.getCurrentTexture();\n    const bindGroupLayout = t.device.createBindGroupLayout({\n      entries: [\n        {\n          binding: 0,\n          visibility: GPUShaderStage.FRAGMENT,\n          storageTexture: { access: 'write-only', format: currentTexture.format },\n        },\n      ],\n    });\n    t.device.createBindGroup({\n      layout: bindGroupLayout,\n      entries: [\n        {\n          binding: 0,\n          resource: currentTexture.createView(),\n        },\n      ],\n    });\n  });\n"],"mappings":"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"}