{"version":3,"file":"bgra8unorm_storage.spec.js","names":["description","makeTestGroup","assert","kTextureUsages","GPUConst","kAllCanvasTypes","createCanvas","ValidationTest","BGRA8UnormStorageValidationTests","testCreateShaderModuleWithBGRA8UnormStorage","shaderType","success","shaderDeclaration","expectValidationError","device","createShaderModule","code","g","test","desc","beforeAllSubcases","t","selectDeviceOrSkipTestCase","fn","descriptor","size","format","usage","TextureUsage","STORAGE","createTextureTracked","createBindGroupLayout","entries","binding","visibility","GPUShaderStage","COMPUTE","storageTexture","params","u","combine","beginSubcases","expand","usageSet","Set","usage0","usage1","add","canvasType","canvas","ctx","getContext","GPUCanvasContext","requiredStorageBinding","GPUTextureUsage","STORAGE_BINDING","configure","currentTexture","getCurrentTexture","bindGroupLayout","FRAGMENT","access","createBindGroup","layout","resource","createView"],"sources":["../../../../../src/webgpu/api/validation/texture/bgra8unorm_storage.spec.ts"],"sourcesContent":["export const description = `\nTests for capabilities added by bgra8unorm-storage flag.\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { assert } from '../../../../common/util/util.js';\nimport { kTextureUsages } from '../../../capability_info.js';\nimport { GPUConst } from '../../../constants.js';\nimport { kAllCanvasTypes, createCanvas } from '../../../util/create_elements.js';\nimport { ValidationTest } from '../validation_test.js';\n\nclass BGRA8UnormStorageValidationTests extends ValidationTest {\n  testCreateShaderModuleWithBGRA8UnormStorage(\n    shaderType: 'fragment' | 'compute',\n    success: boolean\n  ): void {\n    let shaderDeclaration = '';\n    switch (shaderType) {\n      case 'fragment':\n        shaderDeclaration = '@fragment';\n        break;\n      case 'compute':\n        shaderDeclaration = '@compute @workgroup_size(1)';\n        break;\n    }\n    this.expectValidationError(() => {\n      this.device.createShaderModule({\n        code: `\n      @group(0) @binding(1) var outputTex: texture_storage_2d<bgra8unorm, write>;\n      ${shaderDeclaration} fn main() {\n        textureStore(outputTex, vec2<i32>(), vec4<f32>());\n      }\n      `,\n      });\n    }, !success);\n  }\n}\n\nexport const g = makeTestGroup(BGRA8UnormStorageValidationTests);\n\ng.test('create_texture')\n  .desc(\n    `\nTest that it is valid to create bgra8unorm texture with STORAGE usage iff the feature\nbgra8unorm-storage is enabled. Note, the createTexture test suite covers the validation cases where\nthis feature is not enabled, which are skipped here.\n`\n  )\n  .beforeAllSubcases(t => {\n    t.selectDeviceOrSkipTestCase('bgra8unorm-storage');\n  })\n  .fn(t => {\n    const descriptor = {\n      size: [1, 1, 1],\n      format: 'bgra8unorm' as const,\n      usage: GPUConst.TextureUsage.STORAGE,\n    };\n    t.createTextureTracked(descriptor);\n  });\n\ng.test('create_bind_group_layout')\n  .desc(\n    `\nTest that it is valid to create GPUBindGroupLayout that uses bgra8unorm as storage texture format\niff the feature bgra8unorm-storage is enabled. Note, the createBindGroupLayout test suite covers the\nvalidation cases where this feature is not enabled, which are skipped here.\n`\n  )\n  .beforeAllSubcases(t => {\n    t.selectDeviceOrSkipTestCase('bgra8unorm-storage');\n  })\n  .fn(t => {\n    t.device.createBindGroupLayout({\n      entries: [\n        {\n          binding: 0,\n          visibility: GPUShaderStage.COMPUTE,\n          storageTexture: { format: 'bgra8unorm' },\n        },\n      ],\n    });\n  });\n\ng.test('configure_storage_usage_on_canvas_context_without_bgra8unorm_storage')\n  .desc(\n    `\nTest that it is invalid to configure a GPUCanvasContext to 'GPUStorageBinding' usage with\n'bgra8unorm' format on a GPUDevice with 'bgra8unorm-storage' disabled.\n`\n  )\n  .params(u =>\n    u\n      .combine('canvasType', kAllCanvasTypes)\n      .beginSubcases()\n      .expand('usage', () => {\n        const usageSet = new Set<number>();\n        for (const usage0 of kTextureUsages) {\n          for (const usage1 of kTextureUsages) {\n            usageSet.add(usage0 | usage1);\n          }\n        }\n        return usageSet;\n      })\n  )\n  .fn(t => {\n    const { canvasType, usage } = t.params;\n    const canvas = createCanvas(t, canvasType, 1, 1);\n    const ctx = canvas.getContext('webgpu');\n    assert(ctx instanceof GPUCanvasContext, 'Failed to get WebGPU context from canvas');\n\n    const requiredStorageBinding = !!(usage & GPUTextureUsage.STORAGE_BINDING);\n    t.expectValidationError(() => {\n      ctx.configure({\n        device: t.device,\n        format: 'bgra8unorm',\n        usage,\n      });\n    }, requiredStorageBinding);\n  });\n\ng.test('configure_storage_usage_on_canvas_context_with_bgra8unorm_storage')\n  .desc(\n    `\nTest that it is valid to configure a GPUCanvasContext with GPUStorageBinding usage and a GPUDevice\nwith 'bgra8unorm-storage' enabled.\n`\n  )\n  .beforeAllSubcases(t => {\n    t.selectDeviceOrSkipTestCase('bgra8unorm-storage');\n  })\n  .params(u =>\n    u\n      .combine('canvasType', kAllCanvasTypes)\n      .beginSubcases()\n      .expand('usage', () => {\n        const usageSet = new Set<number>();\n        for (const usage of kTextureUsages) {\n          usageSet.add(usage | GPUConst.TextureUsage.STORAGE_BINDING);\n        }\n        return usageSet;\n      })\n  )\n  .fn(t => {\n    const { canvasType, usage } = t.params;\n    const canvas = createCanvas(t, canvasType, 1, 1);\n    const ctx = canvas.getContext('webgpu');\n    assert(ctx instanceof GPUCanvasContext, 'Failed to get WebGPU context from canvas');\n\n    ctx.configure({\n      device: t.device,\n      format: 'bgra8unorm',\n      usage,\n    });\n\n    const currentTexture = ctx.getCurrentTexture();\n    const bindGroupLayout = t.device.createBindGroupLayout({\n      entries: [\n        {\n          binding: 0,\n          visibility: GPUShaderStage.FRAGMENT,\n          storageTexture: { access: 'write-only', format: currentTexture.format },\n        },\n      ],\n    });\n    t.device.createBindGroup({\n      layout: bindGroupLayout,\n      entries: [\n        {\n          binding: 0,\n          resource: currentTexture.createView(),\n        },\n      ],\n    });\n  });\n"],"mappings":"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"}