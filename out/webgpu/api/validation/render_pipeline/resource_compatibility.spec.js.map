{"version":3,"file":"resource_compatibility.spec.js","names":["description","makeTestGroup","keysOf","MaxLimitsTestMixin","kAPIResources","getWGSLShaderForResource","getAPIBindGroupLayoutForResource","doResourcesMatch","CreateRenderPipelineValidationTest","g","test","desc","params","u","combine","filter","t","res","apiResource","stage","buffer","type","storageTexture","access","beginSubcases","fn","wgslResource","skipIf","undefined","hasLanguageFeature","isCompatibility","device","limits","maxStorageBuffersInVertexStage","maxStorageTexturesInVertexStage","maxStorageBuffersInFragmentStage","maxStorageTexturesInFragmentStage","skipIfTextureViewDimensionNotSupported","texture","viewDimension","emptyVS","emptyFS","code","vsCode","fsCode","gpuStage","GPUShaderStage","VERTEX","FRAGMENT","layout","createPipelineLayout","bindGroupLayouts","descriptor","vertex","module","createShaderModule","entryPoint","fragment","targets","format","doCreateRenderPipelineTest","isAsync"],"sources":["../../../../../src/webgpu/api/validation/render_pipeline/resource_compatibility.spec.ts"],"sourcesContent":["export const description = `\nTests for resource compatibility between pipeline layout and shader modules\n  `;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { keysOf } from '../../../../common/util/data_tables.js';\nimport { MaxLimitsTestMixin } from '../../../gpu_test.js';\nimport {\n  kAPIResources,\n  getWGSLShaderForResource,\n  getAPIBindGroupLayoutForResource,\n  doResourcesMatch,\n} from '../utils.js';\n\nimport { CreateRenderPipelineValidationTest } from './common.js';\n\nexport const g = makeTestGroup(MaxLimitsTestMixin(CreateRenderPipelineValidationTest));\n\ng.test('resource_compatibility')\n  .desc(\n    'Tests validation of resource (bind group) compatibility between pipeline layout and WGSL shader'\n  )\n  .params(u =>\n    u //\n      .combine('stage', ['vertex', 'fragment'] as const)\n      .combine('apiResource', keysOf(kAPIResources))\n      .filter(t => {\n        const res = kAPIResources[t.apiResource];\n        if (t.stage === 'vertex') {\n          if (res.buffer && res.buffer.type === 'storage') {\n            return false;\n          }\n          if (res.storageTexture && res.storageTexture.access !== 'read-only') {\n            return false;\n          }\n        }\n        return true;\n      })\n      .beginSubcases()\n      .combine('isAsync', [true, false] as const)\n      .combine('wgslResource', keysOf(kAPIResources))\n  )\n  .fn(t => {\n    const apiResource = kAPIResources[t.params.apiResource];\n    const wgslResource = kAPIResources[t.params.wgslResource];\n    t.skipIf(\n      wgslResource.storageTexture !== undefined &&\n        wgslResource.storageTexture.access !== 'write-only' &&\n        !t.hasLanguageFeature('readonly_and_readwrite_storage_textures'),\n      'Storage textures require language feature'\n    );\n    t.skipIf(\n      t.params.stage === 'vertex' &&\n        ((wgslResource.buffer !== undefined && wgslResource.buffer.type === 'storage') ||\n          (wgslResource.storageTexture !== undefined &&\n            wgslResource.storageTexture.access !== 'read-only')),\n      'Read-Write Storage buffers and textures cannot be used in vertex shaders'\n    );\n    if (t.isCompatibility) {\n      t.skipIf(\n        t.params.stage === 'vertex' &&\n          (apiResource.buffer?.type === 'storage' ||\n            apiResource.buffer?.type === 'read-only-storage') &&\n          t.device.limits.maxStorageBuffersInVertexStage === 0,\n        'Storage buffers can not be used in vertex shaders because maxStorageBuffersInVertexStage === 0'\n      );\n      t.skipIf(\n        t.params.stage === 'vertex' &&\n          apiResource.storageTexture !== undefined &&\n          t.device.limits.maxStorageTexturesInVertexStage === 0,\n        'Storage textures can not be used in vertex shaders because maxStorageTexturesInVertexStage === 0'\n      );\n      t.skipIf(\n        t.params.stage === 'fragment' &&\n          (apiResource.buffer?.type === 'storage' ||\n            apiResource.buffer?.type === 'read-only-storage') &&\n          t.device.limits.maxStorageBuffersInFragmentStage === 0,\n        'Storage buffers can not be used in fragment shaders because maxStorageBuffersInFragmentStage === 0'\n      );\n      t.skipIf(\n        t.params.stage === 'fragment' &&\n          apiResource.storageTexture !== undefined &&\n          t.device.limits.maxStorageTexturesInFragmentStage === 0,\n        'Storage textures can not be used in fragment shaders because maxStorageTexturesInFragmentStage === 0'\n      );\n    }\n    t.skipIfTextureViewDimensionNotSupported(wgslResource.texture?.viewDimension);\n    const emptyVS = `\n@vertex\nfn main() -> @builtin(position) vec4f {\n  return vec4f();\n}\n`;\n    const emptyFS = `\n@fragment\nfn main() -> @location(0) vec4f {\n  return vec4f();\n}\n`;\n\n    const code = getWGSLShaderForResource(t.params.stage, wgslResource);\n    const vsCode = t.params.stage === 'vertex' ? code : emptyVS;\n    const fsCode = t.params.stage === 'fragment' ? code : emptyFS;\n    const gpuStage: GPUShaderStageFlags =\n      t.params.stage === 'vertex' ? GPUShaderStage.VERTEX : GPUShaderStage.FRAGMENT;\n    const layout = t.device.createPipelineLayout({\n      bindGroupLayouts: [getAPIBindGroupLayoutForResource(t.device, gpuStage, apiResource)],\n    });\n\n    const descriptor = {\n      layout,\n      vertex: {\n        module: t.device.createShaderModule({\n          code: vsCode,\n        }),\n        entryPoint: 'main',\n      },\n      fragment: {\n        module: t.device.createShaderModule({\n          code: fsCode,\n        }),\n        entryPoint: 'main',\n        targets: [{ format: 'rgba8unorm' }] as const,\n      },\n    };\n\n    t.doCreateRenderPipelineTest(\n      t.params.isAsync,\n      doResourcesMatch(apiResource, wgslResource),\n      descriptor\n    );\n  });\n"],"mappings":"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"}