{"version":3,"file":"create.spec.js","names":["description","makeTestGroup","assert","kAllBufferUsageBits","kBufferSizeAlignment","kBufferUsages","GPUConst","AllFeaturesMaxLimitsGPUTest","kMaxSafeMultipleOf8","g","test","desc","params","u","combine","beginSubcases","fn","t","mappedAtCreation","size","isValid","usage","BufferUsage","COPY_SRC","shouldThrow","createBufferTracked","sizeAddition","makeLimitVariant","mult","add","device","limits","maxBufferSize","expectGPUError","kInvalidUsage","usage1","usage2","GPUBufferUsage","MAP_READ","COPY_DST","MAP_WRITE","paramsSubcasesOnly","combineWithParams","_valid","UNIFORM","STORAGE"],"sources":["../../../../../src/webgpu/api/validation/buffer/create.spec.ts"],"sourcesContent":["export const description = `\nTests for validation in createBuffer.\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { assert } from '../../../../common/util/util.js';\nimport {\n  kAllBufferUsageBits,\n  kBufferSizeAlignment,\n  kBufferUsages,\n} from '../../../capability_info.js';\nimport { GPUConst } from '../../../constants.js';\nimport { AllFeaturesMaxLimitsGPUTest } from '../../../gpu_test.js';\nimport { kMaxSafeMultipleOf8 } from '../../../util/math.js';\n\nexport const g = makeTestGroup(AllFeaturesMaxLimitsGPUTest);\n\nassert(kBufferSizeAlignment === 4);\ng.test('size')\n  .desc(\n    'Test buffer size alignment is validated to be a multiple of 4 if mappedAtCreation is true.'\n  )\n  .params(u =>\n    u\n      .combine('mappedAtCreation', [false, true])\n      .beginSubcases()\n      .combine('size', [\n        0,\n        kBufferSizeAlignment * 0.5,\n        kBufferSizeAlignment,\n        kBufferSizeAlignment * 1.5,\n        kBufferSizeAlignment * 2,\n      ])\n  )\n  .fn(t => {\n    const { mappedAtCreation, size } = t.params;\n    const isValid = !mappedAtCreation || size % kBufferSizeAlignment === 0;\n    const usage = BufferUsage.COPY_SRC;\n\n    t.shouldThrow(isValid ? false : 'RangeError', () =>\n      t.createBufferTracked({ size, usage, mappedAtCreation })\n    );\n  });\n\ng.test('limit')\n  .desc('Test buffer size is validated against maxBufferSize.')\n  .params(u => u.beginSubcases().combine('sizeAddition', [-1, 0, +1]))\n  .fn(t => {\n    const { sizeAddition } = t.params;\n    const size = t.makeLimitVariant('maxBufferSize', { mult: 1, add: sizeAddition });\n    const isValid = size <= t.device.limits.maxBufferSize;\n    const usage = BufferUsage.COPY_SRC;\n    t.expectGPUError('validation', () => t.createBufferTracked({ size, usage }), !isValid);\n  });\n\nconst kInvalidUsage = 0x8000;\nassert((kInvalidUsage & kAllBufferUsageBits) === 0);\ng.test('usage')\n  .desc('Test combinations of zero to two usage flags are validated to be valid.')\n  .params(u =>\n    u\n      .combine('usage1', [0, ...kBufferUsages, kInvalidUsage])\n      .combine('usage2', [0, ...kBufferUsages, kInvalidUsage])\n      .beginSubcases()\n      .combine('mappedAtCreation', [false, true])\n  )\n  .fn(t => {\n    const { mappedAtCreation, usage1, usage2 } = t.params;\n    const usage = usage1 | usage2;\n\n    const isValid =\n      usage !== 0 &&\n      (usage & ~kAllBufferUsageBits) === 0 &&\n      ((usage & GPUBufferUsage.MAP_READ) === 0 ||\n        (usage & ~(GPUBufferUsage.COPY_DST | GPUBufferUsage.MAP_READ)) === 0) &&\n      ((usage & GPUBufferUsage.MAP_WRITE) === 0 ||\n        (usage & ~(GPUBufferUsage.COPY_SRC | GPUBufferUsage.MAP_WRITE)) === 0);\n\n    t.expectGPUError(\n      'validation',\n      () => t.createBufferTracked({ size: kBufferSizeAlignment * 2, usage, mappedAtCreation }),\n      !isValid\n    );\n  });\n\nconst BufferUsage = GPUConst.BufferUsage;\n\ng.test('createBuffer_invalid_and_oom')\n  .desc(\n    `When creating a mappable buffer, it's expected that shmem may be immediately allocated\n(in the content process, before validation occurs in the GPU process). If the buffer is really\nlarge, though, it could fail shmem allocation before validation fails. Ensure that OOM error is\nhidden behind the \"more severe\" validation error.`\n  )\n  .paramsSubcasesOnly(u =>\n    u.combineWithParams([\n      { _valid: true, usage: BufferUsage.UNIFORM, size: 16 },\n      { _valid: true, usage: BufferUsage.STORAGE, size: 16 },\n      // Invalid because UNIFORM is not allowed with map usages.\n      { usage: BufferUsage.MAP_WRITE | BufferUsage.UNIFORM, size: 16 },\n      { usage: BufferUsage.MAP_WRITE | BufferUsage.UNIFORM, size: kMaxSafeMultipleOf8 },\n      { usage: BufferUsage.MAP_WRITE | BufferUsage.UNIFORM, size: 0x20_0000_0000 }, // 128 GiB\n      { usage: BufferUsage.MAP_READ | BufferUsage.UNIFORM, size: 16 },\n      { usage: BufferUsage.MAP_READ | BufferUsage.UNIFORM, size: kMaxSafeMultipleOf8 },\n      { usage: BufferUsage.MAP_READ | BufferUsage.UNIFORM, size: 0x20_0000_0000 }, // 128 GiB\n    ] as const)\n  )\n  .fn(t => {\n    const { _valid, usage, size } = t.params;\n\n    t.expectGPUError('validation', () => t.createBufferTracked({ size, usage }), !_valid);\n  });\n"],"mappings":"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"}