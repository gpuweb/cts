{"version":3,"sources":["../../../../../../src/webgpu/api/operation/resource_init/check_texture/by_ds_test.ts"],"names":["assert","virtualMipSize","makeFullscreenVertexModule","device","createShaderModule","code","getDepthTestEqualPipeline","t","format","sampleCount","expected","createRenderPipeline","vertex","entryPoint","module","fragment","targets","depthStencil","depthCompare","primitive","topology","multisample","count","getStencilTestEqualPipeline","stencilFront","compare","stencilBack","checkContents","type","params","texture","state","subresourceRange","dimension","viewDescriptor","generateTextureViewDescriptorsForRendering","aspect","baseMipLevel","undefined","width","height","textureWidth","textureHeight","renderTexture","createTexture","size","usage","GPUTextureUsage","RENDER_ATTACHMENT","COPY_SRC","resolveTexture","resolveTarget","createView","commandEncoder","createCommandEncoder","pass","beginRenderPass","colorAttachments","view","clearValue","loadOp","storeOp","depthStencilAttachment","depthStoreOp","depthLoadOp","stencilStoreOp","stencilLoadOp","expectedDepth","stateToTexelComponents","Depth","setPipeline","expectedStencil","Stencil","setStencilReference","draw","end","queue","submit","finish","expectSingleColor","exp","R","checkContentsByDepthTest","args","checkContentsByStencilTest"],"mappings":"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","sourcesContent":["import { assert } from '../../../../../common/util/util.js';\nimport { GPUTest } from '../../../../gpu_test.js';\nimport { virtualMipSize } from '../../../../util/texture/base.js';\nimport { CheckContents } from '../texture_zero.spec.js';\n\nfunction makeFullscreenVertexModule(device: GPUDevice) {\n  return device.createShaderModule({\n    code: `\n    @stage(vertex)\n    fn main(@builtin(vertex_index) VertexIndex : u32)\n         -> @builtin(position) vec4<f32> {\n      var pos : array<vec2<f32>, 3> = array<vec2<f32>, 3>(\n        vec2<f32>(-1.0, -3.0),\n        vec2<f32>( 3.0,  1.0),\n        vec2<f32>(-1.0,  1.0));\n      return vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n    }\n    `,\n  });\n}\n\nfunction getDepthTestEqualPipeline(\n  t: GPUTest,\n  format: GPUTextureFormat,\n  sampleCount: number,\n  expected: number\n): GPURenderPipeline {\n  return t.device.createRenderPipeline({\n    vertex: {\n      entryPoint: 'main',\n      module: makeFullscreenVertexModule(t.device),\n    },\n    fragment: {\n      entryPoint: 'main',\n      module: t.device.createShaderModule({\n        code: `\n        struct Outputs {\n          @builtin(frag_depth) FragDepth : f32,\n          @location(0) outSuccess : f32,\n        };\n\n        @stage(fragment)\n        fn main() -> Outputs {\n          var output : Outputs;\n          output.FragDepth = f32(${expected});\n          output.outSuccess = 1.0;\n          return output;\n        }\n        `,\n      }),\n      targets: [{ format: 'r8unorm' }],\n    },\n    depthStencil: {\n      format,\n      depthCompare: 'equal',\n    },\n    primitive: { topology: 'triangle-list' },\n    multisample: { count: sampleCount },\n  });\n}\n\nfunction getStencilTestEqualPipeline(\n  t: GPUTest,\n  format: GPUTextureFormat,\n  sampleCount: number\n): GPURenderPipeline {\n  return t.device.createRenderPipeline({\n    vertex: {\n      entryPoint: 'main',\n      module: makeFullscreenVertexModule(t.device),\n    },\n    fragment: {\n      entryPoint: 'main',\n      module: t.device.createShaderModule({\n        code: `\n        @stage(fragment)\n        fn main() -> @location(0) f32 {\n          return 1.0;\n        }\n        `,\n      }),\n      targets: [{ format: 'r8unorm' }],\n    },\n    depthStencil: {\n      format,\n      stencilFront: { compare: 'equal' },\n      stencilBack: { compare: 'equal' },\n    },\n    primitive: { topology: 'triangle-list' },\n    multisample: { count: sampleCount },\n  });\n}\n\nconst checkContents: (type: 'depth' | 'stencil', ...args: Parameters<CheckContents>) => void = (\n  type,\n  t,\n  params,\n  texture,\n  state,\n  subresourceRange\n) => {\n  assert(params.dimension === '2d');\n  for (const viewDescriptor of t.generateTextureViewDescriptorsForRendering(\n    params.aspect,\n    subresourceRange\n  )) {\n    assert(viewDescriptor.baseMipLevel !== undefined);\n    const [width, height] = virtualMipSize(\n      params.dimension,\n      [t.textureWidth, t.textureHeight, 1],\n      viewDescriptor.baseMipLevel\n    );\n\n    const renderTexture = t.device.createTexture({\n      size: [width, height, 1],\n      format: 'r8unorm',\n      usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n      sampleCount: params.sampleCount,\n    });\n\n    let resolveTexture = undefined;\n    let resolveTarget = undefined;\n    if (params.sampleCount > 1) {\n      resolveTexture = t.device.createTexture({\n        size: [width, height, 1],\n        format: 'r8unorm',\n        usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n      });\n      resolveTarget = resolveTexture.createView();\n    }\n\n    const commandEncoder = t.device.createCommandEncoder();\n    const pass = commandEncoder.beginRenderPass({\n      colorAttachments: [\n        {\n          view: renderTexture.createView(),\n          resolveTarget,\n          clearValue: [0, 0, 0, 0],\n          loadOp: 'load',\n          storeOp: 'store',\n        },\n      ],\n      depthStencilAttachment: {\n        view: texture.createView(viewDescriptor),\n        depthStoreOp: 'store',\n        depthLoadOp: 'load',\n        stencilStoreOp: 'store',\n        stencilLoadOp: 'load',\n      },\n    });\n\n    switch (type) {\n      case 'depth': {\n        const expectedDepth = t.stateToTexelComponents[state].Depth;\n        assert(expectedDepth !== undefined);\n\n        pass.setPipeline(\n          getDepthTestEqualPipeline(t, params.format, params.sampleCount, expectedDepth)\n        );\n        break;\n      }\n\n      case 'stencil': {\n        const expectedStencil = t.stateToTexelComponents[state].Stencil;\n        assert(expectedStencil !== undefined);\n\n        pass.setPipeline(getStencilTestEqualPipeline(t, params.format, params.sampleCount));\n        pass.setStencilReference(expectedStencil);\n        break;\n      }\n    }\n\n    pass.draw(3);\n    pass.end();\n\n    t.queue.submit([commandEncoder.finish()]);\n\n    t.expectSingleColor(resolveTexture || renderTexture, 'r8unorm', {\n      size: [width, height, 1],\n      exp: { R: 1 },\n    });\n  }\n};\n\nexport const checkContentsByDepthTest = (...args: Parameters<CheckContents>) =>\n  checkContents('depth', ...args);\n\nexport const checkContentsByStencilTest = (...args: Parameters<CheckContents>) =>\n  checkContents('stencil', ...args);\n"],"file":"by_ds_test.js"}