{"version":3,"file":"by_sampling.js","names":["assert","unreachable","kTextureFormatInfo","virtualMipSize","kTexelRepresentationInfo","getSingleDataType","getComponentReadbackTraits","checkContentsBySampling","t","params","texture","state","subresourceRange","format","rep","level","layers","mipLevels","width","height","depth","dimension","textureWidth","textureHeight","textureDepth","ReadbackTypedArray","shaderType","componentOrder","componentCount","length","indexExpression","toLowerCase","map","c","join","_xd","_multisampled","sampleCount","texelIndexExpression","computePipeline","device","createComputePipeline","layout","compute","entryPoint","module","createShaderModule","code","layer","ubo","createBuffer","mappedAtCreation","size","usage","GPUBufferUsage","UNIFORM","COPY_DST","Int32Array","getMappedRange","unmap","byteLength","BYTES_PER_ELEMENT","resultBuffer","STORAGE","COPY_SRC","trackForCleanup","bindGroup","createBindGroup","getBindGroupLayout","entries","binding","resource","buffer","createView","baseArrayLayer","arrayLayerCount","commandEncoder","createCommandEncoder","pass","beginComputePass","setPipeline","setBindGroup","dispatchWorkgroups","end","queue","submit","finish","destroy","expectedValues","ArrayBuffer","expectedState","stateToTexelComponents","i","d","h","w","value","undefined","expectGPUBufferValuesEqual"],"sources":["../../../../../../src/webgpu/api/operation/resource_init/check_texture/by_sampling.ts"],"sourcesContent":["import { assert, unreachable } from '../../../../../common/util/util.js';\nimport { EncodableTextureFormat, kTextureFormatInfo } from '../../../../capability_info.js';\nimport { virtualMipSize } from '../../../../util/texture/base.js';\nimport {\n  kTexelRepresentationInfo,\n  getSingleDataType,\n  getComponentReadbackTraits,\n} from '../../../../util/texture/texel_data.js';\nimport { CheckContents } from '../texture_zero.spec.js';\n\nexport const checkContentsBySampling: CheckContents = (\n  t,\n  params,\n  texture,\n  state,\n  subresourceRange\n) => {\n  assert(params.format in kTextureFormatInfo);\n  const format = params.format as EncodableTextureFormat;\n  const rep = kTexelRepresentationInfo[format];\n\n  for (const { level, layers } of subresourceRange.mipLevels()) {\n    const [width, height, depth] = virtualMipSize(\n      params.dimension,\n      [t.textureWidth, t.textureHeight, t.textureDepth],\n      level\n    );\n\n    const { ReadbackTypedArray, shaderType } = getComponentReadbackTraits(\n      getSingleDataType(format)\n    );\n\n    const componentOrder = rep.componentOrder;\n    const componentCount = componentOrder.length;\n\n    // For single-component textures, generates .r\n    // For multi-component textures, generates ex.)\n    //  .rgba[i], .bgra[i], .rgb[i]\n    const indexExpression =\n      componentCount === 1\n        ? componentOrder[0].toLowerCase()\n        : componentOrder.map(c => c.toLowerCase()).join('') + '[i]';\n\n    const _xd = '_' + params.dimension;\n    const _multisampled = params.sampleCount > 1 ? '_multisampled' : '';\n    const texelIndexExpression =\n      params.dimension === '2d'\n        ? 'vec2<i32>(GlobalInvocationID.xy)'\n        : params.dimension === '3d'\n        ? 'vec3<i32>(GlobalInvocationID.xyz)'\n        : params.dimension === '1d'\n        ? 'i32(GlobalInvocationID.x)'\n        : unreachable();\n    const computePipeline = t.device.createComputePipeline({\n      layout: 'auto',\n      compute: {\n        entryPoint: 'main',\n        module: t.device.createShaderModule({\n          code: `\n            struct Constants {\n              level : i32\n            };\n\n            @group(0) @binding(0) var<uniform> constants : Constants;\n            @group(0) @binding(1) var myTexture : texture${_multisampled}${_xd}<${shaderType}>;\n\n            struct Result {\n              values : array<${shaderType}>\n            };\n            @group(0) @binding(3) var<storage, read_write> result : Result;\n\n            @compute @workgroup_size(1)\n            fn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {\n              let flatIndex : u32 = ${componentCount}u * (\n                ${width}u * ${height}u * GlobalInvocationID.z +\n                ${width}u * GlobalInvocationID.y +\n                GlobalInvocationID.x\n              );\n              let texel : vec4<${shaderType}> = textureLoad(\n                myTexture, ${texelIndexExpression}, constants.level);\n\n              for (var i : u32 = 0u; i < ${componentCount}u; i = i + 1u) {\n                result.values[flatIndex + i] = texel.${indexExpression};\n              }\n            }`,\n        }),\n      },\n    });\n\n    for (const layer of layers) {\n      const ubo = t.device.createBuffer({\n        mappedAtCreation: true,\n        size: 4,\n        usage: GPUBufferUsage.UNIFORM | GPUBufferUsage.COPY_DST,\n      });\n      new Int32Array(ubo.getMappedRange(), 0, 1)[0] = level;\n      ubo.unmap();\n\n      const byteLength =\n        width * height * depth * ReadbackTypedArray.BYTES_PER_ELEMENT * rep.componentOrder.length;\n      const resultBuffer = t.device.createBuffer({\n        size: byteLength,\n        usage: GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC,\n      });\n      t.trackForCleanup(resultBuffer);\n\n      const bindGroup = t.device.createBindGroup({\n        layout: computePipeline.getBindGroupLayout(0),\n        entries: [\n          {\n            binding: 0,\n            resource: { buffer: ubo },\n          },\n          {\n            binding: 1,\n            resource: texture.createView({\n              baseArrayLayer: layer,\n              arrayLayerCount: 1,\n              dimension: params.dimension,\n            }),\n          },\n          {\n            binding: 3,\n            resource: {\n              buffer: resultBuffer,\n            },\n          },\n        ],\n      });\n\n      const commandEncoder = t.device.createCommandEncoder();\n      const pass = commandEncoder.beginComputePass();\n      pass.setPipeline(computePipeline);\n      pass.setBindGroup(0, bindGroup);\n      pass.dispatchWorkgroups(width, height, depth);\n      pass.end();\n      t.queue.submit([commandEncoder.finish()]);\n      ubo.destroy();\n\n      const expectedValues = new ReadbackTypedArray(new ArrayBuffer(byteLength));\n      const expectedState = t.stateToTexelComponents[state];\n      let i = 0;\n      for (let d = 0; d < depth; ++d) {\n        for (let h = 0; h < height; ++h) {\n          for (let w = 0; w < width; ++w) {\n            for (const c of rep.componentOrder) {\n              const value = expectedState[c];\n              assert(value !== undefined);\n              expectedValues[i++] = value;\n            }\n          }\n        }\n      }\n      t.expectGPUBufferValuesEqual(resultBuffer, expectedValues);\n    }\n  }\n};\n"],"mappings":";AAAA;AAAA,GAAA,SAASA,MAAM,EAAEC,WAAW,QAAQ,oCAAoC,CACxE,SAAiCC,kBAAkB,QAAQ,gCAAgC,CAC3F,SAASC,cAAc,QAAQ,kCAAkC;AACjE;AACEC,wBAAwB;AACxBC,iBAAiB;AACjBC,0BAA0B;AACrB,wCAAwC;;;AAG/C,OAAO,MAAMC,uBAAsC,GAAG;AACpDC,CAAC;AACDC,MAAM;AACNC,OAAO;AACPC,KAAK;AACLC,gBAAgB;AACb;EACHZ,MAAM,CAACS,MAAM,CAACI,MAAM,IAAIX,kBAAkB,CAAC;EAC3C,MAAMW,MAAM,GAAGJ,MAAM,CAACI,MAAgC;EACtD,MAAMC,GAAG,GAAGV,wBAAwB,CAACS,MAAM,CAAC;;EAE5C,KAAK,MAAM,EAAEE,KAAK,EAAEC,MAAM,CAAC,CAAC,IAAIJ,gBAAgB,CAACK,SAAS,EAAE,EAAE;IAC5D,MAAM,CAACC,KAAK,EAAEC,MAAM,EAAEC,KAAK,CAAC,GAAGjB,cAAc;IAC3CM,MAAM,CAACY,SAAS;IAChB,CAACb,CAAC,CAACc,YAAY,EAAEd,CAAC,CAACe,aAAa,EAAEf,CAAC,CAACgB,YAAY,CAAC;IACjDT,KAAK,CACN;;;IAED,MAAM,EAAEU,kBAAkB,EAAEC,UAAU,CAAC,CAAC,GAAGpB,0BAA0B;IACnED,iBAAiB,CAACQ,MAAM,CAAC,CAC1B;;;IAED,MAAMc,cAAc,GAAGb,GAAG,CAACa,cAAc;IACzC,MAAMC,cAAc,GAAGD,cAAc,CAACE,MAAM;;IAE5C;IACA;IACA;IACA,MAAMC,eAAe;IACnBF,cAAc,KAAK,CAAC;IAChBD,cAAc,CAAC,CAAC,CAAC,CAACI,WAAW,EAAE;IAC/BJ,cAAc,CAACK,GAAG,CAAC,CAAAC,CAAC,KAAIA,CAAC,CAACF,WAAW,EAAE,CAAC,CAACG,IAAI,CAAC,EAAE,CAAC,GAAG,KAAK;;IAE/D,MAAMC,GAAG,GAAG,GAAG,GAAG1B,MAAM,CAACY,SAAS;IAClC,MAAMe,aAAa,GAAG3B,MAAM,CAAC4B,WAAW,GAAG,CAAC,GAAG,eAAe,GAAG,EAAE;IACnE,MAAMC,oBAAoB;IACxB7B,MAAM,CAACY,SAAS,KAAK,IAAI;IACrB,kCAAkC;IAClCZ,MAAM,CAACY,SAAS,KAAK,IAAI;IACzB,mCAAmC;IACnCZ,MAAM,CAACY,SAAS,KAAK,IAAI;IACzB,2BAA2B;IAC3BpB,WAAW,EAAE;IACnB,MAAMsC,eAAe,GAAG/B,CAAC,CAACgC,MAAM,CAACC,qBAAqB,CAAC;MACrDC,MAAM,EAAE,MAAM;MACdC,OAAO,EAAE;QACPC,UAAU,EAAE,MAAM;QAClBC,MAAM,EAAErC,CAAC,CAACgC,MAAM,CAACM,kBAAkB,CAAC;UAClCC,IAAI,EAAG;AACjB;AACA;AACA;AACA;AACA;AACA,2DAA2DX,aAAc,GAAED,GAAI,IAAGT,UAAW;AAC7F;AACA;AACA,+BAA+BA,UAAW;AAC1C;AACA;AACA;AACA;AACA;AACA,sCAAsCE,cAAe;AACrD,kBAAkBV,KAAM,OAAMC,MAAO;AACrC,kBAAkBD,KAAM;AACxB;AACA;AACA,iCAAiCQ,UAAW;AAC5C,6BAA6BY,oBAAqB;AAClD;AACA,2CAA2CV,cAAe;AAC1D,uDAAuDE,eAAgB;AACvE;AACA;QACQ,CAAC;MACH;IACF,CAAC,CAAC;;IAEF,KAAK,MAAMkB,KAAK,IAAIhC,MAAM,EAAE;MAC1B,MAAMiC,GAAG,GAAGzC,CAAC,CAACgC,MAAM,CAACU,YAAY,CAAC;QAChCC,gBAAgB,EAAE,IAAI;QACtBC,IAAI,EAAE,CAAC;QACPC,KAAK,EAAEC,cAAc,CAACC,OAAO,GAAGD,cAAc,CAACE;MACjD,CAAC,CAAC;MACF,IAAIC,UAAU,CAACR,GAAG,CAACS,cAAc,EAAE,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG3C,KAAK;MACrDkC,GAAG,CAACU,KAAK,EAAE;;MAEX,MAAMC,UAAU;MACd1C,KAAK,GAAGC,MAAM,GAAGC,KAAK,GAAGK,kBAAkB,CAACoC,iBAAiB,GAAG/C,GAAG,CAACa,cAAc,CAACE,MAAM;MAC3F,MAAMiC,YAAY,GAAGtD,CAAC,CAACgC,MAAM,CAACU,YAAY,CAAC;QACzCE,IAAI,EAAEQ,UAAU;QAChBP,KAAK,EAAEC,cAAc,CAACS,OAAO,GAAGT,cAAc,CAACU;MACjD,CAAC,CAAC;MACFxD,CAAC,CAACyD,eAAe,CAACH,YAAY,CAAC;;MAE/B,MAAMI,SAAS,GAAG1D,CAAC,CAACgC,MAAM,CAAC2B,eAAe,CAAC;QACzCzB,MAAM,EAAEH,eAAe,CAAC6B,kBAAkB,CAAC,CAAC,CAAC;QAC7CC,OAAO,EAAE;QACP;UACEC,OAAO,EAAE,CAAC;UACVC,QAAQ,EAAE,EAAEC,MAAM,EAAEvB,GAAG,CAAC;QAC1B,CAAC;QACD;UACEqB,OAAO,EAAE,CAAC;UACVC,QAAQ,EAAE7D,OAAO,CAAC+D,UAAU,CAAC;YAC3BC,cAAc,EAAE1B,KAAK;YACrB2B,eAAe,EAAE,CAAC;YAClBtD,SAAS,EAAEZ,MAAM,CAACY;UACpB,CAAC;QACH,CAAC;QACD;UACEiD,OAAO,EAAE,CAAC;UACVC,QAAQ,EAAE;YACRC,MAAM,EAAEV;UACV;QACF,CAAC;;MAEL,CAAC,CAAC;;MAEF,MAAMc,cAAc,GAAGpE,CAAC,CAACgC,MAAM,CAACqC,oBAAoB,EAAE;MACtD,MAAMC,IAAI,GAAGF,cAAc,CAACG,gBAAgB,EAAE;MAC9CD,IAAI,CAACE,WAAW,CAACzC,eAAe,CAAC;MACjCuC,IAAI,CAACG,YAAY,CAAC,CAAC,EAAEf,SAAS,CAAC;MAC/BY,IAAI,CAACI,kBAAkB,CAAChE,KAAK,EAAEC,MAAM,EAAEC,KAAK,CAAC;MAC7C0D,IAAI,CAACK,GAAG,EAAE;MACV3E,CAAC,CAAC4E,KAAK,CAACC,MAAM,CAAC,CAACT,cAAc,CAACU,MAAM,EAAE,CAAC,CAAC;MACzCrC,GAAG,CAACsC,OAAO,EAAE;;MAEb,MAAMC,cAAc,GAAG,IAAI/D,kBAAkB,CAAC,IAAIgE,WAAW,CAAC7B,UAAU,CAAC,CAAC;MAC1E,MAAM8B,aAAa,GAAGlF,CAAC,CAACmF,sBAAsB,CAAChF,KAAK,CAAC;MACrD,IAAIiF,CAAC,GAAG,CAAC;MACT,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGzE,KAAK,EAAE,EAAEyE,CAAC,EAAE;QAC9B,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAG3E,MAAM,EAAE,EAAE2E,CAAC,EAAE;UAC/B,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAG7E,KAAK,EAAE,EAAE6E,CAAC,EAAE;YAC9B,KAAK,MAAM9D,CAAC,IAAInB,GAAG,CAACa,cAAc,EAAE;cAClC,MAAMqE,KAAK,GAAGN,aAAa,CAACzD,CAAC,CAAC;cAC9BjC,MAAM,CAACgG,KAAK,KAAKC,SAAS,CAAC;cAC3BT,cAAc,CAACI,CAAC,EAAE,CAAC,GAAGI,KAAK;YAC7B;UACF;QACF;MACF;MACAxF,CAAC,CAAC0F,0BAA0B,CAACpC,YAAY,EAAE0B,cAAc,CAAC;IAC5D;EACF;AACF,CAAC"}