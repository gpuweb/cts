{"version":3,"sources":["../../../../../src/webgpu/api/operation/render_pipeline/culling_tests.spec.ts"],"names":["description","makeTestGroup","GPUTest","faceIsCulled","face","frontFace","cullMode","faceColor","isCulled","Uint8Array","g","test","desc","params","u","combine","beginSubcases","fn","t","size","format","texture","device","createTexture","width","height","depthOrArrayLayers","usage","GPUTextureUsage","RENDER_ATTACHMENT","COPY_SRC","depthTexture","depthStencilFormat","encoder","createCommandEncoder","pass","beginRenderPass","colorAttachments","view","createView","loadValue","r","b","a","storeOp","depthStencilAttachment","depthLoadValue","depthStoreOp","stencilLoadValue","stencilStoreOp","undefined","setPipeline","createRenderPipeline","vertex","module","createShaderModule","code","entryPoint","fragment","targets","primitive","topology","primitiveTopology","depthStencil","draw","endPass","queue","submit","finish","kCCWTriangleTopLeftColor","expectSinglePixelIn2DTexture","x","y","exp","kCWTriangleBottomRightColor"],"mappings":"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","sourcesContent":["export const description = `Test culling and rasterizaion state.\n\nTest coverage:\nTest all culling combinations of GPUFrontFace and GPUCullMode show the correct output.\n\nUse 2 triangles with different winding orders:\n\n- Test that the counter-clock wise triangle has correct output for:\n  - All FrontFaces (ccw, cw)\n  - All CullModes (none, front, back)\n  - All depth stencil attachment types (none, depth24plus, depth32float, depth24plus-stencil8)\n  - Some primitive topologies (triangle-list, TODO: triangle-strip)\n\n- Test that the clock wise triangle has correct output for:\n  - All FrontFaces (ccw, cw)\n  - All CullModes (none, front, back)\n  - All depth stencil attachment types (none, depth24plus, depth32float, depth24plus-stencil8)\n  - Some primitive topologies (triangle-list, TODO: triangle-strip)\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { GPUTest } from '../../../gpu_test.js';\n\nfunction faceIsCulled(face: 'cw' | 'ccw', frontFace: GPUFrontFace, cullMode: GPUCullMode): boolean {\n  return cullMode !== 'none' && (frontFace === face) === (cullMode === 'front');\n}\n\nfunction faceColor(face: 'cw' | 'ccw', frontFace: GPUFrontFace, cullMode: GPUCullMode): Uint8Array {\n  // front facing color is green, non front facing is red, background is blue\n  const isCulled = faceIsCulled(face, frontFace, cullMode);\n  if (!isCulled && face === frontFace) {\n    return new Uint8Array([0x00, 0xff, 0x00, 0xff]);\n  } else if (isCulled) {\n    return new Uint8Array([0x00, 0x00, 0xff, 0xff]);\n  } else {\n    return new Uint8Array([0xff, 0x00, 0x00, 0xff]);\n  }\n}\n\nexport const g = makeTestGroup(GPUTest);\n\ng.test('culling')\n  .desc(\n    `\nTODO: test triangle-strip as well [1]\nTODO: check the contents of the depth and stencil outputs [2]\n`\n  )\n  .params(\n    u =>\n      u\n        .combine('frontFace', ['ccw', 'cw'] as const)\n        .combine('cullMode', ['none', 'front', 'back'] as const)\n        .beginSubcases()\n        .combine('depthStencilFormat', [\n          null,\n          'depth24plus',\n          'depth32float',\n          'depth24plus-stencil8',\n        ] as const)\n        .combine('primitiveTopology', ['triangle-list'] as const) // [1]\n  )\n  .fn(t => {\n    const size = 4;\n    const format = 'rgba8unorm';\n\n    const texture = t.device.createTexture({\n      size: { width: size, height: size, depthOrArrayLayers: 1 },\n      format,\n      usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n    });\n\n    const depthTexture = t.params.depthStencilFormat\n      ? t.device.createTexture({\n          size: { width: size, height: size, depthOrArrayLayers: 1 },\n          format: t.params.depthStencilFormat,\n          usage: GPUTextureUsage.RENDER_ATTACHMENT,\n        })\n      : null;\n\n    const encoder = t.device.createCommandEncoder();\n    const pass = encoder.beginRenderPass({\n      colorAttachments: [\n        {\n          view: texture.createView(),\n          loadValue: { r: 0.0, g: 0.0, b: 1.0, a: 1.0 },\n          storeOp: 'store',\n        },\n      ],\n      depthStencilAttachment: depthTexture\n        ? {\n            view: depthTexture.createView(),\n            depthLoadValue: 1.0,\n            depthStoreOp: 'store',\n            stencilLoadValue: 0,\n            stencilStoreOp: 'store',\n          }\n        : undefined,\n    });\n\n    // Draw two triangles with different winding orders:\n    // 1. The top-left one is counterclockwise (CCW)\n    // 2. The bottom-right one is clockwise (CW)\n    pass.setPipeline(\n      t.device.createRenderPipeline({\n        vertex: {\n          module: t.device.createShaderModule({\n            code: `\n              [[stage(vertex)]] fn main(\n                [[builtin(vertex_index)]] VertexIndex : u32\n                ) -> [[builtin(position)]] vec4<f32> {\n                var pos : array<vec2<f32>, 6> = array<vec2<f32>, 6>(\n                    vec2<f32>(-1.0,  1.0),\n                    vec2<f32>(-1.0,  0.0),\n                    vec2<f32>( 0.0,  1.0),\n                    vec2<f32>( 0.0, -1.0),\n                    vec2<f32>( 1.0,  0.0),\n                    vec2<f32>( 1.0, -1.0));\n                return vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n              }`,\n          }),\n          entryPoint: 'main',\n        },\n        fragment: {\n          module: t.device.createShaderModule({\n            code: `\n              [[stage(fragment)]] fn main(\n                [[builtin(front_facing)]] FrontFacing : bool\n                ) -> [[location(0)]] vec4<f32> {\n                var color : vec4<f32>;\n                if (FrontFacing) {\n                  color = vec4<f32>(0.0, 1.0, 0.0, 1.0);\n                } else {\n                  color = vec4<f32>(1.0, 0.0, 0.0, 1.0);\n                }\n                return color;\n              }`,\n          }),\n          entryPoint: 'main',\n          targets: [{ format }],\n        },\n        primitive: {\n          topology: t.params.primitiveTopology,\n          frontFace: t.params.frontFace,\n          cullMode: t.params.cullMode,\n        },\n        depthStencil: depthTexture\n          ? { format: t.params.depthStencilFormat as GPUTextureFormat }\n          : undefined,\n      })\n    );\n\n    pass.draw(6, 1, 0, 0);\n    pass.endPass();\n\n    t.device.queue.submit([encoder.finish()]);\n\n    // front facing color is green, non front facing is red, background is blue\n    const kCCWTriangleTopLeftColor = faceColor('ccw', t.params.frontFace, t.params.cullMode);\n    t.expectSinglePixelIn2DTexture(\n      texture,\n      format,\n      { x: 0, y: 0 },\n      { exp: kCCWTriangleTopLeftColor }\n    );\n\n    const kCWTriangleBottomRightColor = faceColor('cw', t.params.frontFace, t.params.cullMode);\n    t.expectSinglePixelIn2DTexture(\n      texture,\n      format,\n      { x: size - 1, y: size - 1 },\n      { exp: kCWTriangleBottomRightColor }\n    );\n    // [2]: check the contents of the depth and stencil outputs\n  });\n"],"file":"culling_tests.spec.js"}