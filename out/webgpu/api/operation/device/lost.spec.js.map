{"version":3,"file":"lost.spec.js","names":["description","Fixture","makeTestGroup","attemptGarbageCollection","getGPU","assert","assertNotSettledWithinTime","raceWithRejectOnTimeout","DeviceLostTests","kDeviceLostTimeoutMS","getDeviceLostWithTimeout","lost","expectDeviceDestroyed","device","eventualAsyncExpectation","niceStack","expect","reason","ex","message","rec","expectationFailed","g","test","desc","fn","t","adapter","requestAdapter","requestDevice","destroy","lostPromise1","lostPromise2","lostPromise3","lost1","lost2","lost3","lostPromise4","lost4"],"sources":["../../../../../src/webgpu/api/operation/device/lost.spec.ts"],"sourcesContent":["export const description = `\nTests for GPUDevice.lost.\n`;\n\nimport { Fixture } from '../../../../common/framework/fixture.js';\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { attemptGarbageCollection } from '../../../../common/util/collect_garbage.js';\nimport { getGPU } from '../../../../common/util/navigator_gpu.js';\nimport {\n  assert,\n  assertNotSettledWithinTime,\n  raceWithRejectOnTimeout,\n} from '../../../../common/util/util.js';\n\nclass DeviceLostTests extends Fixture {\n  // Default timeout for waiting for device lost is 2 seconds.\n  readonly kDeviceLostTimeoutMS = 2000;\n\n  getDeviceLostWithTimeout(lost: Promise<GPUDeviceLostInfo>): Promise<GPUDeviceLostInfo> {\n    return raceWithRejectOnTimeout(lost, this.kDeviceLostTimeoutMS, 'device was not lost');\n  }\n\n  expectDeviceDestroyed(device: GPUDevice): void {\n    this.eventualAsyncExpectation(async niceStack => {\n      try {\n        const lost = await this.getDeviceLostWithTimeout(device.lost);\n        this.expect(lost.reason === 'destroyed', 'device was lost from destroy');\n      } catch (ex) {\n        niceStack.message = 'device was not lost';\n        this.rec.expectationFailed(niceStack);\n      }\n    });\n  }\n}\n\nexport const g = makeTestGroup(DeviceLostTests);\n\ng.test('not_lost_on_gc')\n  .desc(\n    `'lost' is never resolved by GPUDevice being garbage collected (with attemptGarbageCollection).`\n  )\n  .fn(async t => {\n    // Wraps a lost promise object creation in a function scope so that the device has the best\n    // chance of being gone and ready for GC before trying to resolve the lost promise.\n    const { lost } = await (async () => {\n      const adapter = await getGPU(t.rec).requestAdapter();\n      assert(adapter !== null);\n      const lost = (await adapter.requestDevice()).lost;\n      return { lost };\n    })();\n    await assertNotSettledWithinTime(lost, t.kDeviceLostTimeoutMS, 'device was unexpectedly lost');\n\n    await attemptGarbageCollection();\n  });\n\ng.test('lost_on_destroy')\n  .desc(`'lost' is resolved, with reason='destroyed', on GPUDevice.destroy().`)\n  .fn(async t => {\n    const adapter = await getGPU(t.rec).requestAdapter();\n    assert(adapter !== null);\n    const device: GPUDevice = await adapter.requestDevice();\n    t.expectDeviceDestroyed(device);\n    device.destroy();\n  });\n\ng.test('same_object')\n  .desc(`'lost' provides the same Promise and GPUDeviceLostInfo objects each time it's accessed.`)\n  .fn(async t => {\n    const adapter = await getGPU(t.rec).requestAdapter();\n    assert(adapter !== null);\n    const device: GPUDevice = await adapter.requestDevice();\n\n    // The promises should be the same promise object.\n    const lostPromise1 = device.lost;\n    const lostPromise2 = device.lost;\n    t.expect(lostPromise1 === lostPromise2);\n\n    // Promise object should still be the same after destroy.\n    device.destroy();\n    const lostPromise3 = device.lost;\n    t.expect(lostPromise1 === lostPromise3);\n\n    // The results should also be the same result object.\n    const lost1 = await t.getDeviceLostWithTimeout(lostPromise1);\n    const lost2 = await t.getDeviceLostWithTimeout(lostPromise2);\n    const lost3 = await t.getDeviceLostWithTimeout(lostPromise3);\n    // Promise object should still be the same after we've been notified about device loss.\n    const lostPromise4 = device.lost;\n    t.expect(lostPromise1 === lostPromise4);\n    const lost4 = await t.getDeviceLostWithTimeout(lostPromise4);\n    t.expect(lost1 === lost2 && lost2 === lost3 && lost3 === lost4);\n  });\n"],"mappings":"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"}