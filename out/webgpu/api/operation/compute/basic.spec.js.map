{"version":3,"file":"basic.spec.js","names":["description","makeTestGroup","kLimitInfo","GPUTest","checkElementsEqualGenerated","g","kMaxComputeWorkgroupSize","maxComputeWorkgroupSizeX","default","maxComputeWorkgroupSizeY","maxComputeWorkgroupSizeZ","test","fn","t","data","Uint32Array","src","makeBufferWithContents","GPUBufferUsage","COPY_DST","STORAGE","dst","device","createBuffer","size","usage","COPY_SRC","pipeline","createComputePipeline","layout","compute","module","createShaderModule","code","entryPoint","bg","createBindGroup","entries","binding","resource","buffer","offset","getBindGroupLayout","encoder","createCommandEncoder","pass","beginComputePass","setPipeline","setBindGroup","dispatchWorkgroups","end","queue","submit","finish","expectGPUBufferValuesEqual","desc","params","u","combine","maxComputeWorkgroupsPerDimension","beginSubcases","expand","p","largeDimension","val","badVal","wgSize","workgroupSize","bufferLength","dispatchSize","bufferByteSize","BYTES_PER_ELEMENT","dims","wgSizes","expectGPUBufferValuesPassCheck","a","i","type","typedLength","destroy"],"sources":["../../../../../src/webgpu/api/operation/compute/basic.spec.ts"],"sourcesContent":["export const description = `\nBasic command buffer compute tests.\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { kLimitInfo } from '../../../capability_info.js';\nimport { GPUTest } from '../../../gpu_test.js';\nimport { checkElementsEqualGenerated } from '../../../util/check_contents.js';\n\nexport const g = makeTestGroup(GPUTest);\n\nconst kMaxComputeWorkgroupSize = [\n  kLimitInfo.maxComputeWorkgroupSizeX.default,\n  kLimitInfo.maxComputeWorkgroupSizeY.default,\n  kLimitInfo.maxComputeWorkgroupSizeZ.default,\n];\n\ng.test('memcpy').fn(async t => {\n  const data = new Uint32Array([0x01020304]);\n\n  const src = t.makeBufferWithContents(data, GPUBufferUsage.COPY_DST | GPUBufferUsage.STORAGE);\n\n  const dst = t.device.createBuffer({\n    size: 4,\n    usage: GPUBufferUsage.COPY_SRC | GPUBufferUsage.STORAGE,\n  });\n\n  const pipeline = t.device.createComputePipeline({\n    layout: 'auto',\n    compute: {\n      module: t.device.createShaderModule({\n        code: `\n          struct Data {\n            value : u32\n          };\n\n          @group(0) @binding(0) var<storage, read> src : Data;\n          @group(0) @binding(1) var<storage, read_write> dst : Data;\n\n          @compute @workgroup_size(1) fn main() {\n            dst.value = src.value;\n            return;\n          }\n        `,\n      }),\n      entryPoint: 'main',\n    },\n  });\n\n  const bg = t.device.createBindGroup({\n    entries: [\n      { binding: 0, resource: { buffer: src, offset: 0, size: 4 } },\n      { binding: 1, resource: { buffer: dst, offset: 0, size: 4 } },\n    ],\n    layout: pipeline.getBindGroupLayout(0),\n  });\n\n  const encoder = t.device.createCommandEncoder();\n  const pass = encoder.beginComputePass();\n  pass.setPipeline(pipeline);\n  pass.setBindGroup(0, bg);\n  pass.dispatchWorkgroups(1);\n  pass.end();\n  t.device.queue.submit([encoder.finish()]);\n\n  t.expectGPUBufferValuesEqual(dst, data);\n});\n\ng.test('large_dispatch')\n  .desc(`Test reasonably-sized large dispatches (see also: stress tests).`)\n  .params(u =>\n    u\n      // Reasonably-sized powers of two, and some stranger larger sizes.\n      .combine('dispatchSize', [\n        256,\n        2048,\n        315,\n        628,\n        2179,\n        kLimitInfo.maxComputeWorkgroupsPerDimension.default,\n      ])\n      // Test some reasonable workgroup sizes.\n      .beginSubcases()\n      // 0 == x axis; 1 == y axis; 2 == z axis.\n      .combine('largeDimension', [0, 1, 2] as const)\n      .expand('workgroupSize', p => [1, 2, 8, 32, kMaxComputeWorkgroupSize[p.largeDimension]])\n  )\n  .fn(async t => {\n    // The output storage buffer is filled with this value.\n    const val = 0x01020304;\n    const badVal = 0xbaadf00d;\n\n    const wgSize = t.params.workgroupSize;\n    const bufferLength = t.params.dispatchSize * wgSize;\n    const bufferByteSize = Uint32Array.BYTES_PER_ELEMENT * bufferLength;\n    const dst = t.device.createBuffer({\n      size: bufferByteSize,\n      usage: GPUBufferUsage.COPY_SRC | GPUBufferUsage.STORAGE,\n    });\n\n    // Only use one large dimension and workgroup size in the dispatch\n    // call to keep the size of the test reasonable.\n    const dims = [1, 1, 1];\n    dims[t.params.largeDimension] = t.params.dispatchSize;\n    const wgSizes = [1, 1, 1];\n    wgSizes[t.params.largeDimension] = t.params.workgroupSize;\n    const pipeline = t.device.createComputePipeline({\n      layout: 'auto',\n      compute: {\n        module: t.device.createShaderModule({\n          code: `\n            struct OutputBuffer {\n              value : array<u32>\n            };\n\n            @group(0) @binding(0) var<storage, read_write> dst : OutputBuffer;\n\n            @compute @workgroup_size(${wgSizes[0]}, ${wgSizes[1]}, ${wgSizes[2]})\n            fn main(\n              @builtin(global_invocation_id) GlobalInvocationID : vec3<u32>\n            ) {\n              var xExtent : u32 = ${dims[0]}u * ${wgSizes[0]}u;\n              var yExtent : u32 = ${dims[1]}u * ${wgSizes[1]}u;\n              var zExtent : u32 = ${dims[2]}u * ${wgSizes[2]}u;\n              var index : u32 = (\n                GlobalInvocationID.z * xExtent * yExtent +\n                GlobalInvocationID.y * xExtent +\n                GlobalInvocationID.x);\n              var val : u32 = ${val}u;\n              // Trivial error checking in the indexing and invocation.\n              if (GlobalInvocationID.x > xExtent ||\n                  GlobalInvocationID.y > yExtent ||\n                  GlobalInvocationID.z > zExtent) {\n                val = ${badVal}u;\n              }\n              dst.value[index] = val;\n            }\n          `,\n        }),\n        entryPoint: 'main',\n      },\n    });\n\n    const bg = t.device.createBindGroup({\n      entries: [{ binding: 0, resource: { buffer: dst, offset: 0, size: bufferByteSize } }],\n      layout: pipeline.getBindGroupLayout(0),\n    });\n\n    const encoder = t.device.createCommandEncoder();\n    const pass = encoder.beginComputePass();\n    pass.setPipeline(pipeline);\n    pass.setBindGroup(0, bg);\n    pass.dispatchWorkgroups(dims[0], dims[1], dims[2]);\n    pass.end();\n    t.device.queue.submit([encoder.finish()]);\n\n    t.expectGPUBufferValuesPassCheck(dst, a => checkElementsEqualGenerated(a, i => val), {\n      type: Uint32Array,\n      typedLength: bufferLength,\n    });\n\n    dst.destroy();\n  });\n"],"mappings":"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"}