{"version":3,"file":"requestAdapter.spec.js","names":["description","Fixture","makeTestGroup","getGPU","assert","objectEquals","iterRange","g","powerPreferenceModes","undefined","forceFallbackOptions","validFeatureLevels","invalidFeatureLevels","testAdapter","t","adapter","device","requestDeviceTracked","kOffset","pipeline","createComputePipeline","layout","compute","module","createShaderModule","code","entryPoint","kNumElements","kBufferSize","buffer","trackForCleanup","createBuffer","size","usage","GPUBufferUsage","STORAGE","COPY_SRC","resultBuffer","MAP_READ","COPY_DST","bindGroup","createBindGroup","getBindGroupLayout","entries","binding","resource","encoder","createCommandEncoder","pass","beginComputePass","setPipeline","setBindGroup","dispatchWorkgroups","end","copyBufferToBuffer","queue","submit","finish","expected","Uint32Array","x","mapAsync","GPUMapMode","READ","actual","getMappedRange","destroy","test","desc","params","u","combine","fn","powerPreference","forceFallbackAdapter","rec","requestAdapter","expect","skip","info","isFallbackAdapter","Boolean","featureLevel","includes"],"sources":["../../../../../src/webgpu/api/operation/adapter/requestAdapter.spec.ts"],"sourcesContent":["export const description = `\nTests for GPU.requestAdapter.\n\nTest all possible options to requestAdapter.\ndefault, low-power, and high performance should all always return adapters.\nforceFallbackAdapter may or may not return an adapter.\ninvalid featureLevel values should not return an adapter.\n\nGPU.requestAdapter can technically return null for any reason\nbut we need test functionality so the test requires an adapter except\nwhen forceFallbackAdapter is true.\n\nThe test runs simple compute shader is run that fills a buffer with consecutive\nvalues and then checks the result to test the adapter for basic functionality.\n`;\n\nimport { Fixture } from '../../../../common/framework/fixture.js';\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { getGPU } from '../../../../common/util/navigator_gpu.js';\nimport { assert, objectEquals, iterRange } from '../../../../common/util/util.js';\n\nexport const g = makeTestGroup(Fixture);\n\nconst powerPreferenceModes: Array<GPUPowerPreference | undefined> = [\n  undefined,\n  'low-power',\n  'high-performance',\n];\nconst forceFallbackOptions: Array<boolean | undefined> = [undefined, false, true];\nconst validFeatureLevels: Array<string | undefined> = [undefined, 'core', 'compatibility'];\nconst invalidFeatureLevels: Array<string> = ['cor', 'Core', 'compatability', '', ' '];\n\nasync function testAdapter(t: Fixture, adapter: GPUAdapter | null) {\n  assert(adapter !== null, 'Failed to get adapter.');\n  const device = await t.requestDeviceTracked(adapter);\n\n  assert(device !== null, 'Failed to get device.');\n\n  const kOffset = 1230000;\n  const pipeline = device.createComputePipeline({\n    layout: 'auto',\n    compute: {\n      module: device.createShaderModule({\n        code: `\n          struct Buffer { data: array<u32>, };\n\n          @group(0) @binding(0) var<storage, read_write> buffer: Buffer;\n          @compute @workgroup_size(1u) fn main(\n              @builtin(global_invocation_id) id: vec3<u32>) {\n            buffer.data[id.x] = id.x + ${kOffset}u;\n          }\n        `,\n      }),\n      entryPoint: 'main',\n    },\n  });\n\n  const kNumElements = 64;\n  const kBufferSize = kNumElements * 4;\n  const buffer = t.trackForCleanup(\n    device.createBuffer({\n      size: kBufferSize,\n      usage: GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC,\n    })\n  );\n\n  const resultBuffer = t.trackForCleanup(\n    device.createBuffer({\n      size: kBufferSize,\n      usage: GPUBufferUsage.MAP_READ | GPUBufferUsage.COPY_DST,\n    })\n  );\n\n  const bindGroup = device.createBindGroup({\n    layout: pipeline.getBindGroupLayout(0),\n    entries: [{ binding: 0, resource: { buffer } }],\n  });\n\n  const encoder = device.createCommandEncoder();\n\n  const pass = encoder.beginComputePass();\n  pass.setPipeline(pipeline);\n  pass.setBindGroup(0, bindGroup);\n  pass.dispatchWorkgroups(kNumElements);\n  pass.end();\n\n  encoder.copyBufferToBuffer(buffer, 0, resultBuffer, 0, kBufferSize);\n\n  device.queue.submit([encoder.finish()]);\n\n  const expected = new Uint32Array([...iterRange(kNumElements, x => x + kOffset)]);\n\n  await resultBuffer.mapAsync(GPUMapMode.READ);\n  const actual = new Uint32Array(resultBuffer.getMappedRange());\n\n  assert(objectEquals(actual, expected), 'compute pipeline ran');\n\n  resultBuffer.destroy();\n  buffer.destroy();\n  device.destroy();\n}\n\ng.test('requestAdapter')\n  .desc(`request adapter with all possible options and check for basic functionality`)\n  .params(u =>\n    u\n      .combine('powerPreference', powerPreferenceModes)\n      .combine('forceFallbackAdapter', forceFallbackOptions)\n  )\n  .fn(async t => {\n    const { powerPreference, forceFallbackAdapter } = t.params;\n    const adapter = await getGPU(t.rec).requestAdapter({\n      ...(powerPreference !== undefined && { powerPreference }),\n      ...(forceFallbackAdapter !== undefined && { forceFallbackAdapter }),\n    });\n\n    if (!adapter) {\n      // Failing to create an adapter is only OK when forceFallbackAdapter is true.\n      t.expect(forceFallbackAdapter === true);\n\n      // Mark the test as skipped (as long as nothing else failed before this point).\n      t.skip('No fallback adapter available');\n      return;\n    }\n\n    t.expect(adapter.info.isFallbackAdapter === Boolean(forceFallbackAdapter));\n    await testAdapter(t, adapter);\n  });\n\ng.test('requestAdapter_invalid_featureLevel')\n  .desc(`request adapter with invalid featureLevel string values return null`)\n  .params(u => u.combine('featureLevel', [...validFeatureLevels, ...invalidFeatureLevels]))\n  .fn(async t => {\n    const { featureLevel } = t.params;\n    const adapter = await getGPU(t.rec).requestAdapter({ featureLevel });\n\n    if (!validFeatureLevels.includes(featureLevel)) {\n      assert(adapter === null);\n    } else {\n      await testAdapter(t, adapter);\n    }\n  });\n\ng.test('requestAdapter_no_parameters')\n  .desc(`request adapter with no parameters`)\n  .fn(async t => {\n    const adapter = await getGPU(t.rec).requestAdapter();\n    await testAdapter(t, adapter);\n  });\n"],"mappings":"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"}