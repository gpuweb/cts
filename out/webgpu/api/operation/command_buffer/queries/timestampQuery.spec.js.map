{"version":3,"file":"timestampQuery.spec.js","names":["description","makeTestGroup","AllFeaturesMaxLimitsGPUTest","g","test","desc","params","u","combine","fn","t","stage","numQuerySets","skipIfDeviceDoesNotHaveFeature","device","pushErrorScope","view","createTextureTracked","size","format","usage","GPUTextureUsage","RENDER_ATTACHMENT","createView","encoder","createCommandEncoder","i","querySet","createQuerySetTracked","type","count","pass","beginComputePass","timestampWrites","beginningOfPassWriteIndex","endOfPassWriteIndex","end","beginRenderPass","colorAttachments","loadOp","storeOp","shouldError","expectValidationError","queue","submit","finish","error","popErrorScope","expect","message","kNumSlots","kNumQuerySets","slot"],"sources":["../../../../../../src/webgpu/api/operation/command_buffer/queries/timestampQuery.spec.ts"],"sourcesContent":["export const description = `\nAPI operations tests for timestamp queries.\n\nGiven the values returned are implementation defined\nthere is not much we can test except that there are no errors.\n\n- test query with\n  - compute pass\n  - render pass\n  - 64k query objects\n`;\n\nimport { makeTestGroup } from '../../../../../common/framework/test_group.js';\nimport { AllFeaturesMaxLimitsGPUTest } from '../../../../gpu_test.js';\n\nexport const g = makeTestGroup(AllFeaturesMaxLimitsGPUTest);\n\ng.test('many_query_sets')\n  .desc(\n    `\nTest creating and using 64k query objects.\n\nThis test is because there is a Metal limit of 32 MTLCounterSampleBuffers\nImplementations are supposed to work around this limit by internally allocating\nlarger MTLCounterSampleBuffers and having the WebGPU sets be subsets of those\nlarger buffers.\n\nThis is particular important as the limit is 32 per process\nso a few pages making a few queries would easily hit the limit\nand prevent pages from running.\n    `\n  )\n  .params(u =>\n    u\n      .combine('numQuerySets', [8, 16, 32, 64, 256, 65536] as const)\n      .combine('stage', ['compute', 'render'] as const)\n  )\n  .fn(async t => {\n    const { stage, numQuerySets } = t.params;\n\n    t.skipIfDeviceDoesNotHaveFeature('timestamp-query');\n\n    // At large numQuerySets, this test incurs a lot of validation, which can take several seconds.\n    // Explicitly wrap the test in its own error scope to avoid triggering timeouts in test-cleanup.\n    t.device.pushErrorScope('validation');\n    try {\n      const view = t\n        .createTextureTracked({\n          size: [1, 1, 1],\n          format: 'rgba8unorm',\n          usage: GPUTextureUsage.RENDER_ATTACHMENT,\n        })\n        .createView();\n      const encoder = t.device.createCommandEncoder();\n\n      for (let i = 0; i < numQuerySets; ++i) {\n        const querySet = t.createQuerySetTracked({\n          type: 'timestamp',\n          count: 2,\n        });\n\n        switch (stage) {\n          case 'compute': {\n            const pass = encoder.beginComputePass({\n              timestampWrites: {\n                querySet,\n                beginningOfPassWriteIndex: 0,\n                endOfPassWriteIndex: 1,\n              },\n            });\n            pass.end();\n            break;\n          }\n          case 'render': {\n            const pass = encoder.beginRenderPass({\n              colorAttachments: [{ view, loadOp: 'load', storeOp: 'store' }],\n              timestampWrites: {\n                querySet,\n                beginningOfPassWriteIndex: 0,\n                endOfPassWriteIndex: 1,\n              },\n            });\n            pass.end();\n            break;\n          }\n        }\n      }\n\n      const shouldError = false; // just expect no error\n      t.expectValidationError(() => t.device.queue.submit([encoder.finish()]), shouldError);\n    } finally {\n      const error = await t.device.popErrorScope();\n      // Make sure there weren't any unexpected validation errors caught by the scope.\n      t.expect(error === null, error?.message);\n    }\n  });\n\ng.test('many_slots')\n  .desc(\n    `\nTest creating and using 4k query slots.\n\nMetal has the limit that a MTLCounterSampleBuffer can be max 32k which is 4k slots.\nSo, test we can use 4k slots across a few QuerySets\n    `\n  )\n  .params(u => u.combine('stage', ['compute', 'render'] as const))\n  .fn(t => {\n    const { stage } = t.params;\n\n    t.skipIfDeviceDoesNotHaveFeature('timestamp-query');\n    const kNumSlots = 4096;\n    const kNumQuerySets = 4;\n\n    const view = t\n      .createTextureTracked({\n        size: [1, 1, 1],\n        format: 'rgba8unorm',\n        usage: GPUTextureUsage.RENDER_ATTACHMENT,\n      })\n      .createView();\n    const encoder = t.device.createCommandEncoder();\n\n    for (let i = 0; i < kNumQuerySets; ++i) {\n      const querySet = t.createQuerySetTracked({\n        type: 'timestamp',\n        count: kNumSlots,\n      });\n\n      switch (stage) {\n        case 'compute': {\n          for (let slot = 0; slot < kNumSlots; slot += 2) {\n            const pass = encoder.beginComputePass({\n              timestampWrites: {\n                querySet,\n                beginningOfPassWriteIndex: slot,\n                endOfPassWriteIndex: slot + 1,\n              },\n            });\n            pass.end();\n          }\n          break;\n        }\n        case 'render': {\n          for (let slot = 0; slot < kNumSlots; slot += 2) {\n            const pass = encoder.beginRenderPass({\n              colorAttachments: [{ view, loadOp: 'load', storeOp: 'store' }],\n              timestampWrites: {\n                querySet,\n                beginningOfPassWriteIndex: slot,\n                endOfPassWriteIndex: slot + 1,\n              },\n            });\n            pass.end();\n          }\n          break;\n        }\n      }\n    }\n\n    const shouldError = false; // just expect no error\n    t.expectValidationError(() => t.device.queue.submit([encoder.finish()]), shouldError);\n  });\n"],"mappings":"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"}