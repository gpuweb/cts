{"version":3,"file":"clear_value.spec.js","names":["description","makeTestGroup","assert","depthStencilFormatAspectSize","kStencilTextureFormats","isDepthTextureFormat","AllFeaturesMaxLimitsGPUTest","g","test","desc","unimplemented","params","u","combine","fn","t","stencilFormat","stencilClearValue","applyStencilClearValueAsStencilReferenceValue","skipIfTextureFormatNotSupported","kSize","colorFormat","stencilTexture","createTextureTracked","format","size","usage","GPUTextureUsage","RENDER_ATTACHMENT","COPY_SRC","colorTexture","renderPipeline","device","createRenderPipeline","layout","vertex","module","createShaderModule","code","entryPoint","fragment","targets","depthStencil","depthCompare","depthWriteEnabled","stencilFront","compare","stencilBack","primitive","topology","stencilAspectSizeInBytes","expectedStencilValue","stencilReference","encoder","createCommandEncoder","depthStencilAttachment","view","createView","depthClearValue","stencilLoadOp","stencilStoreOp","depthLoadOp","depthStoreOp","renderPassEncoder","beginRenderPass","colorAttachments","loadOp","storeOp","clearValue","setPipeline","setStencilReference","draw","end","destinationBuffer","createBufferTracked","GPUBufferUsage","COPY_DST","copyTextureToBuffer","texture","aspect","buffer","queue","submit","finish","expectSingleColor","exp","R","G","B","A","expectGPUBufferValuesEqual","Uint8Array"],"sources":["../../../../../src/webgpu/api/operation/render_pass/clear_value.spec.ts"],"sourcesContent":["export const description = `\nTests for render pass clear values.\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { assert } from '../../../../common/util/util.js';\nimport {\n  depthStencilFormatAspectSize,\n  kStencilTextureFormats,\n  isDepthTextureFormat,\n} from '../../../format_info.js';\nimport { AllFeaturesMaxLimitsGPUTest } from '../../../gpu_test.js';\n\nexport const g = makeTestGroup(AllFeaturesMaxLimitsGPUTest);\n\ng.test('loaded')\n  .desc(\n    `Test render pass clear values are visible during the pass by doing some trivial blending\nwith the attachment (e.g. add [0,0,0,0] to the color and verify the stored result).`\n  )\n  .unimplemented();\n\ng.test('stencil_clear_value')\n  .desc(\n    `Test that when stencilLoadOp is \"clear\", the stencil aspect should be correctly cleared by\n     GPURenderPassDepthStencilAttachment.stencilClearValue, which will be converted to the type of\n     the stencil aspect of view by taking the same number of LSBs as the number of bits in the\n     stencil aspect of one texel block of view.`\n  )\n  .params(u =>\n    u\n      .combine('stencilFormat', kStencilTextureFormats)\n      .combine('stencilClearValue', [0, 1, 0xff, 0x100 + 2, 0x10000 + 3])\n      .combine('applyStencilClearValueAsStencilReferenceValue', [true, false])\n  )\n  .fn(t => {\n    const { stencilFormat, stencilClearValue, applyStencilClearValueAsStencilReferenceValue } =\n      t.params;\n\n    t.skipIfTextureFormatNotSupported(stencilFormat);\n\n    const kSize = [1, 1, 1] as const;\n    const colorFormat = 'rgba8unorm';\n    const stencilTexture = t.createTextureTracked({\n      format: stencilFormat,\n      size: kSize,\n      usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n    });\n    const colorTexture = t.createTextureTracked({\n      format: colorFormat,\n      size: kSize,\n      usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n    });\n    const renderPipeline = t.device.createRenderPipeline({\n      layout: 'auto',\n      vertex: {\n        module: t.device.createShaderModule({\n          code: `\n            @vertex\n            fn main(@builtin(vertex_index) VertexIndex : u32)-> @builtin(position) vec4<f32> {\n              var pos : array<vec2<f32>, 6> = array<vec2<f32>, 6>(\n                  vec2<f32>(-1.0,  1.0),\n                  vec2<f32>(-1.0, -1.0),\n                  vec2<f32>( 1.0,  1.0),\n                  vec2<f32>(-1.0, -1.0),\n                  vec2<f32>( 1.0,  1.0),\n                  vec2<f32>( 1.0, -1.0));\n              return vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n            }`,\n        }),\n        entryPoint: 'main',\n      },\n      fragment: {\n        module: t.device.createShaderModule({\n          code: `\n            @fragment\n            fn main() -> @location(0) vec4<f32> {\n              return vec4<f32>(0.0, 1.0, 0.0, 1.0);\n            }`,\n        }),\n        entryPoint: 'main',\n        targets: [{ format: colorFormat }],\n      },\n      depthStencil: {\n        format: stencilFormat,\n        depthCompare: 'always',\n        depthWriteEnabled: false,\n        stencilFront: {\n          compare: 'equal',\n        },\n        stencilBack: {\n          compare: 'equal',\n        },\n      },\n      primitive: {\n        topology: 'triangle-list',\n      },\n    });\n\n    const stencilAspectSizeInBytes = depthStencilFormatAspectSize(stencilFormat, 'stencil-only');\n    assert(stencilAspectSizeInBytes > 0);\n    const expectedStencilValue = stencilClearValue & ((stencilAspectSizeInBytes << 8) - 1);\n\n    // StencilReference used in setStencilReference will also be masked to the lowest valid bits, so\n    // no matter what we set in the rest high bits that will be masked out (different or same\n    // between stencilClearValue and stencilReference), the test will pass if and only if the valid\n    // lowest bits are the same.\n    const stencilReference = applyStencilClearValueAsStencilReferenceValue\n      ? stencilClearValue\n      : expectedStencilValue;\n\n    const encoder = t.device.createCommandEncoder();\n\n    const depthStencilAttachment: GPURenderPassDepthStencilAttachment = {\n      view: stencilTexture.createView(),\n      depthClearValue: 0,\n      stencilLoadOp: 'clear',\n      stencilStoreOp: 'store',\n      stencilClearValue,\n    };\n    if (isDepthTextureFormat(stencilFormat)) {\n      depthStencilAttachment.depthClearValue = 0;\n      depthStencilAttachment.depthLoadOp = 'clear';\n      depthStencilAttachment.depthStoreOp = 'store';\n    }\n    const renderPassEncoder = encoder.beginRenderPass({\n      colorAttachments: [\n        {\n          view: colorTexture.createView(),\n          loadOp: 'clear',\n          storeOp: 'store',\n          clearValue: [1, 0, 0, 1] as const,\n        },\n      ],\n      depthStencilAttachment,\n    });\n    renderPassEncoder.setPipeline(renderPipeline);\n    renderPassEncoder.setStencilReference(stencilReference);\n    renderPassEncoder.draw(6);\n    renderPassEncoder.end();\n\n    const destinationBuffer = t.createBufferTracked({\n      usage: GPUBufferUsage.COPY_SRC | GPUBufferUsage.COPY_DST,\n      size: 4,\n    });\n    encoder.copyTextureToBuffer(\n      {\n        texture: stencilTexture,\n        aspect: 'stencil-only',\n      },\n      {\n        buffer: destinationBuffer,\n      },\n      [1, 1, 1]\n    );\n\n    t.queue.submit([encoder.finish()]);\n\n    t.expectSingleColor(colorTexture, colorFormat, {\n      size: [1, 1, 1],\n      exp: { R: 0, G: 1, B: 0, A: 1 },\n    });\n    t.expectGPUBufferValuesEqual(destinationBuffer, new Uint8Array([expectedStencilValue]));\n  });\n"],"mappings":"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"}