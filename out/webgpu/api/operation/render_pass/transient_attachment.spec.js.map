{"version":3,"file":"transient_attachment.spec.js","names":["description","makeTestGroup","AllFeaturesMaxLimitsGPUTest","kSize","g","test","desc","fn","t","skipIfTransientAttachmentNotSupported","maxAttachments","device","limits","maxColorAttachments","encoder","createCommandEncoder","count","colorAttachments","i","texture","createTextureTracked","size","format","usage","GPUTextureUsage","RENDER_ATTACHMENT","TRANSIENT_ATTACHMENT","push","view","createView","clearValue","r","b","a","loadOp","storeOp","pass","beginRenderPass","end","queue","submit","finish","t1","t2","t3","passes","attachments","map"],"sources":["../../../../../src/webgpu/api/operation/render_pass/transient_attachment.spec.ts"],"sourcesContent":["export const description = `API Operation Tests for transient attachment in render passes.`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { AllFeaturesMaxLimitsGPUTest } from '../../../gpu_test.js';\n\nconst kSize = 4;\n\nexport const g = makeTestGroup(AllFeaturesMaxLimitsGPUTest);\n\ng.test('increasing_attachments_count')\n  .desc(\n    `\n    Use multiple render passes with increasing amounts of transient attachments.\n  `\n  )\n  .fn(t => {\n    // MAINTENANCE_TODO(#4509): Remove this when TRANSIENT_ATTACHMENT is added to the WebGPU spec.\n    t.skipIfTransientAttachmentNotSupported();\n\n    const maxAttachments = t.device.limits.maxColorAttachments;\n    const encoder = t.device.createCommandEncoder();\n\n    for (let count = 1; count <= maxAttachments; count++) {\n      const colorAttachments: GPURenderPassColorAttachment[] = [];\n\n      for (let i = 0; i < count; i++) {\n        const texture = t.createTextureTracked({\n          size: [kSize, kSize, 1],\n          format: 'rgba8unorm',\n          usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.TRANSIENT_ATTACHMENT,\n        });\n\n        colorAttachments.push({\n          view: texture.createView(),\n          clearValue: { r: 0.0, g: 0.0, b: 0.0, a: 0.0 },\n          loadOp: 'clear',\n          storeOp: 'discard',\n        });\n      }\n\n      const pass = encoder.beginRenderPass({ colorAttachments });\n      pass.end();\n    }\n    t.device.queue.submit([encoder.finish()]);\n  });\n\ng.test('overlapping_transient_attachments')\n  .desc(\n    `\n    Use multiple render passes with transient attachments in a circular overlap pattern:\n    Pass 1: (T1, T2)\n    Pass 2: (T2, T3)\n    Pass 3: (T3, T1)\n\n    This stresses the driver's transient memory allocator. If the driver naively reuses\n    T1's memory for T3 during Pass 2 (because T1 isn't active in Pass 2),\n    Pass 3 will fail or corrupt because T1 and T3 are both needed simultaneously again.\n  `\n  )\n  .fn(t => {\n    // MAINTENANCE_TODO(#4509): Remove this when TRANSIENT_ATTACHMENT is added to the WebGPU spec.\n    t.skipIfTransientAttachmentNotSupported();\n\n    const encoder = t.device.createCommandEncoder();\n\n    const desc = {\n      size: [kSize, kSize, 1],\n      format: 'rgba8unorm',\n      usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.TRANSIENT_ATTACHMENT,\n    } as const;\n    const t1 = t.createTextureTracked(desc);\n    const t2 = t.createTextureTracked(desc);\n    const t3 = t.createTextureTracked(desc);\n\n    const passes = [\n      [t1, t2], // Pass 1\n      [t2, t3], // Pass 2\n      [t3, t1], // Pass 3\n    ];\n\n    for (const attachments of passes) {\n      const colorAttachments: GPURenderPassColorAttachment[] = attachments.map(texture => ({\n        view: texture.createView(),\n        clearValue: { r: 0.0, g: 0.0, b: 0.0, a: 0.0 },\n        loadOp: 'clear',\n        storeOp: 'discard',\n      }));\n\n      const pass = encoder.beginRenderPass({ colorAttachments });\n      pass.end();\n    }\n\n    t.device.queue.submit([encoder.finish()]);\n  });\n"],"mappings":"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"}