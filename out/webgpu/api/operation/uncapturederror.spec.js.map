{"version":3,"file":"uncapturederror.spec.js","names":["description","makeTestGroup","raceWithRejectOnTimeout","kGeneratableErrorScopeFilters","ErrorTest","g","test","desc","params","u","combine","fn","t","useOnuncapturederror","errorType","uncapturedErrorEvent","expectUncapturedError","generateError","expect","isInstanceOfError","error","unimplemented","callOrder","makeListener","id","resolve","getPromise","Promise","r","listener","e","preventDefault","debug","push","listenerA","listenerB","callbackC","callbackD","callbackE","promises","device","addEventListener","onuncapturederror","all","order","join","length","removeEventListener"],"sources":["../../../../src/webgpu/api/operation/uncapturederror.spec.ts"],"sourcesContent":["export const description = `\nTests for GPUDevice.onuncapturederror / addEventListener('uncapturederror')\n`;\n\nimport { makeTestGroup } from '../../../common/framework/test_group.js';\nimport { raceWithRejectOnTimeout } from '../../../common/util/util.js';\nimport { kGeneratableErrorScopeFilters } from '../../capability_info.js';\nimport { ErrorTest } from '../../error_test.js';\n\nexport const g = makeTestGroup(ErrorTest);\n\ng.test('iff_uncaptured')\n  .desc(\n    `{validation, out-of-memory} error should fire uncapturederror iff not captured by a scope.`\n  )\n  .params(u =>\n    u\n      .combine('useOnuncapturederror', [false, true])\n      .combine('errorType', kGeneratableErrorScopeFilters)\n  )\n  .fn(async t => {\n    const { useOnuncapturederror, errorType } = t.params;\n    const uncapturedErrorEvent = await t.expectUncapturedError(() => {\n      t.generateError(errorType);\n    }, useOnuncapturederror);\n    t.expect(t.isInstanceOfError(errorType, uncapturedErrorEvent.error));\n  });\n\ng.test('only_original_device_is_event_target')\n  .desc(\n    `Original GPUDevice objects are EventTargets and have onuncapturederror, but\ndeserialized GPUDevices do not.`\n  )\n  .unimplemented();\n\ng.test('uncapturederror_from_non_originating_thread')\n  .desc(\n    `Uncaptured errors on any thread should always propagate to the original GPUDevice object\n(since deserialized ones don't have EventTarget/onuncapturederror).`\n  )\n  .unimplemented();\n\ng.test('onuncapturederror_order_wrt_addEventListener')\n  .desc(\n    `\nTest that onuncapturederror and addEventListener work in the correct order.\n\nThe spec says setting onuncapturederror adds a listener via addEventListener that\ncalls the callback. Changing onuncapturederror changes the callback to the existing\nlistener. Setting onuncapturederror to null removes the listener.\n  `\n  )\n  .fn(async t => {\n    const callOrder: string[] = [];\n\n    const makeListener = (id: string) => {\n      let resolve: () => void;\n      return {\n        getPromise() {\n          return new Promise<void>(r => {\n            resolve = r;\n          });\n        },\n        listener: (e: Event) => {\n          e.preventDefault();\n          t.debug(`listener ${id} called`);\n          callOrder.push(id);\n          resolve();\n        },\n      };\n    };\n\n    const listenerA = makeListener('a');\n    const listenerB = makeListener('b');\n    const callbackC = makeListener('c');\n    const callbackD = makeListener('d');\n    const callbackE = makeListener('e');\n\n    try {\n      t.debug('test they are called in the order added');\n      {\n        const promises = [listenerA.getPromise(), listenerB.getPromise(), callbackC.getPromise()];\n\n        t.device.addEventListener('uncapturederror', listenerA.listener);\n        t.device.onuncapturederror = callbackC.listener;\n        t.device.addEventListener('uncapturederror', listenerB.listener);\n\n        t.generateError('validation');\n        await raceWithRejectOnTimeout(Promise.all(promises), 500, 'timeout1');\n\n        const order = callOrder.join(',');\n        t.expect(order === 'a,c,b', `'${order}' === 'a,c,b'`);\n        callOrder.length = 0;\n      }\n\n      t.debug('test changing onuncapturederror does not change the order');\n      {\n        const promises = [listenerA.getPromise(), listenerB.getPromise(), callbackD.getPromise()];\n\n        t.device.onuncapturederror = callbackD.listener;\n\n        t.generateError('validation');\n        await raceWithRejectOnTimeout(Promise.all(promises), 500, 'timeout2');\n\n        const order = callOrder.join(',');\n        t.expect(order === 'a,d,b', `'${order}' === 'a,d,b'`);\n        callOrder.length = 0;\n      }\n\n      t.debug('test clearing onuncapturederror then setting it does change the order');\n      {\n        const promises = [listenerA.getPromise(), listenerB.getPromise(), callbackE.getPromise()];\n\n        t.device.onuncapturederror = null;\n        t.device.onuncapturederror = callbackE.listener;\n\n        t.generateError('validation');\n        await raceWithRejectOnTimeout(Promise.all(promises), 500, 'timeout3');\n\n        const order = callOrder.join(',');\n        t.expect(order === 'a,b,e', `'${order}' === 'a,b,e'`);\n        callOrder.length = 0;\n      }\n    } finally {\n      t.device.onuncapturederror = null;\n      t.device.removeEventListener('uncapturederror', listenerA.listener);\n      t.device.removeEventListener('uncapturederror', listenerB.listener);\n    }\n  });\n"],"mappings":"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"}