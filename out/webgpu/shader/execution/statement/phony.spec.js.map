{"version":3,"file":"phony.spec.js","names":["description","makeTestGroup","keysOf","GPUTest","g","runStatementTest","t","ty","values","wgsl_main","wgsl","pipeline","device","createComputePipeline","layout","compute","module","createShaderModule","code","entryPoint","maxOutputValues","outputBuffer","createBufferTracked","size","usage","GPUBufferUsage","STORAGE","COPY_SRC","bindGroup","createBindGroup","getBindGroupLayout","entries","binding","resource","buffer","encoder","createCommandEncoder","pass","beginComputePass","setPipeline","setBindGroup","dispatchWorkgroups","end","queue","submit","finish","expectGPUBufferValuesEqual","kTests","literal","src","call","call_in_subexpr","nested_call","unreached","loop","test","desc","params","u","combine","fn","Int32Array","case"],"sources":["../../../../../src/webgpu/shader/execution/statement/phony.spec.ts"],"sourcesContent":["export const description = `\nPhony assignment execution tests\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { keysOf } from '../../../../common/util/data_tables.js';\nimport { TypedArrayBufferView } from '../../../../common/util/util.js';\nimport { GPUTest } from '../../../gpu_test.js';\n\nexport const g = makeTestGroup(GPUTest);\n\n/**\n * Builds, runs then checks the output of a statement shader test.\n *\n * @param t The test object\n * @param ty The WGSL scalar type to be written\n * @param values The expected output values of type ty\n * @param wgsl_main The body of the WGSL entry point.\n */\nexport function runStatementTest(\n  t: GPUTest,\n  ty: string,\n  values: TypedArrayBufferView,\n  wgsl_main: string\n) {\n  const wgsl = `\nstruct Outputs {\n  data  : array<${ty}>,\n};\nvar<private> count: u32 = 0;\n\n@group(0) @binding(1) var<storage, read_write> outputs : Outputs;\n\nfn put(value : ${ty}) -> ${ty} {\n  outputs.data[count] = value;\n  count += 1;\n  return value;\n}\n\n@compute @workgroup_size(1)\nfn main() {\n  let x = outputs.data[0];\n  ${wgsl_main}\n}\n`;\n\n  const pipeline = t.device.createComputePipeline({\n    layout: 'auto',\n    compute: {\n      module: t.device.createShaderModule({ code: wgsl }),\n      entryPoint: 'main',\n    },\n  });\n\n  const maxOutputValues = 1000;\n  const outputBuffer = t.createBufferTracked({\n    size: 4 * (1 + maxOutputValues),\n    usage: GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC,\n  });\n\n  const bindGroup = t.device.createBindGroup({\n    layout: pipeline.getBindGroupLayout(0),\n    entries: [{ binding: 1, resource: { buffer: outputBuffer } }],\n  });\n\n  // Run the shader.\n  const encoder = t.device.createCommandEncoder();\n  const pass = encoder.beginComputePass();\n  pass.setPipeline(pipeline);\n  pass.setBindGroup(0, bindGroup);\n  pass.dispatchWorkgroups(1);\n  pass.end();\n  t.queue.submit([encoder.finish()]);\n\n  t.expectGPUBufferValuesEqual(outputBuffer, values);\n}\n\n// In each case, the program will write non-zero values to the prefix\n// of the output buffer.  The values to check against will cover all\n// those values, plus a 0 just beyond the last written value.\nconst kTests = {\n  literal: {\n    src: `_ = true;`,\n    values: [0],\n  },\n  call: {\n    // RHS evaluated once.\n    src: `_ = put(42i);`,\n    values: [42, 0],\n  },\n  call_in_subexpr: {\n    src: `_ = put(42i) + 1;`,\n    values: [42, 0],\n  },\n  nested_call: {\n    src: `_ = put(put(42)+1);`,\n    values: [42, 43, 0],\n  },\n  unreached: {\n    src: `if (false) { _ = put(1); }`,\n    values: [0],\n  },\n  loop: {\n    src: `for (var i=5; i<7; i++) { _ = put(i); }`,\n    values: [5, 6, 0],\n  },\n} as const;\n\ng.test('executes')\n  .desc('Tests the RHS is evaluated once when the statement is executed.')\n  .params(u => u.combine('case', keysOf(kTests)))\n  .fn(t => {\n    runStatementTest(\n      t,\n      'i32',\n      new Int32Array(kTests[t.params.case].values),\n      kTests[t.params.case].src\n    );\n  });\n"],"mappings":"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"}