{"version":3,"file":"override.spec.js","names":["description","makeTestGroup","keysOf","AllFeaturesMaxLimitsGPUTest","checkElementsEqual","g","kOverrideCases","logical_lhs_override","code","logical_rhs_override","logical_both_override","test","desc","params","u","combine","fn","t","expr","case","pipeline","device","createComputePipeline","layout","compute","module","createShaderModule","entryPoint","buffer","makeBufferWithContents","Uint32Array","GPUBufferUsage","STORAGE","COPY_SRC","COPY_DST","bg","createBindGroup","getBindGroupLayout","entries","binding","resource","encoder","createCommandEncoder","pass","beginComputePass","setPipeline","setBindGroup","dispatchWorkgroups","end","queue","submit","finish","bufferReadback","readGPUBufferRangeTyped","srcByteOffset","type","typedLength","method","got","data","expected","expectOK"],"sources":["../../../../src/webgpu/shader/execution/override.spec.ts"],"sourcesContent":["export const description = `Test override execution`;\n\nimport { makeTestGroup } from '../../../common/framework/test_group.js';\nimport { keysOf } from '../../../common/util/data_tables.js';\nimport { AllFeaturesMaxLimitsGPUTest } from '../../gpu_test.js';\nimport { checkElementsEqual } from '../../util/check_contents.js';\n\nexport const g = makeTestGroup(AllFeaturesMaxLimitsGPUTest);\n\nconst kOverrideCases = {\n  logical_lhs_override: {\n    code: `x == 2 && 1 < 2`,\n  },\n  logical_rhs_override: {\n    code: `1 > 2 || x == 2`,\n  },\n  logical_both_override: {\n    code: `x > 2 || x == 2`,\n  },\n};\n\ng.test('logical')\n  .desc(`Test replacing an override in the LHS of a logical statement`)\n  .params(u => u.combine('case', keysOf(kOverrideCases)))\n  .fn(async t => {\n    const expr = kOverrideCases[t.params.case].code;\n    const code = `\noverride x: u32 = 2;\noverride y: bool = ${expr};\n\n@group(0) @binding(0) var<storage, read_write> v : vec4u;\n\n@compute @workgroup_size(1)\nfn main() {\n  if (y) {\n      v = vec4u(4, 4, 4, 4);\n  } else {\n      v = vec4u(1, 1, 1, 1);\n  }\n}`;\n\n    const pipeline = t.device.createComputePipeline({\n      layout: 'auto',\n      compute: {\n        module: t.device.createShaderModule({\n          code,\n        }),\n        entryPoint: 'main',\n      },\n    });\n\n    const buffer = t.makeBufferWithContents(\n      new Uint32Array([0, 0, 0, 0]),\n      GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC | GPUBufferUsage.COPY_DST\n    );\n\n    const bg = t.device.createBindGroup({\n      layout: pipeline.getBindGroupLayout(0),\n      entries: [\n        {\n          binding: 0,\n          resource: {\n            buffer,\n          },\n        },\n      ],\n    });\n\n    const encoder = t.device.createCommandEncoder();\n    const pass = encoder.beginComputePass();\n    pass.setPipeline(pipeline);\n    pass.setBindGroup(0, bg);\n    pass.dispatchWorkgroups(1, 1, 1);\n    pass.end();\n    t.queue.submit([encoder.finish()]);\n\n    const bufferReadback = await t.readGPUBufferRangeTyped(buffer, {\n      srcByteOffset: 0,\n      type: Uint32Array,\n      typedLength: 4,\n      method: 'copy',\n    });\n    const got: Uint32Array = bufferReadback.data;\n    const expected = new Uint32Array([4, 4, 4, 4]);\n\n    t.expectOK(checkElementsEqual(got, expected));\n  });\n"],"mappings":"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"}