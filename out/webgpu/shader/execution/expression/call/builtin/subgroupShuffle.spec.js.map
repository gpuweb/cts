{"version":3,"file":"subgroupShuffle.spec.js","names":["description","makeTestGroup","keysOf","objectsToRecord","assert","iterRange","kConcreteNumericScalarsAndVectors","VectorType","PRNG","kWGSizes","kPredicateCases","SubgroupTest","runComputeTest","runFragmentTest","kFramebufferSizes","generateTypedInputs","getUintsPerFramebuffer","g","kUpDownOps","kOps","kNumCases","kTypes","kSize","kShuffleCases","no_shuffle","id","expected","input","broadcast","rotate_1_up","idx","rotate_2_down","reversed","clamped","Math","max","min","checkShuffleId","metadata","output","i","expect","res","Error","undefined","test","desc","params","u","combine","fn","t","skipIfDeviceDoesNotHaveFeature","testcase","case","wgsl","inputData","Uint32Array","x","uintsPerOutput","kUpDownCases","delta","op","diagnostic","dynamic_1","override_2","checkShuffleUpDownDelta","kMaskCases","mask","value","expr_3","checkShuffleMask","trunc","generateInputs","seed","numInputs","prng","bound","floor","uniformInt","getShuffledId","checkCompute","numInvs","filter","sub_unique_id_to_inv_idx","Map","empty","inv","subgroup_unique_id","v","get","Array","from","set","sub_inv_id_to_inv_idx","size","inputValue","first_subgroup_inv_id","shuffled_target_id","beginSubcases","wgThreads","wgSize","selectValue","inputArray","numUintsPerOutput","predicate","cond","checkDataTypes","type","requiresF16","index","expectIdx","expectShift","resIdx","resShift","uints","width","j","enables","toString","checkFragment","data","format","height","shuffleId","uintsPerRow","uintsPerTexel","coordToIndex","row","col","mapping","offset","subgroup_id","subgroupMapping","shuffleLinear","shuffleRow","shuffleCol","combineWithParams","fsShader"],"sources":["../../../../../../../src/webgpu/shader/execution/expression/call/builtin/subgroupShuffle.spec.ts"],"sourcesContent":["export const description = `\nExecution tests for subgroupShuffle, subgroupShuffleUp, subgroupShuffleDown, and subgroupShuffleXor.\n\nNote: There is a lack of portability for non-uniform execution so these tests\nrestrict themselves to uniform control flow.\nNote: There is no guaranteed mapping between subgroup_invocation_id and\nlocal_invocation_index. Tests should avoid assuming there is.\n`;\n\nimport { makeTestGroup } from '../../../../../../common/framework/test_group.js';\nimport { keysOf, objectsToRecord } from '../../../../../../common/util/data_tables.js';\nimport { assert, iterRange } from '../../../../../../common/util/util.js';\nimport {\n  kConcreteNumericScalarsAndVectors,\n  Type,\n  VectorType,\n} from '../../../../../util/conversion.js';\nimport { PRNG } from '../../../../../util/prng.js';\n\nimport {\n  kWGSizes,\n  kPredicateCases,\n  SubgroupTest,\n  runComputeTest,\n  runFragmentTest,\n  kFramebufferSizes,\n  generateTypedInputs,\n  getUintsPerFramebuffer,\n} from './subgroup_util.js';\n\nexport const g = makeTestGroup(SubgroupTest);\n\ntype ShuffleOp =\n  | 'subgroupShuffle'\n  | 'subgroupShuffleUp'\n  | 'subgroupShuffleDown'\n  | 'subgroupShuffleXor';\n\nconst kUpDownOps: ShuffleOp[] = ['subgroupShuffleUp', 'subgroupShuffleDown'];\n\nconst kOps: ShuffleOp[] = ['subgroupShuffle', 'subgroupShuffleXor', ...kUpDownOps];\n\nconst kNumCases = 16;\n\nconst kTypes = objectsToRecord(kConcreteNumericScalarsAndVectors);\n\n// This size is selected to guarantee a single subgroup.\nconst kSize = 4;\nconst kShuffleCases = {\n  no_shuffle: {\n    id: `id`,\n    expected: (input: Uint32Array, id: number) => {\n      return input[id];\n    },\n  },\n  broadcast: {\n    id: `input[2]`,\n    expected: (input: Uint32Array, id: number) => {\n      return input[2];\n    },\n  },\n  rotate_1_up: {\n    id: `select(id - 1, ${kSize} - 1, id == 0)`,\n    expected: (input: Uint32Array, id: number) => {\n      const idx = id === 0 ? kSize - 1 : id - 1;\n      return input[idx];\n    },\n  },\n  rotate_2_down: {\n    id: `(id + 2) % ${kSize}`,\n    expected: (input: Uint32Array, id: number) => {\n      const idx = (id + 2) % kSize;\n      return input[idx];\n    },\n  },\n  reversed: {\n    id: `${kSize} - id - 1`,\n    expected: (input: Uint32Array, id: number) => {\n      return input[kSize - id - 1];\n    },\n  },\n  clamped: {\n    id: `clamp(id + 2, 1, 3)`,\n    expected: (input: Uint32Array, id: number) => {\n      const idx = Math.max(Math.min(id + 2, 3), 1);\n      return input[idx];\n    },\n  },\n};\n\nfunction checkShuffleId(\n  metadata: Uint32Array, // unused\n  output: Uint32Array,\n  input: Uint32Array,\n  expected: (input: Uint32Array, id: number) => number\n): Error | undefined {\n  for (let i = 0; i < kSize; i++) {\n    const expect = expected(input, i);\n    const res = output[i];\n    if (res !== expect) {\n      return new Error(`Invocation ${i}: incorrect results\n- expected: ${expect}\n-      got: ${res}`);\n    }\n  }\n\n  return undefined;\n}\n\ng.test('shuffle,id')\n  .desc(`Tests various ways to shuffle invocations`)\n  .params(u => u.combine('case', keysOf(kShuffleCases)))\n  .fn(async t => {\n    t.skipIfDeviceDoesNotHaveFeature('subgroups' as GPUFeatureName);\n    const testcase = kShuffleCases[t.params.case];\n\n    const wgsl = `\nenable subgroups;\n\n@group(0) @binding(0)\nvar<storage> input : array<u32>;\n\n@group(0) @binding(1)\nvar<storage, read_write> output : array<u32>;\n\n@group(0) @binding(2)\nvar<storage, read_write> metadata : array<u32>; // unused\n\n@compute @workgroup_size(${kSize})\nfn main(\n  @builtin(subgroup_invocation_id) id : u32,\n) {\n  // Force usage\n  _ = metadata[0];\n\n  output[id] = subgroupShuffle(input[id], ${testcase.id});\n}`;\n\n    const inputData = new Uint32Array([...iterRange(kSize, x => x)]);\n    const uintsPerOutput = 1;\n    await runComputeTest(\n      t,\n      wgsl,\n      [kSize, 1, 1],\n      uintsPerOutput,\n      inputData,\n      (metadata: Uint32Array, output: Uint32Array) => {\n        return checkShuffleId(metadata, output, inputData, testcase.expected);\n      }\n    );\n  });\n\ninterface UpDownCase {\n  delta: string;\n  expected: (input: Uint32Array, id: number, op: ShuffleOp) => number | undefined;\n  diagnostic: string;\n}\n\n// Delta must be dynamically uniform\nconst kUpDownCases: Record<string, UpDownCase> = {\n  no_shuffle: {\n    delta: `0`,\n    expected: (input: Uint32Array, id: number, op: ShuffleOp) => {\n      return input[id];\n    },\n    diagnostic: `error`,\n  },\n  dynamic_1: {\n    delta: `input[1]`,\n    expected: (input: Uint32Array, id: number, op: ShuffleOp) => {\n      let idx = id;\n      if (op === 'subgroupShuffleUp') {\n        idx = id - 1;\n        if (idx < 0) {\n          return undefined;\n        }\n        return input[idx];\n      } else {\n        idx = id + 1;\n        if (idx > 3) {\n          return undefined;\n        }\n      }\n      return input[idx];\n    },\n    diagnostic: `off`,\n  },\n  override_2: {\n    delta: `override_idx`,\n    expected: (input: Uint32Array, id: number, op: ShuffleOp) => {\n      let idx = id;\n      if (op === 'subgroupShuffleUp') {\n        idx = id - 2;\n        if (idx < 0) {\n          return undefined;\n        }\n        return input[idx];\n      } else {\n        idx = id + 2;\n        if (idx > 3) {\n          return undefined;\n        }\n      }\n      return input[idx];\n    },\n    diagnostic: `error`,\n  },\n};\n\nfunction checkShuffleUpDownDelta(\n  metadata: Uint32Array, // unused\n  output: Uint32Array,\n  input: Uint32Array,\n  op: ShuffleOp,\n  expected: (input: Uint32Array, id: number, op: ShuffleOp) => number | undefined\n): Error | undefined {\n  assert(op === 'subgroupShuffleUp' || op === 'subgroupShuffleDown');\n\n  for (let i = 0; i < kSize; i++) {\n    const expect = expected(input, i, op);\n    const res = output[i];\n    if (expect && expect !== res) {\n      return new Error(`Invocation ${i}: incorrect results\n- expected: ${expect}\n-      got: ${res}`);\n    }\n  }\n\n  return undefined;\n}\n\ng.test('shuffleUpDown,delta')\n  .desc(`Test ShuffleUp and ShuffleDown deltas`)\n  .params(u => u.combine('op', kUpDownOps).combine('case', keysOf(kUpDownCases)))\n  .fn(async t => {\n    t.skipIfDeviceDoesNotHaveFeature('subgroups' as GPUFeatureName);\n    const testcase = kUpDownCases[t.params.case];\n\n    const wgsl = `\nenable subgroups;\ndiagnostic(${testcase.diagnostic}, subgroup_uniformity);\n\noverride override_idx = 2u;\n\n@group(0) @binding(0)\nvar<storage> input : array<u32>;\n\n@group(0) @binding(1)\nvar<storage, read_write> output : array<u32>;\n\n@group(0) @binding(2)\nvar<storage, read_write> metadata : array<u32>; // unused\n\n@compute @workgroup_size(${kSize})\nfn main(\n  @builtin(subgroup_invocation_id) id : u32,\n) {\n  // Force usage\n  _ = metadata[0];\n\n  output[id] = ${t.params.op}(input[id], ${testcase.delta});\n}`;\n\n    const inputData = new Uint32Array([...iterRange(kSize, x => x)]);\n    const uintsPerOutput = 1;\n    await runComputeTest(\n      t,\n      wgsl,\n      [kSize, 1, 1],\n      uintsPerOutput,\n      inputData,\n      (metadata: Uint32Array, output: Uint32Array) => {\n        return checkShuffleUpDownDelta(metadata, output, inputData, t.params.op, testcase.expected);\n      }\n    );\n  });\n\nconst kMaskCases = {\n  no_shuffle: {\n    mask: `0`,\n    value: 0,\n    diagnostic: `error`,\n  },\n  dynamic_1: {\n    mask: `input[1]`,\n    value: 1,\n    diagnostic: `off`,\n  },\n  override_2: {\n    mask: `override_idx`,\n    value: 2,\n    diagnostic: `error`,\n  },\n  expr_3: {\n    mask: `input[1] + input[2]`,\n    value: 3,\n    diagnostic: `off`,\n  },\n};\n\nfunction checkShuffleMask(\n  metadata: Uint32Array, // unused\n  output: Uint32Array,\n  input: Uint32Array,\n  mask: number\n): Error | undefined {\n  assert(mask === Math.trunc(mask));\n  assert(0 <= mask && mask <= 3);\n\n  for (let i = 0; i < kSize; i++) {\n    const expect = input[i ^ mask];\n    const res = output[i];\n    if (res !== expect) {\n      return new Error(`Invocation ${i}: incorrect result\n- expected: ${expect}\n-      got: ${res}`);\n    }\n  }\n\n  return undefined;\n}\n\ng.test('shuffleXor,mask')\n  .desc(`Test ShuffleXor masks`)\n  .params(u => u.combine('case', keysOf(kMaskCases)))\n  .fn(async t => {\n    t.skipIfDeviceDoesNotHaveFeature('subgroups' as GPUFeatureName);\n    const testcase = kMaskCases[t.params.case];\n\n    const wgsl = `\nenable subgroups;\ndiagnostic(${testcase.diagnostic}, subgroup_uniformity);\n\noverride override_idx = 2u;\n\n@group(0) @binding(0)\nvar<storage> input : array<u32>;\n\n@group(0) @binding(1)\nvar<storage, read_write> output : array<u32>;\n\n@group(0) @binding(2)\nvar<storage, read_write> metadata : array<u32>; // unused\n\n@compute @workgroup_size(${kSize})\nfn main(\n  @builtin(subgroup_invocation_id) id : u32,\n) {\n  // Force usage\n  _ = metadata[0];\n\n  output[id] = subgroupShuffleXor(input[id], ${testcase.mask});\n}`;\n\n    const inputData = new Uint32Array([...iterRange(kSize, x => x)]);\n    const uintsPerOutput = 1;\n    await runComputeTest(\n      t,\n      wgsl,\n      [kSize, 1, 1],\n      uintsPerOutput,\n      inputData,\n      (metadata: Uint32Array, output: Uint32Array) => {\n        return checkShuffleMask(metadata, output, inputData, testcase.value);\n      }\n    );\n  });\n\n/**\n * Generate randomized inputs for testing shuffles\n *\n * 1/4 of the cases will be bounded to values in the range [0, 8)\n * 1/4 of the cases will be bounded to values in the range [0, 16)\n * 1/4 of the cases will be bounded to values in the range [0, 32)\n * 1/4 of the cases will be bounded to values in the range [0, 128)\n * @param seed The seed for the PRNG\n * @param numInputs The number of inputs to generate\n */\nfunction generateInputs(seed: number, numInputs: number): Uint32Array {\n  const prng = new PRNG(seed);\n\n  let bound = 128;\n  if (seed < Math.floor(kNumCases / 4)) {\n    bound = 8;\n  } else if (seed < Math.floor(kNumCases / 2)) {\n    bound = 16;\n  } else if (seed < 3 * Math.floor(kNumCases / 4)) {\n    bound = 32;\n  }\n  return new Uint32Array([\n    ...iterRange(numInputs, x => {\n      return prng.uniformInt(bound);\n    }),\n  ]);\n}\n\n/**\n * Returns the subgroup invocation id of requested shuffle\n *\n * @param id The invocation's subgroup_invocation_id\n * @param value The shuffle value\n * @param size The subgroup size\n * @param op The shuffle operation\n */\nfunction getShuffledId(id: number, value: number, op: ShuffleOp): number {\n  switch (op) {\n    case 'subgroupShuffle':\n      return value;\n    case 'subgroupShuffleUp':\n      return id - value;\n    case 'subgroupShuffleDown':\n      return id + value;\n    case 'subgroupShuffleXor':\n      return id ^ value;\n  }\n  assert(false);\n  return 0;\n}\n\n/**\n * Checks results of compute passes\n *\n * @param metadata An array of uint32 values\n *                 * first half is subgroup_invocation_id\n *                 * second half is unique generated subgroup id\n * @param output An array of uint32 values\n *               * first half is shuffle results\n *               * second half is subgroup_size\n * @param input An array of uint32 input values\n * @param op The shuffle\n * @param numInvs The number of invocations\n * @param filter A predicate to filter invocations\n */\nfunction checkCompute(\n  metadata: Uint32Array,\n  output: Uint32Array,\n  input: Uint32Array,\n  op: ShuffleOp,\n  numInvs: number,\n  filter: (id: number, size: number) => boolean\n): Error | undefined {\n  const sub_unique_id_to_inv_idx = new Map<number, number[]>();\n  const empty = [...iterRange(128, x => -1)];\n  for (let inv = 0; inv < numInvs; inv++) {\n    const id = metadata[inv];\n    const subgroup_unique_id = metadata[inv + numInvs];\n    const v = sub_unique_id_to_inv_idx.get(subgroup_unique_id) ?? Array.from(empty);\n    v[id] = inv;\n    sub_unique_id_to_inv_idx.set(subgroup_unique_id, v);\n  }\n\n  for (let inv = 0; inv < numInvs; inv++) {\n    const id = metadata[inv];\n    const subgroup_unique_id = metadata[inv + numInvs];\n    const sub_inv_id_to_inv_idx = sub_unique_id_to_inv_idx.get(subgroup_unique_id) ?? empty;\n\n    const res = output[inv];\n    const size = output[inv + numInvs];\n\n    // subgroup id predicated in shader\n    if (!filter(id, size)) {\n      continue;\n    }\n\n    let inputValue = input[inv];\n    if (op !== 'subgroupShuffle') {\n      // Because we use 'subgroupBroadcastFirst' without predication.\n      const first_subgroup_inv_id = 0;\n      inputValue = input[sub_inv_id_to_inv_idx[first_subgroup_inv_id]];\n    }\n\n    const shuffled_target_id = getShuffledId(id, inputValue, op);\n    if (\n      shuffled_target_id < 0 ||\n      shuffled_target_id >= 128 ||\n      sub_inv_id_to_inv_idx[shuffled_target_id] === -1\n    ) {\n      continue;\n    }\n\n    // subgroup id predicated in shader\n    if (!filter(shuffled_target_id, size)) {\n      continue;\n    }\n\n    if (res !== sub_inv_id_to_inv_idx[shuffled_target_id]) {\n      return new Error(`Invocation ${inv}: unexpected result\n- expected: ${sub_inv_id_to_inv_idx[shuffled_target_id]}\n-      got: ${res}\n-      id = ${id}\n-      size = ${size}\n-      inputValue = ${inputValue}\n-      shuffled_target_id = ${shuffled_target_id}\n-      subgroup_unique_id = ${subgroup_unique_id}`);\n    }\n  }\n\n  return undefined;\n}\n\ng.test('compute,all_active')\n  .desc(`Test randomized inputs across many workgroup sizes`)\n  .params(u =>\n    u\n      .combine('wgSize', kWGSizes)\n      .combine('op', kOps)\n      .beginSubcases()\n      .combine('case', [...iterRange(kNumCases, x => x)])\n  )\n  .fn(async t => {\n    t.skipIfDeviceDoesNotHaveFeature('subgroups' as GPUFeatureName);\n    const wgThreads = t.params.wgSize[0] * t.params.wgSize[1] * t.params.wgSize[2];\n\n    let selectValue = `input[lid]`;\n    if (t.params.op !== 'subgroupShuffle') {\n      // delta and mask operands must be subgroup uniform\n      selectValue = `subgroupBroadcastFirst(input[lid])`;\n    }\n\n    const wgsl = `\nenable subgroups;\ndiagnostic(off, subgroup_uniformity);\n\n@group(0) @binding(0)\nvar<storage> input : array<u32, ${wgThreads}>;\n\nstruct Output {\n  res : array<u32, ${wgThreads}>,\n  size : array<u32, ${wgThreads}>\n}\n\n@group(0) @binding(1)\nvar<storage, read_write> output : Output;\n\nstruct Metadata {\n  id : array<u32, ${wgThreads}>,\n  subgroup_id : array<u32, ${wgThreads}>\n}\n\n@group(0) @binding(2)\nvar<storage, read_write> metadata : Metadata;\n\n@compute @workgroup_size(${t.params.wgSize[0]}, ${t.params.wgSize[1]}, ${t.params.wgSize[2]})\nfn main(\n  @builtin(local_invocation_index) lid : u32,\n  @builtin(subgroup_invocation_id) id : u32,\n  @builtin(subgroup_size) subgroupSize : u32,\n) {\n  metadata.id[lid] = id;\n  metadata.subgroup_id[lid] = subgroupBroadcastFirst(lid + 1); // avoid 0\n\n  output.size[lid] = subgroupSize;\n  output.res[lid] = ${t.params.op}(lid, ${selectValue});\n}`;\n\n    const inputArray = generateInputs(t.params.case, wgThreads);\n    const numUintsPerOutput = 2;\n    await runComputeTest(\n      t,\n      wgsl,\n      [t.params.wgSize[0], t.params.wgSize[1], t.params.wgSize[2]],\n      numUintsPerOutput,\n      inputArray,\n      (metadata: Uint32Array, output: Uint32Array) => {\n        return checkCompute(\n          metadata,\n          output,\n          inputArray,\n          t.params.op,\n          wgThreads,\n          (id: number, size: number) => {\n            return true;\n          }\n        );\n      }\n    );\n  });\n\ng.test('compute,split')\n  .desc(`Test randomized inputs across many workgroup sizes`)\n  .params(u =>\n    u\n      .combine('predicate', keysOf(kPredicateCases))\n      .combine('op', kOps)\n      .beginSubcases()\n      .combine('wgSize', kWGSizes)\n  )\n  .fn(async t => {\n    t.skipIfDeviceDoesNotHaveFeature('subgroups' as GPUFeatureName);\n    const testcase = kPredicateCases[t.params.predicate];\n    const wgThreads = t.params.wgSize[0] * t.params.wgSize[1] * t.params.wgSize[2];\n\n    let value = `input[lidx]`;\n    if (t.params.op !== 'subgroupShuffle') {\n      value = `subgroupBroadcastFirst(input[lidx])`;\n    }\n\n    const wgsl = `\nenable subgroups;\ndiagnostic(off, subgroup_uniformity);\n\n@group(0) @binding(0)\nvar<storage> input : array<u32, ${wgThreads}>;\n\nstruct Output {\n  res : array<u32, ${wgThreads}>,\n  size : array<u32, ${wgThreads}>\n}\n\n@group(0) @binding(1)\nvar<storage, read_write> output : Output;\n\nstruct Metadata {\n  id : array<u32, ${wgThreads}>,\n  subgroup_id : array<u32, ${wgThreads}>\n}\n\n@group(0) @binding(2)\nvar<storage, read_write> metadata : Metadata;\n\n@compute @workgroup_size(${t.params.wgSize[0]}, ${t.params.wgSize[1]}, ${t.params.wgSize[2]})\nfn main(\n  @builtin(local_invocation_index) lidx : u32,\n  @builtin(subgroup_invocation_id) id : u32,\n  @builtin(subgroup_size) subgroupSize : u32,\n) {\n  _ = input[0];\n  metadata.id[lidx] = id;\n  // Made from lidx but not lidx to avoid value confusion.\n  var fake_unique_id = lidx + 1000;\n  metadata.subgroup_id[lidx] = subgroupBroadcastFirst(fake_unique_id);\n\n  output.size[lidx] = subgroupSize;\n  let value = ${value};\n  if ${testcase.cond} {\n    output.res[lidx] = ${t.params.op}(lidx, value);\n  } else {\n    return;\n  }\n}`;\n\n    const inputArray = new Uint32Array([...iterRange(wgThreads, x => x % 128)]);\n    const numUintsPerOutput = 2;\n    await runComputeTest(\n      t,\n      wgsl,\n      [t.params.wgSize[0], t.params.wgSize[1], t.params.wgSize[2]],\n      numUintsPerOutput,\n      inputArray,\n      (metadata: Uint32Array, output: Uint32Array) => {\n        return checkCompute(metadata, output, inputArray, t.params.op, wgThreads, testcase.filter);\n      }\n    );\n  });\n\n/**\n * Checks the results of the data types test\n *\n * The outputs for a given index are expected to match the input values\n * for the given shuffle (op and id).\n * @param metadata An unused parameter\n * @param output The output data\n * @param op The shuffle\n * @param id The shuffle id/mask/delta parameter\n * @param type The data type\n */\nfunction checkDataTypes(\n  metadata: Uint32Array, // unused\n  output: Uint32Array,\n  input: Uint32Array,\n  op: ShuffleOp,\n  id: number,\n  type: Type\n): Error | undefined {\n  if (type.requiresF16() && !(type instanceof VectorType)) {\n    for (let i = 0; i < 4; i++) {\n      const index = getShuffledId(i, id, op);\n      if (index < 0 || index >= 4) {\n        continue;\n      }\n\n      const expectIdx = Math.floor(index / 2);\n      const expectShift = index % 2 === 1;\n      let expect = input[expectIdx];\n      if (expectShift) {\n        expect >>= 16;\n      }\n      expect &= 0xffff;\n\n      const resIdx = Math.floor(i / 2);\n      const resShift = i % 2 === 1;\n      let res = output[resIdx];\n      if (resShift) {\n        res >>= 16;\n      }\n      res &= 0xffff;\n\n      if (res !== expect) {\n        return new Error(`${i}: incorrect result\n- expected: ${expect}\n-      got: ${res}`);\n      }\n    }\n  } else {\n    let uints = 1;\n    if (type instanceof VectorType) {\n      uints = type.width === 3 ? 4 : type.width;\n      if (type.requiresF16()) {\n        uints = Math.floor(uints / 2);\n      }\n    }\n    for (let i = 0; i < 4; i++) {\n      for (let j = 0; j < uints; j++) {\n        const index = getShuffledId(i, id, op);\n        if (index < 0 || index >= 4) {\n          continue;\n        }\n\n        const expect = input[index * uints + j];\n        const res = output[i * uints + j];\n        if (res !== expect) {\n          return new Error(`${uints * i + j}: incorrect result\n- expected: ${expect}\n-      got: ${res}`);\n        }\n      }\n    }\n  }\n\n  return undefined;\n}\n\ng.test('data_types')\n  .params(u =>\n    u\n      .combine('op', kOps)\n      .combine('type', keysOf(kTypes))\n      .beginSubcases()\n      .combine('id', [0, 1, 2, 3] as const)\n  )\n  .fn(async t => {\n    const wgSize = [4, 1, 1];\n    const type = kTypes[t.params.type];\n    t.skipIfDeviceDoesNotHaveFeature('subgroups' as GPUFeatureName);\n    if (type.requiresF16()) {\n      t.skipIfDeviceDoesNotHaveFeature('shader-f16');\n    }\n\n    let enables = `enable subgroups;\\n`;\n    if (type.requiresF16()) {\n      enables += `enable f16;`;\n    }\n    const wgsl = `\n${enables}\n\n@group(0) @binding(0)\nvar<storage> input : array<${type.toString()}>;\n\n@group(0) @binding(1)\nvar<storage, read_write> output : array<${type.toString()}>;\n\n@group(0) @binding(2)\nvar<storage, read_write> metadata : array<u32>; // unused\n\n@compute @workgroup_size(${wgSize[0]}, ${wgSize[1]}, ${wgSize[2]})\nfn main(\n  @builtin(subgroup_invocation_id) id : u32,\n) {\n  // Force usage\n  _ = metadata[0];\n\n  output[id] = ${t.params.op}(input[id], ${t.params.id});\n}`;\n\n    const inputData = generateTypedInputs(type);\n    let uintsPerOutput = 1;\n    if (type instanceof VectorType) {\n      uintsPerOutput = type.width === 3 ? 4 : type.width;\n      if (type.requiresF16()) {\n        uintsPerOutput = Math.floor(uintsPerOutput / 2);\n      }\n    }\n    await runComputeTest(\n      t,\n      wgsl,\n      wgSize,\n      uintsPerOutput,\n      inputData,\n      (metadata: Uint32Array, output: Uint32Array) => {\n        return checkDataTypes(metadata, output, inputData, t.params.op, t.params.id, type);\n      }\n    );\n  });\n\n/**\n * Check subgroup shuffles in fragment shaders\n *\n * @param data The framebuffer output\n *             * component 0 is the result\n *             * component 1 is the subgroup_invocation_id\n *             * component 2 is a unique generated subgroup_id\n * @param format The framebuffer format\n * @param width Framebuffer width\n * @param height Framebuffer height\n * @param shuffleId The value of the shuffle parameter (e.g. id/mask/delta)\n * @param op The shuffle operation\n */\nfunction checkFragment(\n  data: Uint32Array,\n  format: GPUTextureFormat,\n  width: number,\n  height: number,\n  shuffleId: number,\n  op: ShuffleOp\n): Error | undefined {\n  if (width < 3 || height < 3) {\n    return new Error(\n      `Insufficient framebuffer size [${width}w x ${height}h]. Minimum is [3w x 3h].`\n    );\n  }\n\n  const { uintsPerRow, uintsPerTexel } = getUintsPerFramebuffer(format, width, height);\n\n  const coordToIndex = (row: number, col: number) => {\n    return uintsPerRow * row + col * uintsPerTexel;\n  };\n\n  const mapping = new Map<number, number[]>();\n  const empty = [...iterRange(128, x => -1)];\n\n  // Iteration skips last row and column to avoid helper invocations because it is not\n  // guaranteed whether or not they participate in the subgroup operation.\n  for (let row = 0; row < height - 1; row++) {\n    for (let col = 0; col < width - 1; col++) {\n      const offset = coordToIndex(row, col);\n\n      const id = data[offset + 1];\n      const subgroup_id = data[offset + 2];\n\n      const v = mapping.get(subgroup_id) ?? Array.from(empty);\n      v[id] = col + row * width;\n      mapping.set(subgroup_id, v);\n    }\n  }\n\n  for (let row = 0; row < height - 1; row++) {\n    for (let col = 0; col < width - 1; col++) {\n      const offset = coordToIndex(row, col);\n\n      const res = data[offset];\n      const id = data[offset + 1];\n      const subgroup_id = data[offset + 2];\n\n      const subgroupMapping = mapping.get(subgroup_id) ?? empty;\n\n      const index = getShuffledId(id, shuffleId, op);\n      if (index < 0 || index >= 128 || subgroupMapping[index] === -1) {\n        continue;\n      }\n\n      const shuffleLinear = subgroupMapping[index];\n      const shuffleRow = Math.floor(shuffleLinear / width);\n      const shuffleCol = shuffleLinear % width;\n      if (shuffleRow === height - 1 || shuffleCol === width - 1) {\n        continue;\n      }\n\n      if (res !== subgroupMapping[index]) {\n        return new Error(`Row ${row}, col ${col}: incorrect results:\n- expected: ${subgroupMapping[index]}\n-      got: ${res}`);\n      }\n    }\n  }\n\n  return undefined;\n}\n\ng.test('fragment')\n  .desc(`Test shuffles in fragment shaders`)\n  .params(u =>\n    u\n      .combine('size', kFramebufferSizes)\n      .beginSubcases()\n      .combine('op', kOps)\n      .combine('id', [0, 1, 2, 3] as const)\n      .combineWithParams([{ format: 'rgba32uint' }] as const)\n  )\n  .fn(async t => {\n    t.skipIfDeviceDoesNotHaveFeature('subgroups' as GPUFeatureName);\n    const fsShader = `\nenable subgroups;\n\n@group(0) @binding(0)\nvar<uniform> inputs : array<vec4u, 1>; // unused\n\n@fragment\nfn main(\n  @builtin(position) pos : vec4f,\n  @builtin(subgroup_invocation_id) id : u32,\n) -> @location(0) vec4u {\n  // Force usage\n  _ = inputs[0];\n\n  let linear = u32(pos.x) + u32(pos.y) * ${t.params.size[0]};\n  let subgroup_id = subgroupBroadcastFirst(linear + 1);\n\n  // Filter out possible helper invocations.\n  let x_in_range = u32(pos.x) < (${t.params.size[0]} - 1);\n  let y_in_range = u32(pos.y) < (${t.params.size[1]} - 1);\n  let in_range = x_in_range && y_in_range;\n\n  return vec4u(${t.params.op}(linear, ${t.params.id}), id, subgroup_id, linear);\n}`;\n\n    await runFragmentTest(\n      t,\n      t.params.format,\n      fsShader,\n      t.params.size[0],\n      t.params.size[1],\n      new Uint32Array([0]), // unused,\n      (data: Uint32Array) => {\n        return checkFragment(\n          data,\n          t.params.format,\n          t.params.size[0],\n          t.params.size[1],\n          t.params.id,\n          t.params.op\n        );\n      }\n    );\n  });\n"],"mappings":"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"}