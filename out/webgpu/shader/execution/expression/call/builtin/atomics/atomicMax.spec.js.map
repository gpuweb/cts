{"version":3,"file":"atomicMax.spec.js","names":["description","makeTestGroup","GPUTest","dispatchSizes","workgroupSizes","runStorageVariableTest","runWorkgroupVariableTest","typedArrayCtor","g","test","specURL","desc","params","u","combine","fn","t","numInvocations","workgroupSize","dispatchSize","bufferNumElements","initValue","op","expected","scalarType","wgNumElements","fill","d","wg","subarray"],"sources":["../../../../../../../../src/webgpu/shader/execution/expression/call/builtin/atomics/atomicMax.spec.ts"],"sourcesContent":["export const description = `\nAtomically read, max and store value.\n\n* Load the original value pointed to by atomic_ptr.\n* Obtains a new value by taking the max with the value v.\n* Store the new value using atomic_ptr.\n\nReturns the original value stored in the atomic object.\n`;\n\nimport { makeTestGroup } from '../../../../../../../common/framework/test_group.js';\nimport { GPUTest } from '../../../../../../gpu_test.js';\n\nimport {\n  dispatchSizes,\n  workgroupSizes,\n  runStorageVariableTest,\n  runWorkgroupVariableTest,\n  typedArrayCtor,\n} from './harness.js';\n\nexport const g = makeTestGroup(GPUTest);\n\ng.test('max_storage')\n  .specURL('https://www.w3.org/TR/WGSL/#atomic-rmw')\n  .desc(\n    `\nAS is storage or workgroup\nT is i32 or u32\n\nfn atomicMax(atomic_ptr: ptr<AS, atomic<T>, read_write>, v: T) -> T\n`\n  )\n  .params(u =>\n    u\n      .combine('workgroupSize', workgroupSizes)\n      .combine('dispatchSize', dispatchSizes)\n      .combine('scalarType', ['u32', 'i32'] as const)\n  )\n  .fn(t => {\n    const numInvocations = t.params.workgroupSize * t.params.dispatchSize;\n    // Allocate one extra element to ensure it doesn't get modified\n    const bufferNumElements = 2;\n\n    const initValue = 0;\n    const op = `atomicMax(&output[0], id)`;\n    const expected = new (typedArrayCtor(t.params.scalarType))(bufferNumElements);\n    expected[0] = numInvocations - 1;\n\n    runStorageVariableTest({\n      t,\n      workgroupSize: t.params.workgroupSize,\n      dispatchSize: t.params.dispatchSize,\n      bufferNumElements,\n      initValue,\n      op,\n      expected,\n    });\n  });\n\ng.test('max_workgroup')\n  .specURL('https://www.w3.org/TR/WGSL/#atomic-rmw')\n  .desc(\n    `\nAS is storage or workgroup\nT is i32 or u32\n\nfn atomicMax(atomic_ptr: ptr<AS, atomic<T>, read_write>, v: T) -> T\n`\n  )\n  .params(u =>\n    u\n      .combine('workgroupSize', workgroupSizes)\n      .combine('dispatchSize', dispatchSizes)\n      .combine('scalarType', ['u32', 'i32'] as const)\n  )\n  .fn(t => {\n    // Allocate one extra element to ensure it doesn't get modified\n    const wgNumElements = 2;\n\n    const initValue = 0;\n    const op = `atomicMax(&wg[0], id)`;\n\n    const expected = new (typedArrayCtor(t.params.scalarType))(\n      wgNumElements * t.params.dispatchSize\n    ).fill(initValue);\n    for (let d = 0; d < t.params.dispatchSize; ++d) {\n      const wg = expected.subarray(d * wgNumElements);\n      wg[0] = t.params.workgroupSize - 1;\n    }\n\n    runWorkgroupVariableTest({\n      t,\n      workgroupSize: t.params.workgroupSize,\n      dispatchSize: t.params.dispatchSize,\n      wgNumElements,\n      initValue,\n      op,\n      expected,\n    });\n  });\n"],"mappings":"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"}