{"version":3,"file":"invariant.spec.js","names":["description","makeTestGroup","keysOf","ShaderValidationTest","kBuiltins","generateShader","g","kTests","invariant","src","pass","comment","split_line","empty_parens","value","missing_right_paren","missing_left_paren","duplicate","test","desc","params","u","combine","fn","t","code","attr","expectCompileResult","combineWithParams","beginSubcases","attribute","name","type","stage","io","use_struct","has_position","use_invariant"],"sources":["../../../../../src/webgpu/shader/validation/shader_io/invariant.spec.ts"],"sourcesContent":["export const description = `Validation tests for the invariant attribute`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { keysOf } from '../../../../common/util/data_tables.js';\nimport { ShaderValidationTest } from '../shader_validation_test.js';\n\nimport { kBuiltins } from './builtins.spec.js';\nimport { generateShader } from './util.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\nconst kTests = {\n  invariant: {\n    src: `@invariant`,\n    pass: true,\n  },\n  comment: {\n    src: `@/* comment */invariant`,\n    pass: true,\n  },\n  split_line: {\n    src: '@\\ninvariant',\n    pass: true,\n  },\n  empty_parens: {\n    src: `@invariant()`,\n    pass: false,\n  },\n  value: {\n    src: `@invariant(0)`,\n    pass: false,\n  },\n  missing_right_paren: {\n    src: `@invariant(`,\n    pass: false,\n  },\n  missing_left_paren: {\n    src: `@invariant)`,\n    pass: false,\n  },\n  duplicate: {\n    src: `@invariant @invariant`,\n    pass: false,\n  },\n};\n\ng.test('parsing')\n  .desc(`Test parsing of the invariant attribute`)\n  .params(u => u.combine('attr', keysOf(kTests)))\n  .fn(t => {\n    const code = `\n    struct VertexOut {\n      @builtin(position) ${kTests[t.params.attr].src} position : vec4<f32>\n    };\n    @vertex\n    fn main() -> VertexOut {\n      return VertexOut();\n    }\n    `;\n    t.expectCompileResult(kTests[t.params.attr].pass, code);\n  });\n\ng.test('valid_only_with_vertex_position_builtin')\n  .desc(`Test that the invariant attribute is only accepted with the vertex position builtin`)\n  .params(u =>\n    u\n      .combineWithParams(kBuiltins)\n      .combine('use_struct', [true, false] as const)\n      .beginSubcases()\n  )\n  .fn(t => {\n    const code = generateShader({\n      attribute: `@builtin(${t.params.name}) @invariant`,\n      type: t.params.type,\n      stage: t.params.stage,\n      io: t.params.io,\n      use_struct: t.params.use_struct,\n    });\n\n    t.expectCompileResult(t.params.name === 'position', code);\n  });\n\ng.test('valid_only_with_position_in_non_entry_point_struct')\n  .desc(\n    `Test that the invariant attribute requires position, regardless if the struct is used in an entry point`\n  )\n  .params(u => u.combine('has_position', [true, false] as const))\n  .fn(t => {\n    let code = 'struct A {\\n';\n    code += '  @invariant';\n    if (t.params.has_position) {\n      code += ' @builtin(position)';\n    }\n    code += '  a : vec4f,\\n';\n    code += '}\\n';\n    code += '@group(0) @binding(0) var<storage> a: A;\\n';\n    code += '@compute @workgroup_size(1) fn main() { let b = a; }';\n\n    t.expectCompileResult(t.params.has_position, code);\n  });\n\ng.test('not_valid_on_user_defined_io')\n  .desc(`Test that the invariant attribute is not accepted on user-defined IO attributes.`)\n  .params(u => u.combine('use_invariant', [true, false] as const).beginSubcases())\n  .fn(t => {\n    const invariant = t.params.use_invariant ? '@invariant' : '';\n    const code = `\n    struct VertexOut {\n      @location(0) ${invariant} loc0 : vec4<f32>,\n      @builtin(position) position : vec4<f32>,\n    };\n    @vertex\n    fn main() -> VertexOut {\n      return VertexOut();\n    }\n    `;\n    t.expectCompileResult(!t.params.use_invariant, code);\n  });\n"],"mappings":"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"}