{"version":3,"file":"group_and_binding.spec.js","names":["description","makeTestGroup","ShaderValidationTest","declareEntrypoint","kResourceEmitters","kResourceKindsA","kResourceKindsAll","kResourceKindsB","g","test","desc","params","u","combine","beginSubcases","fn","t","emitter","get","resource","code","has_group","undefined","has_binding","expect","expectCompileResult","filter","stage","b_kind","resourceA","a_kind","resourceB","resources","a_group","a_binding","b_group","b_binding","usage","b_stage","a_stage"],"sources":["../../../../../src/webgpu/shader/validation/shader_io/group_and_binding.spec.ts"],"sourcesContent":["export const description = `Validation tests for group and binding`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { ShaderValidationTest } from '../shader_validation_test.js';\n\nimport {\n  declareEntrypoint,\n  kResourceEmitters,\n  kResourceKindsA,\n  kResourceKindsAll,\n  kResourceKindsB,\n  ResourceDeclarationEmitter,\n} from './util.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\ng.test('binding_attributes')\n  .desc(`Test that both @group and @binding attributes must both be declared.`)\n  .params(u =>\n    u\n      .combine('stage', ['vertex', 'fragment', 'compute'] as const)\n      .combine('has_group', [true, false] as const)\n      .combine('has_binding', [true, false] as const)\n      .combine('resource', kResourceKindsAll)\n      .beginSubcases()\n  )\n  .fn(t => {\n    const emitter = kResourceEmitters.get(t.params.resource) as ResourceDeclarationEmitter;\n    //const emitter = kResourceEmitters.get('uniform') as ResourceDeclarationEmitter;\n    const code = emitter(\n      'R',\n      t.params.has_group ? 0 : undefined,\n      t.params.has_binding ? 0 : undefined\n    );\n    const expect = t.params.has_group && t.params.has_binding;\n    t.expectCompileResult(expect, code);\n  });\n\ng.test('private_module_scope')\n  .desc(`Test validation of group and binding on private resources`)\n  .fn(t => {\n    const code = `\n@group(1) @binding(1)\nvar<private> a: i32;\n\n@workgroup_size(1, 1, 1)\n@compute fn main() {\n  _ = a;\n}`;\n    t.expectCompileResult(false, code);\n  });\n\ng.test('private_function_scope')\n  .desc(`Test validation of group and binding on function-scope private resources`)\n  .fn(t => {\n    const code = `\n@workgroup_size(1, 1, 1)\n@compute fn main() {\n  @group(1) @binding(1)\n  var<private> a: i32;\n}`;\n    t.expectCompileResult(false, code);\n  });\n\ng.test('function_scope')\n  .desc(`Test validation of group and binding on function-scope private resources`)\n  .fn(t => {\n    const code = `\n@workgroup_size(1, 1, 1)\n@compute fn main() {\n  @group(1) @binding(1)\n  var a: i32;\n}`;\n    t.expectCompileResult(false, code);\n  });\n\ng.test('function_scope_texture')\n  .desc(`Test validation of group and binding on function-scope private resources`)\n  .fn(t => {\n    const code = `\n@workgroup_size(1, 1, 1)\n@compute fn main() {\n  @group(1) @binding(1)\n  var a: texture_2d<f32>;\n}`;\n    t.expectCompileResult(false, code);\n  });\n\ng.test('single_entry_point')\n  .desc(\n    `Test that two different resource variables in a shader must not have the same group and binding values, when considered as a pair.`\n  )\n  .params(u =>\n    u\n      .combine('stage', ['vertex', 'fragment', 'compute'] as const)\n      .combine('a_kind', kResourceKindsA)\n      .combine('b_kind', kResourceKindsB)\n      .combine('usage', ['direct', 'transitive'] as const)\n      .filter(t => {\n        return !(t.stage === 'vertex' && t.b_kind === 'texture_storage_1d');\n      })\n      .beginSubcases()\n      .combine('a_group', [0, 3] as const)\n      .combine('b_group', [0, 3] as const)\n      .combine('a_binding', [0, 3] as const)\n      .combine('b_binding', [0, 3] as const)\n  )\n  .fn(t => {\n    const resourceA = kResourceEmitters.get(t.params.a_kind) as ResourceDeclarationEmitter;\n    const resourceB = kResourceEmitters.get(t.params.b_kind) as ResourceDeclarationEmitter;\n    const resources = `\n${resourceA('resource_a', t.params.a_group, t.params.a_binding)}\n${resourceB('resource_b', t.params.b_group, t.params.b_binding)}\n`;\n    const expect =\n      t.params.a_group !== t.params.b_group || t.params.a_binding !== t.params.b_binding;\n\n    if (t.params.usage === 'direct') {\n      const code = `\n${resources}\n${declareEntrypoint('main', t.params.stage, '_ = resource_a; _ = resource_b;')}\n`;\n      t.expectCompileResult(expect, code);\n    } else {\n      const code = `\n${resources}\nfn use_a() { _ = resource_a; }\nfn use_b() { _ = resource_b; }\n${declareEntrypoint('main', t.params.stage, 'use_a(); use_b();')}\n`;\n      t.expectCompileResult(expect, code);\n    }\n  });\n\ng.test('different_entry_points')\n  .desc(\n    `Test that resources may use the same binding points if exclusively accessed by different entry points.`\n  )\n  .params(u =>\n    u\n      .combine('a_stage', ['vertex', 'fragment', 'compute'] as const)\n      .combine('b_stage', ['vertex', 'fragment', 'compute'] as const)\n      .combine('a_kind', kResourceKindsA)\n      .combine('b_kind', kResourceKindsB)\n      .combine('usage', ['direct', 'transitive'] as const)\n      .filter(t => {\n        return !(t.b_stage === 'vertex' && t.b_kind === 'texture_storage_1d');\n      })\n      .beginSubcases()\n  )\n  .fn(t => {\n    const resourceA = kResourceEmitters.get(t.params.a_kind) as ResourceDeclarationEmitter;\n    const resourceB = kResourceEmitters.get(t.params.b_kind) as ResourceDeclarationEmitter;\n    const resources = `\n${resourceA('resource_a', /* group */ 0, /* binding */ 0)}\n${resourceB('resource_b', /* group */ 0, /* binding */ 0)}\n`;\n    const expect = true; // Binding reuse between different entry points is fine.\n\n    if (t.params.usage === 'direct') {\n      const code = `\n${resources}\n${declareEntrypoint('main_a', t.params.a_stage, '_ = resource_a;')}\n${declareEntrypoint('main_b', t.params.b_stage, '_ = resource_b;')}\n`;\n      t.expectCompileResult(expect, code);\n    } else {\n      const code = `\n${resources}\nfn use_a() { _ = resource_a; }\nfn use_b() { _ = resource_b; }\n${declareEntrypoint('main_a', t.params.a_stage, 'use_a();')}\n${declareEntrypoint('main_b', t.params.b_stage, 'use_b();')}\n`;\n      t.expectCompileResult(expect, code);\n    }\n  });\n"],"mappings":"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"}