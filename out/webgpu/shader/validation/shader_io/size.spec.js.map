{"version":3,"file":"size.spec.js","names":["description","makeTestGroup","keysOf","ShaderValidationTest","g","kSizeTests","valid","src","pass","non_align_size","i32","u32","constant","const_expr","trailing_comma","hex","whitespace","comment","large","misspelling","no_value","missing_left_paren","missing_right_paren","missing_parens","multiple_values","override","zero","negative","f32_literal","f32","duplicate1","duplicate2","too_small","test","desc","params","u","combine","fn","t","code","attr","expectCompileResult","skipIfDeviceDoesNotHaveFeature","ext","kNonStructTests","control","mod_src","func_src","size","struct","vec","mat","array","scalar","data","array_size"],"sources":["../../../../../src/webgpu/shader/validation/shader_io/size.spec.ts"],"sourcesContent":["export const description = `Validation tests for size`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { keysOf } from '../../../../common/util/data_tables.js';\nimport { ShaderValidationTest } from '../shader_validation_test.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\nconst kSizeTests = {\n  valid: {\n    src: `@size(4)`,\n    pass: true,\n  },\n  non_align_size: {\n    src: `@size(5)`,\n    pass: true,\n  },\n  i32: {\n    src: `@size(4i)`,\n    pass: true,\n  },\n  u32: {\n    src: `@size(4u)`,\n    pass: true,\n  },\n  constant: {\n    src: `@size(z)`,\n    pass: true,\n  },\n  const_expr: {\n    src: `@size(z + 4)`,\n    pass: true,\n  },\n  trailing_comma: {\n    src: `@size(4,)`,\n    pass: true,\n  },\n  hex: {\n    src: `@size(0x4)`,\n    pass: true,\n  },\n  whitespace: {\n    src: '@\\nsize(4)',\n    pass: true,\n  },\n  comment: {\n    src: `@/* comment */size(4)`,\n    pass: true,\n  },\n  large: {\n    src: `@size(2147483647)`,\n    pass: true,\n  },\n\n  misspelling: {\n    src: `@msize(4)`,\n    pass: false,\n  },\n  no_value: {\n    src: `@size()`,\n    pass: false,\n  },\n  missing_left_paren: {\n    src: `@size 4)`,\n    pass: false,\n  },\n  missing_right_paren: {\n    src: `@size(4`,\n    pass: false,\n  },\n  missing_parens: {\n    src: `@size`,\n    pass: false,\n  },\n  multiple_values: {\n    src: `@size(4, 8)`,\n    pass: false,\n  },\n  override: {\n    src: `@size(over)`,\n    pass: false,\n  },\n  zero: {\n    src: `@size(0)`,\n    pass: false,\n  },\n  negative: {\n    src: `@size(-4)`,\n    pass: false,\n  },\n  f32_literal: {\n    src: `@size(4.0)`,\n    pass: false,\n  },\n  f32: {\n    src: `@size(4f)`,\n    pass: false,\n  },\n  duplicate1: {\n    src: `@size(4) @size(4)`,\n    pass: false,\n  },\n  duplicate2: {\n    src: `@size(4) @size(8)`,\n    pass: false,\n  },\n  too_small: {\n    src: `@size(1)`,\n    pass: false,\n  },\n};\n\ng.test('size')\n  .desc(`Test validation of size`)\n  .params(u => u.combine('attr', keysOf(kSizeTests)))\n  .fn(t => {\n    const code = `\noverride over: i32 = 4;\nconst z: i32 = 4;\n\nstruct S {\n  ${kSizeTests[t.params.attr].src} a: f32,\n};\n@group(0) @binding(0)\nvar<storage> a: S;\n\n@workgroup_size(1)\n@compute fn main() {\n  _ = a;\n}`;\n    t.expectCompileResult(kSizeTests[t.params.attr].pass, code);\n  });\n\ng.test('size_fp16')\n  .desc(`Test validation of size with fp16`)\n  .params(u => u.combine('ext', ['', 'h']))\n  .fn(t => {\n    t.skipIfDeviceDoesNotHaveFeature('shader-f16');\n    const code = `\nstruct S {\n  @size(4${t.params.ext}) a: f32,\n}\n@group(0) @binding(0)\nvar<storage> a: S;\n\n@workgroup_size(1)\n@compute fn main() {\n  _ = a;\n}`;\n    t.expectCompileResult(t.params.ext === '', code);\n  });\n\nconst kNonStructTests = {\n  control: {\n    mod_src: ``,\n    func_src: ``,\n    size: 0,\n    pass: true,\n  },\n  struct: {\n    mod_src: `struct S { a: f32 }`,\n    func_src: ``,\n    size: 4,\n    pass: false,\n  },\n  constant: {\n    mod_src: `const a: f32 = 4.0;`,\n    func_src: ``,\n    size: 4,\n    pass: false,\n  },\n  vec: {\n    mod_src: ``,\n    func_src: `vec4<f32>`,\n    size: 16,\n    pass: false,\n  },\n  mat: {\n    mod_src: ``,\n    func_src: `mat4x4<f32>`,\n    size: 64,\n    pass: false,\n  },\n  array: {\n    mod_src: ``,\n    func_src: `array<f32, 4>`,\n    size: 16,\n    pass: false,\n  },\n  scalar: {\n    mod_src: ``,\n    func_src: `f32`,\n    size: 4,\n    pass: false,\n  },\n};\n\ng.test('size_non_struct')\n  .desc(`Test validation of size outside of a struct`)\n  .params(u => u.combine('attr', keysOf(kNonStructTests)))\n  .fn(t => {\n    const data = kNonStructTests[t.params.attr];\n    let code = '';\n    if (data.mod_src !== '') {\n      code += `@size(${data.size}) ${data.mod_src}`;\n    }\n\n    code += `\n@workgroup_size(1)\n@compute fn main() {\n`;\n    if (data.func_src !== '') {\n      code += `@size(${data.size}) var a: ${data.func_src};`;\n    }\n    code += '}';\n\n    t.expectCompileResult(data.pass, code);\n  });\n\ng.test('size_creation_fixed_footprint')\n  .desc(`Test that @size is only valid on types that have creation-fixed footprint.`)\n  .params(u => u.combine('array_size', [', 4', '']))\n  .fn(t => {\n    const code = `\nstruct S {\n  @size(64) a: array<f32${t.params.array_size}>,\n};\n@group(0) @binding(0)\nvar<storage> a: S;\n\n@workgroup_size(1)\n@compute fn main() {\n  _ = a.a[0];\n}`;\n    t.expectCompileResult(t.params.array_size !== '', code);\n  });\n"],"mappings":"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"}