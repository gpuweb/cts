{"version":3,"file":"subgroupAdd.spec.js","names":["description","makeTestGroup","keysOf","objectsToRecord","Type","elementTypeOf","kAllScalarsAndVectors","ShaderValidationTest","g","kBuiltins","kStages","constant","builtin","override","runtime","test","desc","params","u","combine","beginSubcases","fn","t","code","stage","expectCompileResult","wgsl","must_use","kArgumentTypes","type","enables","requiresF16","create","bool","filter","retType","retEleTy","dataType","dataEleTy","abstractInt","abstractFloat","toString","expect","compute","fragment","vertex","entry","kInvalidTypeCases","array_u32","array_f32","struct_s","struct_t","ptr_func","ptr_priv","frexp_ret","val","case"],"sources":["../../../../../../../src/webgpu/shader/validation/expression/call/builtin/subgroupAdd.spec.ts"],"sourcesContent":["export const description = `\nValidation tests for subgroupAdd and subgroupExclusiveAdd\n`;\n\nimport { makeTestGroup } from '../../../../../../common/framework/test_group.js';\nimport { keysOf, objectsToRecord } from '../../../../../../common/util/data_tables.js';\nimport { Type, elementTypeOf, kAllScalarsAndVectors } from '../../../../../util/conversion.js';\nimport { ShaderValidationTest } from '../../../shader_validation_test.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\nconst kBuiltins = ['subgroupAdd', 'subgroupExclusiveAdd', 'subgroupInclusiveAdd'] as const;\n\nconst kStages: Record<string, (builtin: string) => string> = {\n  constant: (builtin: string) => {\n    return `\nenable subgroups;\n@compute @workgroup_size(16)\nfn main() {\n  const x = ${builtin}(0);\n}`;\n  },\n  override: (builtin: string) => {\n    return `\nenable subgroups;\noverride o = ${builtin}(0);`;\n  },\n  runtime: (builtin: string) => {\n    return `\nenable subgroups;\n@compute @workgroup_size(16)\nfn main() {\n  let x = ${builtin}(0);\n}`;\n  },\n};\n\ng.test('early_eval')\n  .desc('Ensures the builtin is not able to be compile time evaluated')\n  .params(u => u.combine('stage', keysOf(kStages)).beginSubcases().combine('builtin', kBuiltins))\n  .fn(t => {\n    const code = kStages[t.params.stage](t.params.builtin);\n    t.expectCompileResult(t.params.stage === 'runtime', code);\n  });\n\ng.test('must_use')\n  .desc('Tests that the builtin has the @must_use attribute')\n  .params(u =>\n    u\n      .combine('must_use', [true, false] as const)\n      .beginSubcases()\n      .combine('builtin', kBuiltins)\n  )\n  .fn(t => {\n    const wgsl = `\nenable subgroups;\n@compute @workgroup_size(16)\nfn main() {\n  ${t.params.must_use ? '_ = ' : ''}${t.params.builtin}(0);\n}`;\n\n    t.expectCompileResult(t.params.must_use, wgsl);\n  });\n\nconst kArgumentTypes = objectsToRecord(kAllScalarsAndVectors);\n\ng.test('data_type')\n  .desc('Validates data parameter type')\n  .params(u =>\n    u.combine('type', keysOf(kArgumentTypes)).beginSubcases().combine('builtin', kBuiltins)\n  )\n  .fn(t => {\n    const type = kArgumentTypes[t.params.type];\n    let enables = `enable subgroups;\\n`;\n    if (type.requiresF16()) {\n      enables += `enable f16;`;\n    }\n    const wgsl = `\n${enables}\n@compute @workgroup_size(1)\nfn main() {\n  _ = ${t.params.builtin}(${type.create(0).wgsl()});\n}`;\n\n    t.expectCompileResult(elementTypeOf(type) !== Type.bool, wgsl);\n  });\n\ng.test('return_type')\n  .desc('Validates data parameter type')\n  .params(u =>\n    u\n      .combine('dataType', keysOf(kArgumentTypes))\n      .combine('retType', keysOf(kArgumentTypes))\n      .filter(t => {\n        const retType = kArgumentTypes[t.retType];\n        const retEleTy = elementTypeOf(retType);\n        const dataType = kArgumentTypes[t.dataType];\n        const dataEleTy = elementTypeOf(dataType);\n        return (\n          retEleTy !== Type.abstractInt &&\n          retEleTy !== Type.abstractFloat &&\n          dataEleTy !== Type.abstractInt &&\n          dataEleTy !== Type.abstractFloat\n        );\n      })\n      .beginSubcases()\n      .combine('builtin', kBuiltins)\n  )\n  .fn(t => {\n    const dataType = kArgumentTypes[t.params.dataType];\n    const retType = kArgumentTypes[t.params.retType];\n    let enables = `enable subgroups;\\n`;\n    if (dataType.requiresF16() || retType.requiresF16()) {\n      enables += `enable f16;`;\n    }\n    const wgsl = `\n${enables}\n@compute @workgroup_size(1)\nfn main() {\n  let res : ${retType.toString()} = ${t.params.builtin}(${dataType.create(0).wgsl()});\n}`;\n\n    const expect = elementTypeOf(dataType) !== Type.bool && dataType === retType;\n    t.expectCompileResult(expect, wgsl);\n  });\n\ng.test('stage')\n  .desc('Validates it is only usable in correct stage')\n  .params(u =>\n    u\n      .combine('stage', ['compute', 'fragment', 'vertex'] as const)\n      .beginSubcases()\n      .combine('builtin', kBuiltins)\n  )\n  .fn(t => {\n    const compute = `\n@compute @workgroup_size(1)\nfn main() {\n  foo();\n}`;\n\n    const fragment = `\n@fragment\nfn main() {\n  foo();\n}`;\n\n    const vertex = `\n@vertex\nfn main() -> @builtin(position) vec4f {\n  foo();\n  return vec4f();\n}`;\n\n    const entry = { compute, fragment, vertex }[t.params.stage];\n    const wgsl = `\nenable subgroups;\nfn foo() {\n  _ = ${t.params.builtin}(0);\n}\n\n${entry}\n`;\n\n    t.expectCompileResult(t.params.stage !== 'vertex', wgsl);\n  });\n\nconst kInvalidTypeCases: Record<string, string> = {\n  array_u32: `array(1u,2u,3u)`,\n  array_f32: `array<f32, 4>()`,\n  struct_s: `S()`,\n  struct_t: `T(1, 1)`,\n  ptr_func: `&func_var`,\n  ptr_priv: `&priv_var`,\n  frexp_ret: `frexp(0)`,\n};\n\ng.test('invalid_types')\n  .desc('Tests that invalid non-plain types are rejected')\n  .params(u =>\n    u.combine('case', keysOf(kInvalidTypeCases)).beginSubcases().combine('builtin', kBuiltins)\n  )\n  .fn(t => {\n    const val = kInvalidTypeCases[t.params.case];\n    const wgsl = `\nenable subgroups;\n\nstruct S {\n  x : u32\n}\n\nstruct T {\n  a : f32,\n  b : u32,\n}\n\nvar<private> priv_var : f32;\nfn foo() {\n  var func_var : vec4u;\n  _ = ${t.params.builtin}(${val});\n}`;\n\n    t.expectCompileResult(false, wgsl);\n  });\n"],"mappings":"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"}