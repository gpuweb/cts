{"version":3,"file":"subgroupBroadcast.spec.js","names":["description","makeTestGroup","keysOf","objectsToRecord","isConvertible","Type","elementTypeOf","kAllScalarsAndVectors","ShaderValidationTest","g","test","desc","params","u","combine","fn","t","wgsl","enable","expectCompileResult","kArgumentTypes","kStages","constant","override","runtime","code","stage","must_use","type","enables","requiresF16","create","bool","filter","retType","retEleTy","dataType","dataEleTy","abstractInt","abstractFloat","toString","expect","u32","i32","kIdCases","const_decl","valid","const_literal","const_expr","let_decl","override_decl","var_func_decl","var_priv_decl","value","beginSubcases","arg","compute","fragment","vertex","entry"],"sources":["../../../../../../../src/webgpu/shader/validation/expression/call/builtin/subgroupBroadcast.spec.ts"],"sourcesContent":["export const description = `\nValidation tests for subgroupBroadcast\n`;\n\nimport { makeTestGroup } from '../../../../../../common/framework/test_group.js';\nimport { keysOf, objectsToRecord } from '../../../../../../common/util/data_tables.js';\nimport {\n  isConvertible,\n  Type,\n  elementTypeOf,\n  kAllScalarsAndVectors,\n} from '../../../../../util/conversion.js';\nimport { ShaderValidationTest } from '../../../shader_validation_test.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\ng.test('requires_subgroups')\n  .desc('Validates that the subgroups feature is required')\n  .params(u => u.combine('enable', [false, true] as const))\n  .fn(t => {\n    const wgsl = `\n${t.params.enable ? 'enable subgroups;' : ''}\nfn foo() {\n  _ = subgroupBroadcast(0, 0);\n}`;\n\n    t.expectCompileResult(t.params.enable, wgsl);\n  });\n\nconst kArgumentTypes = objectsToRecord(kAllScalarsAndVectors);\n\nconst kStages: Record<string, string> = {\n  constant: `\nenable subgroups;\n@compute @workgroup_size(16)\nfn main() {\n  const x = subgroupBroadcast(0, 0);\n}`,\n  override: `\nenable subgroups;\noverride o = subgroupBroadcast(0, 0);`,\n  runtime: `\nenable subgroups;\n@compute @workgroup_size(16)\nfn main() {\n  let x = subgroupBroadcast(0, 0);\n}`,\n};\n\ng.test('early_eval')\n  .desc('Ensures the builtin is not able to be compile time evaluated')\n  .params(u => u.combine('stage', keysOf(kStages)))\n  .fn(t => {\n    const code = kStages[t.params.stage];\n    t.expectCompileResult(t.params.stage === 'runtime', code);\n  });\n\ng.test('must_use')\n  .desc('Tests that the builtin has the @must_use attribute')\n  .params(u => u.combine('must_use', [true, false] as const))\n  .fn(t => {\n    const wgsl = `\nenable subgroups;\n@compute @workgroup_size(16)\nfn main() {\n  ${t.params.must_use ? '_ = ' : ''}subgroupBroadcast(0, 0);\n}`;\n\n    t.expectCompileResult(t.params.must_use, wgsl);\n  });\n\ng.test('data_type')\n  .desc('Validates data parameter type')\n  .params(u => u.combine('type', keysOf(kArgumentTypes)))\n  .fn(t => {\n    const type = kArgumentTypes[t.params.type];\n    let enables = `enable subgroups;\\n`;\n    if (type.requiresF16()) {\n      enables += `enable f16;`;\n    }\n    const wgsl = `\n${enables}\n@compute @workgroup_size(1)\nfn main() {\n  _ = subgroupBroadcast(${type.create(0).wgsl()}, 0);\n}`;\n\n    t.expectCompileResult(elementTypeOf(type) !== Type.bool, wgsl);\n  });\n\ng.test('return_type')\n  .desc('Validates data parameter type')\n  .params(u =>\n    u\n      .combine('dataType', keysOf(kArgumentTypes))\n      .combine('retType', keysOf(kArgumentTypes))\n      .filter(t => {\n        const retType = kArgumentTypes[t.retType];\n        const retEleTy = elementTypeOf(retType);\n        const dataType = kArgumentTypes[t.dataType];\n        const dataEleTy = elementTypeOf(dataType);\n        return (\n          retEleTy !== Type.abstractInt &&\n          retEleTy !== Type.abstractFloat &&\n          dataEleTy !== Type.abstractInt &&\n          dataEleTy !== Type.abstractFloat\n        );\n      })\n  )\n  .fn(t => {\n    const dataType = kArgumentTypes[t.params.dataType];\n    const retType = kArgumentTypes[t.params.retType];\n    let enables = `enable subgroups;\\n`;\n    if (dataType.requiresF16() || retType.requiresF16()) {\n      enables += `enable f16;`;\n    }\n    const wgsl = `\n${enables}\n@compute @workgroup_size(1)\nfn main() {\n  let res : ${retType.toString()} = subgroupBroadcast(${dataType.create(0).wgsl()}, 0);\n}`;\n\n    const expect = elementTypeOf(dataType) !== Type.bool && dataType === retType;\n    t.expectCompileResult(expect, wgsl);\n  });\n\ng.test('id_type')\n  .desc('Validates id parameter type')\n  .params(u => u.combine('type', keysOf(kArgumentTypes)))\n  .fn(t => {\n    const type = kArgumentTypes[t.params.type];\n    const wgsl = `\nenable subgroups;\n@compute @workgroup_size(1)\nfn main() {\n  _ = subgroupBroadcast(0, ${type.create(0).wgsl()});\n}`;\n\n    const expect = isConvertible(type, Type.u32) || isConvertible(type, Type.i32);\n    t.expectCompileResult(expect, wgsl);\n  });\n\nconst kIdCases = {\n  const_decl: {\n    code: 'const_decl',\n    valid: true,\n  },\n  const_literal: {\n    code: '0',\n    valid: true,\n  },\n  const_expr: {\n    code: 'const_decl + 2',\n    valid: true,\n  },\n  let_decl: {\n    code: 'let_decl',\n    valid: false,\n  },\n  override_decl: {\n    code: 'override_decl',\n    valid: false,\n  },\n  var_func_decl: {\n    code: 'var_func_decl',\n    valid: false,\n  },\n  var_priv_decl: {\n    code: 'var_priv_decl',\n    valid: false,\n  },\n};\n\ng.test('id_constness')\n  .desc('Validates that id must be a const-expression')\n  .params(u => u.combine('value', keysOf(kIdCases)))\n  .fn(t => {\n    const wgsl = `\nenable subgroups;\noverride override_decl : u32;\nvar<private> var_priv_decl : u32;\nfn foo() {\n  var var_func_decl : u32;\n  let let_decl = var_func_decl;\n  const const_decl = 0u;\n  _ = subgroupBroadcast(0, ${kIdCases[t.params.value].code});\n}`;\n\n    t.expectCompileResult(kIdCases[t.params.value].valid, wgsl);\n  });\n\ng.test('id_values')\n  .desc('Validates that id must be in the range [0, 128)')\n  .params(u =>\n    u\n      .combine('value', [-1, 0, 127, 128] as const)\n      .beginSubcases()\n      .combine('type', ['literal', 'const', 'expr'] as const)\n  )\n  .fn(t => {\n    let arg = `${t.params.value}`;\n    if (t.params.type === 'const') {\n      arg = `c`;\n    } else if (t.params.type === 'expr') {\n      arg = `c + 0`;\n    }\n\n    const wgsl = `\nenable subgroups;\n\nconst c = ${t.params.value};\n\nfn foo() {\n  _ = subgroupBroadcast(0, ${arg});\n}`;\n\n    const expect = t.params.value >= 0 && t.params.value < 128;\n    t.expectCompileResult(expect, wgsl);\n  });\n\ng.test('stage')\n  .desc('Validates it is only usable in correct stage')\n  .params(u => u.combine('stage', ['compute', 'fragment', 'vertex'] as const))\n  .fn(t => {\n    const compute = `\n@compute @workgroup_size(1)\nfn main() {\n  foo();\n}`;\n\n    const fragment = `\n@fragment\nfn main() {\n  foo();\n}`;\n\n    const vertex = `\n@vertex\nfn main() -> @builtin(position) vec4f {\n  foo();\n  return vec4f();\n}`;\n\n    const entry = { compute, fragment, vertex }[t.params.stage];\n    const wgsl = `\nenable subgroups;\nfn foo() {\n  _ = subgroupBroadcast(0, 0);\n}\n\n${entry}\n`;\n\n    t.expectCompileResult(t.params.stage !== 'vertex', wgsl);\n  });\n"],"mappings":"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"}