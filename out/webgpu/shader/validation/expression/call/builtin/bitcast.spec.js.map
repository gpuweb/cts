{"version":3,"file":"bitcast.spec.js","names":["description","makeTestGroup","kBit","linearRange","ShaderValidationTest","g","vectorCases","width","badIndex","numNaNs","f32InfAndNaNInU32","f32","infinity","positive","i32","max","negative","u32","test","specURL","desc","params","u","combine","fn","t","vectorize","badScalar","fromScalarType","bitBadValue","destType","srcType","components","Array","keys","map","i","join","code","expectCompileResult","f32_matrix_types","j","reduce","a","c","concat","bool_types","T","type","preamble","srcVal","direction","typeOf","s","b","p","var","unimplemented"],"sources":["../../../../../../../src/webgpu/shader/validation/expression/call/builtin/bitcast.spec.ts"],"sourcesContent":["export const description = `\nValidation negative tests for bitcast builtins.\n`;\n\nimport { makeTestGroup } from '../../../../../../common/framework/test_group.js';\nimport { kBit } from '../../../../../util/constants.js';\nimport { linearRange } from '../../../../../util/math.js';\nimport { ShaderValidationTest } from '../../../shader_validation_test.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\n// A VectorCase specfies the number of components a vector type has,\n// and which component will have a bad value.\n// Use width = 1 to indicate a scalar.\ntype VectorCase = { width: number; badIndex: number };\nconst vectorCases: VectorCase[] = [\n  { width: 1, badIndex: 0 },\n  { width: 2, badIndex: 0 },\n  { width: 2, badIndex: 1 },\n  { width: 3, badIndex: 0 },\n  { width: 3, badIndex: 1 },\n  { width: 3, badIndex: 2 },\n  { width: 4, badIndex: 0 },\n  { width: 4, badIndex: 1 },\n  { width: 4, badIndex: 2 },\n  { width: 4, badIndex: 3 },\n];\n\nconst numNaNs = 4;\nconst f32InfAndNaNInU32: number[] = [\n  // Cover NaNs evenly in integer space.\n  // The positive NaN with the lowest integer representation is the integer\n  // for infinity, plus one.\n  // The positive NaN with the highest integer representation is i32.max (!)\n  ...linearRange(kBit.f32.infinity.positive + 1, kBit.i32.positive.max, numNaNs),\n  // The negative NaN with the lowest integer representation is the integer\n  // for negative infinity, plus one.\n  // The negative NaN with the highest integer representation is u32.max (!)\n  ...linearRange(kBit.f32.infinity.negative + 1, kBit.u32.max, numNaNs),\n  kBit.f32.infinity.positive,\n  kBit.f32.infinity.negative,\n];\n\ng.test('bad_const_to_f32')\n  .specURL('https://www.w3.org/TR/WGSL/#floating-point-evaluation')\n  .desc(\n    `\nIt is a shader-creation error if any const-expression of floating-point type evaluates to NaN or infinity.\n`\n  )\n  .params(u =>\n    u\n      .combine('fromScalarType', ['i32', 'u32'] as const)\n      .combine('vectorize', [...vectorCases] as const)\n      .combine('bitBadValue', [...f32InfAndNaNInU32] as const)\n  )\n  .fn(t => {\n    // For scalar cases, generate code like:\n    //  const f = bitcast<f32>(i32(u32(0x7f800000)));\n    // For vector cases, generate code where one component is bad. In this case\n    // width=4 and badIndex=2\n    //  const f = bitcast<vec4f>(vec4<32>(0,0,i32(u32(0x7f800000)),0));\n    const width = t.params.vectorize.width;\n    const badIndex = t.params.vectorize.badIndex;\n    const badScalar = `${t.params.fromScalarType}(u32(${t.params.bitBadValue}))`;\n    const destType = width === 1 ? 'f32' : `vec${width}f`;\n    const srcType =\n      width === 1 ? t.params.fromScalarType : `vec${width}<${t.params.fromScalarType}>`;\n    const components = [...Array(width).keys()]\n      .map(i => (i === badIndex ? badScalar : '0'))\n      .join(',');\n    const code = `const f = bitcast<${destType}>(${srcType}(${components}));`;\n    t.expectCompileResult(false, code);\n  });\n\nconst f32_matrix_types = [2, 3, 4]\n  .map(i => [2, 3, 4].map(j => `mat${i}x${j}f`))\n  .reduce((a, c) => a.concat(c), []);\nconst bool_types = ['bool', ...[2, 3, 4].map(i => `vec${i}<bool>`)];\n\ng.test('bad_type_constructible')\n  .specURL('https://www.w3.org/TR/WGSL/#bitcast-builtin')\n  .desc(\n    `\nBitcast only applies to concrete numeric scalar or concrete numeric vector.\nTest constructible types.\n`\n  )\n  .params(u =>\n    u\n      .combine('type', [...f32_matrix_types, ...bool_types, 'array<i32,2>', 'S'])\n      .combine('direction', ['to', 'from'])\n  )\n  .fn(t => {\n    const T = t.params.type;\n    const preamble = T === 'S' ? 'struct S { a:i32 } ' : '';\n    // Create a value of type T using zero-construction: T().\n    const srcVal = t.params.direction === 'to' ? '0' : `${T}()`;\n    const destType = t.params.direction === 'to' ? T : 'i32';\n    const code = preamble + `const x = bitcast<${destType}>(${srcVal});`;\n    t.expectCompileResult(false, code);\n  });\n\ng.test('bad_type_nonconstructible')\n  .specURL('https://www.w3.org/TR/WGSL/#bitcast-builtin')\n  .desc(\n    `\nBitcast only applies to concrete numeric scalar or concrete numeric vector.\nTest non-constructible types.\n`\n  )\n  .params(u => u.combine('var', ['s', 't', 'b', 'p']).combine('direction', ['to', 'from']))\n  .fn(t => {\n    const typeOf: Record<string, string> = {\n      s: 'sampler',\n      t: 'texture_depth_2d',\n      b: 'array<i32>',\n      p: 'ptr<private,i32>',\n    };\n    const srcVal = t.params.direction === 'to' ? '0' : t.params.var;\n    const destType = t.params.direction === 'to' ? typeOf[t.params.var] : 'i32';\n    const code = `\n    @group(0) @binding(0) var s: sampler;\n    @group(0) @binding(1) var t: texture_depth_2d;\n    @group(0) @binding(2) var<storage> b: array<i32>;\n    var<private> v: i32;\n    @compute @workgroup_size(1)\n    fn main() {\n      let p = &v;\n      let x = bitcast<${destType}>(${srcVal});\n    }\n    `;\n    t.expectCompileResult(false, code);\n  });\n\ng.test('bad_to_vec3h')\n  .specURL('https://www.w3.org/TR/WGSL/#bitcast-builtin')\n  .desc(\n    `\nCan't cast numeric type to vec3<f16> because it is 48 bits wide\nand no other type is that size.\n`\n  )\n  .unimplemented();\n"],"mappings":"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"}