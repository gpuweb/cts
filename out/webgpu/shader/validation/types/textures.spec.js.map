{"version":3,"file":"textures.spec.js","names":["description","makeTestGroup","isTextureFormatUsableAsStorageFormat","kAllTextureFormats","kColorTextureFormats","kTextureFormatInfo","getPlainTypeInfo","ShaderValidationTest","g","test","desc","params","u","combine","filter","p","format","color","storage","beginSubcases","beforeAllSubcases","t","shaderScalarType","selectDeviceOrSkipTestCase","requiredFeatures","isCompatibility","skip","fn","info","validShaderScalarType","type","shaderValueType","wgsl","expectCompileResult","kValidTextureSampledTypes","textureType","sampledType","comma","includes","kAccessModes","access","isFormatValid","isAccessValid","samplerType"],"sources":["../../../../../src/webgpu/shader/validation/types/textures.spec.ts"],"sourcesContent":["export const description = `\nValidation tests for various texture types in shaders.\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport {\n  isTextureFormatUsableAsStorageFormat,\n  kAllTextureFormats,\n  kColorTextureFormats,\n  kTextureFormatInfo,\n} from '../../../format_info.js';\nimport { getPlainTypeInfo } from '../../../util/shader.js';\nimport { ShaderValidationTest } from '../shader_validation_test.js';\n\nexport const g = makeTestGroup(ShaderValidationTest);\n\ng.test('texel_formats')\n  .desc(\n    'Test channels and channel format of various texel formats when using as the storage texture format'\n  )\n  .params(u =>\n    u\n      .combine('format', kColorTextureFormats)\n      .filter(p => kTextureFormatInfo[p.format].color.storage)\n      .beginSubcases()\n      .combine('shaderScalarType', ['f32', 'u32', 'i32', 'bool', 'f16'] as const)\n  )\n  .beforeAllSubcases(t => {\n    if (t.params.shaderScalarType === 'f16') {\n      t.selectDeviceOrSkipTestCase({ requiredFeatures: ['shader-f16'] });\n    }\n\n    if (!isTextureFormatUsableAsStorageFormat(t.params.format, t.isCompatibility)) {\n      t.skip('storage usage is unsupported');\n    }\n  })\n  .fn(t => {\n    const { format, shaderScalarType } = t.params;\n    const info = kTextureFormatInfo[format];\n    const validShaderScalarType = getPlainTypeInfo(info.color.type);\n    const shaderValueType = `vec4<${shaderScalarType}>`;\n    const wgsl = `\n    @group(0) @binding(0) var tex: texture_storage_2d<${format}, read>;\n    @compute @workgroup_size(1) fn main() {\n        let v : ${shaderValueType} = textureLoad(tex, vec2u(0));\n        _ = v;\n    }\n`;\n    t.expectCompileResult(validShaderScalarType === shaderScalarType, wgsl);\n  });\n\ng.test('texel_formats,as_value')\n  .desc('Test that texel format cannot be used as value')\n  .fn(t => {\n    const wgsl = `\n    @compute @workgroup_size(1) fn main() {\n        var i = rgba8unorm;\n    }\n`;\n    t.expectCompileResult(false, wgsl);\n  });\n\nconst kValidTextureSampledTypes = ['f32', 'i32', 'u32'];\n\ng.test('sampled_texture_types')\n  .desc(\n    `Test that for texture_xx<T>\n- The sampled type T must be f32, i32, or u32\n`\n  )\n  .params(u =>\n    u\n      .combine('textureType', ['texture_2d', 'texture_multisampled_2d'])\n      .beginSubcases()\n      .combine('sampledType', [\n        ...kValidTextureSampledTypes,\n        'bool',\n        'vec2',\n        'mat2x2',\n        '1.0',\n        '1',\n        '1u',\n      ] as const)\n      .combine('comma', ['', ','] as const)\n  )\n  .fn(t => {\n    const { textureType, sampledType, comma } = t.params;\n    const wgsl = `@group(0) @binding(0) var tex: ${textureType}<${sampledType}${comma}>;`;\n    t.expectCompileResult(kValidTextureSampledTypes.includes(sampledType), wgsl);\n  });\n\ng.test('external_sampled_texture_types')\n  .desc(\n    `Test that texture_external compiles and cannot specify address space\n`\n  )\n  .fn(t => {\n    t.expectCompileResult(true, `@group(0) @binding(0) var tex: texture_external;`);\n    t.expectCompileResult(false, `@group(0) @binding(0) var<private> tex: texture_external;`);\n  });\n\nconst kAccessModes = ['read', 'write', 'read_write'];\n\ng.test('storage_texture_types')\n  .desc(\n    `Test that for texture_storage_xx<format, access>\n- format must be an enumerant for one of the texel formats for storage textures\n- access must be an enumerant for one of the access modes\n\nBesides, the shader compilation should always pass regardless of whether the format supports the usage indicated by the access or not.\n`\n  )\n  .params(u =>\n    u\n      .combine('access', [...kAccessModes, 'storage'] as const)\n      .combine('format', kAllTextureFormats)\n      .combine('comma', ['', ','] as const)\n  )\n  .fn(t => {\n    const { format, access, comma } = t.params;\n    // bgra8unorm is considered a valid storage format at shader compilation stage\n    const isFormatValid =\n      isTextureFormatUsableAsStorageFormat(format, false) || format === 'bgra8unorm';\n    const isAccessValid = kAccessModes.includes(access);\n    const wgsl = `@group(0) @binding(0) var tex: texture_storage_2d<${format}, ${access}${comma}>;`;\n    t.expectCompileResult(isFormatValid && isAccessValid, wgsl);\n  });\n\ng.test('depth_texture_types')\n  .desc(\n    `Test that for texture_depth_xx\n- must not specify an address space\n`\n  )\n  .params(u =>\n    u.combine('textureType', [\n      'texture_depth_2d',\n      'texture_depth_2d_array',\n      'texture_depth_cube',\n      'texture_depth_cube_array',\n    ])\n  )\n  .fn(t => {\n    const { textureType } = t.params;\n    t.expectCompileResult(true, `@group(0) @binding(0) var t: ${textureType};`);\n    t.expectCompileResult(false, `@group(0) @binding(0) var<private> t: ${textureType};`);\n    t.expectCompileResult(false, `@group(0) @binding(0) var<storage, read> t: ${textureType};`);\n  });\n\ng.test('sampler_types')\n  .desc(\n    `Test that for sampler and sampler_comparison\n- cannot specify address space\n- cannot be declared in WGSL function scope\n`\n  )\n  .params(u => u.combine('samplerType', ['sampler', 'sampler_comparison']))\n  .fn(t => {\n    const { samplerType } = t.params;\n    t.expectCompileResult(true, `@group(0) @binding(0) var s: ${samplerType};`);\n    t.expectCompileResult(false, `@group(0) @binding(0) var<private> s: ${samplerType};`);\n    t.expectCompileResult(\n      false,\n      `\n      @compute @workgroup_size(1) fn main() {\n        var s: ${samplerType};\n      }\n    `\n    );\n  });\n"],"mappings":"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"}