{"version":3,"file":"async_expectations.spec.js","names":["description","makeTestGroup","makeTestGroupForUnitTesting","assert","objectEquals","rejectOnTimeout","resolveOnTimeout","TestGroupTest","UnitTest","FixtureToTest","immediateAsyncExpectation","fn","eventualAsyncExpectation","g","test","t0","runState","runStateIndex","t","idx","resultsPromise","run","statuses","Array","from","map","v","status","toString"],"sources":["../../src/unittests/async_expectations.spec.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/require-await */\nexport const description = `\nTests for eventualAsyncExpectation and immediateAsyncExpectation.\n`;\n\nimport { makeTestGroup } from '../common/framework/test_group.js';\nimport { makeTestGroupForUnitTesting } from '../common/internal/test_group.js';\nimport { assert, objectEquals, rejectOnTimeout, resolveOnTimeout } from '../common/util/util.js';\n\nimport { TestGroupTest } from './test_group_test.js';\nimport { UnitTest } from './unit_test.js';\n\nclass FixtureToTest extends UnitTest {\n  public override immediateAsyncExpectation<T>(fn: () => Promise<T>): Promise<T> {\n    return super.immediateAsyncExpectation(fn);\n  }\n  public override eventualAsyncExpectation<T>(fn: (niceStack: Error) => Promise<T>): void {\n    super.eventualAsyncExpectation(fn);\n  }\n}\n\nexport const g = makeTestGroup(TestGroupTest);\n\ng.test('eventual').fn(async t0 => {\n  const g = makeTestGroupForUnitTesting(FixtureToTest);\n\n  const runState = [0, 0, 0, 0];\n  let runStateIndex = 0;\n\n  // Should pass in state 3\n  g.test('noawait,resolve').fn(t => {\n    const idx = runStateIndex++;\n\n    runState[idx] = 1;\n    t.eventualAsyncExpectation(async () => {\n      runState[idx] = 2;\n      await resolveOnTimeout(50);\n      runState[idx] = 3;\n    });\n    runState[idx] = 4;\n  });\n\n  // Should fail in state 4\n  g.test('noawait,reject').fn(t => {\n    const idx = runStateIndex++;\n\n    runState[idx] = 1;\n    t.eventualAsyncExpectation(async () => {\n      runState[idx] = 2;\n      await rejectOnTimeout(50, 'rejected 1');\n      runState[idx] = 3;\n    });\n    runState[idx] = 4;\n  });\n\n  // Should fail in state 3\n  g.test('nested,2').fn(t => {\n    const idx = runStateIndex++;\n\n    runState[idx] = 1;\n    t.eventualAsyncExpectation(async () => {\n      runState[idx] = 2;\n      await resolveOnTimeout(50); // Wait a bit before adding a new eventualAsyncExpectation\n      t.eventualAsyncExpectation(() => rejectOnTimeout(100, 'inner rejected 1'));\n      runState[idx] = 3;\n    });\n    runState[idx] = 4;\n  });\n\n  // Should fail in state 3\n  g.test('nested,4').fn(t => {\n    const idx = runStateIndex++;\n\n    runState[idx] = 1;\n    t.eventualAsyncExpectation(async () => {\n      t.eventualAsyncExpectation(async () => {\n        t.eventualAsyncExpectation(async () => {\n          runState[idx] = 2;\n          await resolveOnTimeout(50); // Wait a bit before adding a new eventualAsyncExpectation\n          t.eventualAsyncExpectation(() => rejectOnTimeout(100, 'inner rejected 2'));\n          runState[idx] = 3;\n        });\n      });\n    });\n    runState[idx] = 4;\n  });\n\n  const resultsPromise = t0.run(g);\n  assert(objectEquals(runState, [0, 0, 0, 0]));\n\n  const statuses = Array.from(await resultsPromise).map(([, v]) => v.status);\n  assert(objectEquals(runState, [3, 4, 3, 3]), () => runState.toString());\n  assert(objectEquals(statuses, ['pass', 'fail', 'fail', 'fail']), () => statuses.toString());\n});\n\ng.test('immediate').fn(async t0 => {\n  const g = makeTestGroupForUnitTesting(FixtureToTest);\n\n  const runState = [0, 0, 0, 0, 0];\n\n  g.test('noawait,resolve').fn(t => {\n    runState[0] = 1;\n    void t.immediateAsyncExpectation(async () => {\n      runState[0] = 2;\n      await resolveOnTimeout(50);\n      runState[0] = 3;\n    });\n    runState[0] = 4;\n  });\n\n  // (Can't g.test('noawait,reject') because it causes a top-level Promise\n  // rejection which crashes Node.)\n\n  g.test('await,resolve').fn(async t => {\n    runState[1] = 1;\n    await t.immediateAsyncExpectation(async () => {\n      runState[1] = 2;\n      await resolveOnTimeout(50);\n      runState[1] = 3;\n    });\n  });\n\n  g.test('await,reject').fn(async t => {\n    runState[2] = 1;\n    await t.immediateAsyncExpectation(async () => {\n      runState[2] = 2;\n      await rejectOnTimeout(50, 'rejected 3');\n      runState[2] = 3;\n    });\n  });\n\n  // (Similarly can't test 'nested,noawait'.)\n\n  g.test('nested,await,2').fn(t => {\n    runState[3] = 1;\n    t.eventualAsyncExpectation(async () => {\n      runState[3] = 2;\n      await resolveOnTimeout(50); // Wait a bit before adding a new immediateAsyncExpectation\n      runState[3] = 3;\n      await t.immediateAsyncExpectation(() => rejectOnTimeout(100, 'inner rejected 3'));\n      runState[3] = 5;\n    });\n    runState[3] = 4;\n  });\n\n  g.test('nested,await,4').fn(t => {\n    runState[4] = 1;\n    t.eventualAsyncExpectation(async () => {\n      t.eventualAsyncExpectation(async () => {\n        t.eventualAsyncExpectation(async () => {\n          runState[4] = 2;\n          await resolveOnTimeout(50); // Wait a bit before adding a new immediateAsyncExpectation\n          runState[4] = 3;\n          await t.immediateAsyncExpectation(() => rejectOnTimeout(100, 'inner rejected 3'));\n          runState[4] = 5;\n        });\n      });\n    });\n    runState[4] = 4;\n  });\n\n  const resultsPromise = t0.run(g);\n  assert(objectEquals(runState, [0, 0, 0, 0, 0]));\n\n  const statuses = Array.from(await resultsPromise).map(([, v]) => v.status);\n  assert(objectEquals(runState, [3, 3, 2, 3, 3]));\n  assert(objectEquals(statuses, ['fail', 'pass', 'fail', 'fail', 'fail']));\n});\n"],"mappings":"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"}