{"version":3,"file":"getStackTrace.spec.js","names":["description","makeTestGroup","extractImportantStackTrace","UnitTest","g","test","paramsSimple","case","_expectedLines","_stack","fn","t","ex","Error","stack","params","expect","stringified","parts","split","length","last","indexOf"],"sources":["../../src/unittests/getStackTrace.spec.ts"],"sourcesContent":["export const description = `\nTests for getStackTrace.\n`;\n\nimport { makeTestGroup } from '../common/framework/test_group.js';\nimport { extractImportantStackTrace } from '../common/internal/stack.js';\n\nimport { UnitTest } from './unit_test.js';\n\nexport const g = makeTestGroup(UnitTest);\n\ng.test('stacks')\n  .paramsSimple([\n    {\n      case: 'node_fail',\n      _expectedLines: 3,\n      _stack: `Error:\n   at CaseRecorder.fail (/Users/kainino/src/cts/src/common/framework/logger.ts:99:30)\n   at RunCaseSpecific.exports.g.test.t [as fn] (/Users/kainino/src/cts/src/unittests/logger.spec.ts:80:7)\n   at RunCaseSpecific.run (/Users/kainino/src/cts/src/common/framework/test_group.ts:121:18)\n   at processTicksAndRejections (internal/process/task_queues.js:86:5)`,\n    },\n    {\n      // MAINTENANCE_TODO: make sure this test case actually matches what happens on windows\n      case: 'node_fail_backslash',\n      _expectedLines: 3,\n      _stack: `Error:\n   at CaseRecorder.fail (C:\\\\Users\\\\kainino\\\\src\\\\cts\\\\src\\\\common\\\\framework\\\\logger.ts:99:30)\n   at RunCaseSpecific.exports.g.test.t [as fn] (C:\\\\Users\\\\kainino\\\\src\\\\cts\\\\src\\\\unittests\\\\logger.spec.ts:80:7)\n   at RunCaseSpecific.run (C:\\\\Users\\\\kainino\\\\src\\\\cts\\\\src\\\\common\\\\framework\\\\test_group.ts:121:18)\n   at processTicksAndRejections (internal\\\\process\\\\task_queues.js:86:5)`,\n    },\n    {\n      case: 'node_fail_processTicksAndRejections',\n      _expectedLines: 5,\n      _stack: `Error: expectation had no effect: suite1:foo:\n    at Object.generateMinimalQueryList (/Users/kainino/src/cts/src/common/framework/generate_minimal_query_list.ts:72:24)\n    at testGenerateMinimalQueryList (/Users/kainino/src/cts/src/unittests/loading.spec.ts:289:25)\n    at processTicksAndRejections (internal/process/task_queues.js:93:5)\n    at RunCaseSpecific.fn (/Users/kainino/src/cts/src/unittests/loading.spec.ts:300:3)\n    at RunCaseSpecific.run (/Users/kainino/src/cts/src/common/framework/test_group.ts:144:9)\n    at /Users/kainino/src/cts/src/common/runtime/cmdline.ts:62:25\n    at async Promise.all (index 29)\n    at /Users/kainino/src/cts/src/common/runtime/cmdline.ts:78:5`,\n    },\n    {\n      case: 'node_throw',\n      _expectedLines: 2,\n      _stack: `Error: hello\n    at RunCaseSpecific.g.test.t [as fn] (/Users/kainino/src/cts/src/unittests/test_group.spec.ts:51:11)\n    at RunCaseSpecific.run (/Users/kainino/src/cts/src/common/framework/test_group.ts:121:18)\n    at processTicksAndRejections (internal/process/task_queues.js:86:5)`,\n    },\n    {\n      case: 'firefox_fail',\n      _expectedLines: 3,\n      _stack: `fail@http://localhost:8080/out/common/framework/logger.js:104:30\nexpect@http://localhost:8080/out/common/framework/default_fixture.js:59:16\n@http://localhost:8080/out/unittests/util.spec.js:35:5\nrun@http://localhost:8080/out/common/framework/test_group.js:119:18`,\n    },\n    {\n      case: 'firefox_throw',\n      _expectedLines: 1,\n      _stack: `@http://localhost:8080/out/unittests/test_group.spec.js:48:11\nrun@http://localhost:8080/out/common/framework/test_group.js:119:18`,\n    },\n    {\n      case: 'safari_fail',\n      _expectedLines: 3,\n      _stack: `fail@http://localhost:8080/out/common/framework/logger.js:104:39\nexpect@http://localhost:8080/out/common/framework/default_fixture.js:59:20\nhttp://localhost:8080/out/unittests/util.spec.js:35:11\nhttp://localhost:8080/out/common/framework/test_group.js:119:20\nasyncFunctionResume@[native code]\n[native code]\npromiseReactionJob@[native code]`,\n    },\n    {\n      case: 'safari_throw',\n      _expectedLines: 1,\n      _stack: `http://localhost:8080/out/unittests/test_group.spec.js:48:20\nhttp://localhost:8080/out/common/framework/test_group.js:119:20\nasyncFunctionResume@[native code]\n[native code]\npromiseReactionJob@[native code]`,\n    },\n    {\n      case: 'chrome_fail',\n      _expectedLines: 4,\n      _stack: `Error\n    at CaseRecorder.fail (http://localhost:8080/out/common/framework/logger.js:104:30)\n    at DefaultFixture.expect (http://localhost:8080/out/common/framework/default_fixture.js:59:16)\n    at RunCaseSpecific.fn (http://localhost:8080/out/unittests/util.spec.js:35:5)\n    at RunCaseSpecific.run (http://localhost:8080/out/common/framework/test_group.js:119:18)\n    at async runCase (http://localhost:8080/out/common/runtime/standalone.js:37:17)\n    at async http://localhost:8080/out/common/runtime/standalone.js:102:7`,\n    },\n    {\n      case: 'chrome_throw',\n      _expectedLines: 6,\n      _stack: `Error: hello\n    at RunCaseSpecific.fn (http://localhost:8080/out/unittests/test_group.spec.js:48:11)\n    at RunCaseSpecific.run (http://localhost:8080/out/common/framework/test_group.js:119:18)\"\n    at async Promise.all (index 0)\n    at async TestGroupTest.run (http://localhost:8080/out/unittests/test_group_test.js:6:5)\n    at async RunCaseSpecific.fn (http://localhost:8080/out/unittests/test_group.spec.js:53:15)\n    at async RunCaseSpecific.run (http://localhost:8080/out/common/framework/test_group.js:119:7)\n    at async runCase (http://localhost:8080/out/common/runtime/standalone.js:37:17)\n    at async http://localhost:8080/out/common/runtime/standalone.js:102:7`,\n    },\n    {\n      case: 'multiple_lines',\n      _expectedLines: 8,\n      _stack: `Error: hello\n    at RunCaseSpecific.fn (http://localhost:8080/out/unittests/test_group.spec.js:48:11)\n    at RunCaseSpecific.fn (http://localhost:8080/out/unittests/test_group.spec.js:48:11)\n    at RunCaseSpecific.fn (http://localhost:8080/out/unittests/test_group.spec.js:48:11)\n    at RunCaseSpecific.run (http://localhost:8080/out/common/framework/test_group.js:119:18)\"\n    at async Promise.all (index 0)\n    at async TestGroupTest.run (http://localhost:8080/out/unittests/test_group_test.js:6:5)\n    at async RunCaseSpecific.fn (http://localhost:8080/out/unittests/test_group.spec.js:53:15)\n    at async RunCaseSpecific.run (http://localhost:8080/out/common/framework/test_group.js:119:7)\n    at async runCase (http://localhost:8080/out/common/runtime/standalone.js:37:17)\n    at async http://localhost:8080/out/common/runtime/standalone.js:102:7`,\n    },\n  ])\n  .fn(t => {\n    const ex = new Error();\n    ex.stack = t.params._stack;\n    t.expect(ex.stack === t.params._stack);\n    const stringified = extractImportantStackTrace(ex);\n    const parts = stringified.split('\\n');\n\n    t.expect(parts.length === t.params._expectedLines);\n    const last = parts[parts.length - 1];\n    t.expect(last.indexOf('/unittests/') !== -1 || last.indexOf('\\\\unittests\\\\') !== -1);\n  });\n"],"mappings":";;GAAA,OAAO,MAAMA,WAAW,GAAI;AAC5B;AACA,CAAC,CAED,SAASC,aAAa,QAAQ,mCAAmC;AACjE,SAASC,0BAA0B,QAAQ,6BAA6B;;AAExE,SAASC,QAAQ,QAAQ,gBAAgB;;AAEzC,OAAO,MAAMC,CAAC,GAAGH,aAAa,CAACE,QAAQ,CAAC;;AAExCC,CAAC,CAACC,IAAI,CAAC,QAAQ,CAAC;AACbC,YAAY,CAAC;AACZ;EACEC,IAAI,EAAE,WAAW;EACjBC,cAAc,EAAE,CAAC;EACjBC,MAAM,EAAG;AACf;AACA;AACA;AACA;AACI,CAAC;AACD;EACE;EACAF,IAAI,EAAE,qBAAqB;EAC3BC,cAAc,EAAE,CAAC;EACjBC,MAAM,EAAG;AACf;AACA;AACA;AACA;AACI,CAAC;AACD;EACEF,IAAI,EAAE,qCAAqC;EAC3CC,cAAc,EAAE,CAAC;EACjBC,MAAM,EAAG;AACf;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACI,CAAC;AACD;EACEF,IAAI,EAAE,YAAY;EAClBC,cAAc,EAAE,CAAC;EACjBC,MAAM,EAAG;AACf;AACA;AACA;AACI,CAAC;AACD;EACEF,IAAI,EAAE,cAAc;EACpBC,cAAc,EAAE,CAAC;EACjBC,MAAM,EAAG;AACf;AACA;AACA;AACI,CAAC;AACD;EACEF,IAAI,EAAE,eAAe;EACrBC,cAAc,EAAE,CAAC;EACjBC,MAAM,EAAG;AACf;AACI,CAAC;AACD;EACEF,IAAI,EAAE,aAAa;EACnBC,cAAc,EAAE,CAAC;EACjBC,MAAM,EAAG;AACf;AACA;AACA;AACA;AACA;AACA;AACI,CAAC;AACD;EACEF,IAAI,EAAE,cAAc;EACpBC,cAAc,EAAE,CAAC;EACjBC,MAAM,EAAG;AACf;AACA;AACA;AACA;AACI,CAAC;AACD;EACEF,IAAI,EAAE,aAAa;EACnBC,cAAc,EAAE,CAAC;EACjBC,MAAM,EAAG;AACf;AACA;AACA;AACA;AACA;AACA;AACI,CAAC;AACD;EACEF,IAAI,EAAE,cAAc;EACpBC,cAAc,EAAE,CAAC;EACjBC,MAAM,EAAG;AACf;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACI,CAAC;AACD;EACEF,IAAI,EAAE,gBAAgB;EACtBC,cAAc,EAAE,CAAC;EACjBC,MAAM,EAAG;AACf;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACI,CAAC;AACF,CAAC;AACDC,EAAE,CAAC,CAAAC,CAAC,KAAI;EACP,MAAMC,EAAE,GAAG,IAAIC,KAAK,CAAC,CAAC;EACtBD,EAAE,CAACE,KAAK,GAAGH,CAAC,CAACI,MAAM,CAACN,MAAM;EAC1BE,CAAC,CAACK,MAAM,CAACJ,EAAE,CAACE,KAAK,KAAKH,CAAC,CAACI,MAAM,CAACN,MAAM,CAAC;EACtC,MAAMQ,WAAW,GAAGf,0BAA0B,CAACU,EAAE,CAAC;EAClD,MAAMM,KAAK,GAAGD,WAAW,CAACE,KAAK,CAAC,IAAI,CAAC;;EAErCR,CAAC,CAACK,MAAM,CAACE,KAAK,CAACE,MAAM,KAAKT,CAAC,CAACI,MAAM,CAACP,cAAc,CAAC;EAClD,MAAMa,IAAI,GAAGH,KAAK,CAACA,KAAK,CAACE,MAAM,GAAG,CAAC,CAAC;EACpCT,CAAC,CAACK,MAAM,CAACK,IAAI,CAACC,OAAO,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC,IAAID,IAAI,CAACC,OAAO,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC,CAAC;AACtF,CAAC,CAAC"}