{"version":3,"file":"navigator_gpu.js","names":["ErrorWithExtra","assert","objectEquals","defaultGPUProvider","navigator","gpu","undefined","gpuProvider","setGPUProvider","provider","impl","defaultRequestAdapterOptions","setDefaultRequestAdapterOptions","options","Error","getDefaultRequestAdapterOptions","getGPU","recorder","oldFn","requestAdapter","promise","call","then","adapter","info","requestAdapterInfo","infoString","vendor","architecture","device","debug","adapterInfo"],"sources":["../../../src/common/util/navigator_gpu.ts"],"sourcesContent":["import { TestCaseRecorder } from '../framework/fixture.js';\n\nimport { ErrorWithExtra, assert, objectEquals } from './util.js';\n\n/**\n * Finds and returns the `navigator.gpu` object (or equivalent, for non-browser implementations).\n * Throws an exception if not found.\n */\nfunction defaultGPUProvider(): GPU {\n  assert(\n    typeof navigator !== 'undefined' && navigator.gpu !== undefined,\n    'No WebGPU implementation found'\n  );\n  return navigator.gpu;\n}\n\n/**\n * GPUProvider is a function that creates and returns a new GPU instance.\n * May throw an exception if a GPU cannot be created.\n */\nexport type GPUProvider = () => GPU;\n\nlet gpuProvider: GPUProvider = defaultGPUProvider;\n\n/**\n * Sets the function to create and return a new GPU instance.\n */\nexport function setGPUProvider(provider: GPUProvider) {\n  assert(impl === undefined, 'setGPUProvider() should not be after getGPU()');\n  gpuProvider = provider;\n}\n\nlet impl: GPU | undefined = undefined;\n\nlet defaultRequestAdapterOptions: GPURequestAdapterOptions | undefined;\n\nexport function setDefaultRequestAdapterOptions(options: GPURequestAdapterOptions) {\n  // It's okay to call this if you don't change the options\n  if (objectEquals(options, defaultRequestAdapterOptions)) {\n    return;\n  }\n  if (impl) {\n    throw new Error('must call setDefaultRequestAdapterOptions before getGPU');\n  }\n  defaultRequestAdapterOptions = { ...options };\n}\n\nexport function getDefaultRequestAdapterOptions() {\n  return defaultRequestAdapterOptions;\n}\n\n/**\n * Finds and returns the `navigator.gpu` object (or equivalent, for non-browser implementations).\n * Throws an exception if not found.\n */\nexport function getGPU(recorder: TestCaseRecorder | null): GPU {\n  if (impl) {\n    return impl;\n  }\n\n  impl = gpuProvider();\n\n  if (defaultRequestAdapterOptions) {\n    // eslint-disable-next-line @typescript-eslint/unbound-method\n    const oldFn = impl.requestAdapter;\n    impl.requestAdapter = function (\n      options?: GPURequestAdapterOptions\n    ): Promise<GPUAdapter | null> {\n      const promise = oldFn.call(this, { ...defaultRequestAdapterOptions, ...options });\n      if (recorder) {\n        void promise.then(async adapter => {\n          if (adapter) {\n            // MAINTENANCE_TODO: Remove requestAdapterInfo when info is implemented.\n            const info = adapter.info || (await adapter.requestAdapterInfo());\n            const infoString = `Adapter: ${info.vendor} / ${info.architecture} / ${info.device}`;\n            recorder.debug(new ErrorWithExtra(infoString, () => ({ adapterInfo: info })));\n          }\n        });\n      }\n      return promise;\n    };\n  }\n\n  return impl;\n}\n"],"mappings":";;GAEA,SAASA,cAAc,EAAEC,MAAM,EAAEC,YAAY,QAAQ,WAAW;;AAEhE;AACA;AACA;AACA;AACA,SAASC,kBAAkBA,CAAA,EAAQ;EACjCF,MAAM;IACJ,OAAOG,SAAS,KAAK,WAAW,IAAIA,SAAS,CAACC,GAAG,KAAKC,SAAS;IAC/D;EACF,CAAC;EACD,OAAOF,SAAS,CAACC,GAAG;AACtB;;AAEA;AACA;AACA;AACA;;;AAGA,IAAIE,WAAwB,GAAGJ,kBAAkB;;AAEjD;AACA;AACA;AACA,OAAO,SAASK,cAAcA,CAACC,QAAqB,EAAE;EACpDR,MAAM,CAACS,IAAI,KAAKJ,SAAS,EAAE,+CAA+C,CAAC;EAC3EC,WAAW,GAAGE,QAAQ;AACxB;;AAEA,IAAIC,IAAqB,GAAGJ,SAAS;;AAErC,IAAIK,4BAAkE;;AAEtE,OAAO,SAASC,+BAA+BA,CAACC,OAAiC,EAAE;EACjF;EACA,IAAIX,YAAY,CAACW,OAAO,EAAEF,4BAA4B,CAAC,EAAE;IACvD;EACF;EACA,IAAID,IAAI,EAAE;IACR,MAAM,IAAII,KAAK,CAAC,yDAAyD,CAAC;EAC5E;EACAH,4BAA4B,GAAG,EAAE,GAAGE,OAAO,CAAC,CAAC;AAC/C;;AAEA,OAAO,SAASE,+BAA+BA,CAAA,EAAG;EAChD,OAAOJ,4BAA4B;AACrC;;AAEA;AACA;AACA;AACA;AACA,OAAO,SAASK,MAAMA,CAACC,QAAiC,EAAO;EAC7D,IAAIP,IAAI,EAAE;IACR,OAAOA,IAAI;EACb;;EAEAA,IAAI,GAAGH,WAAW,CAAC,CAAC;;EAEpB,IAAII,4BAA4B,EAAE;;IAEhC,MAAMO,KAAK,GAAGR,IAAI,CAACS,cAAc;IACjCT,IAAI,CAACS,cAAc,GAAG;IACpBN,OAAkC;IACN;MAC5B,MAAMO,OAAO,GAAGF,KAAK,CAACG,IAAI,CAAC,IAAI,EAAE,EAAE,GAAGV,4BAA4B,EAAE,GAAGE,OAAO,CAAC,CAAC,CAAC;MACjF,IAAII,QAAQ,EAAE;QACZ,KAAKG,OAAO,CAACE,IAAI,CAAC,OAAMC,OAAO,KAAI;UACjC,IAAIA,OAAO,EAAE;YACX;YACA,MAAMC,IAAI,GAAGD,OAAO,CAACC,IAAI,KAAK,MAAMD,OAAO,CAACE,kBAAkB,CAAC,CAAC,CAAC;YACjE,MAAMC,UAAU,GAAI,YAAWF,IAAI,CAACG,MAAO,MAAKH,IAAI,CAACI,YAAa,MAAKJ,IAAI,CAACK,MAAO,EAAC;YACpFZ,QAAQ,CAACa,KAAK,CAAC,IAAI9B,cAAc,CAAC0B,UAAU,EAAE,OAAO,EAAEK,WAAW,EAAEP,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC;UAC/E;QACF,CAAC,CAAC;MACJ;MACA,OAAOJ,OAAO;IAChB,CAAC;EACH;;EAEA,OAAOV,IAAI;AACb"}