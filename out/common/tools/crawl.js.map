{"version":3,"file":"crawl.js","names":["fs","path","loadMetadataForSuite","TestQueryMultiCase","TestQueryMultiFile","validQueryPart","assert","unreachable","specFileSuffix","__filename","endsWith","crawlFilesRecursively","dir","subpathInfo","Promise","all","promises","readdir","map","d","p","join","stats","stat","isDirectory","isFile","files","filter","i","sep","concat","reduce","a","b","resolve","crawl","suiteDir","opts","existsSync","Error","totalCases","totalSubcases","validateTimingsEntries","validate","metadata","testsFoundInFiles","Set","filesToEnumerate","f","relative","replace","sort","entries","file","filepathWithoutExtension","substring","length","pathSegments","split","suite","basename","filename","process","env","STANDALONE_DEV_SERVER","mod","description","undefined","g","printCaseCountReport","t","iterate","testQuery","testPath","toString","cases","subcases","c","computeSubcaseCount","perCase","toFixed","console","log","add","test","push","dirname","readme","readFileSync","trim","zeroEntries","staleEntries","metadataKey","metadataValue","Object","startsWith","subcaseMS","has","printMetadataWarnings","warn","missingEntries","error","makeListing"],"sources":["../../../src/common/tools/crawl.ts"],"sourcesContent":["// Node can look at the filesystem, but JS in the browser can't.\n// This crawls the file tree under src/suites/${suite} to generate a (non-hierarchical) static\n// listing file that can then be used in the browser to load the modules containing the tests.\n\nimport * as fs from 'fs';\nimport * as path from 'path';\n\nimport { loadMetadataForSuite } from '../framework/metadata.js';\nimport { SpecFile } from '../internal/file_loader.js';\nimport { TestQueryMultiCase, TestQueryMultiFile } from '../internal/query/query.js';\nimport { validQueryPart } from '../internal/query/validQueryPart.js';\nimport { TestSuiteListingEntry, TestSuiteListing } from '../internal/test_suite_listing.js';\nimport { assert, unreachable } from '../util/util.js';\n\nconst specFileSuffix = __filename.endsWith('.ts') ? '.spec.ts' : '.spec.js';\n\nasync function crawlFilesRecursively(dir: string): Promise<string[]> {\n  const subpathInfo = await Promise.all(\n    (await fs.promises.readdir(dir)).map(async d => {\n      const p = path.join(dir, d);\n      const stats = await fs.promises.stat(p);\n      return {\n        path: p,\n        isDirectory: stats.isDirectory(),\n        isFile: stats.isFile(),\n      };\n    })\n  );\n\n  const files = subpathInfo\n    .filter(\n      i =>\n        i.isFile &&\n        (i.path.endsWith(specFileSuffix) ||\n          i.path.endsWith(`${path.sep}README.txt`) ||\n          i.path === 'README.txt')\n    )\n    .map(i => i.path);\n\n  return files.concat(\n    await subpathInfo\n      .filter(i => i.isDirectory)\n      .map(i => crawlFilesRecursively(i.path))\n      .reduce(async (a, b) => (await a).concat(await b), Promise.resolve([]))\n  );\n}\n\nexport async function crawl(\n  suiteDir: string,\n  opts: {\n    validate: boolean;\n    printMetadataWarnings: boolean;\n    printCaseCountReport: boolean;\n  } | null = null\n): Promise<TestSuiteListingEntry[]> {\n  if (!fs.existsSync(suiteDir)) {\n    throw new Error(`Could not find suite: ${suiteDir}`);\n  }\n\n  let totalCases = 0;\n  let totalSubcases = 0;\n\n  let validateTimingsEntries;\n  if (opts?.validate) {\n    const metadata = loadMetadataForSuite(suiteDir);\n    if (metadata) {\n      validateTimingsEntries = {\n        metadata,\n        testsFoundInFiles: new Set<string>(),\n      };\n    }\n  }\n\n  // Crawl files and convert paths to be POSIX-style, relative to suiteDir.\n  const filesToEnumerate = (await crawlFilesRecursively(suiteDir))\n    .map(f => path.relative(suiteDir, f).replace(/\\\\/g, '/'))\n    .sort();\n\n  const entries: TestSuiteListingEntry[] = [];\n  for (const file of filesToEnumerate) {\n    // |file| is the suite-relative file path.\n    if (file.endsWith(specFileSuffix)) {\n      const filepathWithoutExtension = file.substring(0, file.length - specFileSuffix.length);\n      const pathSegments = filepathWithoutExtension.split('/');\n\n      const suite = path.basename(suiteDir);\n\n      if (opts?.validate) {\n        const filename = `../../${suite}/${filepathWithoutExtension}.spec.js`;\n\n        assert(!process.env.STANDALONE_DEV_SERVER);\n        const mod = (await import(filename)) as SpecFile;\n        assert(mod.description !== undefined, 'Test spec file missing description: ' + filename);\n        assert(mod.g !== undefined, 'Test spec file missing TestGroup definition: ' + filename);\n\n        mod.g.validate(new TestQueryMultiFile(suite, pathSegments));\n\n        if (opts?.printCaseCountReport || validateTimingsEntries) {\n          for (const t of mod.g.iterate()) {\n            const testQuery = new TestQueryMultiCase(\n              suite,\n              pathSegments,\n              t.testPath,\n              {}\n            ).toString();\n\n            let cases = 0;\n            let subcases = 0;\n            for (const c of t.iterate(null)) {\n              cases++;\n              if (opts?.printCaseCountReport) {\n                subcases += c.computeSubcaseCount();\n              }\n            }\n\n            if (opts?.printCaseCountReport) {\n              const perCase = (subcases / cases).toFixed(0);\n              console.log(`${testQuery} - ${cases} cases, ${subcases} subcases (~${perCase}/case)`);\n              totalCases += cases;\n              totalSubcases += subcases;\n            }\n\n            if (validateTimingsEntries && cases > 0) {\n              validateTimingsEntries.testsFoundInFiles.add(testQuery);\n            }\n          }\n        }\n      }\n\n      for (const p of pathSegments) {\n        assert(validQueryPart.test(p), `Invalid directory name ${p}; must match ${validQueryPart}`);\n      }\n      entries.push({ file: pathSegments });\n    } else if (path.basename(file) === 'README.txt') {\n      const dirname = path.dirname(file);\n      const readme = fs.readFileSync(path.join(suiteDir, file), 'utf8').trim();\n\n      const pathSegments = dirname !== '.' ? dirname.split('/') : [];\n      entries.push({ file: pathSegments, readme });\n    } else {\n      unreachable(`Matched an unrecognized filename ${file}`);\n    }\n  }\n\n  if (validateTimingsEntries) {\n    const zeroEntries = [];\n    const staleEntries = [];\n    for (const [metadataKey, metadataValue] of Object.entries(validateTimingsEntries.metadata)) {\n      if (metadataKey.startsWith('_')) {\n        // Ignore json \"_comments\".\n        continue;\n      }\n      if (metadataValue.subcaseMS <= 0) {\n        zeroEntries.push(metadataKey);\n      }\n      if (!validateTimingsEntries.testsFoundInFiles.has(metadataKey)) {\n        staleEntries.push(metadataKey);\n      }\n    }\n    if (zeroEntries.length && opts?.printMetadataWarnings) {\n      console.warn(\n        'WARNING: subcaseMS â‰¤ 0 found in listing_meta.json (see docs/adding_timing_metadata.md):'\n      );\n      for (const metadataKey of zeroEntries) {\n        console.warn(`  ${metadataKey}`);\n      }\n    }\n\n    if (opts?.printMetadataWarnings) {\n      const missingEntries = [];\n      for (const metadataKey of validateTimingsEntries.testsFoundInFiles) {\n        if (!(metadataKey in validateTimingsEntries.metadata)) {\n          missingEntries.push(metadataKey);\n        }\n      }\n      if (missingEntries.length) {\n        console.error(\n          'WARNING: Tests missing from listing_meta.json (see docs/adding_timing_metadata.md):'\n        );\n        for (const metadataKey of missingEntries) {\n          console.error(`  ${metadataKey}`);\n        }\n      }\n    }\n\n    if (staleEntries.length) {\n      console.error('ERROR: Non-existent tests found in listing_meta.json. Please update:');\n      for (const metadataKey of staleEntries) {\n        console.error(`  ${metadataKey}`);\n      }\n      unreachable();\n    }\n  }\n\n  if (opts?.printCaseCountReport) {\n    console.log(`-----\\nTOTAL: ${totalCases} cases, ${totalSubcases} subcases`);\n  }\n  return entries;\n}\n\nexport function makeListing(filename: string): Promise<TestSuiteListing> {\n  // Don't validate. This path is only used for the dev server and running tests with Node.\n  // Validation is done for listing generation and presubmit.\n  return crawl(path.dirname(filename));\n}\n"],"mappings":";;IAAA;AACA;AACA;AAEA,OAAO,KAAKA,EAAE,MAAM,IAAI,CACxB,OAAO,KAAKC,IAAI,MAAM,MAAM;;AAE5B,SAASC,oBAAoB,QAAQ,0BAA0B;;AAE/D,SAASC,kBAAkB,EAAEC,kBAAkB,QAAQ,4BAA4B;AACnF,SAASC,cAAc,QAAQ,qCAAqC;;AAEpE,SAASC,MAAM,EAAEC,WAAW,QAAQ,iBAAiB;;AAErD,MAAMC,cAAc,GAAGC,UAAU,CAACC,QAAQ,CAAC,KAAK,CAAC,GAAG,UAAU,GAAG,UAAU;;AAE3E,eAAeC,qBAAqBA,CAACC,GAAW,EAAqB;EACnE,MAAMC,WAAW,GAAG,MAAMC,OAAO,CAACC,GAAG;IACnC,CAAC,MAAMf,EAAE,CAACgB,QAAQ,CAACC,OAAO,CAACL,GAAG,CAAC,EAAEM,GAAG,CAAC,OAAMC,CAAC,KAAI;MAC9C,MAAMC,CAAC,GAAGnB,IAAI,CAACoB,IAAI,CAACT,GAAG,EAAEO,CAAC,CAAC;MAC3B,MAAMG,KAAK,GAAG,MAAMtB,EAAE,CAACgB,QAAQ,CAACO,IAAI,CAACH,CAAC,CAAC;MACvC,OAAO;QACLnB,IAAI,EAAEmB,CAAC;QACPI,WAAW,EAAEF,KAAK,CAACE,WAAW,CAAC,CAAC;QAChCC,MAAM,EAAEH,KAAK,CAACG,MAAM,CAAC;MACvB,CAAC;IACH,CAAC;EACH,CAAC;;EAED,MAAMC,KAAK,GAAGb,WAAW;EACtBc,MAAM;IACL,CAAAC,CAAC;IACCA,CAAC,CAACH,MAAM;IACPG,CAAC,CAAC3B,IAAI,CAACS,QAAQ,CAACF,cAAc,CAAC;IAC9BoB,CAAC,CAAC3B,IAAI,CAACS,QAAQ,CAAE,GAAET,IAAI,CAAC4B,GAAI,YAAW,CAAC;IACxCD,CAAC,CAAC3B,IAAI,KAAK,YAAY;EAC7B,CAAC;EACAiB,GAAG,CAAC,CAAAU,CAAC,KAAIA,CAAC,CAAC3B,IAAI,CAAC;;EAEnB,OAAOyB,KAAK,CAACI,MAAM;IACjB,MAAMjB,WAAW;IACdc,MAAM,CAAC,CAAAC,CAAC,KAAIA,CAAC,CAACJ,WAAW,CAAC;IAC1BN,GAAG,CAAC,CAAAU,CAAC,KAAIjB,qBAAqB,CAACiB,CAAC,CAAC3B,IAAI,CAAC,CAAC;IACvC8B,MAAM,CAAC,OAAOC,CAAC,EAAEC,CAAC,KAAK,CAAC,MAAMD,CAAC,EAAEF,MAAM,CAAC,MAAMG,CAAC,CAAC,EAAEnB,OAAO,CAACoB,OAAO,CAAC,EAAE,CAAC;EAC1E,CAAC;AACH;;AAEA,OAAO,eAAeC,KAAKA;AACzBC,QAAgB;AAChBC,IAIQ;;;;AAAG,IAAI;AACmB;EAClC,IAAI,CAACrC,EAAE,CAACsC,UAAU,CAACF,QAAQ,CAAC,EAAE;IAC5B,MAAM,IAAIG,KAAK,CAAE,yBAAwBH,QAAS,EAAC,CAAC;EACtD;;EAEA,IAAII,UAAU,GAAG,CAAC;EAClB,IAAIC,aAAa,GAAG,CAAC;;EAErB,IAAIC,sBAAsB;EAC1B,IAAIL,IAAI,EAAEM,QAAQ,EAAE;IAClB,MAAMC,QAAQ,GAAG1C,oBAAoB,CAACkC,QAAQ,CAAC;IAC/C,IAAIQ,QAAQ,EAAE;MACZF,sBAAsB,GAAG;QACvBE,QAAQ;QACRC,iBAAiB,EAAE,IAAIC,GAAG,CAAS;MACrC,CAAC;IACH;EACF;;EAEA;EACA,MAAMC,gBAAgB,GAAG,CAAC,MAAMpC,qBAAqB,CAACyB,QAAQ,CAAC;EAC5DlB,GAAG,CAAC,CAAA8B,CAAC,KAAI/C,IAAI,CAACgD,QAAQ,CAACb,QAAQ,EAAEY,CAAC,CAAC,CAACE,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;EACxDC,IAAI,CAAC,CAAC;;EAET,MAAMC,OAAgC,GAAG,EAAE;EAC3C,KAAK,MAAMC,IAAI,IAAIN,gBAAgB,EAAE;IACnC;IACA,IAAIM,IAAI,CAAC3C,QAAQ,CAACF,cAAc,CAAC,EAAE;MACjC,MAAM8C,wBAAwB,GAAGD,IAAI,CAACE,SAAS,CAAC,CAAC,EAAEF,IAAI,CAACG,MAAM,GAAGhD,cAAc,CAACgD,MAAM,CAAC;MACvF,MAAMC,YAAY,GAAGH,wBAAwB,CAACI,KAAK,CAAC,GAAG,CAAC;;MAExD,MAAMC,KAAK,GAAG1D,IAAI,CAAC2D,QAAQ,CAACxB,QAAQ,CAAC;;MAErC,IAAIC,IAAI,EAAEM,QAAQ,EAAE;QAClB,MAAMkB,QAAQ,GAAI,SAAQF,KAAM,IAAGL,wBAAyB,UAAS;;QAErEhD,MAAM,CAAC,CAACwD,OAAO,CAACC,GAAG,CAACC,qBAAqB,CAAC;QAC1C,MAAMC,GAAG,GAAI,MAAM,MAAM,CAACJ,QAAQ,CAAc;QAChDvD,MAAM,CAAC2D,GAAG,CAACC,WAAW,KAAKC,SAAS,EAAE,sCAAsC,GAAGN,QAAQ,CAAC;QACxFvD,MAAM,CAAC2D,GAAG,CAACG,CAAC,KAAKD,SAAS,EAAE,+CAA+C,GAAGN,QAAQ,CAAC;;QAEvFI,GAAG,CAACG,CAAC,CAACzB,QAAQ,CAAC,IAAIvC,kBAAkB,CAACuD,KAAK,EAAEF,YAAY,CAAC,CAAC;;QAE3D,IAAIpB,IAAI,EAAEgC,oBAAoB,IAAI3B,sBAAsB,EAAE;UACxD,KAAK,MAAM4B,CAAC,IAAIL,GAAG,CAACG,CAAC,CAACG,OAAO,CAAC,CAAC,EAAE;YAC/B,MAAMC,SAAS,GAAG,IAAIrE,kBAAkB;cACtCwD,KAAK;cACLF,YAAY;cACZa,CAAC,CAACG,QAAQ;cACV,CAAC;YACH,CAAC,CAACC,QAAQ,CAAC,CAAC;;YAEZ,IAAIC,KAAK,GAAG,CAAC;YACb,IAAIC,QAAQ,GAAG,CAAC;YAChB,KAAK,MAAMC,CAAC,IAAIP,CAAC,CAACC,OAAO,CAAC,IAAI,CAAC,EAAE;cAC/BI,KAAK,EAAE;cACP,IAAItC,IAAI,EAAEgC,oBAAoB,EAAE;gBAC9BO,QAAQ,IAAIC,CAAC,CAACC,mBAAmB,CAAC,CAAC;cACrC;YACF;;YAEA,IAAIzC,IAAI,EAAEgC,oBAAoB,EAAE;cAC9B,MAAMU,OAAO,GAAG,CAACH,QAAQ,GAAGD,KAAK,EAAEK,OAAO,CAAC,CAAC,CAAC;cAC7CC,OAAO,CAACC,GAAG,CAAE,GAAEV,SAAU,MAAKG,KAAM,WAAUC,QAAS,eAAcG,OAAQ,QAAO,CAAC;cACrFvC,UAAU,IAAImC,KAAK;cACnBlC,aAAa,IAAImC,QAAQ;YAC3B;;YAEA,IAAIlC,sBAAsB,IAAIiC,KAAK,GAAG,CAAC,EAAE;cACvCjC,sBAAsB,CAACG,iBAAiB,CAACsC,GAAG,CAACX,SAAS,CAAC;YACzD;UACF;QACF;MACF;;MAEA,KAAK,MAAMpD,CAAC,IAAIqC,YAAY,EAAE;QAC5BnD,MAAM,CAACD,cAAc,CAAC+E,IAAI,CAAChE,CAAC,CAAC,EAAG,0BAAyBA,CAAE,gBAAef,cAAe,EAAC,CAAC;MAC7F;MACA+C,OAAO,CAACiC,IAAI,CAAC,EAAEhC,IAAI,EAAEI,YAAY,CAAC,CAAC,CAAC;IACtC,CAAC,MAAM,IAAIxD,IAAI,CAAC2D,QAAQ,CAACP,IAAI,CAAC,KAAK,YAAY,EAAE;MAC/C,MAAMiC,OAAO,GAAGrF,IAAI,CAACqF,OAAO,CAACjC,IAAI,CAAC;MAClC,MAAMkC,MAAM,GAAGvF,EAAE,CAACwF,YAAY,CAACvF,IAAI,CAACoB,IAAI,CAACe,QAAQ,EAAEiB,IAAI,CAAC,EAAE,MAAM,CAAC,CAACoC,IAAI,CAAC,CAAC;;MAExE,MAAMhC,YAAY,GAAG6B,OAAO,KAAK,GAAG,GAAGA,OAAO,CAAC5B,KAAK,CAAC,GAAG,CAAC,GAAG,EAAE;MAC9DN,OAAO,CAACiC,IAAI,CAAC,EAAEhC,IAAI,EAAEI,YAAY,EAAE8B,MAAM,CAAC,CAAC,CAAC;IAC9C,CAAC,MAAM;MACLhF,WAAW,CAAE,oCAAmC8C,IAAK,EAAC,CAAC;IACzD;EACF;;EAEA,IAAIX,sBAAsB,EAAE;IAC1B,MAAMgD,WAAW,GAAG,EAAE;IACtB,MAAMC,YAAY,GAAG,EAAE;IACvB,KAAK,MAAM,CAACC,WAAW,EAAEC,aAAa,CAAC,IAAIC,MAAM,CAAC1C,OAAO,CAACV,sBAAsB,CAACE,QAAQ,CAAC,EAAE;MAC1F,IAAIgD,WAAW,CAACG,UAAU,CAAC,GAAG,CAAC,EAAE;QAC/B;QACA;MACF;MACA,IAAIF,aAAa,CAACG,SAAS,IAAI,CAAC,EAAE;QAChCN,WAAW,CAACL,IAAI,CAACO,WAAW,CAAC;MAC/B;MACA,IAAI,CAAClD,sBAAsB,CAACG,iBAAiB,CAACoD,GAAG,CAACL,WAAW,CAAC,EAAE;QAC9DD,YAAY,CAACN,IAAI,CAACO,WAAW,CAAC;MAChC;IACF;IACA,IAAIF,WAAW,CAAClC,MAAM,IAAInB,IAAI,EAAE6D,qBAAqB,EAAE;MACrDjB,OAAO,CAACkB,IAAI;QACV;MACF,CAAC;MACD,KAAK,MAAMP,WAAW,IAAIF,WAAW,EAAE;QACrCT,OAAO,CAACkB,IAAI,CAAE,KAAIP,WAAY,EAAC,CAAC;MAClC;IACF;;IAEA,IAAIvD,IAAI,EAAE6D,qBAAqB,EAAE;MAC/B,MAAME,cAAc,GAAG,EAAE;MACzB,KAAK,MAAMR,WAAW,IAAIlD,sBAAsB,CAACG,iBAAiB,EAAE;QAClE,IAAI,EAAE+C,WAAW,IAAIlD,sBAAsB,CAACE,QAAQ,CAAC,EAAE;UACrDwD,cAAc,CAACf,IAAI,CAACO,WAAW,CAAC;QAClC;MACF;MACA,IAAIQ,cAAc,CAAC5C,MAAM,EAAE;QACzByB,OAAO,CAACoB,KAAK;UACX;QACF,CAAC;QACD,KAAK,MAAMT,WAAW,IAAIQ,cAAc,EAAE;UACxCnB,OAAO,CAACoB,KAAK,CAAE,KAAIT,WAAY,EAAC,CAAC;QACnC;MACF;IACF;;IAEA,IAAID,YAAY,CAACnC,MAAM,EAAE;MACvByB,OAAO,CAACoB,KAAK,CAAC,sEAAsE,CAAC;MACrF,KAAK,MAAMT,WAAW,IAAID,YAAY,EAAE;QACtCV,OAAO,CAACoB,KAAK,CAAE,KAAIT,WAAY,EAAC,CAAC;MACnC;MACArF,WAAW,CAAC,CAAC;IACf;EACF;;EAEA,IAAI8B,IAAI,EAAEgC,oBAAoB,EAAE;IAC9BY,OAAO,CAACC,GAAG,CAAE,iBAAgB1C,UAAW,WAAUC,aAAc,WAAU,CAAC;EAC7E;EACA,OAAOW,OAAO;AAChB;;AAEA,OAAO,SAASkD,WAAWA,CAACzC,QAAgB,EAA6B;EACvE;EACA;EACA,OAAO1B,KAAK,CAAClC,IAAI,CAACqF,OAAO,CAACzB,QAAQ,CAAC,CAAC;AACtC"}