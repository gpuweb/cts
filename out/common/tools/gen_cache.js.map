{"version":3,"file":"gen_cache.js","names":["fs","path","process","dataCache","setIsBuildingDataCache","usage","rc","console","error","exit","mode","verbose","nonFlagsArgs","a","argv","startsWith","log","push","length","outRootDir","setStore","load","Promise","resolve","reject","readFile","err","data","message","suiteDir","slice","build","specFileSuffix","__filename","endsWith","crawlFilesRecursively","dir","subpathInfo","all","promises","readdir","map","d","p","join","stats","stat","isDirectory","isFile","files","filter","i","concat","reduce","b","existsSync","filesToEnumerate","sort","cacheablePathToTS","Map","file","pathWithoutExtension","substring","mod","serialize","undefined","cacheable","existing","get","set","outPath","serialized","mkdirSync","dirname","recursive","writeFileSync"],"sources":["../../../src/common/tools/gen_cache.ts"],"sourcesContent":["import * as fs from 'fs';\nimport * as path from 'path';\nimport * as process from 'process';\n\nimport { Cacheable, dataCache, setIsBuildingDataCache } from '../framework/data_cache.js';\n\nfunction usage(rc: number): void {\n  console.error(`Usage: tools/gen_cache [options] [OUT_DIR] [SUITE_DIRS...]\n\nFor each suite in SUITE_DIRS, pre-compute data that is expensive to generate\nat runtime and store it under OUT_DIR. If the data file is found then the\nDataCache will load this instead of building the expensive data at CTS runtime.\n\nOptions:\n  --help          Print this message and exit.\n  --list          Print the list of output files without writing them.\n  --validate      Check that cache should build (Tests for collisions).\n  --verbose       Print each action taken.\n`);\n  process.exit(rc);\n}\n\nlet mode: 'emit' | 'list' | 'validate' = 'emit';\nlet verbose = false;\n\nconst nonFlagsArgs: string[] = [];\nfor (const a of process.argv) {\n  if (a.startsWith('-')) {\n    switch (a) {\n      case '--list':\n        mode = 'list';\n        break;\n      case '--help':\n        usage(0);\n        break;\n      case '--verbose':\n        verbose = true;\n        break;\n      case '--validate':\n        mode = 'validate';\n        break;\n      default:\n        console.log('unrecognized flag: ', a);\n        usage(1);\n    }\n  } else {\n    nonFlagsArgs.push(a);\n  }\n}\n\nif (nonFlagsArgs.length < 4) {\n  usage(0);\n}\n\nconst outRootDir = nonFlagsArgs[2];\n\ndataCache.setStore({\n  load: (path: string) => {\n    return new Promise<string>((resolve, reject) => {\n      fs.readFile(`data/${path}`, 'utf8', (err, data) => {\n        if (err !== null) {\n          reject(err.message);\n        } else {\n          resolve(data);\n        }\n      });\n    });\n  },\n});\nsetIsBuildingDataCache();\n\nvoid (async () => {\n  for (const suiteDir of nonFlagsArgs.slice(3)) {\n    await build(suiteDir);\n  }\n})();\n\nconst specFileSuffix = __filename.endsWith('.ts') ? '.spec.ts' : '.spec.js';\n\nasync function crawlFilesRecursively(dir: string): Promise<string[]> {\n  const subpathInfo = await Promise.all(\n    (await fs.promises.readdir(dir)).map(async d => {\n      const p = path.join(dir, d);\n      const stats = await fs.promises.stat(p);\n      return {\n        path: p,\n        isDirectory: stats.isDirectory(),\n        isFile: stats.isFile(),\n      };\n    })\n  );\n\n  const files = subpathInfo\n    .filter(i => i.isFile && i.path.endsWith(specFileSuffix))\n    .map(i => i.path);\n\n  return files.concat(\n    await subpathInfo\n      .filter(i => i.isDirectory)\n      .map(i => crawlFilesRecursively(i.path))\n      .reduce(async (a, b) => (await a).concat(await b), Promise.resolve([]))\n  );\n}\n\nasync function build(suiteDir: string) {\n  if (!fs.existsSync(suiteDir)) {\n    console.error(`Could not find ${suiteDir}`);\n    process.exit(1);\n  }\n\n  // Crawl files and convert paths to be POSIX-style, relative to suiteDir.\n  const filesToEnumerate = (await crawlFilesRecursively(suiteDir)).sort();\n\n  const cacheablePathToTS = new Map<string, string>();\n\n  for (const file of filesToEnumerate) {\n    if (file.endsWith(specFileSuffix)) {\n      const pathWithoutExtension = file.substring(0, file.length - specFileSuffix.length);\n      const mod = await import(`../../../${pathWithoutExtension}.spec.js`);\n      if (mod.d?.serialize !== undefined) {\n        const cacheable = mod.d as Cacheable<unknown>;\n\n        {\n          // Check for collisions\n          const existing = cacheablePathToTS.get(cacheable.path);\n          if (existing !== undefined) {\n            console.error(\n              `error: Cacheable '${cacheable.path}' is emitted by both:\n    '${existing}'\nand\n    '${file}'`\n            );\n            process.exit(1);\n          }\n          cacheablePathToTS.set(cacheable.path, file);\n        }\n\n        const outPath = `${outRootDir}/data/${cacheable.path}`;\n\n        switch (mode) {\n          case 'emit': {\n            if (verbose) {\n              console.log(`building '${outPath}'`);\n            }\n            const data = await cacheable.build();\n            const serialized = cacheable.serialize(data);\n            fs.mkdirSync(path.dirname(outPath), { recursive: true });\n            fs.writeFileSync(outPath, serialized);\n            break;\n          }\n          case 'list': {\n            console.log(outPath);\n            break;\n          }\n          case 'validate': {\n            // Only check currently performed is the collision detection above\n            break;\n          }\n        }\n      }\n    }\n  }\n}\n"],"mappings":"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"}