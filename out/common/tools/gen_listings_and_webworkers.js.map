{"version":3,"file":"gen_listings_and_webworkers.js","names":["fs","path","process","crawl","usage","rc","console","error","exit","argv","indexOf","i","splice","length","myself","outDir","suiteDir","slice","then","listing","suite","basename","outFile","normalize","join","mkdirSync","recursive","writeFileSync","JSON","stringify","undefined","entry","outFileDir","file","relPathToSuiteRoot","Array","fill"],"sources":["../../../src/common/tools/gen_listings_and_webworkers.ts"],"sourcesContent":["import * as fs from 'fs';\nimport * as path from 'path';\nimport * as process from 'process';\n\nimport { crawl } from './crawl.js';\n\nfunction usage(rc: number): void {\n  console.error(`Usage: tools/gen_listings_and_webworkers [options] [OUT_DIR] [SUITE_DIRS...]\n\nFor each suite in SUITE_DIRS, generate listings into OUT_DIR/{suite}/listing.js,\nand generate Web Worker proxies in OUT_DIR/{suite}/webworker/**/*.as_worker.js for\nevery .spec.js file. (Note {suite}/webworker/ is reserved for this purpose.)\n\nExample:\n  tools/gen_listings_and_webworkers gen/ src/unittests/ src/webgpu/\n\nOptions:\n  --help          Print this message and exit.\n`);\n  process.exit(rc);\n}\n\nconst argv = process.argv;\nif (argv.indexOf('--help') !== -1) {\n  usage(0);\n}\n\n{\n  // Ignore old argument that is now the default\n  const i = argv.indexOf('--no-validate');\n  if (i !== -1) {\n    argv.splice(i, 1);\n  }\n}\n\nif (argv.length < 4) {\n  usage(0);\n}\n\nconst myself = 'src/common/tools/gen_listings_and_webworkers.ts';\n\nconst outDir = argv[2];\n\nfor (const suiteDir of argv.slice(3)) {\n  // Run concurrently for each suite (might be a tiny bit more efficient)\n  void crawl(suiteDir).then(listing => {\n    const suite = path.basename(suiteDir);\n\n    // Write listing.js\n    const outFile = path.normalize(path.join(outDir, `${suite}/listing.js`));\n    fs.mkdirSync(path.join(outDir, suite), { recursive: true });\n    fs.writeFileSync(\n      outFile,\n      `\\\n// AUTO-GENERATED - DO NOT EDIT. See ${myself}.\n\nexport const listing = ${JSON.stringify(listing, undefined, 2)};\n`\n    );\n\n    // Write suite/webworker/**/*.as_worker.js\n    // (Note we avoid \".worker.js\" because that conflicts with WPT test naming patterns.)\n    for (const entry of listing) {\n      if ('readme' in entry) continue;\n\n      const outFileDir = path.join(\n        outDir,\n        suite,\n        'webworker',\n        ...entry.file.slice(0, entry.file.length - 1)\n      );\n      const outFile = path.join(outDir, suite, 'webworker', ...entry.file) + '.as_worker.js';\n\n      const relPathToSuiteRoot = Array<string>(entry.file.length).fill('..').join('/');\n\n      fs.mkdirSync(outFileDir, { recursive: true });\n      fs.writeFileSync(\n        outFile,\n        `\\\n// AUTO-GENERATED - DO NOT EDIT. See ${myself}.\n\nimport { g } from '${relPathToSuiteRoot}/${entry.file.join('/')}.spec.js';\nimport { wrapTestGroupForWorker } from '${relPathToSuiteRoot}/../common/runtime/helper/wrap_for_worker.js';\n\nwrapTestGroupForWorker(g);\n`\n      );\n    }\n  });\n}\n"],"mappings":"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"}