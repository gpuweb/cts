{"version":3,"file":"server.js","names":["fs","http","dataCache","getResourcePath","setBaseResourcePath","globalTestConfig","DefaultTestFileLoader","prettyPrintLog","Logger","parseQuery","Colors","setDefaultRequestAdapterOptions","setGPUProvider","sys","usage","rc","console","log","exit","existsSync","enabled","emitCoverage","verbose","gpuProviderModule","undefined","gpuProviderFlags","i","args","length","a","startsWith","compatibility","forceFallbackAdapter","logToWebSocket","modulePath","require","push","enableDebugLogs","unrollConstEvalLoops","codeCoverage","compatibilityMode","create","coverage","error","setStore","load","path","Promise","resolve","reject","readFile","err","data","message","setDebugLogger","testcases","Map","runTestcase","testcase","expectations","name","query","toString","rec","res","record","run","server","createServer","request","response","url","end","loadCasesPrefix","runPrefix","terminatePrefix","substr","webgpuQuery","loader","loadCases","set","statusCode","stack","get","begin","start","performance","now","result","durationMS","coverageData","logs","map","join","status","JSON","stringify","close","listen","address","port","catch","ex"],"sources":["../../../src/common/runtime/server.ts"],"sourcesContent":["/* eslint-disable no-console, n/no-restricted-import */\n\nimport * as fs from 'fs';\nimport * as http from 'http';\nimport { AddressInfo } from 'net';\n\nimport { dataCache } from '../framework/data_cache.js';\nimport { getResourcePath, setBaseResourcePath } from '../framework/resources.js';\nimport { globalTestConfig } from '../framework/test_config.js';\nimport { DefaultTestFileLoader } from '../internal/file_loader.js';\nimport { prettyPrintLog } from '../internal/logging/log_message.js';\nimport { Logger } from '../internal/logging/logger.js';\nimport { LiveTestCaseResult, Status } from '../internal/logging/result.js';\nimport { parseQuery } from '../internal/query/parseQuery.js';\nimport { TestQueryWithExpectation } from '../internal/query/query.js';\nimport { TestTreeLeaf } from '../internal/tree.js';\nimport { Colors } from '../util/colors.js';\nimport { setDefaultRequestAdapterOptions, setGPUProvider } from '../util/navigator_gpu.js';\n\nimport sys from './helper/sys.js';\n\nfunction usage(rc: number): never {\n  console.log(`Usage:\n  tools/server [OPTIONS...]\nOptions:\n  --colors                  Enable ANSI colors in output.\n  --compat                  Run tests in compatibility mode.\n  --coverage                Add coverage data to each result.\n  --verbose                 Print result/log of every test as it runs.\n  --debug                   Include debug messages in logging.\n  --gpu-provider            Path to node module that provides the GPU implementation.\n  --gpu-provider-flag       Flag to set on the gpu-provider as <flag>=<value>\n  --unroll-const-eval-loops Unrolls loops in constant-evaluation shader execution tests\n  --u                       Flag to set on the gpu-provider as <flag>=<value>\n\nProvides an HTTP server used for running tests via an HTTP RPC interface\nFirst, load some tree or subtree of tests:\n  http://localhost:port/load?unittests:basic:*\nTo run a single test case, perform an HTTP GET or POST at the URL:\n  http://localhost:port/run?unittests:basic:test,sync\nTo shutdown the server perform an HTTP GET or POST at the URL:\n  http://localhost:port/terminate\n`);\n  return sys.exit(rc);\n}\n\ninterface RunResult {\n  // The result of the test\n  status: Status;\n  // Any additional messages printed\n  message: string;\n  // The time it took to execute the test\n  durationMS: number;\n  // Code coverage data, if the server was started with `--coverage`\n  // This data is opaque (implementation defined).\n  coverageData?: string;\n}\n\n// The interface that exposes creation of the GPU, and optional interface to code coverage.\ninterface GPUProviderModule {\n  // @returns a GPU with the given flags\n  create(flags: string[]): GPU;\n  // An optional interface to a CodeCoverageProvider\n  coverage?: CodeCoverageProvider;\n}\n\ninterface CodeCoverageProvider {\n  // Starts collecting code coverage\n  begin(): void;\n  // Ends collecting of code coverage, returning the coverage data.\n  // This data is opaque (implementation defined).\n  end(): string;\n}\n\nif (!sys.existsSync('src/common/runtime/cmdline.ts')) {\n  console.log('Must be run from repository root');\n  usage(1);\n}\nsetBaseResourcePath('out-node/resources');\n\nColors.enabled = false;\n\nlet emitCoverage = false;\nlet verbose = false;\nlet gpuProviderModule: GPUProviderModule | undefined = undefined;\n\nconst gpuProviderFlags: string[] = [];\nfor (let i = 0; i < sys.args.length; ++i) {\n  const a = sys.args[i];\n  if (a.startsWith('-')) {\n    if (a === '--colors') {\n      Colors.enabled = true;\n    } else if (a === '--compat') {\n      globalTestConfig.compatibility = true;\n    } else if (a === '--coverage') {\n      emitCoverage = true;\n    } else if (a === '--force-fallback-adapter') {\n      globalTestConfig.forceFallbackAdapter = true;\n    } else if (a === '--log-to-websocket') {\n      globalTestConfig.logToWebSocket = true;\n    } else if (a === '--gpu-provider') {\n      const modulePath = sys.args[++i];\n      gpuProviderModule = require(modulePath);\n    } else if (a === '--gpu-provider-flag') {\n      gpuProviderFlags.push(sys.args[++i]);\n    } else if (a === '--debug') {\n      globalTestConfig.enableDebugLogs = true;\n    } else if (a === '--unroll-const-eval-loops') {\n      globalTestConfig.unrollConstEvalLoops = true;\n    } else if (a === '--help') {\n      usage(1);\n    } else if (a === '--verbose') {\n      verbose = true;\n    } else {\n      console.log(`unrecognized flag: ${a}`);\n    }\n  }\n}\n\nlet codeCoverage: CodeCoverageProvider | undefined = undefined;\n\nif (globalTestConfig.compatibility || globalTestConfig.forceFallbackAdapter) {\n  // MAINTENANCE_TODO: remove the cast once compatibilityMode is officially added\n  setDefaultRequestAdapterOptions({\n    compatibilityMode: globalTestConfig.compatibility,\n    forceFallbackAdapter: globalTestConfig.forceFallbackAdapter,\n  } as GPURequestAdapterOptions);\n}\n\nif (gpuProviderModule) {\n  setGPUProvider(() => gpuProviderModule!.create(gpuProviderFlags));\n\n  if (emitCoverage) {\n    codeCoverage = gpuProviderModule.coverage;\n    if (codeCoverage === undefined) {\n      console.error(\n        `--coverage specified, but the GPUProviderModule does not support code coverage.\nDid you remember to build with code coverage instrumentation enabled?`\n      );\n      sys.exit(1);\n    }\n  }\n}\n\ndataCache.setStore({\n  load: (path: string) => {\n    return new Promise<Uint8Array>((resolve, reject) => {\n      fs.readFile(getResourcePath(`cache/${path}`), (err, data) => {\n        if (err !== null) {\n          reject(err.message);\n        } else {\n          resolve(data);\n        }\n      });\n    });\n  },\n});\n\nif (verbose) {\n  dataCache.setDebugLogger(console.log);\n}\n\n// eslint-disable-next-line @typescript-eslint/require-await\n(async () => {\n  const log = new Logger();\n  const testcases = new Map<string, TestTreeLeaf>();\n\n  async function runTestcase(\n    testcase: TestTreeLeaf,\n    expectations: TestQueryWithExpectation[] = []\n  ): Promise<LiveTestCaseResult> {\n    const name = testcase.query.toString();\n    const [rec, res] = log.record(name);\n    await testcase.run(rec, expectations);\n    return res;\n  }\n\n  const server = http.createServer(\n    async (request: http.IncomingMessage, response: http.ServerResponse) => {\n      if (request.url === undefined) {\n        response.end('invalid url');\n        return;\n      }\n\n      const loadCasesPrefix = '/load?';\n      const runPrefix = '/run?';\n      const terminatePrefix = '/terminate';\n\n      if (request.url.startsWith(loadCasesPrefix)) {\n        const query = request.url.substr(loadCasesPrefix.length);\n        try {\n          const webgpuQuery = parseQuery(query);\n          const loader = new DefaultTestFileLoader();\n          for (const testcase of await loader.loadCases(webgpuQuery)) {\n            testcases.set(testcase.query.toString(), testcase);\n          }\n          response.statusCode = 200;\n          response.end();\n        } catch (err) {\n          response.statusCode = 500;\n          response.end(`load failed with error: ${err}\\n${(err as Error).stack}`);\n        }\n      } else if (request.url.startsWith(runPrefix)) {\n        const name = request.url.substr(runPrefix.length);\n        try {\n          const testcase = testcases.get(name);\n          if (testcase) {\n            if (codeCoverage !== undefined) {\n              codeCoverage.begin();\n            }\n            const start = performance.now();\n            const result = await runTestcase(testcase);\n            const durationMS = performance.now() - start;\n            const coverageData = codeCoverage !== undefined ? codeCoverage.end() : undefined;\n            let message = '';\n            if (result.logs !== undefined) {\n              message = result.logs.map(log => prettyPrintLog(log)).join('\\n');\n            }\n            const status = result.status;\n            const res: RunResult = { status, message, durationMS, coverageData };\n            response.statusCode = 200;\n            response.end(JSON.stringify(res));\n          } else {\n            response.statusCode = 404;\n            response.end(`test case '${name}' not found`);\n          }\n        } catch (err) {\n          response.statusCode = 500;\n          response.end(`run failed with error: ${err}`);\n        }\n      } else if (request.url.startsWith(terminatePrefix)) {\n        server.close();\n        sys.exit(1);\n      } else {\n        response.statusCode = 404;\n        response.end('unhandled url request');\n      }\n    }\n  );\n\n  server.listen(0, () => {\n    const address = server.address() as AddressInfo;\n    console.log(`Server listening at [[${address.port}]]`);\n  });\n})().catch(ex => {\n  console.error(ex.stack ?? ex.toString());\n  sys.exit(1);\n});\n"],"mappings":"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"}