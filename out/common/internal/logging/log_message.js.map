{"version":3,"file":"log_message.js","names":["extractImportantStackTrace","LogMessageWithStack","Error","stackHiddenMessage","undefined","wrapError","name","ex","message","stack","extra","constructor","o","setStackHidden","toJSON","m","toRawData","JSON","parse","stringify","prettyPrintLog","log","replace"],"sources":["../../../../src/common/internal/logging/log_message.ts"],"sourcesContent":["import { ErrorWithExtra } from '../../util/util.js';\nimport { extractImportantStackTrace } from '../stack.js';\n\nimport { LogMessageRawData } from './result.js';\n\nexport class LogMessageWithStack extends Error {\n  readonly extra: unknown;\n\n  private stackHiddenMessage: string | undefined = undefined;\n\n  /**\n   * Wrap an Error (which was created to capture the stack at that point) into a\n   * LogMessageWithStack (which has extra stuff for good log messages).\n   *\n   * The original `ex.name` is ignored. Inclued it in the `name` parameter if it\n   * needs to be preserved.\n   */\n  static wrapError(name: string, ex: Error | ErrorWithExtra) {\n    return new LogMessageWithStack({\n      name,\n      message: ex.message,\n      stackHiddenMessage: undefined,\n      stack: ex.stack,\n      extra: 'extra' in ex ? ex.extra : undefined,\n    });\n  }\n\n  constructor(o: LogMessageRawData) {\n    super(o.message);\n    this.name = o.name;\n    this.stackHiddenMessage = o.stackHiddenMessage;\n    this.stack = o.stack;\n    this.extra = o.extra;\n  }\n\n  /** Set a flag so the stack is not printed in toJSON(). */\n  setStackHidden(stackHiddenMessage: string) {\n    this.stackHiddenMessage ??= stackHiddenMessage;\n  }\n\n  /**\n   * Print the message for display.\n   *\n   * Note: This is toJSON instead of toString to make it easy to save logs using JSON.stringify.\n   */\n  toJSON(): string {\n    let m = this.name;\n    if (this.message) m += ': ' + this.message;\n    if (this.stack) {\n      if (this.stackHiddenMessage === undefined) {\n        m += '\\n' + extractImportantStackTrace(this);\n      } else if (this.stackHiddenMessage) {\n        m += `\\n  at (elided: ${this.stackHiddenMessage})`;\n      }\n    }\n    return m;\n  }\n\n  /**\n   * Flatten the message for sending over a message channel.\n   *\n   * Note `extra` may get mangled by postMessage.\n   */\n  toRawData(): LogMessageRawData {\n    let extra = this.extra;\n    if (extra !== undefined) {\n      extra = JSON.parse(JSON.stringify(extra));\n    }\n\n    return {\n      name: this.name,\n      message: this.message,\n      stackHiddenMessage: this.stackHiddenMessage,\n      stack: this.stack,\n      extra,\n    };\n  }\n}\n\n/**\n * Returns a string, nicely indented, for debug logs.\n * This is used in the cmdline and wpt runtimes. In WPT, it shows up in the `*-actual.txt` file.\n */\nexport function prettyPrintLog(log: LogMessageWithStack): string {\n  return '  - ' + log.toJSON().replace(/\\n/g, '\\n    ');\n}\n"],"mappings":";;GACA,SAASA,0BAA0B,QAAQ,aAAa;;;AAIxD,OAAO,MAAMC,mBAAmB,SAASC,KAAK,CAAC;;;EAGrCC,kBAAkB,GAAuBC,SAAS;;EAE1D;AACF;AACA;AACA;AACA;AACA;AACA;EACE,OAAOC,SAASA,CAACC,IAAY,EAAEC,EAA0B,EAAE;IACzD,OAAO,IAAIN,mBAAmB,CAAC;MAC7BK,IAAI;MACJE,OAAO,EAAED,EAAE,CAACC,OAAO;MACnBL,kBAAkB,EAAEC,SAAS;MAC7BK,KAAK,EAAEF,EAAE,CAACE,KAAK;MACfC,KAAK,EAAE,OAAO,IAAIH,EAAE,GAAGA,EAAE,CAACG,KAAK,GAAGN;IACpC,CAAC,CAAC;EACJ;;EAEAO,WAAWA,CAACC,CAAoB,EAAE;IAChC,KAAK,CAACA,CAAC,CAACJ,OAAO,CAAC;IAChB,IAAI,CAACF,IAAI,GAAGM,CAAC,CAACN,IAAI;IAClB,IAAI,CAACH,kBAAkB,GAAGS,CAAC,CAACT,kBAAkB;IAC9C,IAAI,CAACM,KAAK,GAAGG,CAAC,CAACH,KAAK;IACpB,IAAI,CAACC,KAAK,GAAGE,CAAC,CAACF,KAAK;EACtB;;EAEA;EACAG,cAAcA,CAACV,kBAA0B,EAAE;IACzC,IAAI,CAACA,kBAAkB,KAAKA,kBAAkB;EAChD;;EAEA;AACF;AACA;AACA;AACA;EACEW,MAAMA,CAAA,EAAW;IACf,IAAIC,CAAC,GAAG,IAAI,CAACT,IAAI;IACjB,IAAI,IAAI,CAACE,OAAO,EAAEO,CAAC,IAAI,IAAI,GAAG,IAAI,CAACP,OAAO;IAC1C,IAAI,IAAI,CAACC,KAAK,EAAE;MACd,IAAI,IAAI,CAACN,kBAAkB,KAAKC,SAAS,EAAE;QACzCW,CAAC,IAAI,IAAI,GAAGf,0BAA0B,CAAC,IAAI,CAAC;MAC9C,CAAC,MAAM,IAAI,IAAI,CAACG,kBAAkB,EAAE;QAClCY,CAAC,IAAK,mBAAkB,IAAI,CAACZ,kBAAmB,GAAE;MACpD;IACF;IACA,OAAOY,CAAC;EACV;;EAEA;AACF;AACA;AACA;AACA;EACEC,SAASA,CAAA,EAAsB;IAC7B,IAAIN,KAAK,GAAG,IAAI,CAACA,KAAK;IACtB,IAAIA,KAAK,KAAKN,SAAS,EAAE;MACvBM,KAAK,GAAGO,IAAI,CAACC,KAAK,CAACD,IAAI,CAACE,SAAS,CAACT,KAAK,CAAC,CAAC;IAC3C;;IAEA,OAAO;MACLJ,IAAI,EAAE,IAAI,CAACA,IAAI;MACfE,OAAO,EAAE,IAAI,CAACA,OAAO;MACrBL,kBAAkB,EAAE,IAAI,CAACA,kBAAkB;MAC3CM,KAAK,EAAE,IAAI,CAACA,KAAK;MACjBC;IACF,CAAC;EACH;AACF;;AAEA;AACA;AACA;AACA;AACA,OAAO,SAASU,cAAcA,CAACC,GAAwB,EAAU;EAC/D,OAAO,MAAM,GAAGA,GAAG,CAACP,MAAM,CAAC,CAAC,CAACQ,OAAO,CAAC,KAAK,EAAE,QAAQ,CAAC;AACvD"}