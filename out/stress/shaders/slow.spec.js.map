{"version":3,"file":"slow.spec.js","names":["description","makeTestGroup","GPUTest","TextureTestMixin","g","test","desc","fn","t","kDispatchSize","data","Uint32Array","buffer","makeBufferWithContents","GPUBufferUsage","STORAGE","COPY_SRC","module","device","createShaderModule","code","pipeline","createComputePipeline","layout","compute","entryPoint","encoder","createCommandEncoder","pass","beginComputePass","setPipeline","bindGroup","createBindGroup","getBindGroupLayout","entries","binding","resource","setBindGroup","dispatchWorkgroups","end","queue","submit","finish","expectGPUBufferValuesEqual","Array","fill","createRenderPipeline","vertex","buffers","primitive","topology","fragment","targets","format","uniforms","UNIFORM","renderTarget","createTexture","size","usage","GPUTextureUsage","RENDER_ATTACHMENT","beginRenderPass","colorAttachments","view","createView","clearValue","loadOp","storeOp","draw","expectSinglePixelComparisonsAreOkInTexture","texture","coord","x","y","exp","Uint8Array"],"sources":["../../../src/stress/shaders/slow.spec.ts"],"sourcesContent":["export const description = `\nStress tests covering robustness in the presence of slow shaders.\n`;\n\nimport { makeTestGroup } from '../../common/framework/test_group.js';\nimport { GPUTest, TextureTestMixin } from '../../webgpu/gpu_test.js';\n\nexport const g = makeTestGroup(TextureTestMixin(GPUTest));\n\ng.test('compute')\n  .desc(`Tests execution of compute passes with very long-running dispatch operations.`)\n  .fn(t => {\n    const kDispatchSize = 1000;\n    const data = new Uint32Array(kDispatchSize);\n    const buffer = t.makeBufferWithContents(data, GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC);\n    const module = t.device.createShaderModule({\n      code: `\n        struct Buffer { data: array<u32>, };\n        @group(0) @binding(0) var<storage, read_write> buffer: Buffer;\n        @compute @workgroup_size(1) fn main(\n            @builtin(global_invocation_id) id: vec3<u32>) {\n          loop {\n            if (buffer.data[id.x] == 1000000u) {\n              break;\n            }\n            buffer.data[id.x] = buffer.data[id.x] + 1u;\n          }\n        }\n      `,\n    });\n    const pipeline = t.device.createComputePipeline({\n      layout: 'auto',\n      compute: { module, entryPoint: 'main' },\n    });\n    const encoder = t.device.createCommandEncoder();\n    const pass = encoder.beginComputePass();\n    pass.setPipeline(pipeline);\n    const bindGroup = t.device.createBindGroup({\n      layout: pipeline.getBindGroupLayout(0),\n      entries: [{ binding: 0, resource: { buffer } }],\n    });\n    pass.setBindGroup(0, bindGroup);\n    pass.dispatchWorkgroups(kDispatchSize);\n    pass.end();\n    t.device.queue.submit([encoder.finish()]);\n    t.expectGPUBufferValuesEqual(buffer, new Uint32Array(new Array(kDispatchSize).fill(1000000)));\n  });\n\ng.test('vertex')\n  .desc(`Tests execution of render passes with a very long-running vertex stage.`)\n  .fn(t => {\n    const module = t.device.createShaderModule({\n      code: `\n        struct Data { counter: u32, increment: u32, };\n        @group(0) @binding(0) var<uniform> data: Data;\n        @vertex fn vmain() -> @builtin(position) vec4<f32> {\n          var counter: u32 = data.counter;\n          loop {\n            counter = counter + data.increment;\n            if (counter % 50000000u == 0u) {\n              break;\n            }\n          }\n          return vec4<f32>(1.0, 1.0, 0.0, f32(counter));\n        }\n        @fragment fn fmain() -> @location(0) vec4<f32> {\n          return vec4<f32>(1.0, 1.0, 0.0, 1.0);\n        }\n      `,\n    });\n\n    const pipeline = t.device.createRenderPipeline({\n      layout: 'auto',\n      vertex: { module, entryPoint: 'vmain', buffers: [] },\n      primitive: { topology: 'point-list' },\n      fragment: {\n        targets: [{ format: 'rgba8unorm' }],\n        module,\n        entryPoint: 'fmain',\n      },\n    });\n    const uniforms = t.makeBufferWithContents(new Uint32Array([0, 1]), GPUBufferUsage.UNIFORM);\n    const bindGroup = t.device.createBindGroup({\n      layout: pipeline.getBindGroupLayout(0),\n      entries: [\n        {\n          binding: 0,\n          resource: { buffer: uniforms },\n        },\n      ],\n    });\n    const renderTarget = t.device.createTexture({\n      size: [3, 3],\n      usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n      format: 'rgba8unorm',\n    });\n    const encoder = t.device.createCommandEncoder();\n    const pass = encoder.beginRenderPass({\n      colorAttachments: [\n        {\n          view: renderTarget.createView(),\n          clearValue: [0, 0, 0, 0],\n          loadOp: 'clear',\n          storeOp: 'store',\n        },\n      ],\n    });\n    pass.setPipeline(pipeline);\n    pass.setBindGroup(0, bindGroup);\n    pass.draw(1);\n    pass.end();\n    t.device.queue.submit([encoder.finish()]);\n    t.expectSinglePixelComparisonsAreOkInTexture({ texture: renderTarget }, [\n      {\n        coord: { x: 1, y: 1 },\n        exp: new Uint8Array([255, 255, 0, 255]),\n      },\n    ]);\n  });\n\ng.test('fragment')\n  .desc(`Tests execution of render passes with a very long-running fragment stage.`)\n  .fn(t => {\n    const module = t.device.createShaderModule({\n      code: `\n        struct Data { counter: u32, increment: u32, };\n        @group(0) @binding(0) var<uniform> data: Data;\n        @vertex fn vmain() -> @builtin(position) vec4<f32> {\n          return vec4<f32>(0.0, 0.0, 0.0, 1.0);\n        }\n        @fragment fn fmain() -> @location(0) vec4<f32> {\n          var counter: u32 = data.counter;\n          loop {\n            counter = counter + data.increment;\n            if (counter % 50000000u == 0u) {\n              break;\n            }\n          }\n          return vec4<f32>(1.0, 1.0, 1.0 / f32(counter), 1.0);\n        }\n      `,\n    });\n\n    const pipeline = t.device.createRenderPipeline({\n      layout: 'auto',\n      vertex: { module, entryPoint: 'vmain', buffers: [] },\n      primitive: { topology: 'point-list' },\n      fragment: {\n        targets: [{ format: 'rgba8unorm' }],\n        module,\n        entryPoint: 'fmain',\n      },\n    });\n    const uniforms = t.makeBufferWithContents(new Uint32Array([0, 1]), GPUBufferUsage.UNIFORM);\n    const bindGroup = t.device.createBindGroup({\n      layout: pipeline.getBindGroupLayout(0),\n      entries: [\n        {\n          binding: 0,\n          resource: { buffer: uniforms },\n        },\n      ],\n    });\n    const renderTarget = t.device.createTexture({\n      size: [3, 3],\n      usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n      format: 'rgba8unorm',\n    });\n    const encoder = t.device.createCommandEncoder();\n    const pass = encoder.beginRenderPass({\n      colorAttachments: [\n        {\n          view: renderTarget.createView(),\n          clearValue: [0, 0, 0, 0],\n          loadOp: 'clear',\n          storeOp: 'store',\n        },\n      ],\n    });\n    pass.setPipeline(pipeline);\n    pass.setBindGroup(0, bindGroup);\n    pass.draw(1);\n    pass.end();\n    t.device.queue.submit([encoder.finish()]);\n    t.expectSinglePixelComparisonsAreOkInTexture({ texture: renderTarget }, [\n      {\n        coord: { x: 1, y: 1 },\n        exp: new Uint8Array([255, 255, 0, 255]),\n      },\n    ]);\n  });\n"],"mappings":"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"}